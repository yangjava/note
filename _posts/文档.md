# 应用开发规范



修订记录

| **版本号** | **修订人** | **修订日期** | **修订描述**     |
| ---------- | ---------- | ------------ | ---------------- |
| 0.1        | 赵峰       | 2021.12.27   | 应用开发规范初稿 |
|            |            |              |                  |

# 一、应用结构



- 应用目录结构　

　sample-app

　├── pom.xml                     // 应用父pom    （1）

　├── sample-api               // 对外API模块  （2）

　├── sample-biz               // 业务编排模块 （3）

　├── sample-common    // 内部公共模块 （4）

　├── sample-domain      // 问题领域模块 （5）

　└── sample-endpoint   // 服务端口模块 （6）

- 模块间的依赖关系

![img](https://cdn.nlark.com/yuque/__mermaid_v3/b90f8208ea41943421884587fbe2492c.svg)



## (1)  应用父pom

组织服务内的各个模块，管理jar依赖，定义构建参数等。应用中所有子模块用的jar版本统一在父pom的dependencyManagement管理，也就是子模块引用jar的时候不需要指定具体的版本。

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.qjdchina.common</groupId>
        <artifactId>qjd-spring-boot-starter-parent</artifactId>
        <version>1.1.5</version>
        <relativePath/>
    </parent>
    <groupId>com.qjdchina.archetype</groupId>
    <artifactId>sample-parent</artifactId>
    <version>1.0.0</version>
    <packaging>pom</packaging>

    <modules>
        <module>sample-api</module>
        <module>sample-biz</module>
        <module>sample-common</module>
        <module>sample-domain</module>
        <module>sample-endpoint</module>
    </modules>

    <properties>
        <!--基础pom管理中没有的三方jar版本-->
        <poi.version>3.7</poi.version>
    </properties>

    <dependencyManagement>
        <dependencies>
            <!--两方系统服务版本管理-->
            <dependency>
                <groupId>com.qjdchina.common</groupId>
                <artifactId>qjd-services</artifactId>
                <version>20211217</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <!--服务内模块版本管理-->
            <dependency>
                <groupId>com.qjdchina.archetype</groupId>
                <artifactId>sample-api</artifactId>
                <version>1.0.0</version>
            </dependency>
            <dependency>
                <groupId>com.qjdchina.archetype</groupId>
                <artifactId>sample-biz</artifactId>
                <version>${project.version}</version>
            </dependency>
            <dependency>
                <groupId>com.qjdchina.archetype</groupId>
                <artifactId>sample-common</artifactId>
                <version>${project.version}</version>
            </dependency>
            <dependency>
                <groupId>com.qjdchina.archetype</groupId>
                <artifactId>sample-domain</artifactId>
                <version>${project.version}</version>
            </dependency>
            <!--三方依赖-->
            <!--
            <dependency>
                <groupId>org.apache.poi</groupId>
                <artifactId>poi</artifactId>
                <version>${poi.version}</version>
            </dependency>
            <dependency>
                <groupId>org.apache.poi</groupId>
                <artifactId>poi-ooxml</artifactId>
                <version>${poi.version}</version>
            </dependency>
            -->
        </dependencies>
    </dependencyManagement>
</project>
```



## (2) API模块

pom文件继承qjd-common-parent.xml ，jar版本也独立于整个项目的版本。应尽量减少对其他jar包的依赖。



## (3) 业务编排模块

应用的问题领域范围内跟业务逻强相关的代码实现，实现领域逻辑和业务逻辑的解耦（隔离变化）



## (4) 内部公共模块

应用内部多个模块都需要用的代码，包括：常量/枚举定义，异常定义，公共数据模型，工具类定义。



## (5) 问题领域模块

封装本应用需要解决的问题领域相关的领域知识，内部package可以根据DDD的方式进行划分。



## (6) 服务端口模块

本应用向外提供的访问端口暴露模块，包括web端口，rpc端口，job调度端口，jms端口等服务端口。

引用外部配置和资源，对微服务进行组装和配置，向外提供rest和rpc服务。



约定：微服务相关的所有模块都共享一个基础package前缀，启动类放在此基础package下。

例如以上应用模块都使用相同的基础package名：com.qjdchina.archetype

启动类为：com.qjdchina.archetype.SampleApplication



# 二、基础POM

- qjd-dependencies.xml

职责：维护安全，稳定，可相互协作的三方jar版本。

在spring-boot-dependencies的基础上，加入应用常用的其他三方jar包

定义了私有仓库的URL

此pom用于创建其他2个基础pom，一般不单独使用。



- qjd-common-parent.xml

职责：为需要发布到私服的公共组件，或者两方服务jar包提供公共的父pom。

继承qjd-dependencies，定义了java编译版本（source，target）以及代码字符集（UTF-8）

用法：一般需要发布到私有仓库的jar包（两方服务jar包，公共组件）需要指定parent为此pom。



- qjd-spring-boot-parent.xml

职责：为应用服务提供常用的基础组件版本管理，定义构建参数。

继承qjd-dependencies，在基础jar的基础上，维护了大部分应用开发都需要用到的内部组件的版本管理。和spring-boot-starter-parent保持相同的构建参数。

用法：使用springboot开发的微服务模块需要指定parent为此pom。



POM继承关系

![img](https://cdn.nlark.com/yuque/__mermaid_v3/c626b588191371b16b8323f88d6c0e33.svg)

# 三、Jar包管理

## 1. 基础知识

### 1.1 依赖管理和依赖的区别

<dependencyManagement>和<dependency>区别，在父pom中定义dependencyManagement会影响传递依赖的jar包的版本，但不会实际引入该jar包。父pom的dependencies中引入的jar包则会在子pom中自动引入。因此尽量避免在父pom中引入jar包。

### 1.2 optional和provided的区别

```xml
<dependency>
  <groupId>org.projectlombok</groupId>
  <artifactId>lombok</artifactId>
  <optional>true</optional>
</dependency>
```

optional为true的jar包不会出现在传递依赖中，比如a-service.jar的pom中定义了Lombok的依赖，并设置optional为true，那么其他引入了a-service.jar的pom不会传递引入Lombok的jar包。

```xml
<dependency>
  <groupId>javax.servlet</groupId>
  <artifactId>servlet-api</artifactId>
  <scope>provided</scope>
</dependency>
```

scope为provided的jar包同样不会出现在传递依赖中，例如a-service.jar的pom中定义了对servlet-api的依赖（比如写了一些处理Cookie的工具类）那么引入该jar包的服务不会传递依赖servlet-api的jar包。



**optional=true和scope=provided从效果上讲都是排除了某个jar包的递依赖，但语义和使用场景是不一样的**

- optional意为“可选” 典型的应用是springboot的DataSourceAutoConfigure 为不同jdbc数据源提供自动装配功能，但实际使用的时候只会用到一种数据源，因此对每个数据源（hikari，tomcat-jdbc，druid等）都应该是optional，需要使用该jar包的服务需要做2个事情：1. 引入该jar包，2. 选择性地引入该jar包中optional的一些其他jar包。
- provided意为“被提供”也就是当前的jar包要正确运行是建立在引入该jar包的服务已经提供了该jar的前提之下的。典型的场景是对servlet-api的引用，tomcat等servlet容器本身提供了对servlet-api的支持，因此针对servlet规范编写的web应用组件需要用到HttpServletRequest等接口时可以引入servlet-api的特定版本，并设置scope为provided。

### 1.3 scope

- compile 编译时依赖，也就是写代码的时候需要用到某个jar包中的类，那么该jar包的scope应该为compile（不指定scope的时候默认是compile依赖）
- runtime 运行时依赖，也就是写代码的时候不会引用该jar包中的某个类，但运行时会被加载。例如jdbc驱动，一般写代码的时候是不用直接用到mysql-connector-java的jar包里的类的，但运行时会动态加载里面的类。
- test 测试依赖，也就是在junit单元测试时才会用到的类。比如junit，mockito等测试框架的jar包，应该指定scope为test，这样打包的时候就不会把这些jar包打进去。
- provided 被提供的依赖，例如某个jar包针对servlet规范开发，将来会运行在tomcat，jetty等servlet容器上，那么servlet-api.jar包就应该是provided。

## 2. Jar包分类

### 2.1 基础框架

定义应用框架的基础数据类型，常量，枚举，结构化异常体系等。

考虑到历史遗留系统的兼容性，目前SaaS以外的服务使用的基础框架为

git@gitlab.qjdchina.com:wangxiangyang/common.base.git



**主要包含**

RestBody：前后端交互的JSON消息格式定义 

ReturnT和Result： RPC调用返回结果包装类

PageModel：分页结果类

BusinessException：业务异常

ResultCode：结果Code（包含：系统，模块，错误码，错误消息等信息）

此外还包含了兼容老系统的一些枚举值



目前还缺少一些基础类，有待后续补全。

例如：分页参数和分页方法有多种不同的实现，需要用基础框架进行统一。



### 2.2 应用组件

应用开发中经常需要用到的一些业务无关的组件。例如：工具类，经过封装的中间件等

- qjd-spring-boot-starter-activemq
- qjd-spring-boot-starter-common
- qjd-spring-boot-starter-druid
- qjd-spring-boot-starter-dubbo
- qjd-spring-boot-starter-elasticsearch
- qjd-spring-boot-starter-formula
- qjd-spring-boot-starter-ldap
- qjd-spring-boot-starter-lock
- qjd-spring-boot-starter-mongodb
- qjd-spring-boot-starter-monitor
- qjd-spring-boot-starter-mybatis
- qjd-spring-boot-starter-oss
- qjd-spring-boot-starter-quartz
- qjd-spring-boot-starter-redis
- qjd-spring-boot-starter-shiro
- qjd-spring-boot-starter-web
- qjd-spring-boot-starter-xxl-job
- qjd-web-common
- qjd-web-security
- qjd-http
- qjd-redis

### 2.3 两方服务接口

业务相关服务提供外部系统访问该服务的接口定义。尽量减少对其他Jar包的依赖，只包含接口定义，DTO，VO等POJO和必要的注解。可依赖框架类的Jar包，以便Jar包定义的接口和数据类型符合框架要求。

接口类的Jar包只应该包含接口相关的信息和数据对象，避免引入具体的实现类

#### 2.3.1 统一父POM

接口类的Jar包需要继承以下父POM，该POM定义了三方JAR的版本，仓库地址和build插件的基础配置

```xml
<parent>
  <groupId>com.qjdchina.common</groupId>
  <artifactId>qjd-common-parent</artifactId>
  <version>1.0.0</version>
  <relativePath/>
</parent>
```

#### 2.3.2 可依赖的包

1）lombok

2）validation-api

注：hibernate-validator是validation-api的具体实现，接口jar包不要依赖该具体实现

3）swagger-annotation，jackson-annotation等注解jar包

主：不要引入swagger-core，jackson-core等

4）base（框架）



原则上应避免引用其他的两方服：例如：合同模块向外提供的服务proof-api需要用到供应链产品的product-api中的ProductVO，应在自己的jar包中定义DTO，选择ProductVO中需要用到的字段。



#### 2.3.3 需要避免的依赖

1）带有具体功能的三方jar包

例如：poi，fastjson，jackson，gson，commons-lang，guava等

2）其他的接口类Jar包



#### 2.3.4 关于序列化

接口提供的DTO和VO都需要实现Serializable接口，并指定固定的serialVersionUID

避免序列化存储这些DTO的使用方（例如流程引擎等）在DTO字段变更后因自动生成的serialVersionUID变化引起的反序列化错误。



## 3. 版本管理

按照jar包更新迭代的速度和对稳定性的要求，分为两类进行管理。



### 3.1 基础组件

基础组件和基础pom放在 git@gitlab.qjdchina.com:incubator/qjd-common.git 仓库进行管理，所有developer可见，向仓库合并代码需要提交mergeRequest，由backendmaster组进行Review后合并。



### 3.2 两方服务

SNAPSHOT版本：加入分支环境标签 <branch>-SNAPSHOT

Release版本：



### 3.3 版本号规则

[Major].[Minor].[Revision]

例：1.3.2

Major为主版本号，一般只有在有很大改动且不向下兼容的时候才升级。

Minor为次版本号，有新的功能迭代时升级此版本号。

Revision为修订版本号，一些版本发布后，出现bug或安全性修复的时候升级此版本号。



## 4. 私有仓库



release版本发布后，不允许登录nexus管理页面进行手动删除。已经下载了release版本的构建机器不能获取和仓库中被替换后的jar包，会隐藏一些问题（注：mvn 的 -U 参数只会强制下载SNAPSHOT包）。



# 四、配置管理

约定优先，牺牲部分灵活性换取可预期的行为。具体请参考 [《配置规范》](https://cgfrqb.yuque.com/cgfrqb/ehf1l2/yimenw)

## 1. 配置种类

### 1.1 组件默认配置

应用依赖的组件（各类starter）有自身建议的配置，例如数据库连接会加上一些默认参数，Mybatis的配置会加上一些默认行为等。这些参数放在组件starter工程的resources文件夹下，在启动时会被加载后会调用addLast放到Springboot应用的environment的末端，因此优先级最低。

### 1.2 应用默认配置

应用的application.properties（或者yaml文件）中定义的配置，自动的时候自动加载，优先级高于组件默认配置。

### 1.3 Apollo配置

Apollo配置中心中定义的application或者各类common配置，在Apollo初始化的时候会放在environment的最前端（名字叫ApolloBootstrapPropertySources），因此优先级最高。

## 2. 加载优先顺序

规则：

1. 动态/外置的配置 > 静态/固化的配置。因此，Apollo配置中心中同名的配置覆盖应用的静态配置
2. 满足上述1的情况下，应用特定的配置 > 通用的配置。因此，apollo配置中application优先于common.env和组件的配置。
3. 组件的配置和common.env不能出现重复的key

![img](https://cdn.nlark.com/yuque/0/2022/png/102749/1641889087933-d485edf1-212b-4ef6-830a-2ced12d7220f.png)

## 3. 配置加密

放在Apollo上的配置中的敏感信息，需要进行加密。加密后的配置项格式为：

**config.key.xxx=****ENC**(Q64M....4f....m4这里是加密后的内容....3gUu9bj5gyngI=)

应用程序通过Spring正常读取配置的方式(@Value注入等) 可获取原文

上述加密配置可以通过https://boss-testa.qjdchina.com/toolkit/jasypt/encrypt 加密（线上也有对应的地址)

可以把整个配置文件拷贝进去一次性加密，只要把需要加密的配置值改成DEC(xxxx)这样的格式。

```plain
config.key.xxx=DEC(这里是需要加密的配置内容)
# 注释等其他内容不会改变
config.key.yyy=DEC(这里是需要加密的配置内容)
```

注意：加密前的格式为**DEC**(xxxx) 加密后是 **ENC**(......)

# 五、服务监控



每个服务都应该接入服务监控模块，以便运维管理平台对微服务的健康状态进行监控报警。

接入方式：引入以下jar包

```xml
<dependency>
	<groupId>com.qjdchina.common</groupId>
	<artifactId>qjd-spring-boot-starter-monitor</artifactId>
</dependency>
```



# 六、最佳实践

## lombok

### 1. 是否该用

关于开发团队中是否引入lombok网上有很多争论，持反对态度的人最主要的观点有2个

1. 绑架整个开发团队都必须装ide插件才能正确显示使用了lombok的代码
2. 会让编译过程变慢
3. 只是一种语法糖，很多功能其实ide也能实现（例如，getter/setter equals/hashCode生成）

实际上我们团队已经在使用lombok，且有很多场景确实能带来便利，因此就不展开是否能用lombok的讨论，而应该关注怎样把lombok用好。

### 2. 怎样用

在用lombok的时候，首先需要知道lombok的原理：lombok确实只是一种"语法糖" ，实际是基于“JSR 269 Pluggable Annotation Processing API”在**编译阶段**生成了一些代码，帮助开发人员减少开发中经常重复的模板代码，提升代码简洁度，并减少出错概率。因此我们在使用lombok的时候，需要知道每个注解实际生成了怎样的代码，做到“心中有码”(可以反编译class文件查看实际代码）。

### 3. 常用的注解

#### @NonNull

加入类似断言的保护机制，在代码一定不能为空的地方加入此注解。

```java
private PageModel<RegResult> search(@NonNull String operator) {
    auditLogMapper.selectList(new LambdaQueryWrapper<>(new AuditLog().setOperator(operator)));
    ....
}
```

上面代码中，如果operator为空则后面的selectList会忽略掉查询条件，把所有记录查询出来。显然不是想要的结果。如果代码上下文中可以保证operator不为空，但为了保证代码的强壮型，加入判空逻辑或简单地加入@NonNull注解。



#### @RequiredArgsConstructor

配合Spring 4.x开始推荐使用的构造器注入代替@Autowired 可以让代码变得更简洁。

```java
@Component
@RequiredArgsConstructor  // final 属性会自动加在构造器中
@Slf4j
public class UserRegServiceImpl implements UserRegService {
    // 需要注入的对象加final
    private final GeneralMessageService generalMessageService;
    private final AuditLogMapper auditLogMapper;
    private final CompanyService cifCompanyService;
    private final com.qjdchina.ofs.service.CompanyService ofsCompanyService;
    ....
}
```

#### @Data

@Getter/@Setter

@ToString

@EqualsAndHashCode

@Value

@Builder

#### @Log

生成static的log对象

private static final Logger *log* = LoggerFactory.*getLogger*(**XXXX.class**);

减少拷贝粘贴上述模板代码的时候忘记修改XXXX.class部分。

#### @Cleanup

比try with resource减少一层嵌套

```java
public void search() throws IOException {
	@Cleanup
	InputStream in = new FileInputStream("filepath");
	in.read();
	...
}
```

## 

## 依赖注入

依赖注入方式建议使用构造器注入的方式（有多个候选Bean的时候使用Qualifier限定）

### dubbo

@DubboReference注入



# 七、工具支持

# 配置规范



# 一、治理方案

### 1. 约定优先

按照COC（Convention Over Configuration）约定优先的思路，减少配置的灵活性以换取配置的统一化和简洁性。例如：每个应用需要定义一个app.id 这个值，会用在apollo中对应的应用名称，以及dubbo应用名称，日志文件名等需要对应用进行隔离的地方。更多的约定

### 2. 关注点分离

把应用开发人员需要关注的配置和运维人员需要关注的配置进行分离。新建一套环境时，运维人员只要把运维相关的配置文件中跟中间件，账号等相关的配置进行修改。开发人员则只需要关系应用的配置，不需要关心环境差异部分导致的配置修改。



开发人员需要关注的配置：

1）template.* 按照最佳实践配置（基础架构组）

2）服务application.properties配置每个应用固定的配置 （应用开发人员）

3）apollo对应应用的application配置 （应用开发人员）

运维人员需要关注的配置：

1）common.env 不同环境需要区分的公共配置

2）common.mysql 等不同环境按照用途划分的配置

### 3. 资源声明

开发人员需要某个资源（例如：数据库，redis等）时，只需要用声明的方式指定资源名称，而不需要知道具体怎样初始化这些资源。

例如：某个应用需要连接数据库ams和udc时，只需要声明application.datasources=ams,udc

则系统会根据约定初始化2个数据库连接池，并按照约定加上Qualifier以便程序引用。

运维人员则按照约定的方式，给ams和udc两个数据库分配ip，端口，用户名，密码等。

### 4. 统一模板

数据库连接池，redis，mongodb等会参考最佳实践统一用一套模板进行配置，避免差异化带来的不可预期的问题。

### 5. 隔离变化

每个应用不变的配置应该放在application.properties中，变化的部分放到apollo应用的配置中。

apollo中存放的应用级别的配置主要有：

1. 不同业务环境导致的不同配置。例如：某个特殊业务的账户ID，业务通知邮箱等
2. 功能开关

### 6. 配置加密

Apollo上账号密码相关的敏感信息使用jasypt进行加密，从Apollo读取配置初始化Bean的时候，会自动解密。Apollo上加密的配置可以用ENC(xxxxx)表示，xxxxx为加密后的内容。例如：

datasource_bigfrog_host = ENC(ihY012m8B72bG6JcCu/+EG/FUFFnFXX919D2D4tiDzE=)

配置加密工具可以参考 git@gitlab.qjdchina.com:zhaofeng/demo.git 中的tool/pwgen.sh



参考：https://github.com/ulisesbocchio/jasypt-spring-boot

涉及到强加密算法需要运维人员修改jdk基础镜像

https://www.oracle.com/java/technologies/javase-jce8-downloads.html



### 7. 配置审核

1）应用中的application.properties作为代码管理，保存环境无关的配置，在代码提交的时候通过MergeRequest跟代码一起做审核。

2）apollo上新增配置的时候，需要走以下审核流程。

开发人员发起->项目Owner审核->运维审核

3）运维人员根据申请的配置维护环境相关的公共配置，例如增加新的数据源等。



# 二、配置步骤

### pom修改

原父pom使用spring-boot-starter-parent的地方修改成以下父pom

```xml
    <parent>
        <groupId>com.qjdchina.common</groupId>
        <artifactId>qjd-spring-boot-starter-parent</artifactId>
        <version>1.0.5</version>
        <relativePath/>
    </parent>
```

### 基础配置

application.properties中维护跟环境无关的应用级别配置，跟具体环境相关的应用级别的配置需要放到apollo配置中心对应的应用下

```plain
# 每个应用需要定义一个应用ID
# 1) 告诉apollo读取哪个应用的配置
# 2) 被其他需要区分应用的配置中引用
app.id = customer
```

### dubbo

引入qjd-spring-boot-starter-dubbo统一dubbo的版本为2.7.3以及zk和curator版本

```xml
<dependency>
    <groupId>com.qjdchina.common</groupId>
    <artifactId>qjd-spring-boot-starter-dubbo</artifactId>
</dependency>
```

启动类上加上@EnableDubbo

```java
@SpringBootApplication
@EnableDubbo
public class DemoApplication {
    public static void main(String[] args) {
        SpringApplication.run(DemoApplication.class, args);
    }
}
```



### DataSource

数据库连接池统一成druid，pom.xml中增加以下依赖

```xml
<dependency>
    <groupId>com.qjdchina.common</groupId>
    <artifactId>qjd-spring-boot-starter-druid</artifactId>
</dependency>
# application.properties
# 声明需要用到的数据库，第一个为primary数据源
application.databases=customer,bigfrog
```

以上配置会生成2个DataSource，bean的名字分别为dataSource_customer和dataSource_bigfrog，并且会生成一个Primary代理数据源作为dataSource_customer的包装，交给spring-boot默认数据源初始化处理。

运维人员在apollo的common.mysql给每个数据库增加以下配置

```plain
datasource_bigfrog_host = 10.1.1.122
datasource_bigfrog_port = 3306
datasource_bigfrog_name = bigfrog
datasource_bigfrog_username = xxxxx
datasource_bigfrog_password = yyyyy

datasource_customer_host = 10.1.1.122
datasource_customer_port = 3306
datasource_customer_name = customer
datasource_customer_username = xxxxx
datasource_customer_password = yyyyy
```

### xxl-job

xxl-job用的是2.0.2版本（需要跟运维部署的xxl的服务端版本匹配）

```xml
<dependency>
    <groupId>com.qjdchina.common</groupId>
    <artifactId>qjd-spring-boot-starter-xxl-job</artifactId>
</dependency>
```

读取了common.env中以下的公共配置，应用无需修改，只需要引入common.env即可。注意执行器的名称是${app.id}-executor  （不做环境隔离，每个环境会配置一个xxl-admin）

```plain
# xxl-job配置
xxl.job.executor.appname = ${app.id}-executor
xxl.job.admin.addresses = http://10.1.1.143:8888/xxl-job-admin/
xxl.job.executor.port = 22884
xxl.job.accessToken = qjd123456
xxl.job.executor.logpath = /srv/logs/xxl-job/jobhandler/${app.id}
xxl.job.executor.logretentiondays = 15
```

如果原先已经引入了xxljob的jar包，并做了配置，请先删除。

原先在xxl-job-admin中配置的执行器名称没有按照约定的情况下，请修改执行器名字。

### activemq

加入ActiveMQ的依赖包

```xml
<dependency>
    <groupId>com.qjdchina.common</groupId>
    <artifactId>qjd-spring-boot-starter-activemq</artifactId>
</dependency>
```

会根据common.activemq配置创建ConnectionFactory。同时创建JmsHelper等帮助类。同时starter会引入common.queue的配置，消息发送方和监听方可以直接引用队列相关的key。

```java
发送消息和监听消息的应用使用common.queue中定义的key

// 注入队列名称
@Value("${queue.ClmsOrderCreated}")
private String queueName;

...  {
   // 发送消息
   jmsHelper.sendQueue(queueName, "message");
}
```



### mongodb

1）加入starter依赖

```xml
<dependency>
    <groupId>com.qjdchina.common</groupId>
    <artifactId>qjd-spring-boot-starter-mongodb</artifactId>
</dependency>
```

2）application.properties

```plain
# 声明需要连接的数据库名
application.mongodb=account
```

原理：

starter会根据上述声明生成一个配置项：spring.data.mongodb.uri=${mongodb_account_uri}

运维在common.mongodb中按照约定给名叫account的mongodb配置以下内容

mongodb_account_uri = mongodb://<user>:<passwd>@<host>:<port>/<db>?authDb=xx

这样就能用spring-boot-starter-data-mongodb约定的方式初始化MongoTemplate等对象



### redis

加入redis相关starter即可使用StringRedisTemplate等spring官方的redis-starter相关组件

```xml
<dependency>
    <groupId>com.qjdchina.common</groupId>
    <artifactId>qjd-spring-boot-starter-redis</artifactId>
</dependency>
```

运维人员在common.redis中按照使用场景加入对应的配置，上述starter引用的是redis_common*相关配置

```plain
# 根据使用redis的场景，运维会提供以下配置
redis_common_host = 10.1.1.143
redis_common_port = 6379
redis_common_password = qjd123456
redis_common_maxIdle = 5
redis_common_database = 0

redis_shiro_host = 10.1.1.143
redis_shiro_port = 6379
redis_shiro_password = qjd123456
redis_shiro_maxIdle = 5
redis_shiro_database = 3

redis_lock_host = 10.1.1.143
redis_lock_port = 6379
redis_lock_password = qjd123456
redis_lock_maxIdle = 5
redis_lock_database = 5

1. common给通用的数据缓存等场景用
2. shiro用于分布式缓存
3. lock用于分布式锁
```

### 

### ldap

引入starter，自动创建LdapTemplate

```xml
<dependency>
    <groupId>com.qjdchina.common</groupId>
    <artifactId>qjd-spring-boot-starter-ldap</artifactId>
</dependency>
```

## 三、其他

### 相关约定

| **约定**                                 | **说明**                                                     |
| ---------------------------------------- | ------------------------------------------------------------ |
| 每个环境定义一个cluster.id               | 用于区分url等不同环境成套出现的配置例如：cluster.id=qa5则系统的url可以用以下方式按照模板配置qa5.qjdchina.comqa5smoke.qjdchina.comqa5boss.qjdchina.com |
| 每个应用都需要定义一个app.id             | app.id会被用到以下几个地方apollo的应用iddubbo的应用名称日志文件中带的应用名 |
| 统一dubbo服务提供者和消费者的版本号      | dubbo.provider.version = ${cluster.id}dubbo.consumer.version = ${cluster.id} |
| 资源相关配置命名规则                     | 命名规则：资源类型_逻辑名_配置项例如数据库配置datasource_ofs_urldatasource_ofs_usernameredis.shiro.host运维人员按照这个约定配置相关资源的属性，开发人员按照这个约定引用资源相关的配置。 |
| 消息队列名称在公共配置common.queue中定义 | queue的命名规则为queue.<队列名> = <队列名>topic命名规则为topic.<主题名> = <主题名>也就是queue和topic配置的key为名称加上固定的前缀，这样做的好处是：生产者和消费者引用公共的配置可保持一致统一命名规则避免名称冲突（相同Key不能在apollo上保存） |
| 各个应用通过starter项目引入必要的组件    | starter项目地址git@gitlab.qjdchina.com:zhaofeng/qjd-common.git目前有：activemq，druid，dubbo，redis，xxl-job等starter项目会按照约定从apollo引入必要的配置，应用不需要关心组件的初始化过程。组件具体引用的配置项可参考starter项目源码和apollo配置模板。应用可在application级别定义同名的配置Key覆写组件的默认配置。 |
| apollo默认配置                           | apollo.bootstrap.enabled=true#在日志初始化之前加载配置apollo.bootstrap.eagerLoad.enabled=true#默认加载application和公共环境变量apollo.bootstrap.namespaces=application,common.env |
| 配置优先级                               | 配置了相同key的时候，配置优先级顺序从高到低如下Apollo Bootstrap配置applicationcommon.env应用程序配置application.properties组件配置common.*template.* |

### 本地调试



方式1

本方案中间件都从apollo读取配置，跟apollo强关联。当没有apollo服务器需要本地调试的时候可以在

/opt/settings/server.properties 中配置env=Local

（注意：本地调试后别忘记改回来，不然获取不到最新配置）

配置后，启动会打印消息 ==== Apollo is in local mode! Won't pull configs from remote server

apollo客户端不从服务端拉取配置，而是读取本地的配置缓存。

具体可以参考 [apollo的使用文档](https://www.apolloconfig.com/#/zh/usage/java-sdk-user-guide?id=五、本地开发模式) 中5.2.2 本地配置文件章节



方式2

application.properties中定义

\#关闭apollo

apollo.bootstrap.enabled=false

按照配置规约把对应的配置拷贝到application.properties例如数据眼配置

datasource_bigfrog_host = 10.1.1.122

datasource_bigfrog_port = 3306

datasource_bigfrog_name = bigfrog

datasource_bigfrog_username = xxxxx

datasource_bigfrog_password = yyyyy



### 查看中间件依赖

需要查看例如有哪些工程在使用redis，只需要看apollo的redis配置有哪些应用在读取

![img](https://cdn.nlark.com/yuque/0/2021/png/102749/1628597071226-800a51ea-f633-4c1b-bd88-04aa322fcac9.png)

### demo

以下工程有各个starter的使用demo

https://gitlab.qjdchina.com/zhaofeng/demo



若有收获，就点个赞吧

# Rest接口规范

## 

## 一、报文格式

### 1. 请求报文

#### 查询

| 请求方法 | GET       |                                                              |
| -------- | --------- | ------------------------------------------------------------ |
| 参数传递 | Query参数 | 传递的参数需要用UTF-8进行URLEncoding注意：Query参数有长度限制，具体长度和浏览器，服务器类型有关，以不超过2048字节为宜。因此，尽量避免设计批量传递ID查询的接口。**分页查询参数使用固定的字段名**pageSize：页大小pageNo：需要获取的页 |
| 消息体   | 不允许    | 浏览器不会禁止GET请求传递消息体，但HTTP协议上不允许，有些服务器会报错。 |



#### 创建/修改/删除

| 请求方法 | POST         |                                                              |
| -------- | ------------ | ------------------------------------------------------------ |
| 请求头   | Content-Type | application/json;charset=UTF-8                               |
| 消息体   | JSON格式     | JSON可以是Object，Array，Boolean，String等符合JSON规范的所有格式。但为了代码实现层面的统一，限定消息体只能传递Object格式的JSON消息，因此需要传递数组对象的时候，应该用Object进行包装。例如：// 正确{  "params": [1, 2, 3]}// 错误[1,2,3] |

#### 文件上传

文件上传使用POST方式+multipart/form格式上传文件到统一的文件服务器，上传成功后文件服务器会返回一个文件Key，后续可以把这个Key传递给其他需要文件上传的业务。

| 请求方法 | POST           |                     |
| -------- | -------------- | ------------------- |
| 请求头   | Content-Type   | multipart/form-data |
| 消息体   | 文件等表单参数 |                     |



### 2. 响应报文

1. 状态码：服务器响应200的时候，消息体为JSON格式，并带有约定的字段。**200以外的情况，消息体格式不能保证是JSON格式**（例如503等情况，后端服务不能控制返回报文的格式）
2. Content-Type: application/json;charset=UTF-8
3. 消息体（JSON）

```json
{
  "code": "0",
  "message": "成功",
  "traceId": "xxxxxxx", // 扩展字段
  "data": {
    "id": 1,
    "name": "Jim Green"
  }
}
```

字段说明：

code：响应编码，"0"表示业务操作成功，"0"以外表示操作失败，客户端可以提示错误信息。

某些特定的code可以做特殊处理，例如前后端约定一个表示未登录的错误码，前端可以根据该错误码跳转到登录页面。

message：错误码对应的错误提示消息。注意：该消息字段是展示可客户看的，因此不要传递代码实现层面的错误消息。开发人员因根据错误码+错误日志进行错误分类，也可以返回traceId等扩展字段来辅助错误排查。

data：业务消息体。统一为Object类型的JSON格式（除非系统间交互要求报文加密，则data字段可以使加密有的报文，并加入扩展字段指定加密格式）

### 3. 分页模型

返回分页数据：

- totalCount：总条数
- pageSize：页大小
- pageNo：当前页号
- pagedRecords：当前页记录

示例报文

```json
{
  "code": "0",
  "message": "成功",
  "data": {
    "totalCount": 100,
    "pageSize": 10,
    "pageNo": 1,
    "pagedRecords": [1,2,3,4...]
  }
}
```

### 4. 日期处理

因JSON中没有时间类型，因此前后端交互的时候需要对时间格式有一个统一的约定。

日期格式统一为"yyyy-MM-dd HH:mm:ss" 如果前端只需要显示年月日，则根据需要去掉时分秒。



### 5. 数字处理

前端应尽量避免对数字的处理（浮点数计算等）避免精度丢失，涉及到计算的字段应由后端计算后返回给前端显示。id等字段如果是long类型，应该转成字符串类型，否则前端获取到的内容回丢失精度（后面几位有可能变0）

### 6. 空值处理

1. 字段值为空的时候，应该保留字段的key。
2. 字段允许为null，前端应该兼容以下的空值情况（兼容老的接口）

| 字段类型 | 可能空值         | 说明                                                    |
| -------- | ---------------- | ------------------------------------------------------- |
| 数值     | null             | 数字的0和null有区分，null一般表示没有输入，值未定的情况 |
| 字符串   | null空字符串("") | 返回null的时候应显示空白                                |
| 对象     | null             | 应避免返回空对象{}                                      |
| 数组     | null[]           | 返回null或者[] 前端应该有相同的行为                     |
| 日期     | null""           | 返回null的时候应显示空白                                |

### 7. 命名规范

接口字段命名采用小写字母开头的“驼峰命名”方式，并使用有意义的英文单词组合，避免使用拼音缩写等没有明确含义的字母组合。

## 二、接口发布

后端统一使用Swagger发布接口，使用方式如下：

1. 在pom文件中引入swagger相关jar包knife4j-spring-boot-starter

```xml
        <dependency>
            <groupId>com.github.xiaoymin</groupId>
            <artifactId>knife4j-spring-boot-starter</artifactId>
	          <version>3.0.3</version>
        </dependency>
```

1. 配置和使用

```java
// 配置Swagger
@Configuration
@ConditionalOnProperty(value = "swagger-ui.enabled", havingValue = "true") // ①
public class SwaggerConfigurer {

    private ApiInfo apiInfo() {
        return new ApiInfoBuilder()
                .title("供应链API文档")
                .description("接口文档")
                .termsOfServiceUrl("https://www.qjdchina.com/order-server/doc.html")
                .contact(new Contact("仟金顶网络科技有限公司", "https://www.qjdchina.com", "developer@qjdchina.com"))
                .version("1.0.0")
                .build();
    }

    @Bean
    public Docket api() { // ②
        return new Docket(DocumentationType.SWAGGER_2)
                .apiInfo(apiInfo())
                .protocols(Sets.newHashSet("https", "http"))
                .select()
                .apis(RequestHandlerSelectors.basePackage("com.qjdchina.scm"))
                .paths(PathSelectors.any())
                .build().groupName("订单");
    }
}

// 定义API
@RestController
@RequestMapping("/supplierDeliveryNote")
@Api(tags = "亚士订单") // ③
public class SupplierDeliveryNoteController {

    @Resource
    private ISupplierDeliveryNoteService supplierDeliveryNoteService;


    @ApiOperation(value = "分页查询厂家发货明细")  // ④
    @GetMapping("/page")
    public RestBody<PageModel<SupplierDeliveryNoteVO>> page(@RequestBody QueryDeliveryNoteDto queryDeliveryNoteDto){

        PageModel<SupplierDeliveryNoteVO> page = supplierDeliveryNoteService.page(queryDeliveryNoteDto);

        return RestBody.OK(page);
    }
}
```

① 使用swagger-ui.enabled配置来确定是否开启swagger，线上环境统一设置成false不开启swagger。

② 定义一个或多个Doclet，每个Docklet需要指定扫描哪些包。

③④ 定义API



以上是swagger的最简使用说明，具体注解的使用方式请参考swagger文档

## 分支模型



Git代码仓库的分支可分为普通分支和受控分支两个大类。



### 1. 普通分支

普通分支是开发人员可以根据其他分支自由创建和删除的分支。主要有2类

#### a. 特性分支

开发某个新功能时，需要从最新的master分支创建一个新的分支，命名规范feature/xxxx

思考：为什么需要通过master拉特性分支

其中xxxx代表某个功能，新功能从开发到上线需要的操作如下：



\1) 创建分支

```bash
# 先拉取最新远程分支
git fetch --all
# 从master创建新的特性分支
git checkout origin/master -b feature/xxxx
```

\2) 开发完成后合并到develop分支

```bash
# 切换到develop分支
git checkout develop
# 拉取最新内容
git pull
# 合并到develop分支，使用--no-ff选项
git merge --no-ff feature/xxxx
# 推送到远程分支（实际需要通过提MergeRequest的方式合并）
git push
```

\3) 合并到test分支

```bash
# 切换到test分支
git checkout test
# 拉取最新内容
git pull
# 合并到test分支，使用--no-ff选项
git merge --no-ff feature/xxxx
# 推送到远程分支（实际需要通过提MergeRequest的方式合并）
git push
```

\4) 合并到release分支

```bash
# 切换到release分支
git checkout release
# 拉取最新内容
git pull
# 合并到release分支，使用--no-ff选项
git merge --no-ff feature/xxxx
# 推送到远程分支（实际需要通过提MergeRequest的方式合并）
git push
```

注意：合并到release分支号，需要把依赖Jar包中SNAPSHOT版本改成正式版

#### 

#### b. 热修复分支



热修复分支用于发现线上的bug后进行紧急修复和上线



 操作流程:





\1) 创建分支

```bash
# 先拉取最新远程分支
git fetch --all
# 从master创建新的热修复分支
git checkout origin/master -b hotfix/xxxx
```



\2) 修复代码后合并到master分支

```bash
# 切换到master分支
git checkout master
# 拉取最新内容
git pull
# 合并到master分支，使用--no-ff选项
git merge --no-ff hotfix/xxxx
# 推送到远程分支（实际需要通过提MergeRequest的方式合并）
git push
```

\3) 合并到develop分支

```bash
# 切换到develop分支
git checkout develop
# 拉取最新内容
git pull
# 合并到develop分支，使用--no-ff选项
git merge --no-ff hotfix/xxxx
# 推送到远程分支
git push
```



\4) 合并到test分支

```bash
# 切换到test分支
git checkout test
# 拉取最新内容
git pull
# 合并到test分支，使用--no-ff选项
git merge --no-ff hotfix/xxxx
# 推送到远程分支（实际需要通过提MergeRequest的方式合并）
git push
```



\5) 合并到release分支

```bash
# 切换到release分支
git checkout release
# 拉取最新内容
git pull
# 合并到release分支，使用--no-ff选项
git merge --no-ff hotfix/xxxx
# 推送到远程分支（实际需要通过提MergeRequest的方式合并）
git push
```





### 2. 受控分支



受控分支是服务于开发流程的特殊分支，开发人员不能随意创建和删除，从“上游”到“下游”依次为

develop->test->release->master 上游拥有最新的代码，下游拥有最稳定的代码

其中develop，test，release三个分支合并代码的时候需要提MergeRequest（--no-ff选项让提交历史变得清晰，也可以在MergeRequest进行Review） release合并到master用fast-forward（2个分支的提交历史保持一致，可以用工具自动合并）



#### 1）develop

开发分支，对应开发环境。集合了所有最新开发中的新特性。

#### 2）test

测试分支，对应测环境。开发完成自测之后进行提测，把需要交给测试的特性分支合并到test分支。

#### 3）release

测试通过后的特性需要发布到预发环境进行验证，则需要把特性分支合并到release分支。



**其他方案**

1）release分支根据上线日期创建(例如 release20210730)

2）预发环境根据最近需要上线的release<日期> 分支发布 

3）预发验证完成之后，把release<日期> 分支发布到线上环境

4）合并release<日期>分支内容到master分支

5）其他所有待发布的分支合并最新master分支代码进行验证



好处

1. 不需要维护固定的release分支，不能按原计划上线的内容不用手动从release分支撤销
2. 可并行存在多个release<日期>分支，预发环境在多个分支间切换比较简单

难点

1. 预发环境发布非固定的分支需要有运维工具支持
2. 需要有机制确保发布的release分支合并了最新的代码

#### 4）master

release分支验证完成后合并到master分支进行上线。



小结：

1）无论是创建特性分支还是热修复分支，都从最新的master分支拉取，避免混入本次修改以外的内容。

2）热修复分支在经过测试之后直接合并master（不通过release分支合并，避免混入未完全测试的内容）



## 特别注意

1）不要直接用上游分支合并到下游分支：例如develop合并test，test合并release的操作需要禁止！

​    只能从特性分支，热修复分支去合并develop，test，release等分支。

2）不要把master以外的分支往自己的分支上合并。例如把develop分支合并到自己的分支上的话，上线的时候把自己分支往release合并的时候就带上了develop分支的内容。

| **版本号** | **更新日期** | **备注**                                                     |
| ---------- | ------------ | ------------------------------------------------------------ |
| 1.0        | 2021.4.24    | 参考[值得收藏的SQL规范](https://www.yuque.com/zhangyi-fmoxc/gw9qrv/ht9u52) |
| 2.0        | 2021.9.15    | DBA定制的规范                                                |
| 2.1        | 2021.9.28    | 新增NOT NULL处理规范                                         |

 

## 一、DDL规范

【强制】创建表或者新增列时，这列不为空(NOT NULL)

【强制】创建表或者新增列时，NOT NULL的字段不设置默认值，默认值需在代码中明确设置。

如果老业务新增了NOT NULL的字段，考虑到上线过程有新老代码并存运行的时间，需要先去掉NOT NULL的限制。等新代码上线成功后，补齐老代码产生的NULL数据，再补上NOT NULL的限制。

【强制】创建或者新增列时，此列需要添加注释

【强制】创建表时需要添加主键及索引

【强制】表名字段名禁用关键字show, index, select，order等

【强制】索引命名规范二级索引:idx_ 开头  唯一索引:uniq_ 开头

【强制】所有表需要有is_deleted字段标识记录是否删除，不允许使用物理删除

【强制】创建表需要添加创建时间(ins_datetime)和修改时间(upd_datetime)两个字段，可以默认值CURRENT_TIMESTAMP和ON UPDATE CURRENT_TIMESTAMP来填充

ins_datetime和upd_datetime是数据库层面给大数据用于同步数据的依据，由数据库自动维护

业务用的时间字段gmt_created和gmt_modified保持不变。Mapper文件中应不出现ins_datetime和upd_datetime这2个自动维护的字段

【强制】时间日期字段类型使用timestamp，业务时间字段默认值使用'1970-01-01 08:00:00'

【强制】使用text、blob等大字段需要跟DBA或架构师确认，存储过长的字符串类型需独立出来一张表，用主键来对应，避免影响其它字段索引效率

【强制】禁用使用数据库自身的功能如：外键，定时任务(event)，触发器，存储过程，视图

【建议】表主键建议默认自增步长为 1，类型为 unsigned bigint

【建议】合利使用单键和复合索引，控制单表索引数量

【强制】不能删除字段，避免下游大数据问题

## 二、索引规范

【强制】索引默认类型都是B-TREE

【强制】禁止不使用索引直接使用 not in、like '%key%'、 <> 、 != 这些写法，引起索引失效

【强制】对于需要有唯一特性的字段，即使在应用层做了校验，也必须建立唯一索引

【建议】对于count和group场景，请使用覆盖索引覆盖，提高查询性能

【建议】禁止在where条件后的字段加上函数做转换或运算后进行比较，在有些条件下这样会引起索引失效

【建议】索引设计，尽量使用复合索引，并将区别度高的字段放在前面，以降低索引数量



语句部分及其它：

【强制】update语句必须有条件字段，且条件字段列表中必须有一个字段有索引

【强制】统一采用Innodb存储引擎，字符集类默认设置为UTF-8

【强制】业务中禁止使用select *

【强制】禁止对纯select语句开启事务(select for update 需要跟DBA确认)，禁止出现where 1=1这样的语句

【强制】在使用创建时间排序的地方使用 order by id desc 代替  order by 创建时间 desc，适用于ID递增的场景

【强制】禁止跨库join链接，尽量采用反范式化设计来避免join连接

【强制】所有单表行数超过2000万行的表，容量超过50G的表都要考虑用到进行分库分表，拆分规则遵循先通过业务分析进行垂直拆分的方式，然后再进行水平拆分

【强制】超过两个表禁止join，需要join的字段，数据类型必须绝对一致，两表关联时保证用小表驱动大表的方式进行，尽量使用inner join的方式

【强制】多维度查询和多字段模糊查询，请使用es引擎来解决

【强制】禁止使用OR操作，必须改为union all操作，避免索引失效

| **版本号** | **更新日期** | **备注**                     |
| ---------- | ------------ | ---------------------------- |
| 0.9        | 2020.11.9    | 参考阿里巴巴Java编码规约定制 |
| 1.0        | 2020.12.3    | 格式整理索引编排             |

 

## 一、编程规约

### (一) 命名风格

\1. 【强制】代码中的命名均不能以下划线或美元符号开始，也不能以下划线或美元符号结束。 

​      反例：_name /   _name / $Object / name_ / name$ / Object$

\2. 【强制】代码中的命名严禁使用拼音与英文混合的方式，更不允许直接使用中文的方式。

​     正确的英文拼写和语法可以让阅读者易于理解，避免歧义。注意，即使纯拼音命名方式 也要避免采用。

​      正例：alibaba / taobao / youku / hangzhou等国际通用的名称，可视同英文。 

​      反例：DaZhePromotion ［打折］/ getPingfenByName()［评分］/ int 某变量=3

\3. 【强制】类名使用UpperCamelCase风格，必须遵从驼峰形式

​      正例：MarcoPolo / UserDO / XmlService / TcpUdpDeal / TaPromotion

​      反例：macroPolo / UserDo / XMLService / TCPUDPDeal / TAPromotion

\4. 【强制】方法名、参数名、成员变量、局部变量都统一使用lowerCamelCase风格，必须遵从 驼峰形式。

​      正例： localValue / getHttpMessage()  / inputUserId

\5. 【强制】常量命名全部大写，单词间用下划线隔开，力求语义表达完整清楚，不要嫌名字长。 

​      正例：MAX_STOCK_COUNT

​      反例：MAX_COUNT

\6. 【强制】抽象类命名使用Abstract或Base开头；异常类命名使用Exception结尾；测试类 命名以它要测试的类的名称开始，以Test结尾。

\7. 【强制】中括号是数组类型的一部分，数组定义如下：String口 args;

​      反例：使用String args［］的方式来定义。

\8. 【强制】POJO类中布尔类型的变量，都不要加is,否则部分框架解析会引起序列化错误。 

​      反例：定义为基本数据类型Boolean isDeleted；的属性，它的方法也是isDeleted()， RPC 框架在反向解析的时候，“以为”对应的属性名称是deleted,导致属性获取不到，进而抛出异 常。

\9. 【强制】包名统一使用小写，点分隔符之间有且仅有一个自然语义的英语单词。包名统一使用 单数形式，但是类名如果有复数含义，类名可以使用复数形式。

​      正例：应用工具类包名为com.alibaba.open.util、类名为MessageUtils （此规则参考 spring的框架结构）

\10. 【强制】杜绝完全不规范的缩写，避免望文不知义。

​      反例：Abstractclass"缩写”命名成AbsClass； condition “缩写”命名成condi，此类随 意缩写严重降低了代码的可阅读性。

\11. 【推荐】为了达到代码自解释的目标，任何自定义编程元素在命名时，使用尽量完整的单词 组合来表达其意。

​      正例：从远程仓库拉取代码的类命名为**PullCodeFromRemoteRepository**o

​      反例：变量**int a;**的随意命名方式。

\12. 【推荐】如果模块、接口、类、方法使用了设计模式，在命名时体现出具体模式。

​      说明：将设计模式体现在名字中，有利于阅读者快速理解架构设计理念。

​      正例：public class OrderFactory;

​               public class LoginProxy; 

​               public class ResourceObserver;

\13. 【推荐】接口类中的方法和属性不要加任何修饰符号（public也不要加），保持代码的简洁 性，并加上有效的Javadoc注释。尽量不要在接口里定义变量，如果一定要定义变量，肯定是 与接口方法相关，并且是整个应用的基础常量。

正例：接口方法签名：void f（）;

​                  接口基础常量表示：String COMPANY = "alibaba";

反例：接 口方法定义：public abstract void f（）;

说明：JDK8中接口允许有默认实现，那么这个default方法，是对所有实现类都有价值的默 认实现。

\14. 接口和实现类的命名有两套规则：

1） 【强制】对于Service和DAO类，基于SOA的理念，暴露出来的服务一定是接口，内部 的实现类用Impl的后缀与接口区别。

正例：CacheServiceImpl 实现 CacheService 接口。

2） 【推荐】如果是形容能力的接口名称，取对应的形容词做接口名（通常是-able的形式）。 正例：AbstractTranslator 实现 Translatable。

\15.  【参考】枚举类名建议带上Enum后缀，枚举成员名称需要全大写，单词间用下划线隔开。 说明：枚举其实就是特殊的常量类，且构造方法被默认强制是私有。

正例：枚举名字为 ProcessStatusEnum 的成员名称：SUCCESS / UNKOWN_REASON。

\16.  【参考】各层命名规约：

​       A） Service/DAO层方法命名规约

​         1） 获取单个对象的方法用get做前缀。

​         2） 获取多个对象的方法用list做前缀。

​         3） 获取统计值的方法用count做前缀。

​         4） 插入的方法用save/insert做前缀。

​         5） 删除的方法用remove/delete做前缀。

​         6） 修改的方法用update做前缀。

​      B） 领域模型命名规约

​         1） 数据对象：xxxDO, xxx即为数据表名。

​         2） 数据传输对象：xxxDTO，xxx为业务领域相关的名称。

​         3） 展示对象：xxxVO，xxx 一般为网页名称。

​         4） POJO是DO/DTO/BO/VO的统称，禁止命名成xxxPOJO。

### (二）常量定义

\1.  【强制】不允许任何魔法值（即未经定义的常量）直接出现在代码中。

反例：String key = "Id#taobao_" + tradeId;

cache.put（key, value）;

\2. 【强制】long或者Long初始赋值时，使用大写的L,不能是小写的l,小写容易跟数字1混 淆，造成误解。

说明：Long a = 2l;写的是数字的21,还是Long型的2?

\3.  【推荐】不要使用一个常量类维护所有常量，按常量功能进行归类，分开维护。

说明：大而全的常量类，非得使用查找功能才能定位到修改的常量，不利于理解和维护。 正例：缓存相关常量放在类CacheConsts下；系统配置相关常量放在类ConfigConsts下。

\4. 【推荐】常量的复用层次有五层：跨应用共享常量、应用内共享常量、子工程内共享常量、包 内共享常量、类内共享常量。

1）  跨应用共享常量：放置在二方库中，通常是client.jar中的constant目录下。

2）  应用内共享常量：放置在一方库中，通常是modules中的constant目录下。

反例：易懂变量也要统一定义成应用内共享常量，两位攻城师在两个类中分别定义了表示

“是”的变量:

类 A 中：public static final String YES = "yes";

类B 中：public static final String YES = "y";

A.YES.equals（B.YES）,预期是true，但实际返回为false,导致线上问题。

3） 子工程内部共享常量：即在当前子工程的constant目录下。

4） 包内共享常量：即在当前包下单独的constant目录下。

5） 类内共享常量：直接在类内部private static final定义。

\5. 【推荐】如果变量值仅在一个范围内变化，且带有名称之外的延伸属性，定义为枚举类。下面 正例中的数字就是延伸信息，表示星期几。

正例：public Enum { M0NDAY（1）, TUESDAY（2）, WEDNESDAY©）, THURSDAY（4）, FRIDAY（5）, SATURDAY（6）, SUNDAY（7）;}

### (三）代码格式

\1. 【强制】大括号的使用约定。如果是大括号内为空，则简洁地写成{}即可，不需要换行；如果 是非空代码块则：

1） 左大括号前不换行。

2） 左大括号后换行。

3） 右大括号前换行。

4） 右大括号后还有else等代码则不换行；表示终止的右大括号后必须换行。

\2. 【强制】左小括号和字符之间不出现空格；同样，右小括号和字符之间也不出现空格。详见 第5条下方正例提示。

反例：if （空格a == b空格）

\3.  【强制】if/for/while/switch/do等保留字与括号之间都必须加空格。

\4. 【强制】任何二目、三目运算符的左右两边都需要加一个空格。 说明：运算符包括赋值运算符=、逻辑运算符&&、加减乘除符号等。

\5.  【强制】采用4个空格缩进，禁止使用tab字符。

说明：如果使用tab缩进，必须设置1个tab为4个空格。IDEA设置tab为4个空格时， 请勿勾选 Use tab character；而在 eclipse 中，必须勾选 insert spaces for tabs

正例：（涉及1-5点）

public static void main（String[] args） {

//缩进4个空格

String say = "hello";

//运算符的左右必须有一个空格

int flag = 0;

//关键词if与括号之间必须有一个空格，括号内的f与左括号，0与右括号不需要空格

if (flag == 0) (

System.out.println(say);

)

//左大括号前加空格且不换行；左大括号后换行

if (flag == 1) (

System.out.println("world");

//右大括号前换行，右大括号后有else，不用换行

) else ( System.out.println("ok");

//在右大括号后直接结束，则必须换行

)

)

\6.  【强制】注释的双斜线与注释内容之间有且仅有一个空格。

正例：//注释内容，注意在//和注释内容之间有一个空格。

\7.  【强制】单行字符数限制不超过**120**个，超出需要换行，换行时遵循如下原则：

\1) 第二行相对第一行缩进**4**个空格，从第三行开始，不再继续缩进，参考示例。

\2) 运算符与下文一起换行。

\3) 方法调用的点符号与下文一起换行。

\4) 方法调用时，多个参数，需要换行时，在逗号后进行。

\5) 在括号前不要换行，见反例。

正例：

StringBuffer sb = new StringBuffer();

//超过120个字符的情况下，换行缩进4个空格，点号和方法名称一起换行 sb.append("zi").append("xin")...

.append("huang")...

.append("huang")... .append("huang");

反例：

StringBuffer sb = new StringBuffer**。；**

//超过120个字符的情况下，不要在括号前换行 sb.append("zi").append("xin")...append

("huang");

//参数很多的方法调用可能超过120个字符，不要在逗号前换行

method(args1, args2, args3, ... , argsX);

\8.  【强制】方法参数在定义和传入时，多个参数逗号后边必须加空格。

正例：下例中实参的"a",后边必须要有一个空格。

method("a", "b", "c");

\9. 【强制】IDE的text file encoding设置为UTF-8; IDE中文件的换行符使用Unix格式, 不要使用Windows格式。



\10. 【推荐】没有必要增加若干空格来使某一行的字符与上一行对应位置的字符对齐。 正例：

int a = 3;

long b = 4L;

float c = 5F;

StringBuffer sb = new StringBuffer();

说明：增加sb这个变量，如果需要对齐，则给a、b、c都要增加几个空格，在变量比较多的 情况下，是一种累赘的事情。

\11. 【推荐】方法体内的执行语句组、变量的定义语句组、不同的业务逻辑之间或者不同的语义 之间插入一个空行。相同业务逻辑和语义之间不需要插入空行。

说明：没有必要插入多个空行进行隔开。

### (四) OOP规约

\1. 【强制】避免通过一个类的对象引用访问此类的静态变量或静态方法，无谓增加编译器解析成 本，直接用类名来访问即可。

\2.  【强制】所有的覆写方法，必须加©Override注解。

说明：getObject()与get0bject()的问题。一个是字母的O，一个是数字的0，加©Override 可以准确判断是否覆盖成功。另外，如果在抽象类中对方法签名进行修改，其实现类会马上编 译报错。

\3. 【强制】相同参数类型，相同业务含义，才可以使用Java的可变参数，避免使用Object。 说明：可变参数必须放置在参数列表的最后。(提倡同学们尽量不用可变参数编程) 正例： public User getUsers(String type, Integer... ids) {...}

\4. 【强制】外部正在调用或者二方库依赖的接口，不允许修改方法签名，避免对接口调用方产生 影响。接口过时必须加©Deprecated注解，并清晰地说明采用的新接口或者新服务是什么。

\5.  【强制】不能使用过时的类或方法。

说明：java.net.URLDecoder中的方法decode(String encodeStr)这个方法已经过时，应 该使用双参数decode(String source, String encode)。接口提供方既然明确是过时接口， 那么有义务同时提供新的接口；作为调用方来说，有义务去考证过时方法的新实现是什么。

\6. 【强制】Object的equals方法容易抛空指针异常，应使用常量或确定有值的对象来调用 equals。

正例："test”.equals(object);

反例：object.equals( "test");

说明：推荐使用java.util .Objects#equals (JDK7引入的工具类)

\7.  【强制】所有的相同类型的包装类对象之间值的比较，全部使用equals方法比较。

说明：对于Integer var = ? 在-128至127范围内的赋值，Integer对象是在

  禁止用于商业用途，违者必究  **6** /**35**



IntegerCache.cache产生，会复用已有对象，这个区间内的Integer值可以直接使用==进行 判断，但是这个区间之外的所有数据，都会在堆上产生，并不会复用已有对象，这是一个大坑， 推荐使用equals方法进行判断。

\8.  关于基本数据类型与包装数据类型的使用标准如下：

\1)  【强制】所有的POJO类属性必须使用包装数据类型。

\2)  【强制】RPC方法的返回值和参数必须使用包装数据类型。

\3)  【推荐】所有的局部变量使用基本数据类型。

说明：POJO类属性没有初值是提醒使用者在需要使用时，必须自己显式地进行赋值，任何 NPE问题，或者入库检查，都由使用者来保证。

正例：数据库的查询结果可能是null，因为自动拆箱，用基本数据类型接收有NPE风险。 反例：比如显示成交总额涨跌情况，即正负x%, x为基本数据类型，调用的RPC服务，调用 不成功时，返回的是默认值，页面显示为0%,这是不合理的，应该显示成中划线。所以包装 数据类型的null值，能够表示额外的信息，如：远程调用失败，异常退出。

\9.  【强制】定义do/dto/vo等POJO类时，不要设定任何属性默认值

反例：POJO类的gmtCreate默认值为new Date();但是这个属性在数据提取时并没有置入具 体值，在更新其它字段时又附带更新了此字段，导致创建时间被修改成当前时间。

\10. 【强制】序列化类新增属性时，请不要修改serialVersionUID字段，避免反序列失败；如 果完全不兼容升级，避免反序列化混乱，那么请修改serialVersionUID值。

说明：注意serialVersionUID不一致会抛出序列化运行时异常。

\11. 【强制】构造方法里面禁止加入任何业务逻辑，如果有初始化逻辑，请放在init方法中。

\12. 【强制】POJO类必须写toString方法。使用IDE的中工具：source> generate toString 时，如果继承了另一个POJO类，注意在前面加一下super.toString。

说明：在方法执行抛出异常时，可以直接调用POJO的toString()方法打印其属性值，便于排 查问题。

\13. 【推荐】使用索引访问用String的split方法得到的数组时，需做最后一个分隔符后有无 内容的检查，否则会有抛IndexOutOfBoundsException的风险。

说明：

String str = "a,b,c,,";

String口 ary = str.split(",");

//预期大于3,结果是3

System.out.println(ary.length);

\14. 【推荐】当一个类有多个构造方法，或者多个同名方法，这些方法应该按顺序放置在一起， 便于阅读，此条规则优先于第15条规则。

\15. 【推荐】类内方法定义顺序依次是：公有方法或保护方法 > 私有方法> getter/setter

方法。 说明：公有方法是类的调用者和维护者最关心的方法，首屏展示最好；保护方法虽然只是子类 关心，也可能是“模板设计模式”下的核心方法；而私有方法外部一般不需要特别关心，是一个 黑盒实现；因为承载的信息价值较低，所有Service和DAO的getter/setter方法放在类体 最后。

\16. 【推荐】setter方法中，参数名称与类成员变量名称一致，this,成员名=参数名。在 getter/setter方法中，不要增加业务逻辑，增加排查问题的难度。

反例：

public Integer getData（） （

if （true） （

return this.data + 100;

} else （

return this.data - 100;

}

}

\17. 【推荐】循环体内，字符串的连接方式，使用StringBuilder的append方法进行扩展。 说明：反编译出的字节码文件显示每次循环都会new出一个StringBuilder对象，然后进行 append操作，最后通过toString方法返回String对象，造成内存资源浪费。

反例：

String str = "start";

for （int i = 0; i < 100; i+ + ） （

str = str + "hello";

}

\18. 【推荐】final可以声明类、成员变量、方法、以及本地变量，下列情况使用final关键字：

1） 不允许被继承的类，如：String类。

2） 不允许修改引用的域对象，如：POJO类的域变量。

3） 不允许被重写的方法，如：POJO类的setter方法。

4） 不允许运行过程中重新赋值的局部变量。

5） 避免上下文重复使用一个变量，使用final描述可以强制重新定义一个变量，方便更好 地进行重构。

\19. 【推荐】慎用Object的clone方法来拷贝对象。

说明：对象的clone方法默认是浅拷贝，若想实现深拷贝需要重写clone方法实现属性对象 的拷贝。

\20. 【推荐】类成员与方法访问控制从严：

1） 如果不允许外部直接通过new来创建对象，那么构造方法必须是private。

2） 工具类不允许有public或default构造方法。

3） 类非static成员变量并且与子类共享，必须是protected。

4） 类非static成员变量并且仅在本类使用，必须是private。

5） 类static成员变量如果仅在本类使用，必须是private。

\6) 若是static成员变量，必须考虑是否为final。

\7) 类成员方法只供类内部调用，必须是private。

\8) 类成员方法只对继承类公开，那么限制为protectedo

说明：任何类、方法、参数、变量，严控访问范围。过于宽泛的访问范围，不利于模块解耦。 思考：如果是一个private的方法，想删除就删除，可是一个public的service方法，或者 一个public的成员变量，删除一下，不得手心冒点汗吗？变量像自己的小孩，尽量在自己的 视线内，变量作用域太大，无限制的到处跑，那么你会担心的。

### (五) 集合处理

\1.  【强制】关于hashCode和equals的处理，遵循如下规则：

\1)  只要重写equals，就必须重写hashCode。

\2)  因为Set存储的是不重复的对象，依据hashCode和equals进行判断，所以Set存储的 对象必须重写这两个方法。

\3)  如果自定义对象做为Map的键，那么必须重写hashCode和equals。

说明：String重写了 hashCode和equals方法，所以我们可以非常愉快地使用String对象 作为key来使用。

\2. 【强制】ArrayList的subList结果不可强转成ArrayList，否则会抛出ClassCastException 异常，即 java.util.RandomAccessSubList cannot be cast to java.util.ArrayList. 说明：subList返回的是ArrayList的内部类SubList，并不是ArrayList，而是 ArrayList的一个视图，对于SubList子列表的所有操作最终会反映到原列表上。

\3. 【强制】在subList场景中，高度注意对原集合元素个数的修改，会导致子列表的遍历、增加、 删除均会产生 ConcurrentModificationException 异常。

\4. 【强制】使用集合转数组的方法，必须使用集合的toArray(T[] array)，传入的是类型完全 一样的数组，大小就是list.size()。

说明：使用toArray带参方法，入参分配的数组空间不够大时，toArray方法内部将重新分配 内存空间，并返回新数组地址；如果数组元素大于实际所需，下标为[list.size()]的数组 元素将被置为null，其它数组元素保持原值，因此最好将方法入参数组大小定义与集合元素 个数一致。

正例：

List<String> list = new ArrayList<String>(2);

list.add("guan");

list.add("bao");

String[] array = new String[list.size()];

array = list.toArray(array);

反例：直接使用toArray无参方法存在问题，此方法返回值只能是Object[]类，若强转其它 类型数组将出现ClassCastException错误。

\5. 【强制】使用工具类Arrays・asList()把数组转换成集合时，不能使用其修改集合相关的方 法，它的 add/remove/clear 方法会抛出 UnsupportedOperationException 异常。

说明asList的返回对象是一个Arrays内部类，并没有实现集合的修改方法o Arrays.asList 体现的是适配器模式，只是转换接口，后台的数据仍是数组。

String]] str = new String[] ( "you", "wu" );

List list = Arrays.asList(str);

第一种情况：list・add("yangguanbao");运行时异常。

第二种情况：str[0] = "gujin";那么list.get(O)也会随之修改。

\6. 【强制】泛型通配符＜? extends T＞来接收返回的数据，此写法的泛型集合不能使用add方 法，而＜? super T＞不能使用get方法，做为接口调用赋值时易出错。

说明：扩展说一下PECS(Producer Extends Consumer Super)原则：第一、频繁往外读取内 容的，适合用＜? extends T＞。第二、经常往里插入的，适合用＜? super T＞。

\7. 【强制】不要在foreach循环里进行元素的remove/add操作。remove元素请使用Iterator 方式，如果并发操作，需要对Iterator对象加锁。

正例：

Iterator＜String＞ iterator = list.iterator();

while (iterator.hasNext()) (

String item = iterator.next();

if (删除元素的条件){

iterator.remove();

)

)

反例：

List＜String＞ list = new ArrayList＜String＞();

list.add("1");

list.add("2");

for (String item : list) {

if ("T'.equals(item)) { list.remove(item);

)

)

说明：以上代码的执行结果肯定会出乎大家的意料，那么试一下把“T‘换成“2",会是同样的 结果吗？

\8. 【强制】在JDK7版本及以上，Comparator要满足如下三个条件，不然Arrays.sort， Collections .sort 会扌艮 IllegalArgumentException 异常。

说明：三个条件如下

\1) x，y的比较结果和y，x的比较结果相反。

\2)  x>y, y>z,则 x>z。

\3)  x = y,则x, z比较结果和y, z比较结果相同。

反例：下例中没有处理相等的情况，实际使用中可能会出现异常：

new Comparator<Student>() (

©Override

public int compare(Student o1, Student o2)  (

return ol.getId。> o2.getId() ? 1 : T;

}

};

\9.  【推荐】集合初始化时，指定集合初始值大小。

说明：HashMap 使用 HashMap(int initialcapacity)初始化，

正例initialcapacity **=**(需要存储的元素个数/负载因子)+ 1。注意负载因子(即loader factor)默认为0.75,如果暂时无法确定初始值大小，请设置为16 (即默认值)。

反例：HashMap需要放置1024个元素，由于没有设置容量初始大小，随着元素不断增加，容 量**7**次被迫扩大，resize需要重建hash表，严重影响性能。

\10. 【推荐】使用entrySet遍历Map类集合KV,而不是keySet方式进行遍历。

说明：keySet其实是遍历了 2次，一次是转为Iterator对象，另一次是从hashMap中取出 key所对应的value。而entrySet只是遍历了一次就把key和value都放到了 entry中，效 率更高。如果是JDK8，使用Map.foreach方法。

正例：values。返回的是V值集合，是一个list集合对象；keySet()返回的是K值集合，是 一个Set集合对象；entrySet()返回的是K-V值组合集合。

\11. 【推荐】高度注意Map类集合K/V能不能存储null值的情况，如下表格：

| **集合类**        | **Key**      | **Value**    | **Super**   | **说明**             |
| ----------------- | ------------ | ------------ | ----------- | -------------------- |
| Hashtable         | 不允许为null | 不允许为null | Dictionary  | 线程安全             |
| ConcurrentHashMap | 不允许为null | 不允许为null | AbstractMap | 锁分段技术(JDK8:CAS) |
| TreeMap           | 不允许为null | 允许为null   | AbstractMap | 线程不安全           |
| HashMap           | 允许为null   | 允许为null   | AbstractMap | 线程不安全           |

反例：由于HashMap的干扰，很多人认为ConcurrentHashMap是可以置入null值，而事实上, 存储null值时会抛出NPE异常。

\12.  【参考】合理利用好集合的有序性(sort)和稳定性(order),避免集合的无序性(unsort)和 不稳定性(unorder)带来的负面影响。

说明：有序性是指遍历的结果是按某种比较规则依次排列的。稳定性指集合每次遍历的元素次 序是一定的。如：ArrayList 是 order/unsort； HashMap 是 unorder/unsort； TreeSet 是 order/sort。

\13. 【参考】利用Set元素唯一的特性，可以快速对一个集合进行去重操作，避免使用List的 contains方法进行遍历、对比、去重操作。

### (六) 并发处理

\1. 【强制】获取单例对象需要保证线程安全，其中的方法也要保证线程安全。 说明：资源驱动类、工具类、单例工厂类都需要注意。

\2.  【强制】创建线程或线程池时请指定有意义的线程名称，方便出错时回溯。

正例：

public class TimerTaskThread extends Thread (

public TimerTaskThread() ( super.setName("TimerTaskThread");

}

\3.  【强制】线程资源必须通过线程池提供，不允许在应用中自行显式创建线程。

说明：使用线程池的好处是减少在创建和销毁线程上所花的时间以及系统资源的开销，解决资 源不足的问题。如果不使用线程池，有可能造成系统创建大量同类线程而导致消耗完内存或者 “过度切换"的问题。

\4. 【强制】线程池不允许使用Executors去创建，而是通过ThreadPoolExecutor的方式，这样 的处理方式让写的同学更加明确线程池的运行规则，规避资源耗尽的风险。

说明：Executors返回的线程池对象的弊端如下：

**1)** FixedThreadPool 和 SingleThreadPool**：**

允许的请求队列长度为Integer.MAX_VALUE,可能会堆积大量的请求，从而导致00M。

**2)** CachedThreadPool 和 ScheduledThreadPool**：**

允许的创建线程数量为Integer.MAX_VALUE,可能会创建大量的线程，从而导致00M。

\5. 【强制】SimpleDateFormat是线程不安全的类，一般不要定义为static变量，如果定义为 static，必须加锁，或者使用DateUtils工具类。

正例：注意线程安全，使用DateUtils。亦推荐如下处理：

private static final ThreadLocal<DateFormat> df = new ThreadLocal<DateFormat>() (

©Override

protected DateFormat initialValue() ( return new SimpleDateFormat("yyyy-MM-dd");

}

};

说明：如果是JDK8的应用，可以使用Instant代替Date， LocalDateTime代替Calendar， DateTimeFormatter 代替 SimpleDateFormat，官方给出的解释：simple beautiful strong immutable thread-safe。



\6. 【强制】高并发时，同步调用应该去考量锁的性能损耗。能用无锁数据结构，就不要用锁；能 锁区块，就不要锁整个方法体；能用对象锁，就不要用类锁。

说明：尽可能使加锁的代码块工作量尽可能的小，避免在锁代码块中调用**RPC**方法。

\7. 【强制】对多个资源、数据库表、对象同时加锁时，需要保持一致的加锁顺序，否则可能会造 成死锁。

说明：线程一需要对表A、B、C依次全部加锁后才可以进行更新操作，那么线程二的加锁顺序 也必须是A、B、C,否则可能出现死锁。

\8. 【强制】并发修改同一记录时，避免更新丢失，需要加锁。要么在应用层加锁，要么在缓存加 锁，要么在数据库层使用乐观锁，使用version作为更新依据。

说明：如果每次访问冲突概率小于2。%,推荐使用乐观锁，否则使用悲观锁。乐观锁的重试次 数不得小于3次。

\9. 【强制】多线程并行处理定时任务时，Timer运行多个TimeTask时，只要其中之一没有捕获 抛出的异常，其它任务便会自动终止运行，使用ScheduledExecutorService则没有这个问题。

\10. 【推荐】使用CountDownLatch进行异步转同步操作，每个线程退出前必须调用countDown 方法，线程执行代码注意catch异常，确保countDown方法被执行到，避免主线程无法执行 至await方法，直到超时才返回结果。

说明：注意，子线程抛出异常堆栈，不能在主线程try-catch到。

\11. 【推荐】避免Random实例被多线程使用，虽然共享该实例是线程安全的，但会因竞争同一 seed导致的性能下降。

说明：Random实例包括java. util.Random的实例或者Math . random()的方式。

正例：在JDK7之后，可以直接使用API ThreadLocalRandom,而在JDK7之前，需要编码保 证每个线程持有一个实例。

\12. 【推荐】在并发场景下，通过双重检查锁(double-checked locking)实现延迟初始化的优 化问题隐患(可参考 The "Double-Checked Locking is Broken" Declaration)，推荐解 决方案中较为简单一种(适用于JDK5及以上版本)，将目标属性声明为volatile型。

反例：

class Singleton {

private Helper helper = null;

public Helper getHelper() {

if (helper == null) synchronized(this) {

if (helper == null)

helper = new Helper();

}

return helper;

}

// other methods and fields...

}

\13. 【参考】volatile解决多线程内存不可见问题。对于一写多读，是可以解决变量同步问题, 但是如果多写，同样无法解决线程安全问题。如果是count + +操作，使用如下类实现： AtomicInteger count = new AtomicInteger(); count .addAndGet(l);如果是 JDK8，推 荐使用LongAdder对象，比AtomicLong性能更好(减少乐观锁的重试次数)。

\14. 【参考】HashMap在容量不够进行resize时由于高并发可能出现死链，导致CPU飙升，在 开发过程中可以使用其它数据结构或加锁来规避此风险。

\15. 【参考】ThreadLocal无法解决共享对象的更新问题，ThreadLocal对象建议使用static 修饰。这个变量是针对一个线程内所有操作共享的，所以设置为静态变量，所有此类实例共享 此静态变量，也就是说在类第一次被使用时装载，只分配一块存储空间，所有此类的对象(只 要是这个线程内定义的)都可以操控这个变量。

### (七) 控制语句

\1. 【强制】在一个switch块内，每个case要么通过break/return等来终止，要么注释说明程 序将继续执行到哪一个case为止；在一个switch块内，都必须包含一个default语句并且 放在最后，即使它什么代码也没有。

\2. 【强制】在if/else/for/while/do语句中必须使用大括号。即使只有一行代码，避免采用 单行的编码方式：if (condition) statements;

\3.  【推荐】表达异常的分支时，少用if-else方式，这种方式可以改写成：

if (condition) {

return obj;

}

//接着写else的业务逻辑代码；

说明：如果非得使用if()..・else if()..・else.・・方式表达逻辑，【强制】避免后续代码维 护困难，请勿超过3层。

正例：超过3层的if-else的逻辑判断代码可以使用卫语句、策略模式、状态模式等来实现， 其中卫语句示例如下：

public void today() (

if (isBusy()) (

System.out.println(“change time.”)；

return;

}

if (isFree()) (

System.out.println(“go to travel.”)；

return;

System.out.println(“stay at home to learn Alibaba Java Coding Guidelines return;

)

\4. 【推荐】除常用方法(如**getXxx/isXxx**)等外，不要在条件判断中执行其它复杂的语句，将复 杂逻辑判断的结果赋值给一个有意义的布尔变量名，以提高可读性。

说明：很多**if**语句内的逻辑相当复杂，阅读者需要分析条件表达式的最终结果，才能明确什么 样的条件执行什么样的语句，那么，如果阅读者分析逻辑表达式错误呢？ 正例：

//伪代码如下

final boolean existed = (file.open(fileName, "w")   != null) && (...) || (...);

if (existed) {

)

反例：

if ((file.open(fileName, "w")  != null) && (...) || (...)) {

)

\5. 【推荐】循环体中的语句要考量性能，以下操作尽量移至循环体外处理，如定义对象、变量、 获取数据库连接，进行不必要的try-catch操作(这个try-catch是否可以移至循环体外)。

\6.  【推荐】接口入参保护，这种场景常见的是用于做批量操作的接口。

\7.  【参考】下列情形，需要进行参数校验：

\1)  调用频次低的方法。

\2)  执行时间开销很大的方法。此情形中，参数校验时间几乎可以忽略不计，但如果因为参 数错误导致中间执行回退，或者错误，那得不偿失。

\3)  需要极高稳定性和可用性的方法。

\4)  对外提供的开放接口，不管是RPC/API/HTTP接口。

\5)  敏感权限入口。

\8.  【参考】下列情形，不需要进行参数校验：

\1)  极有可能被循环调用的方法。但在方法说明里必须注明外部参数检查要求。

\2)  底层调用频度比较高的方法。毕竟是像纯净水过滤的最后一道，参数错误不太可能到底 层才会暴露问题。一般DAO层与Service层都在同一个应用中，部署在同一台服务器中，所 以DAO的参数校验，可以省略。

\3)  被声明成private只会被自己代码所调用的方法，如果能够确定调用方法的代码传入参 数已经做过检查或者肯定不会有问题，此时可以不校验参数。

### (八) 注释规约

\1. 【强制】类、类属性、类方法的注释必须使用Javadoc规范，使用/**内容*/格式，不得使用 // xxx方式。

说明：在IDE编辑窗口中，Javadoc方式会提示相关注释，生成Javadoc可以正确输出相应注 释；在IDE中，工程调用方法时，不进入方法即可悬浮提示方法、参数、返回值的意义，提高 阅读效率。

\2. 【强制】所有的抽象方法（包括接口中的方法）必须要用Javadoc注释、除了返回值、参数、 异常说明外，还必须指出该方法做什么事情，实现什么功能。

说明：对子类的实现要求，或者调用注意事项，请一并说明。

\3.  【强制】所有的类都必须添加创建者和创建日期。

\4.  【强制】方法内部单行注释，在被注释语句上方另起一行，使用//注释。方法内部多行注释

使用/* */注释，注意与代码对齐。

\5.  【强制】所有的枚举类型字段必须要有注释，说明每个数据项的用途。

\6. 【推荐】与其“半吊子”英文来注释，不如用中文注释把问题说清楚。专有名词与关键字保持 英文原文即可。

反例：“TCP连接超时”解释成“传输控制协议连接超时”，理解反而费脑筋。

\7. 【推荐】代码修改的同时，注释也要进行相应的修改，尤其是参数、返回值、异常、核心逻辑 等的修改。

说明：代码与注释更新不同步，就像路网与导航软件更新不同步一样，如果导航软件严重滞后， 就失去了导航的意义。

\8. 【参考】谨慎注释掉代码。在上方详细说明，而不是简单地注释掉。如果无用，则删除。 说明：代码被注释掉有两种可能性：1）后续会恢复此段代码逻辑。2）永久不用。前者如果没 有备注信息，难以知晓注释动机。后者建议直接删掉（代码仓库保存了历史代码）。

\9. 【参考】对于注释的要求：第一、能够准确反应设计思想和代码逻辑；第二、能够描述业务含 义，使别的程序员能够迅速了解到代码背后的信息。完全没有注释的大段代码对于阅读者形同 天书，注释是给自己看的，即使隔很长时间，也能清晰理解当时的思路；注释也是给继任者看 的，使其能够快速接替自己的工作。

\10. 【参考】好的命名、代码结构是自解释的，注释力求精简准确、表达到位。避免出现注释的 一个极端：过多过滥的注释，代码的逻辑一旦修改，修改注释是相当大的负担。

反例：

// put elephant into fridge put(elephant, fridge);

方法名put,加上两个有意义的变量名elephant和fridge,已经说明了这是在干什么，语 义清晰的代码不需要额外的注释。

\11. 【参考】特殊注释标记，请注明标记人与标记时间。注意及时处理这些标记，通过标记扫描， 经常清理此类标记。线上故障有时候就是来源于这些标记处的代码。

1） 待办事宜（TODO）:（标记人，标记时间，［预计处理时间］）

表示需要实现，但目前还未实现的功能。这实际上是一个Javadoc的标签，目前的Javadoc 还没有实现，但已经被广泛使用。只能应用于类，接口和方法（因为它是一个Javadoc标签）。

2） 错误，不能工作（FIXME）：（标记人，标记时间，［预计处理时间］）

在注释中用FIXME标记某代码是错误的，而且不能工作，需要及时纠正的情况。

### (九) 其它

\1.  【强制】在使用正则表达式时，利用好其预编译功能，可以有效加快正则匹配速度。

说明：不要在方法体内定义：Pattern pattern = Pattern . compile（规则）；

\2. 【强制】velocity调用POJO类的属性时，建议直接使用属性名取值即可，模板引擎会自动按 规范调用POJO的getXxx（），如果是boolean基本数据类型变量（boolean命名不需要加is 前缀），会自动调用isXxx（）方法。

说明：注意如果是Boolean包装类对象，优先调用getXxx（）的方法。

\3. 【强制】后台输送给页面的变量必须加$!{var}—中间的感叹号。 说明：如果var = null或者不存在，那么${var}会直接显示在页面上。

\4. 【强制】注意Math . random（）这个方法返回是double类型，注意取值的范围0<x<1 （能够 取到零值，注意除零异常），如果想获取整数类型的随机数，不要将x放大10的若干倍然后 取整，直接使用Random对象的nextInt或者nextLong方法。

\5. 【强制】获取当前毫秒数 System.currentTimeMillis（）;而不是 new Date（） .getTime（）; 说明：如果想获取更加精确的纳秒级时间值，使用System.nanoTime（）的方式。在JDK8中， 针对统计时间等场景，推荐使用Instant类。

\6.  【推荐】不要在视图模板中加入任何复杂的逻辑。

说明：根据**MVC**理论，视图的职责是展示，不要抢模型和控制器的活。

\7.  【推荐】任何数据结构的构造或初始化，都应指定大小，避免数据结构无限增长吃光内存。

\8.  【推荐】及时清理不再使用的代码段或配置信息。

说明：对于垃圾代码或过时配置，坚决清理干净，避免程序过度臃肿，代码冗余。

正例：对于暂时被注释掉，后续可能恢复使用的代码片断，在注释代码上方，统一规定使用三 个斜杠（///）来说明注释掉代码的理由。

## 二、异常日志

### (一)异常处理

\1. 【强制】Java类库中定义的一类RuntimeException可以通过预先检查进行规避，而不应该 通过 catch 来处理，比如：IndexOutOfBoundsException， NullPointerException 等等。 说明：无法通过预检查的异常除外，如在解析一个外部传来的字符串形式数字时，通过catch NumberFormatException 来实现。

正例：if (obj != null) {...}

反例：try { obj.method() } catch (NullPointerException e) {...}

\2.  【强制】异常不要用来做流程控制，条件控制，因为异常的处理效率比条件分支低。

\3. 【强制】对大段代码进行try-catch，这是不负责任的表现。catch时请分清稳定代码和非稳 定代码，稳定代码指的是无论如何不会出错的代码。对于非稳定代码的catch尽可能进行区分 异常类型，再做对应的异常处理。

\4. 【强制】捕获异常是为了处理它，不要捕获了却什么都不处理而抛弃之，如果不想处理它，请 将该异常抛给它的调用者。最外层的业务使用者，必须处理异常，将其转化为用户可以理解的 内容。

\5. 【强制】有try块放到了事务代码中，catch异常后，如果需要回滚事务，一定要注意手动回 滚事务。

\6.  【强制】finally块必须对资源对象、流对象进行关闭，有异常也要做try-catch。

说明：如果JDK7及以上，可以使用try-with-resources方式。

\7. 【强制】不能在finally块中使用return，finally块中的return返回后方法结束执行，不 会再执行try块中的return语句。

\8. 【强制】捕获异常与抛异常，必须是完全匹配，或者捕获异常是抛异常的父类。 说明：如果预期对方抛的是绣球，实际接到的是铅球，就会产生意外情况。

\9. 【推荐】方法的返回值可以为null，不强制返回空集合，或者空对象等，必须添加注释充分 说明什么情况下会返回null值。调用方需要进行null判断防止NPE问题。

说明：本手册明确防止NPE是调用者的责任。即使被调用方法返回空集合或者空对象，对调用 者来说，也并非高枕无忧，必须考虑到远程调用失败、序列化失败、运行时异常等场景返回 null的情况。

\10. 【推荐】防止NPE，是程序员的基本修养，注意NPE产生的场景：

1)返回类型为基本数据类型，return包装数据类型的对象时，自动拆箱有可能产生NPE。

反例：public int f() ( return Integer 对象},如果为 null，自动解箱抛 NPE。

2） 数据库的查询结果可能为null。

3） 集合里的元素即使isNotEmpty，取出的数据元素也可能为null。

4） 远程调用返回对象时，一律要求进行空指针判断，防止NPE。

5） 对于Session中获取的数据，建议NPE检查，避免空指针。

6） 级联调用obj.getA（）.getB（）.getC（）； 一连串调用，易产生NPE。

正例：使用JDK8的Optional类来防止NPE问题。

\11. 【推荐】定义时区分unchecked / checked异常，避免直接抛出new RuntimeException（）， 更不允许抛出Exception或者Throwable，应使用有业务含义的自定义异常。推荐业界已定义 过的自定义异常，如：DAOException / ServiceException 等。

\12. 【参考】在代码中使用“抛异常”还是“返回错误码”，对于公司外的http/api开放接口必须 使用“错误码”；而应用内部推荐异常抛出；跨应用间RPC调用优先考虑使用Result方式，封 装isSuccess（）方法、“错误码"、“错误简短信息”。

说明：关于RPC方法返回方式使用Result方式的理由：

1） 使用抛异常返回方式，调用方如果没有捕获到就会产生运行时错误。

2） 如果不加栈信息，只是new自定义异常，加入自己的理解的error message，对于调用 端解决问题的帮助不会太多。如果加了栈信息，在频繁调用出错的情况下，数据序列化和传输 的性能损耗也是问题。

\13. 【参考】避免出现重复的代码（Don't Repeat Yourself），即DRY原则。

说明：随意复制和粘贴代码，必然会导致代码的重复，在以后需要修改时，需要修改所有的副 本，容易遗漏。必要时抽取共性方法，或者抽象公共类，甚至是组件化。

正例：-个类中有多个public方法，都需要进行数行相同的参数校验操作，这个时候请抽取： private boolean checkParam（DTO dto） {...}

### (二) 日志规约

\1. 【强制】应用中不可直接使用日志系统（Log4j、Logback）中的API，而应依赖使用日志框架 SLF4J中的API，使用门面模式的日志框架，有利于维护和各个类的日志处理方式统一。

import org.slf4j.Logger;

import org.slf4j.LoggerFactory;

private static final Logger logger = LoggerFactory.getLogger（Abc.class）;

\2.  【强制】日志文件推荐至少保存15天，因为有些异常具备以“周"为频次发生的特点。

\3. 【强制】应用中的扩展日志（如打点、临时监控、访问日志等）命名方式： appName_logType_logName.logo logType：日志类型，推荐分类有 stats/desc/monitor/visit等；logName：日志描述。这种命名的好处：通过文件名就可知 道日志文件属于什么应用，什么类型，什么目的，也有利于归类查找。

正例：mppserver应用中单独监控时区转换异常，如： mppserver_monitor_timeZoneConvert.log

说明：推荐对日志进行分类，如将错误日志和业务日志分开存放，便于开发人员查看，也便于 通过日志对系统进行及时监控。

\4. 【强制】对trace/debug/info级别的日志输出，必须使用条件输出形式或者使用占位符的方 式。

说明：logger.debug("Processing trade with id : " + id + " and symbol: " + symbol);

如果日志级别是warn，上述日志不会打印，但是会执行字符串拼接操作，如果symbol是对象， 会执行toString()方法，浪费了系统资源，执行了上述操作，最终日志却没有打印。

正例：(条件)

if (logger.isDebugEnabled。){ logger.debug("Processing trade with id: " + id + " and symbol: " + symbol);

}

正例：(占位符)

logger.debug("Processing trade with id: {} and symbol :   {} ", id, symbol);

\5. 【强制】避免重复打印日志，浪费磁盘空间，务必在log4j.xml中设置additivity = false。 正例：〈logger name="com.taobao.dubbo.config" additivity="false">

\6. 【强制】异常信息应该包括两类信息：案发现场信息和异常堆栈信息。如果不处理，那么通过 关键字throws往上抛出。

正例：logger.error(各类参数或者对象 toString +  "_" + e.getMessage(), e);

\7. 【推荐】谨慎地记录日志。生产环境禁止输出debug日志；有选择地输出info日志；如果使 用warn来记录刚上线时的业务行为信息，一定要注意日志输出量的问题，避免把服务器磁盘 撑爆，并记得及时删除这些观察日志。

说明：大量地输出无效日志，不利于系统性能提升，也不利于快速定位错误点。记录日志时请 思考：这些日志真的有人看吗？看到这条日志你能做什么？能不能给问题排查带来好处？

\8. 【参考】可以使用warn日志级别来记录用户输入参数错误的情况，避免用户投诉时，无所适 从。注意日志输出的级别，error级别只记录系统逻辑出错、异常等重要的错误信息。如非必 要，请不要在此场景打出error级别。

## 三、单元测试

\1.  【强制】好的单元测试必须遵守AIR原则。

说明：单元测试在线上运行时，感觉像空气（AIR） 一样并不存在，但在测试质量的保障上， 却是非常关键的。好的单元测试宏观上来说，具有自动化、独立性、可重复执行的特点。

•   A： Automatic （自动化）

•   I： Independent （独立性）

•   R： Repeatable （可重复）

\2. 【强制】单元测试应该是全自动执行的，并且非交互式的。测试框架通常是定期执行的，执行 过程必须完全自动化才有意义。输出结果需要人工检查的测试不是一个好的单元测试。单元测 试中不准使用System.out来进行人肉验证，必须使用assert来验证。

\3. 【强制】保持单元测试的独立性。为了保证单元测试稳定可靠且便于维护，单元测试用例之间 决不能互相调用，也不能依赖执行的先后次序。

反例：method2需要依赖methodi的执行，将执行结果做为method2的输入。

\4.  【强制】单元测试是可以重复执行的，不能受到外界环境的影响。

说明：单元测试通常会被放到持续集成中，每次有代码check in时单元测试都会被执行。如 果单测对外部环境（网络、服务、中间件等）有依赖，容易导致持续集成机制的不可用。

正例：为了不受外界环境影响，要求设计代码时就把SUT的依赖改成注入，在测试时用spring 这样的DI框架注入一个本地（内存）实现或者Mock实现。

\5. 【强制】对于单元测试，要保证测试粒度足够小，有助于精确定位问题。单测粒度至多是类级 另U, 一般是方法级别。

说明：只有测试粒度小才能在出错时尽快定位到出错位置。单测不负责检查跨类或者跨系统的 交互逻辑，那是集成测试的领域。

\6.  【强制】核心业务、核心应用、核心模块的增量代码确保单元测试通过。

说明：新增代码及时补充单元测试，如果新增代码影响了原有单元测试，请及时修正。

\7. 【强制】单元测试代码必须写在如下工程目录：src/test/java,不允许写在业务代码目录下。 说明：源码构建时会跳过此目录，而单元测试框架默认是扫描此目录。

\8. 【推荐】单元测试的基本目标：语句覆盖率达到70%；核心模块的语句覆盖率和分支覆盖率都 要达到100%

说明：在工程规约的应用分层中提到的DAO层，Manager层，可重用度高的Service，都应该 进行单元测试。

\9.  【推荐】编写单元测试代码遵守BCDE原则，以保证被测试模块的交付质量。

•   B： Border，边界值测试，包括循环边界、特殊取值、特殊时间点、数据顺序等。

•   C： Correct，正确的输入，并得到预期的结果。

•   D： Design，与设计文档相结合，来编写单元测试。

•   E： Error，强制错误信息输入（如：非法数据、异常流程、非业务允许输入等），并得 到预期的结果。

\10. 【推荐】对于数据库相关的查询，更新，删除等操作，不能假设数据库里的数据是存在的， 或者直接操作数据库把数据插入进去，请使用程序插入或者导入数据的方式来准备数据。 反例：删除某一行数据的单元测试，在数据库中，先直接手动增加一行作为删除目标，但是这 一行新增数据并不符合业务插入规则，导致测试结果异常。

\11. 【推荐】和数据库相关的单元测试，可以设定自动回滚机制，不给数据库造成脏数据。或者 对单元测试产生的数据有明确的前后缀标识。

正例：在RDC内部单元测试中，使用RDC_UNIT_TEST_的前缀标识数据。

\12. 【推荐】对于不可测的代码建议做必要的重构，使代码变得可测，避免为了达到测试要求而 书写不规范测试代码。

\13. 【推荐】在设计评审阶段，开发人员需要和测试人员一起确定单元测试范围，单元测试最好 覆盖所有测试用例（UC）。

\14. 【推荐】单元测试作为一种质量保障手段，不建议项目发布后补充单元测试用例，建议在项 目提测前完成单元测试。

\15. 【参考】为了更方便地进行单元测试，业务代码应避免以下情况：

•构造方法中做的事情过多。

•存在过多的全局变量和静态方法。

•存在过多的外部依赖。

•存在过多的条件语句。

说明：多层条件语句建议使用卫语句、策略模式、状态模式等方式重构。

\16. 【参考】不要对单元测试存在如下误解：

•那是测试同学干的事情。本文是开发手册，凡是本文内容都是与开发同学强相关的。

•单元测试代码是多余的。汽车的整体功能与各单元部件的测试正常与否是强相关的。

•单元测试代码不需要维护。一年半载后，那么单元测试几乎处于废弃状态。

•单元测试与线上故障没有辩证关系。好的单元测试能够最大限度地规避线上故障。



## 四、安全规约

\1.  【强制】隶属于用户个人的页面或者功能必须进行权限控制校验。

说明：防止没有做水平权限校验就可随意访问、修改、删除别人的数据，比如查看他人的私信 内容、修改他人的订单。

\2.  【强制】用户敏感数据禁止直接展示，必须对展示数据进行脱敏。

说明：查看个人手机号码会显示成：158****9119,隐藏中间4位，防止隐私泄露。

\3. 【强制】用户输入的SQL参数严格使用参数绑定或者METADATA字段值限定，防止SQL注入, 禁止字符串拼接SQL访问数据库。

\4.  【强制】用户请求传入的任何参数必须做有效性验证。

说明：忽略参数校验可能导致：

•   page size过大导致内存溢出

•恶意order by导致数据库慢查询

•任意重定向

•   SQL注入

•反序列化注入

•正则输入源串拒绝服务ReDoS

说明：**Java**代码用正则来验证客户端的输入，有些正则写法验证普通用户输入没有问题， 但是如果攻击人员使用的是特殊构造的字符串来验证，有可能导致死循环的结果。

\5.  【强制】禁止向HTML页面输出未经安全过滤或未正确转义的用户数据。

\6.  【强制】表单、AJAX提交必须执行CSRF安全过滤。

说明：CSRF(Cross-site request forgery)跨站请求伪造是一类常见编程漏洞。对于存在 CSRF漏洞的应用/网站，攻击者可以事先构造好URL，只要受害者用户一访问，后台便在用户 不知情情况下对数据库中用户参数进行相应修改。

\7. 【强制】在使用平台资源，譬如短信、邮件、电话、下单、支付，必须实现正确的防重放限制， 如数量限制、疲劳度控制、验证码校验，避免被滥刷、资损。

说明：如注册时发送验证码到手机，如果没有限制次数和频率，那么可以利用此功能骚扰到其 它用户，并造成短信平台资源浪费。

\8. 【推荐】发贴、评论、发送即时消息等用户生成内容的场景必须实现防刷、文本内容违禁词过 滤等风控策略。

## 五、MySQL数据库

### (一) 建表规约

\1. 【强制】表达是与否概念的字段，必须使用is_xxx的方式命名，数据类型是unsigned tinyint （1表示是，0表示否）。

说明：任何字段如果为非负数，必须是unsigned。

正例：表达逻辑删除的字段名is_deleted，**1**表示删除，**0**表示未删除。

\2. 【强制】表名、字段名必须使用小写字母或数字，禁止出现数字开头，禁止两个下划线中间只 出现数字。数据库字段名的修改代价很大，因为无法进行预发布，所以字段名称需要慎重考虑。 说明：**MySQL**在**Windows**下不区分大小写，但在**Linux**下默认是区分大小写。因此，数据库 名、表名、字段名，都不允许出现任何大写字母，避免节外生枝。

正例：aliyun_admin， rdc_config, level3_name

反例：AliyunAdmin， rdcConfig， level_3_name

\3.  【强制】表名不使用复数名词。

说明：表名应该仅仅表示表里面的实体内容，不应该表示实体数量，对应于DO类名也是单数 形式，符合表达习惯。

\4.  【强制】禁用保留字，如desc、range、match、delayed等，请参考MySQL官方保留字。

\5. 【强制】主键索引名为pk_字段名；唯一索引名为uk_字段名；普通索引名则为idx_字段名。 说明：pk_ 即 primary key； uk_ 即 unique key； idx_ 即 index 的简称。

\6.  【强制】小数类型为decimal，禁止使用float和double。

说明：float和double在存储的时候，存在精度损失的问题，很可能在值的比较时，得到不 正确的结果。如果存储的数据范围超过decimal的范围，建议将数据拆成整数和小数分开存储。

\7.  【强制】如果存储的字符串长度几乎相等，使用char定长字符串类型。

\8. 【强制】varchar是可变长字符串，不预先分配存储空间，长度不要超过5000，如果存储长 度大于此值，定义字段类型为text，独立出来一张表，用主键来对应，避免影响其它字段索 引效率。

\9.  【强制】表必备三字段：id, gmt_create, gmt_modified。

说明：其中id必为主键，类型为unsigned bigint、单表时自增、步长为**1**。gmt_create, gmt_modified的类型均为date_time类型，前者现在时表示主动创建，后者过去分词表示被 动更新。

\10.  【推荐】表的命名最好是加上“业务名称_表的作用”。

正例：alipay_task / force_project / trade_config

\11.  【推荐】库名与应用名称尽量一致。

\12.  【推荐】如果修改字段含义或对字段表示的状态追加时，需要及时更新字段注释。

\13.  【推荐】字段允许适当冗余，以提高查询性能，但必须考虑数据一致。冗余字段应遵循：

1） 不是频繁修改的字段。

2） 不是varchar超长字段，更不能是text字段。

正例：商品类目名称使用频率高，字段长度短，名称基本一成不变，可在相关联的表中冗余存 储类目名称，避免关联查询。

\14.  【推荐】单表行数超过500万行或者单表容量超过2GB，才推荐进行分库分表。

说明：如果预计三年后的数据量根本达不到这个级别，请不要在创建表时就分库分表。

15.【参考】合适的字符存储长度，不但节约数据库表空间、节约索引存储，更重要的是提升检 索速度。

正例：如下表，其中无符号值可以避免误存负数，且扩大了表示范围。

| 对象     | 年龄区间  | 类型              | 字节 | 表示范围                  |
| -------- | --------- | ----------------- | ---- | ------------------------- |
| 人       | 150岁之内 | unsigned tinyint  | 1    | 无符号值：0到255          |
| 龟       | 数百岁    | unsigned smallint | 2    | 无符号值：0到65535        |
| 恐龙化石 | 数千万年  | unsigned int      | 4    | 无符号值：0到约42.9亿     |
| 太阳     | 约50亿年  | unsigned bigint   | 8    | 无符号值：0到约10的19次方 |

 

### (二) 索引规约

\1.  【强制】业务上具有唯一特性的字段，即使是多个字段的组合，也必须建成唯一索引。

说明：不要以为唯一索引影响了 insert速度，这个速度损耗可以忽略，但提高查找速度是明 显的；另外，即使在应用层做了非常完善的校验控制，只要没有唯一索引，根据墨菲定律，必 然有脏数据产生。

\2. 【强制】超过三个表禁止join。需要join的字段，数据类型必须绝对一致；多表关联查询时， 保证被关联的字段需要有索引。

说明：即使双表join也要注意表索引、SQL性能。

\3. 【强制】在varchar字段上建立索引时，必须指定索引长度，没必要对全字段建立索引，根据 实际文本区分度决定索引长度即可。

说明：索引的长度与区分度是一对矛盾体，一般对字符串类型数据，长度为20的索引，区分 度会高达90%以上，可以使用count(distinct left(列名，索引长度))/count(*)的区分度 来确定。

\4.  【强制】页面搜索严禁左模糊或者全模糊，如果需要请走搜索引擎来解决。

说明：索引文件具有B-Tree的最左前缀匹配特性，如果左边的值未确定，那么无法使用此索 引。

\5. 【推荐】如果有order by的场景，请注意利用索引的有序性。order by最后的字段是组合 索引的一部分，并且放在索引组合顺序的最后，避免出现file_sort的情况，影响查询性能。

正例：where a = ? and b = ? order by c;索引I： a_b_c

反例：索引中有范围查找，那么索引有序性无法利用，如：WHERE a>10 ORDER BY b;索引 a_b无法排序。

\6.  【推荐】利用覆盖索引来进行查询操作，避免回表。

说明：如果一本书需要知道第11章是什么标题，会翻开第11章对应的那一页吗？目录浏览 一下就好，这个目录就是起到覆盖索引的作用。

正例：能够建立索引的种类：主键索引、唯一索引、普通索引，而覆盖索引是一种查询的一种 效果，用explain的结果，extra列会出现：using index。

\7.  【推荐】利用延迟关联或者子查询优化超多分页场景。

说明：MySQL并不是跳过offset行，而是取offset + N行，然后返回放弃前offset行，返回 N行，那当offset特别大的时候，效率就非常的低下，要么控制返回的总页数，要么对超过 特定阈值的页数进行SQL改写。

正例：先快速定位需要获取的id段，然后再关联：

SELECT a.* FROM 表 1 a, (select id from 表 1 where 条件 LIMIT 100000,20 ) b where a.id = b.id

\8. 【推荐】SQL性能优化的目标：至少要达到range级别，要求是ref级别，如果可以是consts 最好。

说明：

\1) consts单表中最多只有一个匹配行(主键或者唯一索引)，在优化阶段即可读取到数据。

\2) ref指的是使用普通的索引(normal index)。

\3) range对索引进行范围检索。

反例：explain表的结果，type = index，索引物理文件全扫描，速度非常慢，这个index级 别比较range还低，与全表扫描是小巫见大巫。

\9.  【推荐】建组合索引的时候，区分度最高的在最左边。

正例：如果where a = ? and b=? ， a列的几乎接近于唯一值，那么只需要单建idx_a索引即

可。

说明：存在非等号和等号混合判断条件时，在建索引时，请把等号条件的列前置。如:where a>? and b=?那么即使a的区分度更高，也必须把b放在索引的最前列。

\10. 【推荐】防止因字段类型不同造成的隐式转换，导致索引失效。

\11. 【参考】创建索引时避免有如下极端误解：

\1) 宁滥勿缺。认为一个查询就需要建一个索引。

\2) 宁缺勿滥。认为索引会消耗空间、严重拖慢更新和新增速度。

\3) 抵制惟一索引。认为业务的惟一性一律需要在应用层通过“先查后插”方式解决。

### (三) SQL语句

\1. 【强制】不要使用count(列名)或count(常量)来替代count(*)，count(*)是SQL92定义的 标准统计行数的语法，跟数据库无关，跟NULL和非NULL无关。

说明：count(*)会统计值为NULL的行，而count(列名)不会统计此列为NULL值的行。

\2. 【强制】count(distinct col)计算该列除NULL之外的不重复行数，注意count(distinct col1, col2)如果其中一列全为NULL，那么即使另一列有不同的值，也返回为0。

\3. 【强制】当某一列的值全是NULL时，count(col)的返回结果为0,但sum(col)的返回结果为 NULL，因此使用sum()时需注意NPE问题。

正例：可以使用如下方式来避免sum的NPE问题：SELECT IF(ISNULL(SUM(g)),0,SUM(g)) FROM table;

\4.  【强制】使用ISNULL()来判断是否为NULL值。

说明：NULL与任何值的直接比较都为NULL

\1) NULLCNULL的返回结果是NULL，而不是false

\2) NULL=NULL的返回结果是NULL，而不是true

\3) NULL<>1的返回结果是NULL，而不是true

\5.  【强制】在代码中写分页查询逻辑时，若count为0应直接返回，避免执行后面的分页语句。

\6.  【强制】不得使用外键与级联，一切外键概念必须在应用层解决。

说明：以学生和成绩的关系为例，学生表中的student_id是主键，那么成绩表中的student_id 则为外键。如果更新学生表中的student_id，同时触发成绩表中的student_id更新，即为 级联更新。外键与级联更新适用于单机低并发，不适合分布式、高并发集群；级联更新是强阻 塞，存在数据库更新风暴的风险；外键影响数据库的插入速度。

\7.  【强制】禁止使用存储过程，存储过程难以调试和扩展，更没有移植性。

\8. 【强制】数据订正时，删除和修改记录时，要先select，避免出现误删除，确认无误才能执 行更新语句。

\9. 【推荐】in操作能避免则避免，若实在避免不了，需要仔细评估in后边的集合元素数量，控 制在1。。。个之内。

\10. 【参考】如果有全球化需要，所有的字符存储与表示，均以utf-8编码，注意字符统计函数 的区别。

说明：

SELECT LENGTH("轻松工作")；返回为12

SELECT CHARACTER_LENGTH("轻松工作")；返回为 4

如果需要存储表情，那么选择utfmb4来进行存储，注意它与utf-8编码的区别。

\11. 【参考】TRUNCATE TABLE比DELETE速度快，且使用的系统和事务日志资源少，但TRUNCATE 无事务且不触发trigger，有可能造成事故，故不建议在开发代码中使用此语句。

说明：TRUNCATE TABLE在功能上与不带WHERE子句的DELETE语句相同。

### (四) ORM映射

\1. 【强制】在表查询中，一律不要使用*作为查询的字段列表，需要哪些字段必须明确写明。 说明：1)增加查询分析器解析成本。2)增减字段容易与resultMap配置不一致。

\2. 【强制】POJO类的布尔属性不能加is,而数据库字段必须加is_，要求在resultMap中进行 字段与属性之间的映射。

说明：参见定义POJO类以及数据库字段定义规定，在〈resultMap>中增加映射，是必须的。 在MyBatis Generator生成的代码中，需要进行对应的修改。

\3. 【强制】不要用resultclass当返回参数，即使所有类属性名与数据库字段一一对应，也需 要定义；反过来，每一个表也必然有一个与之对应。

说明：配置映射关系，使字段与DO类解耦，方便维护。

\4.  【强制】sql.xml配置参数使用：#{},#param#不要使用${}此种方式容易出现SQL注入。

\5. 【强制】iBATIS 自带的 queryForList(String statementName, int start, int size)不推 荐使用。

说明其实现方式是在数据库取到statementName对应的SQL语句的所有记录,再通过subList 取start, size的子集合。

正例：Map<String, Object> map = new HashMap<String, Object>();

map.put("start", start);

map.put("size", size);

\6.  【强制】不允许直接拿HashMap与Hashtable作为查询结果集的输出。

说明：resultClass = ”Hashtable”，会置入字段名和属性值，但是值的类型不可控。

\7.  【强制】更新数据表记录时，必须同时更新记录对应的gmt_modified字段值为当前时间。

\8. 【推荐】不要写一个大而全的数据更新接口。传入为POJO类，不管是不是自己的目标更新字 段，都进行叩date table set c1=value1,c2=value2, c3=value3;这是不对的。执行 SQL 时，不要更新无改动的字段，一是易出错；二是效率低；三是增加binlog存储。

\9. 【参考】@Transactional事务不要滥用。事务会影响数据库的QPS，另外使用事务的地方需 要考虑各方面的回滚方案，包括缓存回滚、搜索引擎回滚、消息补偿、统计修正等。

\10. 【参考】＜isEqual＞中的compareValue是与属性值对比的常量，一般是数字，表示相等时带 上此条件；＜isNotEmpty＞表示不为空且不为null时执行；＜isNotNull＞表示不为null值时 执行。



## 六、工程结构

### (一) 应用分层

\1.  【推荐】图中默认上层依赖于下层，箭头关系表示可直接依赖，如：开放接口层可以依赖于

Web层，也可以直接依赖于Service层，依此类推：

![img](https://cdn.nlark.com/yuque/0/2020/jpeg/102749/1590744399522-2e8ca66d-ba08-4e30-a063-3eda76364b60.jpeg)

 

•开放接口层：可直接封装Service方法暴露成RPC接口；通过Web封装成http接口；进行 网关安全控制、流量控制等。

•终端显示层：各个端的模板渲染并执行显示的层。当前主要是velocity渲染，JS渲染, JSP渲染，移动端展示等。

•    **Web**层：主要是对访问控制进行转发，各类基本参数校验，或者不复用的业务简单处理等。

•    **Service**层：相对具体的业务逻辑服务层。

•    **Manager**层：通用业务处理层，它有如下特征：

1） 对第三方平台封装的层，预处理返回结果及转化异常信息；

2） 对Service层通用能力的下沉，如缓存方案、中间件通用处理；

3） 与DAO层交互，对多个DAO的组合复用。

•    **DAO**层：数据访问层，与底层MySQL、Oracle、Hbase等进行数据交互。

•外部接口或第三方平台：包括其它部门RPC开放接口，基础平台，其它公司的HTTP接口。

\2. 【参考】（分层异常处理规约）在DAO层，产生的异常类型有很多，无法用细粒度的异常进 行 catch，使用 catch（Exception e）方式，并 throw new DAOException（e），不需要打印 日志，因为日志在Manager/Service层一定需要捕获并打到日志文件中去，如果同台服务器 再打日志，浪费性能和存储。在Service层出现异常时，必须记录出错日志到磁盘，尽可能带 上参数信息，相当于保护案发现场。如果Manager层与Service同机部署，日志方式与DAO 层处理一致，如果是单独部署，则采用与Service 一致的处理方式。Web层绝不应该继续往上 抛异常，因为已经处于顶层，如果意识到这个异常将导致页面无法正常渲染，那么就应该直接 跳转到友好错误页面，加上用户容易理解的错误提示信息。开放接口层要将异常处理成错误码 和错误信息方式返回。

\3.  【参考】分层领域模型规约：

・**DO**(Data Object):与数据库表结构-------- 对应，通过DAO层向上传输数据源对象。

•    **DTO**(Data Transfer Object):数据传输对象，Service或Manager向外传输的对象。

・**BO**(Business Object):业务对象。由Service层输出的封装业务逻辑的对象。

・**AO** (Application Object):应用对象。在Web层与Service层之间抽象的复用对象模型， 极为贴近展示层，复用度不高。

・**VO**(View Object):显示层对象，通常是Web向模板渲染引擎层传输的对象。

•   **Query**:数据查询对象，各层接收上层的查询请求。注意超过2个参数的查询封装，禁止 使用Map类来传输。

### (二) 二方库依赖

\1.  【强制】定义GAV遵从以下规则：

\1)  **G**roupID格式：com.｛公司/BU ｝.业务线.［子业务线］，最多4级。

说明｛公司/BU｝例如：alibaba/taobao/tmall/aliexpress等BU 一级；子业务线可选。 正例：com. taobao .jstorm 或 com.alibaba.dubbo. register

\2)  **A**rtifactID格式：产品线名-模块名。语义不重复不遗漏，先到中央仓库去查证一下。

正例：dubbo-client / fastjson-api / jstorm-tool

\3)  **V**ersion：详细规定参考下方。

\2.  【强制】二方库版本号命名方式：主版本号.次版本号.修订号

\1)  主版本号：产品方向改变，或者大规模API不兼容，或者架构不兼容升级。

\2)  次版本号：保持相对兼容性，增加主要功能特性，影响范围极小的API不兼容修改。

\3)  修订号：保持完全兼容性，修复BUG、新增次要功能特性等。

说明：注意起始版本号必须为：**1.0.0**，而不是**0.0.1** 正式发布的类库必须先去中央仓库进 行查证，使版本号有延续性，正式版本号不允许覆盖升级。如当前版本：1.3.3,那么下一个 合理的版本号：1.3.4或1.4.。或2.0.0

\3.  【强制】线上应用不要依赖SNAPSHOT版本(安全包除外)。

说明：不依赖SNAPSHOT版本是保证应用发布的幂等性。另外，也可以加快编译时的打包构建。

\4. 【强制】二方库的新增或升级，保持除功能点之外的其它jar包仲裁结果不变。如果有改变, 必须明确评估和验证，建议进行dependency：resolve前后信息比对，如果仲裁结果完全不一 致，那么通过dependency : tree命令，找出差异点，进行〈excludes〉排除jar包。

\5. 【强制】二方库里可以定义枚举类型，参数可以使用枚举类型，但是接口返回值不允许使用枚 举类型或者包含枚举类型的POJO对象。

\6.  【强制】依赖于一个二方库群时，必须定义一个统一的版本变量，避免版本号不一致。

说明：依赖springframework-core , - context, - beans，它们都是同一个版本，可以定义一 个变量来保存版本：${spring.version}，定义依赖的时候，引用该版本。

\7. 【强制】禁止在子项目的pom依赖中出现相同的GroupId，相同的ArtifactId，但是不同的 Version。

说明：在本地调试时会使用各子项目指定的版本号，但是合并成一个war，只能有一个版本号 出现在最后的lib目录中。可能出现线下调试是正确的，发布到线上却出故障的问题。

\8. 【推荐】所有pom文件中的依赖声明放在＜dependencies＞语句块中，所有版本仲裁放在 ＜dependencyManagement＞ 语句块中。

说明：＜dependencyManagement＞里只是声明版本，并不实现引入，因此子项目需要显式的声 明依赖，version和scope都读取自父pom。而〈dependencies〉所有声明在主pom的 ＜dependencies＞里的依赖都会自动引入，并默认被所有的子项目继承。

\9.  【推荐】二方库不要有配置项，最低限度不要再增加配置项。

\10. 【参考】为避免应用二方库的依赖冲突问题，二方库发布者应当遵循以下原则：

1） 精简可控原则。移除一切不必要的API和依赖，只包含Service API、必要的领域模型对 象、Utils类、常量、枚举等。如果依赖其它二方库，尽量是provided引入，让二方库使用 者去依赖具体版本号；无log具体实现，只依赖日志框架。

2） 稳定可追溯原则。每个版本的变化应该被记录，二方库由谁维护，源码在哪里，都需要能 方便查到。除非用户主动升级版本，否则公共二方库的行为不应该发生变化。

### (三) 服务器

\1.  【推荐】高并发服务器建议调小TCP协议的time_wait超时时间。

说明：操作系统默认240秒后，才会关闭处于time_wait状态的连接，在高并发访问下，服 务器端会因为处于time_wait的连接数太多，可能无法建立新的连接，所以需要在服务器上 调小此等待值。

正例：在linux服务器上请通过变更/etc/sysctl.conf文件去修改该缺省值（秒）：

net.ipv4.tcp_fin_timeout  = 30

\2.  【推荐】调大服务器所支持的最大文件句柄数（File Descriptor,简写为fd）*。*

说明：主流操作系统的设计是将TCP/UDP连接采用与文件一样的方式去管理，即一个连接对 应于一个fd。主流的linux服务器默认所支持最大fd数量为1024,当并发连接数很大时很 容易因为fd不足而出现“open too many files”错误，导致新的连接无法建立。建议将linux 服务器所支持的最大句柄数调高数倍（与服务器的内存数量相关）。

\3. 【推荐】给JVM设置-XX：+HeapDumpOnOutOfMemoryError参数，让JVM碰到OOM场景时输出 dump信息。

说明：OOM的发生是有概率的，甚至有规律地相隔数月才出现一例，出现时的现场信息对查错 非常有价值。

\4. 【推荐】在线上生产环境，JVM的Xms和Xmx设置一样大小的内存容量，避免在GC后调整堆 大小带来的压力。

\5. 【参考】服务器内部重定向使用forward；外部重定向地址使用URL拼装工具类来生成，否则 会带来URL维护不一致的问题和潜在的安全风险。



## 一、共识

- 开发人员是质量最重要的保障者，测试人员是质量的最后一道防线。
- Bug越早发现，修复的成本越低。

## 二、标准

  提测之前开发人员需要完成自测，确保以下几个点。

- 完成提测相关的Rest接口文档

​    输出：Swagger文档

  没有接口文档的提测，测试人员有权进行打回。



- 相关冒烟测试用例已通过

​    输出：冒烟用例执行结果（需要填写用例的执行人，执行时间，执行结果）

  提测的时候，需要附上冒烟用例的执行结果。未填写执行结果的，测试人员有权进行打回。

## 三、流程

- 需求评审

1）客户真实的需求是怎样的

2）产品设计是否解决了客户的需求

3）实现方式是否合理，是否需要优化

- 设计评审

1）开发给出的设计方案是否实现了产品的需求

2）设计方案是否合理

3）影响范围是否考虑周全

- 用例评审

1）测试用例是否能验证客户的需求

2）场景覆盖是否全面（正向，逆向，边界，异常）

3）是否有针对影响范围评估结果的用例

4）开发和测试对“冒烟用例”达成共识

a. 跟本次功能相关的主流程的正向用例

b. 数量不能超过整体测试用例的5%（待讨论）

c. 操作步骤和期待结果有准确的描述（测试跟开发能达成一致理解）

 

 git@gitlab.qjdchina.com:incubator/qjd-common.git



## 一、父POM管理

### qjd-dependencies.xml

三方jar版本管理

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <!--基础的三方jar包基于spring-boot的依赖-->
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-dependencies</artifactId>
        <version>2.5.4</version>
    </parent>
    <groupId>com.qjdchina.common</groupId>
    <artifactId>qjd-dependencies</artifactId>
    <packaging>pom</packaging>
    <version>1.0.2</version>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>com.ctrip.framework.apollo</groupId>
                <artifactId>apollo-client</artifactId>
                <version>${apollo-client.version}</version>
            </dependency>
            ......
            // 其他三方jar包版本管理
        </dependencies>
    </dependencyManagement>

    // Maven私服（已经改成https的地址，支持maven 3.6+）
    <distributionManagement>
        <repository>
            <id>nexus-releases</id>
            <name>Nexus Releases</name>
            <url>https://nexus.qjdchina.com/nexus/repository/releases/</url>
        </repository>
        <snapshotRepository>
            <id>nexus-snapshots</id>
            <name>Nexus Snapshots</name>
            <url>https://nexus.qjdchina.com/nexus/repository/snapshots/</url>
        </snapshotRepository>
    </distributionManagement>
</project>
```

### qjd-common-parent.xml

所有需要打包发布到nexus仓库的组件的父pom，继承qjd-dependencies，定义了java版本encoding等。

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.qjdchina.common</groupId>
        <artifactId>qjd-dependencies</artifactId>
        <version>1.0.2</version>
        <relativePath/>
    </parent>
    <artifactId>qjd-common-parent</artifactId>
    <version>1.0.3</version>
    <packaging>pom</packaging>
    <description>公共组件的父POM</description>

    <properties>
        <java.version>1.8</java.version>
        <maven.compiler.source>${java.version}</maven.compiler.source>
        <maven.compiler.target>${java.version}</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
    </properties>

    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-source-plugin</artifactId>
                <executions>
                    <execution>
                        <id>attach-sources</id>
                        <goals>
                            <goal>jar-no-fork</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>
</project>
```

### qjd-spring-boot-parent.xml

应用的父pom（原继承spring-boot-starter-parent的应用需要继承本父pom）管理了自定义starter的版本。



### 主要的修改

1. 三方jar包版本升级后（安全升级等）需要修改 qjd-dependencies.xml 升级版本号，与之关联的qjd-common-parent.xml和qjd-spring-boot-parent.xml也需要升级版本。

1. 应用组件qjd-spring-boot-starter-xxxx 升级之后，升级qjd-spring-boot-parent.xml。

上述pom文件版本升级后可以参考 deploy_release.sh 中的命令进行发布



## 二、自动加载配置的starter

### qjd-spring-boot-starter-common

定义了自动加载配置的顺序和配置加解密，可参考《应用开发规范》的“配置管理”章节。

### starter编写方法

1. 加载starter对应组件需要的配置，一般是common.xxx (例如：common.mysql，common.mongodb）
2. 定义一些加入组件后需要自动初始化的bean

可以参考 qjd-spring-boot-starter-activemq 的写法。



注意：尽量保证封装后的starter和spring-boot官方starter配置和行为一致，只做了配置的自动加载或加了一些增量的功能。

 

 1：

在saas中写业务 都是针对租户的域来操作的  可以理解为 当前操作是某个公司的数据  因此在内部业务中无感租户域

但是在非saas项目中如果涉及saas业务 ，也都是有针对性的租户操作  此时的dubbo接口的参数设计要包含租户的信息字段 而且要必填

此时提供接口方 就要有感知的设置租户域   **TenantContextHolder.setTenantId(租户id);**

### 2：saas dubbo接口案例

**案例**

```java
@Data
public class TestRequest {

    /**
     * 租户id
     */
    private String tenantId;
    
    private String name;
    
    ......

}

public interface TestServiceApi {

    void testDubboApi(TestRequest testRequest);

}


import org.apache.dubbo.config.annotation.Service;

@Service
public class TestServiceImpl implements TestServiceApi {
    @Override
    public void testDubboApi(TestRequest testRequest) {
        TenantContextHolder.setTenantId(testRequest.getTenantId());
        //业务代码

        
    }
}  
```

3：调用方案例

```java
    @Resource
    private TestServiceApi testServiceApi;


    TestRequest param = new TestRequest();
    param.setTenantId("企业编码（corporation_id）（租户id）");
    testServiceApi.testDubboApi(param);
```

 

 1：依赖

在公司项目中直接加入下面依赖

```xml
        <dependency>
            <groupId>com.qjdchina.saas</groupId>
            <artifactId>saas-global-id</artifactId>
        </dependency>
```



## 2：主键上注解

```xml
    @TableId(value = "id", type = IdType.ASSIGN_ID)
```

## 3：代码中直接使用

GlobalIdWorker.getNextId()

## 4：注意事项：

application.properties 中记得要有spring.application.name 属性

 **一旦引用这个包 就不要用mybatis-plus下的idWork 要用****GlobalIdWorker.getNextId()**





## 已加入的项目有

saas-admin

saas-contract

saas-credit

saas-ofc

saas-task

saas-boss

saas-core

saas-flow

saas-sign

 

 需求背景

很多业务需要监听Activiti流程引擎在流程运转过程中的消息，大致有以下场景

1. 监听所有流程的所有事件：例如，记录流程日志
2. 监听所有流程的特定事件：例如，所有流程中的人工节点开始的时候发送短信通知
3. 监听特定流程的所有事件：例如，需要监听放款流程的开始，结束和人工节点被处理等事件
4. 监听特定流程的特定事件：例如，监听金融产品审批流程的人工节点被处理的事件



## 设计思路

上述这些“事件”处理逻辑是多样的，流程中心如果需要知道外部的处理逻辑发送特定的消息到特定的队列，那么系统之间的耦合性会非常强，每次有新的业务需求都需要修改流程引擎，增加消息类型。因此Activiti流程中心只应该在流程状态变化的时候，发送消息到固定的Topic而不用关心消费逻辑。



但Topic的消费方式有几个问题

1. Topic的语意是发布和订阅的消费方式，相同消费逻辑的消息订阅者如果在集群中有多个实例，同一个消息就会被消费多次。
2. Topic的语意决定了消费者在长时间下线之后，消息可能会被丢失。



利用ActiveMQ的[VirtualTopic](http://activemq.apache.org/virtual-destinations)特性，可以很好的解决这个问题。

利用VirtualTopic，相当于多了一系列和业务相关的队列来接受Topic发送的消息。而业务逻辑是从指定队列中获取和消费消息。具体机制可以参考[VirtualTopic](http://activemq.apache.org/virtual-destinations)的说明文档。



ActiveMQ中VirtualTopic配置

```xml
  <broker>
    <destinationInterceptors>
      <virtualDestinationInterceptor>
        <virtualDestinations>
          <!-- 虚拟主题配置，注意selectorAware为true的时候会导致消息丢失-->
          <virtualTopic name=">" prefix="EVT.*." selectorAware="false"/>
        </virtualDestinations>
      </virtualDestinationInterceptor>
    </destinationInterceptors>

    <plugins>
      <!-- 消息消费失败的情况下，放到DLQ的配置-->
      <redeliveryPlugin fallbackToDeadLetter="true" sendToDlqIfMaxRetriesExceeded="true">
        <redeliveryPolicyMap>
          <redeliveryPolicyMap>
            <defaultEntry>
              <!-- 尝试重新发送3次，首次失败延迟5秒，以后间隔2秒发送-->
              <redeliveryPolicy maximumRedeliveries="3" initialRedeliveryDelay="5000" redeliveryDelay="2000"/>
            </defaultEntry>
          </redeliveryPolicyMap>
        </redeliveryPolicyMap>
      </redeliveryPlugin>
    </plugins>
  </broker>
```



## 使用方式



继承activiti-api中的FlowEventListener，通过复写getProcessDefKey和getEvent进行组合，可以达到“需求背景”中的四类消费需求。



```java
package com.qjdchina.activiti.service;

import com.qjdchina.activiti.jms.EventType;
import com.qjdchina.activiti.jms.FlowEvent;
import com.qjdchina.activiti.jms.FlowEventListener;
import org.springframework.stereotype.Service;

@Service
public class TestListener extends FlowEventListener {

    @Override
    protected String getProcessDefKey() {
        return "batchRecordAccount";
    }

    @Override
    protected EventType getEvent() {
        return EventType.PROCESS_STARTED;
    }

    @Override
    protected void processData(FlowEvent event) {

    }
}
```



```java
package com.qjdchina.activiti.service;

import com.qjdchina.activiti.jms.EventType;
import com.qjdchina.activiti.jms.FlowEvent;
import com.qjdchina.activiti.jms.FlowEventListener;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

@Slf4j
@Service
public class SendSmsListener extends FlowEventListener {

    @Override
    protected String getProcessDefKey() {
        // 监听所有流程
        return null;
    }

    @Override
    protected EventType getEvent() {
        // 监听所有事件
        return null;
    }

    @Override
    protected void processData(FlowEvent event) {
        log.info("event={}", event);
    }
}
```

| 序号      | 步骤                           | 操作                                                         | 说明                                                         | 疑问                                                      | 代码入口                                       |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| --------- | ------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | --------------------------------------------------------- | ---------------------------------------------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| A-0       | 切换记账日期                   | bizDate等于上次日切成功的日期+1，也就是下一个业务日期，并设置日切状态为处理中 | dailyrun_job_definition.xml中 WriteBizdate定义了更改记账日期的逻辑 |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| A-1       | 阶梯利率映射                   | 全量查询loan_rate_info获取贷款编号到阶梯利率的映射 Map<String, List<LoanRateInfo>> | loan_rate_info记录每条贷款对应的阶段利率和罚息率 owner_type和type分组？ | 是否并不是每条贷款都有对应的N条loan_rate_info             |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| A-2       | 获取所有贷款记录               | 全量查询loan_info状态不等于WAIT_MAKE List<LoanInfo>          |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| A-3       | 获取每条贷款的利息汇总         | 对每一条贷款记录循环处理： 全量查询running_account中的loan_id等于当前贷款的id，同时针对每条running_account获取running_account_cost_item Map<String, List<RunningAccount>> | 一条贷款最多对应两条running_account分别记录经销商和厂家的利息汇总 | running_account_cost_item是啥玩意儿？  还款计划汇总扩展表 |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| B-1       | 期初汇总额（上一期期末汇总额） | 查询daily_summary 条件1：last_biz_date=上个日切成功日期-1 条件2：type=INTEREST | daily_summary中last_biz_date记录的是上次日切成功的last_biz_date，所以等于当前biz_date记录的last_biz_date - 1  daily_summary按照日期记录type等于以下三个类型的利息 INTEREST_SUB PENALTY INTEREST |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| B-2       | 计算本期产生汇总额             | 每日计息表中日期为当前bizDate的记录的金额总和  daily表中last_biz_date=本期日期 |                                                              | daily表中的记录什么时候插入和更新                         |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| B-3       | 期末汇总额                     | running_account中的sum(interest_accumulated)表示所有贷款记录的利息汇总 | running_account为每一条贷款维度的利息汇总                    |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| B-4       | 累计汇总额                     | 已完成的贷款直接取runningAccount表中的累积利息，未完成的贷款则需要计算 | 循环A-2获取的贷款记录，循环变量：当前贷款 1. A-1获取的Map中去掉已经完成的经销商阶梯利率 2. A-3中获取的Map中loanId对应的记录最多2条校验 3. 根据DailySummaryType映射LoanRateInfoType，获取当前贷款对应的指定费用项(LoanRateInfoType)的利率表，并根据利率的owner_type划分成厂家和经销商的利率  // 贷款对应的经销商利率表 List<LoanRateInfo> dLoanRateInfoList // 贷款对应的厂家利率表 List<LoanRateInfo> fLoanRateInfoList |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| B-4-1     | 针对每条贷款处理               |                                                              | 针对每条贷款记录进行比较 1. 贷款状态：经销商的时候用status字段，厂家的时候用factory_status字段。贷款状态为DONE的则跳过 2. 非DONE的时候进行比较： 业务日期=IF(有坏账则用坏账日期) ELSE 当前日期业务日期，并计算每一条贷款的利息 | getInterestByLoanInfoIdAndDate中是不是不用VO转？          |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| B-4-1-1   | 计算每条贷款的利息             |                                                              | 【初始化】 1. 起息日：valueDate（网筑一号用getFactoryValueDate） 2. 当前贷款的剩余本金：remainPrincipal 3. 当前贷款的还款：List<RepayDetailVO> repays(repayment_detail) 4. 当前贷款的冲销：List<AbateInfo> abates.  abate_info(type != REVERSE) 把abate中有本金变更的记录当做还款加入repays数组 5. repays数组根据RepayDetailVO的还款日排序 【计算利息】 calculate2(当前业务日期，利率表，起息日，剩余本金，还款记录） |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| B-4-1-1-1 | calculate2                     | 起息日到还款日之间产生的利息累计                             | 循环处理还款记录：repay 所有的利息计算都是基于剩余本金       |                                                           | RepaymentPlanManagementImpl#calculate2         |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| B-4-1-1-2 |                                | 计算指定期间内产生的利息                                     | 参数：剩余本金，起息日，还款日，利率表，精度                 |                                                           | RepaymentCalculateUtil#getInterestByLadderRate |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| B-5       | 校验                           | 1. 累计汇总额=期初汇总额+本期产生汇总额 2. 累计汇总额=期末汇总额 |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|           |                                |                                                              |                                                              |                                                           |                                                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |

## 增加Maven依赖



在springMVC的web工程pom.xml文件增加以下依赖，并排除slf4j-log4j12等日志包的冲突（可查看启动日志，如果有冲突则会在控制台提示有多个日志实现可以绑定）



```xml
        <dependency>
            <groupId>com.qjdchina</groupId>
            <artifactId>qjd-log</artifactId>
            <version>1.0.0</version>
        </dependency>
```



1. 排除直接的jar依赖

1. 1. 在工程中用正则表达式搜索 >(jcl|slf4j|jul|logback|log4j|logback) 删除相关的jar包直接依赖

1. 排除传递依赖

1. 1. 查看web工程下的pom.xml文件，查看传递依赖中是否包含slf4j-log4j12 有的话则排除



## 删除旧配置文件



删除工程中原有的logback.xml和log4j.xml



## 修改web.xml



修改web.xml删除原先的log4j监听器



## 增加启动参数



让dubbo使用slf4j 需要在服务启动参数中增加 -Ddubbo.application.logger=slf4j



## 验证



1. /srv/logs/<服务名称> 文件夹下生成debug.log info.log warn.log error.log 4个日志文件
2. 日志文件的格式为统一的日志格式%d{yyyy-MM-dd HH:mm:ss.SSS} ${*hostname*} [%thread] [%X{traceId}] [%X{bizType}] %-5level %logger{50}:%line - %msg%n
3. 应用启动的时候slf4j没有提示有多个日志实现绑定的警告

| 分类                                                         | 治理项                                                       | 治理内容                                                     | 说明                                                         |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| application.properties                                       | 每个项目定义app.id                                           | 每个应用定义全局唯一的app.id                                 | app.id变量被应用于dubbo注册，日志文件路径等模板化的配置中    |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| apollo.xxx 相关配置                                          | 删除以apollo开头的配置项                                     | 因使用统一的规则使用apollo的配置，规定了配置加载顺序和默认加载的配置 |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| jar包依赖                                                    | 向外提供的Service jar包的父pom依赖                           | 需要发布到仓库的服务父pom选择为 <parent>         <groupId>com.qjdchina.common</groupId>         <artifactId>qjd-common-parent</artifactId>         <version>1.0.3</version>         <relativePath/> </parent> | qjd-common-parent提供了编译版本，三方jar包版本管理，发布仓库管理功能 |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 服务自身入口以及服务内使用的模块：dao，biz等的父pom依赖      | 不需要发布到仓库的服务父pom选择 <parent>         <groupId>com.qjdchina.common</groupId>         <artifactId>qjd-spring-boot-starter-parent</artifactId>         <version>1.1.10</version>         <relativePath/> </parent> | qjd-spring-boot-starter-parent在官方spring-boot-starter-parent的基础上维护了多个应用开发需要引入的starter项目和公共jar包的版本，管理了常用jar包的传递依赖。 |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 向外提供的Service包不包含三方框架类的jar包                   | 比如应该依赖validation-api而非hibernate-validator 应该依赖swagger-annotations而非swagger-core 应该依赖jackson-annotations而非jackson-core等 |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 其他仟金顶两方服务的jar版本管理                              | 使用一下方式引入两方服务jar包的版本管理 <dependencyManagement>     <dependencies>         <!-- 统一维护的两方系统jar包管理pom -->         <dependency>             <groupId>com.qjdchina.common</groupId>             <artifactId>qjd-services</artifactId>             <version>20211229</version>             <type>pom</type>             <scope>import</scope>         </dependency>         <!-- 需要覆写的版本 -->         <dependency>             <groupId>com.qjdchina</groupId>             <artifactId>qjd-http</artifactId>             <version>1.0.2</version>         </dependency>     </dependencies> </dependencyManagement> | 暂时使用1.0.0-SNAPSHOT非稳定构建版本，等应用治理上线完成之后，会打一个次pom文件的稳定版本的包，后续升级参考《两方服务jar包版本管理方案》 |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 启动模块加spring-boot-maven-plugin                           | <build>     <plugins>         <plugin>             <groupId>org.springframework.boot</groupId>             <artifactId>spring-boot-maven-plugin</artifactId>         </plugin>     </plugins> </build> |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 三方jar包使用父pom的依赖管理提供的版本                       | 引入三方jar包的时候，优先使用父pom管理的版本，不自己指定特定的版本。 例如： <dependency>     <groupId>org.slf4j</groupId>     <artifactId>slf4j-api</artifactId>     <version>1.7.1</version>     ---->去掉这行版本定义 </dependency>  在父pom中没有管理的jar包才需要指定版本 | 父pom中管理的jar包是基于springboot的父pom，外加已经验证能一起正常协作没有版本冲突的jar，且会关注jar的安全更新和升级 |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| dubbo配置                                                    | dubbo依赖                                                    | pom中是否引入了dubbo以及相关的curator和zookeeper的jar包，如果有应该删除，使用qjd-spring-boot-starter-dubbo | qjd-spring-boot-starter-dubbo维护了统一的dubbo版本依赖，启动的时候会自动加载公共的dubbo注册中心配置 |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| dubbo过滤器                                                  | 是否定了自己的dubboFilter处理PRC异常，如果有则需要删除       | qjd-spring-boot-starter-dubbo提供公共的exceptionFilter       |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 使用新的注解                                                 | @DubboReference代替@Refefence @DubboService代替@Service      | 反例：部分提供分页接口的jar包使用了pagehelper的PageInfo作为返回类，或者包含Mybatis-Plus的一些注解 |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| @Reference和@Service中是否固定写死版本？                     | 有些服务固定把版本号写1.0.0需要去掉固定的版本设置            |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| @EnableDubbo指定具体扫描的包                                 | 例如： @EnableDubbo(scanBasePackages = {"com.qjdchina.process", "com.qjdchina.activiti"}) | 可以提升启动速度                                             |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| @DubboService和@DubboReference不要固定指定version属性        | 避免类似这样的写法： @DubboReference(version="1.0.0")        | 环境路由会有问题                                             |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| jdbc数据源配置                                               | 使用mysql数据源的应用需要定义application.dabatases           | 数据源逻辑名使用物理库名去掉下划线 比如使用了ai_data数据库和db_search数据库，则配置的定义为 application.databases=aidata,dbsearch | 使用统一的命名规则避免同一个数据源多个key定义                |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| mybatis-plus配置                                             | Interceptor配置                                              | 删除原有的分页，乐观锁，防止全表更新与删除插件（框架已经默认加载这三个插件） |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| @TableLogic注解需要结合,@TableField(value = "is_deleted", fill = FieldFill.INSERT)才能自动填充值 | 老版本的mybatis-plus可以不加，升级后如果不加FiledFill配置则不会自动填充 |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 数据库AES加解密配置                                          | 引入 <dependency>     <groupId>com.qjdchina</groupId>     <artifactId>cryptor-aes</artifactId> </dependency> |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| Apollo配置(应用级别）                                        | 配置放在application.properties还是Apollo的application中的判断原则：不随环境变化的配置，尽量写在程序的application.properties中 | Apollo的application配置中，是否有一些不随环境变化的配置可以移动到应用的application.properties中 |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| datasource配置清理                                           | 删除数据源相关配置：spring.datasource开头的所有配置（连接大数据impala数据库除外） | 只要声明application.databases就可以加载对应数据源（支持多数据源） |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| dubbo配置清理                                                | 删除dubbo相关所有配置                                        | 引入qjd-spring-boot-starter-dubbo后会自动按照约定进行配置    |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| mybatis配置固化                                              | mybatis相关的配置放到应用的application.properties中例如：mybatis.mapper-locations等配置不会随环境变更 |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 两方系统URL定义                                              | 两方应用路径使用common.env中定义的key，例如：fs.rest.request.url改成common.fs.url 注意：定义URL的时候，尽量只到域名部分，且不以'/'结尾 例如：https://www.qjdchina.com/riskreport/api 放到apollo配置的时候，需要定义成qjd.www.url=https://www.qjdchina.com 然后程序中访问api的URL定义为 @Value("${qjd.www.url}/riskreport/api") | 提取公共前缀，尽量减少URL配置                                |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 线上环境判断方式统一                                         | 删除是否是生产环境的配置，比如product.mode或者online.check等这样的配置，代码中使用ProductModeUtil.isOnlineMode()代替 | 最好是代码中不要有类似的根据是否是线上环境做不同处理，如果一定要有（历史原因等）则使用统一的开关 |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 中间件优先使用qjd-common下的starter                          | 删除redis，elasticsearch，等中间件的配置，使用qjd-common 工程下的xxx-starter | 引入后会根据环境自动配置                                     |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 应用的配置只做删除不做修改                                   | Apollo的应用配置治理完成之后，一般只会删除原先各种冗余的配置，不会修改配置的值。如果有修改，则需要关注是否真的需要改变值。 | 删除的配置确保没有默认值相关的配置                           |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 老的应用删除xxl.job.executor.appname配置后记得修改xxl-job-admin中的执行器名称 | 执行器默认的名称为${app.id}-executor                         |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 不使用带有默认值的配置                                       | 代码中全局正则搜索使用默认值的配置 "\$\{[^:}]+:[^}]*\}"  如果有，则去掉默认值，并在Apollo中定义 | 避免不同环境漏了默认值设置，程序用错误的配置跑了业务         |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| Shiro鉴权框架引入                                            | 引入qjd-web-security                                         | 不用指定具体版本，由父pom统一管理                            |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 创建需要使用的Realm鉴权Bean                                  | 例如，使用ldap鉴权则创建以下Bean      @Bean     LdapAuthRealm ldapAuthRealm() {         return new LdapAuthRealm();     } |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 定义shiroFilter                                              | 应用定义一个FilterChainDef的bean，加入需要shiro过滤的路径，例如     @Bean     FilterChainDef filterChainDef() {         FilterChainDef chainDef = new FilterChainDef();         chainDef.add("/tender/detail", "anon");         chainDef.add("/**", "saas, ai");         return chainDef;     } |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 老的应用之前使用@Import方式导入的shiro-xxx.xml的需要去掉     | 比如需要去掉 @ImportResource({"classpath:process-shiro-config.xml"}) |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 功能冲突的三方Jar排除                                        | 日志配置框架                                                 | 应用是否定义了自己的log4j.xml和logback.xml等配置，如果有则需要删除对应的配置文件和jar包。 | 引入的starter统一对日志框架的jar包和日志格式，输出路径等进行处理。 |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| hibernate-validator                                          | 确认最终引入的是6.2.0-Final版本                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| qjd-log已废弃                                                | pom文件中删除依赖                                            |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| qjd-dao已废弃                                                | 使用qjd-spring-boot-starter-mybatis代替                      |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| qjd-lock已废弃                                               | 使用qjd-spring-boot-starter-lock代替                         | 使用redis+lua实现分布式锁的方案                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| qjd-jms已废弃                                                | 使用qjd-spring-boot-starter-activemq代替，并确认三方jar包是否有传递依赖qjd-jms有的话需要exclude |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| OSS配置                                                      | 使用qjd-spring-boot-starter-oss访问oss                       | 0. 一个应用只改访问一个oss的bucket 1. 引入qjd-spring-boot-starter-oss 2. 在applicatoin.properties中定义application.oss.name=fs来获取访问oss的bucket的组件 3. 注入OSSBucket对象进行oss访问     @Resource     private OSSBucket ossBucket; | 组件会根据配置                                               |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 使用redis                                                    | 使用qjd-spring-boot-starter-redis                            | 1. pom中引入去掉原先对redis，jedis等依赖，引入qjd-spring-boot-starter-redis 2. 代码中可注入RedisTemplate等原先spring的redis可用的组件，或者RedisHelper等更接近redis原始指令用法的组件。 |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 加入监控依赖                                                 | qjd-spring-boot-starter-monitor                              | pom文件中加入以下依赖做服务监控 <dependency>     <groupId>com.qjdchina.common</groupId>     <artifactId>qjd-spring-boot-starter-monitor</artifactId> </dependency> |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 线上k8s配置                                                  | 启动参数修改                                                 | devops平台应用的启动参数引用config-map中定义的配置加密key，覆盖secrets中定义的加密key。 |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| MessageConverter                                             | 升级SpringBoot之后，原先使用的MessageConverter如果从fastjson改成了Jackson的MessageConverter，则应该注意以下几点。 1. 日期的序列号和反序列化配置 2. 时区配置 3. 对象类型转String是否支持 4. 返回String的接口，是否序列化String类型的json的时候是否带上了"" | spring.jackson.date-format=yyyy-MM-dd HH:mm:ss spring.jackson.time-zone=GMT+8  #如果需要将date序列化成时间戳则用以下配置 spring.jackson.serialization.write-dates-as-timestamps=true |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                                                              |                                                              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |

| 问题                                                         | 原因                                                         | 原因分类         | 解决方案                                                     | 关联应用         |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ---------------- | ------------------------------------------------------------ | ---------------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 逻辑删除实体后用原先被删除的实体进行插入操作，会出现主键冲突。 | mybatis-plus升级之后，改变了@TableId(type = IdType.AUTO)的行为：原先不管id字段是否有值都进行自增赋值。升级后，id字段有值的时候不进行赋值。 | Mybatis-Plus升级 | 手动设置ID为null                                             | proof qjd-credit |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 返回Map类型的查询，原先的Date字段变成了LocalDateTime         | mybatis-plus升级之后，没有指定字段类型的情况，用LocalDateTime代替了Date，导致jackson序列化出错 | Mybatis-Plus升级 | 配置jackson支持LocalDateTime参考proof的 JacksonConfig LocalDateTimeSerializer | proof            |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| @TableLogic字段没有结合@TableField(fill = FieldFill.INSERT)的时候不会基于MetaObjectHandler进行自动填充 | mybatis-plus升级之后行为改变，某个字段需要进行自动填充，该字段必须加FieldFill | Mybatis-Plus升级 | 给@TableLogic的字段添加@TableField(fill = FieldFill.INSERT)  | proof            |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 使用构造器的基于类型注入代替DubboReference后，原先通过Bean名字获取ReferenceBean的方式报错 | 原先通过定义一个local的Bean指向DubboReference的方式，通过Bean名字获取没有问题。新的方式ReferenceBean没有有意义的名字，不能用于引用Bean | 应用框架升级     | 通过Bean的类型获取                                           | proof            |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| Json返回时间字段的时候原先返回时间戳，升级后返回了字符串格式 | proof定义了ObjectMapper类型的bean让springBoot的jackson的AutoConfig没有按照starter约定的规则配置，默认把date序列化成时间戳。升级后使用了约定的规则，日期格式变成了字符串。 | Json框架升级     | 配置jackson序列化日期为时间戳                                | proof            |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| com.google.common.util.concurrent.Futures.addCallback 2参数的方法找不到 | E签宝的guava版本为19.0                                       | guava升级        | dependencyManagement配置guava版本为19.0                      | proof            |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| 使用jackson作为MessageConverter之后，无参数的构造器会报错    | Jackson反序列化json到bean的时候需要bean提供无参数构造器，原先使用FastJsonHttpMessageConverter没有这个问题 | json框架替换     | 增加无参构造方法，或者定义一个FastJsonHttpMessageConverter的Bean且优先级@Order(-1) | crm              |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
| MultipartFile强制转换报错                                    | MultipartFile uploadedFile... CommonsMultipartFile cf = (CommonsMultipartFile) uploadedFile; 此处强制转换报错，springboot中MultipartFile接口有自己的实现类 | springboot升级   |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |
|                                                              |                                                              |                  |                                                              |                  |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |      |

# 事务

## 一、何为事务

一言蔽之，**事务是逻辑上的一组操作，要么都执行，要么都不执行。**

**可以简单举一个例子不？**

事务最经典也经常被拿出来说例子就是转账了。假如小明要给小红转账 1000 元，这个转账会涉及到两个关键操作就是：

1. 将小明的余额减少 1000 元
2. 将小红的余额增加 1000 元。

事务会把这两个操作就可以看成逻辑上的一个整体，这个整体包含的操作要么都成功，要么都要失败。

这样就不会出现小明余额减少而小红的余额却并没有增加的情况。



## 二、何为数据库事务？

数据库事务在我们日常开发中接触的最多了。如果你的项目属于单体架构的话，你接触到的往往就是数据库事务了。

平时，我们在谈论事务的时候，如果没有特指**分布式事务**，往往指的就是**数据库事务**。

**那数据库事务有什么作用呢？**

简单来说：数据库事务可以保证多个对数据库的操作（也就是 SQL 语句）构成一个逻辑上的整体。构成这个逻辑上的整体的这些数据库操作遵循：**要么全部执行成功,要么全部不执行** 。

```sql
# 开启一个事务
START TRANSACTION;
# 多条 SQL 语句
SQL1,SQL2...
## 提交事务
COMMIT;
```

![img](https://cdn.nlark.com/yuque/0/2021/png/317933/1634790835149-af973335-9dfb-41ca-9942-e246487a4396.png)

## 三、何为ACID



另外，关系型数据库（例如：MySQL、SQL Server、Oracle 等）事务都有 **ACID** 特性：

![img](https://cdn.nlark.com/yuque/0/2021/png/317933/1634790912144-d979e67a-bbde-452f-a748-6cec26479200.png)

1. **原子性**（Atomicity） ： 事务是最小的执行单位，不允许分割。事务的原子性确保动作要么全部完成，要么完全不起作用；
2. **一致性**（Consistency）： 执行事务前后，数据保持一致，例如转账业务中，无论事务是否成功，转账者和收款人的总额应该是不变的；
3. **隔离性**（Isolation）： 并发访问数据库时，一个用户的事务不被其他事务所干扰，各并发事务之间数据库是独立的；
4. **持久性**（Durability）： 一个事务被提交之后。它对数据库中数据的改变是持久的，即使数据库发生故障也不应该对其有任何影响。



## 四、并发事务带来哪些问题

在典型的应用程序中，多个事务并发运行，经常会操作相同的数据来完成各自的任务（多个用户对同一数据进行操作）。并发虽然是必须的，但可能会导致以下的问题。

- **脏读（Dirty read）:** 当一个事务正在访问数据并且对数据进行了修改，而这种修改还没有提交到数据库中，这时另外一个事务也访问了这个数据，然后使用了这个数据。因为这个数据是还没有提交的数据，那么另外一个事务读到的这个数据是“脏数据”，依据“脏数据”所做的操作可能是不正确的。
- **丢失修改（Lost to modify）:** 指在一个事务读取一个数据时，另外一个事务也访问了该数据，那么在第一个事务中修改了这个数据后，第二个事务也修改了这个数据。这样第一个事务内的修改结果就被丢失，因此称为丢失修改。 例如：事务 1 读取某表中的数据 A=20，事务 2 也读取 A=20，事务 1 修改 A=A-1，事务 2 也修改 A=A-1，最终结果 A=19，事务 1 的修改被丢失。
- **不可重复读（Unrepeatable read）:** 指在一个事务内多次读同一数据。在这个事务还没有结束时，另一个事务也访问该数据。那么，在第一个事务中的两次读数据之间，由于第二个事务的修改导致第一个事务两次读取的数据可能不太一样。这就发生了在一个事务内两次读到的数据是不一样的情况，因此称为不可重复读。
- **幻读（Phantom read）:** 幻读与不可重复读类似。它发生在一个事务（T1）读取了几行数据，接着另一个并发事务（T2）插入了一些数据时。在随后的查询中，第一个事务（T1）就会发现多了一些原本不存在的记录，就好像发生了幻觉一样，所以称为幻读。



**不可重复读和幻读区别：**

不可重复读的重点是修改比如多次读取一条记录发现其中某些列的值被修改，幻读的重点在于新增或者删除比如多次读取一条记录发现记录增多或减少了。



## 五、事务隔离级别有哪些?

SQL 标准定义了四个隔离级别：

- **READ-UNCOMMITTED(读取未提交)：** 最低的隔离级别，允许读取尚未提交的数据变更，**可能会导致脏读、幻读或不可重复读**。
- **READ-COMMITTED(读取已提交)：** 允许读取并发事务已经提交的数据，**可以阻止脏读，但是幻读或不可重复读仍有可能发生**。
- **REPEATABLE-READ(可重复读)：** 对同一字段的多次读取结果都是一致的，除非数据是被本身事务自己所修改，**可以阻止脏读和不可重复读，但幻读仍有可能发生**。
- **SERIALIZABLE(可串行化)：** 最高的隔离级别，完全服从 ACID 的隔离级别。所有的事务依次逐个执行，这样事务之间就完全不可能产生干扰，也就是说，**该级别可以防止脏读、不可重复读以及幻读**。

------

| **隔离级别**     | **脏读** | **不可重复读** | **幻读** |
| ---------------- | -------- | -------------- | -------- |
| READ-UNCOMMITTED | √        | √              | √        |
| READ-COMMITTED   | ×        | √              | √        |
| REPEATABLE-READ  | ×        | ×              | √        |
| SERIALIZABLE     | ×        | ×              | ×        |

MySQL InnoDB 存储引擎的默认支持的隔离级别是 **REPEATABLE-READ（可重读）**。我们可以通过**SELECT @@tx_isolation;**命令来查看



## 六、Spring事务原理

**从本质上来讲，Spring事务就是数据库事务。**

Spring事务流程与数据库事务大致是一致的：

```java
## 1.获取数据库链接，修改为手动提交
transaction = getTransaction();
## 2.执行代码
execute();
## 3.判断是否有异常需要回滚
transaction.rollback() || transaction.commit();
```

### TransactionInterceptor

Spring中，事务常见的使用方式是在方法上加注解@Transactional，而其对应的实现即为org.springframework.transaction.interceptor.TransactionInterceptor。详见代码。



## 七、使用中常见问题

### 1、明明加了@Transactional注解，但是事务没有生效，报错没有触发回滚

1）当前类可能不是Spring管理的Bean

2）内部调用，没有通过代理类调用

3）异常类型不是指定的回滚类型

4）存在多个数据库链接，没有指定对应的transactionManager

### 2、明明catch住了异常，结果还是回滚了

这个是因为调用了有事务的方法，transactionStatus 已经被标记为rollBackOnly

# 错误信息规范

错误提示或错误日志要能体现出具体原因

# 日志规范

# 1：不允许使用system.out 或者使用printStackTrace()

要统一使用项目的日志 尽量使用sl4j 标准接口  方便做统一管理，

（1）：如果后面禁止了控制台输出 上面的日志也就不会出现了  

（2）：链路id无法追加到上面的输出上



若有收获，就点个赞吧

































# 2021年11月

1、上个月做的事，然后做的怎么样了；
2、这个月的目标，计划怎么去做去落实；
3、接下来一段时间，比如3个月或者6个月的一个目标和计划。

## 11月做的事情

### 环境路由

#### 总体目标：

全面推进环境路由的使用，提升研发效能：

环境路由能力功能提升：如支持web层的本地开发调试，ingress支持子环境

开发、测试环境统一：下线掉现有开发环境，统一使用testa环境；50%的业务qa使用testa环境测试

基础环境的稳定性提升：提升规格、去除远程debug、运行状态监控等

环境路由功能完善，尝试从broker层面解决消息路由的问题



#### 基础环境的稳定性提升

1. 定期人工查看testa环境的服务运行情况，解决部署、启动失败的问题，保持了环境的稳定性

#### 功能完善

1. 调整运维对mongodb/activemq集群的错误配置方式：原为nginx代理，改为了直连
2. 数据库时区修正，使应用连接与db管理平台效果一致
3. dubbo分组统一为环境名称，即testa，去除了特殊性
4. activemq环境路由插件，从broker层面解决了消息路由的问题
5. devops特性环境创建添加创建人等信息，便于追踪与及时资源回收
6. 网关环境路由的支持改造

#### 开发、测试环境一体化推广

1. 完成saas业务的qa培训环境路由
2. 完成大数据团队环境路由培训
3. 下线原开发环境：dev环境11.15正式对开发关闭
4. 一体化qa与技术leader沟通会：与qa与技术负责人一起，沟通推进问题，主要问题还是在数据上。最后达成结论，先完成新预发环境的搭建、数据的整理，支持日切功能的验证，然后数据同步到testa上。预计12.10以后qa也可以统一在testa环境上进行测试

### 监控报警系统

#### 总体目标：

1、从0-1打造调用链路画像系统，提供优化参考建议：sql、dubbo基本画像，链路长度，重复调用，循环依赖等 

2、打造一个简化的报警、工单系统：接入核心业务监控指标，系统问题自主发现率从0提升到30%

3、日志系统优化：制定日志规范，解决日志乱的问题；解决Kibana日志不完整问题 

4、基础设施全面监控：中间件、服务器、网络时延等全方位监控

5、BCP平台技术方案制定：给出框架，采集规则与校验结果

6、traceId端透出：准确提供故障现场，减少沟通成本，更快定位问题  -- 10.13已上线

7、性能优化：慢请求治理：优化掉web层90% 4S以上的请求

#### 监控报警系统开与优化

1. 邀请架构师评审、使用体验
2. 监控系统服务、实例名称的一致性改造，链路追踪、应用监控、与基础监控保持一致， 为将来数据整合做准备
3. 支持自定义规则、忽略指定异常规则、按照配置的PromQL发送消息等
4. 交互优化：添加时间范围选择框
5. 钉钉消息按照不同的群组进行发送
6. BCP业务核对添加指标项和监控规则
7. 首页统计昨日异常和高耗时统计信息息
8. 慢性能数据统计，异常情况统计，高耗时入口链路的span长度等分析
9. 链路数据解析，为业务链路性能分析、异常分析、业务重构等提供参考

1. 1. 统计分析所有端点调用信息，接口名称，数据库信息，SQL信息：供业务下线、重构参考
   2. 推动和协助业务修改链路异常问题

1. 月会分享“监控系统设计和实践”

#### 服务接入监控系统推进

1. 提供springboot和tomcat两种监控接入工具
2. 中间件监控接入：redis/rds的监控已接入，可在grafana上查看
3. 监控接入总体进展：应接入80，已接入30。https://cgfrqb.yuque.com/cgfrqb/exyntx/rbqdkc#GPIs

#### 服务稳定性治理

1. 长链路优化：链路数据从每天24G，降至19G
2. 异常治理：集中治理NPE，效果显著，从日均800+， 降至日均100+
3. 线上服务稳定性治理： 线上个别服务pod 不定期被系统杀死，在不增加资源的情况下，调整了线上内存占用超过97%的服务，调整后降到85%左右
4. 监控实时性：11.29日上午process所有流程处理都有异常，执行不下去，报警与业务反馈几乎同时到达

### 网关系统

#### 总体目标：

打造高性能统一鉴权、接入的网关系统：

1、完成具备基本功能的网关系统研发：环境路由、鉴权、接入dubbo、动态路由配置下发、功能开关等

2、部分业务接入：上线后，新业务接口全部使用网关，老业务完成小部分迁移

#### 网关系统开发：从0-1开发高性能网关系统

1. 启动立项
2. 网关技术评审
3. 基于jwt统一认证
4. 全响应式编程，高性能网关
5. 泛化调用的链路记录优化
6. 环境路由支持fluxWeb
7. 链路追踪支持fluxWeb
8. 网关管理平台开发、测试、部署
9. 网关开发、测试、部署

### 11月总结

环境路由功能已基本完善，稳定运行了2个多月。开发已全面使用这套环境，11.15下线了原开发环境。对大数据和qa团队分别组织了培训，从saas业务入手，逐步推行开发、测试环境一体化试点，取得较好的效果。与qa、开发leader沟通，随着新预发环境的搭建交付，12月中旬后，在其他业务逐步推行，收回test和test-project两套测试环境。



从0到1搭建了业务监控报警系统，服务接入率40%。从链路数据出发，对链路数据进行解析，为业务链路性能分析、异常分析、业务重构等提供了参考依据；并把链路中的异常第一时间报警给对应的开发负责人，第一时间处理。集中治理NPE，效果显著，从日均800+， 降至日均100+。线上个别服务pod 不定期被系统杀死，在不增加资源的情况下，调整了线上内存占用超过97%的服务，调整后降到85%左右



从0-1打造高性能通用网关系统，全面拥抱响应式编程。现已开发完成，待业务接入

## 12月份的目标

### 环境路由：

1. 稳定性自动化监控
2. 开发、测试环境一体化推进：开发、测试全面使用一套环境

### 监控报警系统：

1. 报警系统优化，解决重复报警过多的问题
2. 中间件监控接入
3. 异常治理推进
4. 性能优化推进：长链路优化、慢请求优化
5. 业务监控接入推进
6. 线上服务稳定性治理：在不增加资源的情况下，线上pod内存资源占比调到90%以下，降低POD自动重启的次数

### 网关系统：

1. 系统功能完善
2. 完成一个业务的接入



### 数据一致性

1. 分布式事务方案调研



## 长期目标

数据一致性

分布式事务

事务消息

BCP系统



系统稳定性提升

解决慢请求、慢sql

长链路治理

解决pod自重启问题

异常治理

监控优化



网关系统的接入与优化

限流

降级

熔断



DevOps平台研发

- 镜像打镜像，环境更干净
- 新的git分支模型
- 去除jenkins，降低复杂性
- 发布流水线：开发、测试、预发、线上大的发布流水线
- 对开发屏蔽k8s，使用更方便高效
- 收藏功能
- 新的发布模式：批量、灰度等
- 真正devops模式

- - devops模式推广：未来一定不是保姆式的服务模式

- sidecar研究
- 统计功能





# 全链路监控告警设计和实践

# 背景

随着微服务架构的流行，**服务按照不同的维度进行拆分**，一次请求往往需要涉及到多个服务。

因此，就需要一些可以帮助理解系统行为、用于分析性能问题的工具，以便发生故障的时候，能够快速定位和解决问题。

![img](https://cdn.nlark.com/yuque/0/2021/webp/334043/1635734909252-f99aa611-5a90-4b79-ba6c-064a136e4f0c.webp)

面对复杂的调用链路就带来一系列问题：



1. **如何快速发现问题？**
2. **如何判断故障影响范围？**
3. **如何梳理服务依赖以及依赖的合理性？**
4. **如何分析链路性能问题以及实时容量规划？**



因此,无论是运维还是从开发乃至于测试的角度来说,都需要一套监控系统



![img](https://cdn.nlark.com/yuque/0/2021/png/334043/1630471589784-043cdbc1-1ea1-4168-95f4-a2169914ad79.png)



# 设计

## SkyWalking

https://skywalking.apache.org/

SkyWalking是一个开源监控平台，用于从服务和云原生基础设施收集、分析、聚合和可视化数据。

SkyWalking提供了一种简单的方法来维护分布式系统的清晰视图，甚至可以跨云查看。它是一种现代APM，专门为云原生、基于容器的分布式系统设计。

SkyWalking从三个维度对应用进行监视：service（服务）, service instance（实例）, endpoint（端点）



生产环境地址：http://skywalking.qjdidc.com:8080/trace

![img](https://cdn.nlark.com/yuque/0/2021/png/334043/1635736428596-6aa2b13c-a97e-49f0-8c21-8aab690eea82.png)



## Prometheus

地址：http://qjd-test.qjdidc.com/

![img](https://cdn.nlark.com/yuque/0/2021/png/334043/1630477804147-656ba780-c0be-48a4-9230-efb8b220305c.png)



Prometheus（普罗米修斯）是由前google员工2015年正式发布的开源监控系统，采用Go语言开发。架构非常简单。

优势：

- **较强的处理能力**：监控数据直接存储在Prometheus Server本地的时序数据库中，单个实例可以处理数百万的metrics。
- **灵活的数据模型：**引入了tag，属于多维数据模型，聚合统计更方便。
- **强大的查询语句：**PromQL允许在同一个查询语句中，对多个metrics进行加法、连接和取分位值等操作。
- **很好地支持云环境**：能自动发现容器，同时k8s和etcd等项目都提供了对Prometheus的原生支持，是目前容器监控最流行的方案。



prometheus存储的是时序数据，即按相同时序(相同名称和标签)，以时间维度存储连续的数据的集合。

时序(time series)是由名字(Metric)以及一组key/value标签定义的，具有相同的名字以及标签属于相同时序。

**Metric**类型：

- Counter: 一种累加的metric，如请求的个数，结束的任务数，出现的错误数等
- Gauge: 常规的metric,如温度，可任意加减。其为瞬时的，与时间没有关系的，可以任意变化的数据。
- Histogram: 柱状图，用于观察结果采样，分组及统计，如：请求持续时间，响应大小。其主要用于表示一段时间内对数据的采样，并能够对其指定区间及总数进行统计。**根据统计区间计算**
- Summary: 类似Histogram，用于表示一段时间内数据采样结果，其直接存储quantile数据，而不是根据统计区间计算出来的。**不需要计算，直接存储结果**



## grafana

http://qjd-grafana.qjdchina.com  

只读账号：test  密码：test123!@#

![img](https://cdn.nlark.com/yuque/0/2021/png/334043/1630476419001-53ff597b-693a-46cb-870b-c686f861fa20.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0)

Grafana是一个跨平台的开源的度量分析和可视化工具，可以通过将采集的数据查询然后可视化的展示，并及时通知。



# 实践

![img](https://cdn.nlark.com/yuque/0/2021/png/334043/1635836686325-8f969641-501a-4476-822d-af4f59b41a98.png)

如何实现应用层和业务层监控

#### Spring Boot Actuator

Spring Boot Actuator可以帮助你监控和管理Spring Boot应用，比如健康检查、审计、统计和HTTP追踪、获取线程状态等。

```plain
 <dependencies>
        <dependency>
           <groupId>com.qjdchina.common</groupId>
            <artifactId>qjd-spring-boot-starter-monitor</artifactId>
            <version>1.0.0</version>
        </dependency>
</dependencies>


AppMonitor.biz("");
```

#### 黄金指标

![img](https://cdn.nlark.com/yuque/0/2021/png/334043/1635837572923-224531a3-5146-44f2-ad10-6746ed1b4374.png)

#### 监控告警

![img](https://cdn.nlark.com/yuque/0/2021/png/334043/1635837845513-979b9497-14fa-41b9-92ca-9e03908af9a4.png)



告警汇集

异常事件发现

精准分派相关人员

多维度告警分析

监控体系（自底向上）系统层监控⚫系统监控：CPU、Load、Memory、Swap、Disk IO、Processes、Kernel Parameters、......⚫网络监控：网络设备、工作负载、网络延迟、丢包率、......中间件及基础设施类系统监控⚫消息中间件：Kafka、RocketMQ和RabbitMQ等；⚫Web服务容器：Tomcat和Jetty等；⚫数据库及缓存系统：MySQL、PostgreSQL、MogoDB、ElasticSearch和Redis等；⚫数据库连接池：ShardingSpere等；⚫存储系统：Ceph等应用层监控⚫用于衡量应用程序代码的状态和性能业务层监控⚫用于衡量应用程序的价值，例如电子商务网站上的销售量⚫QPS、DAU日活、转化率；⚫业务接口：登录数、注册数、订单量、搜索量和支付量等； 马哥教育ww监控告警



![img](https://cdn.nlark.com/yuque/0/2021/png/334043/1635737310735-b754bc37-1f8c-4799-9b9a-9bf34239ebe1.png)

@Data
@ToString
public class Product implements Serializable {

    @Math(name = "收入")
    private Integer in1;
    
    @Math(name = "首付款比率")
    private BigDecimal in2;
    
    @Math(name = "经销商支付首付款银行承兑汇票比率")
    private BigDecimal in3;
    
    @Math(name = "贴息率")
    private BigDecimal in4;
    
    @Math(name = "银承天数")
    private BigDecimal in5;
    
    @Math(name = "首付款比率")
    private BigDecimal in6;
    
    @Math(name = "赊销周期")
    private BigDecimal in7;
    
    @Math(name = "赊销周期1")
    private BigDecimal in8;
    }
| **对比维度**         | **环境路由之前**                                             | **环境路由**                                                 |
| -------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 环境创建速度         | 周级别，两周以上                                             | 分钟级                                                       |
| 资源节约             | 每套环境涉及80+服务、10+中间件，需要全套部署，资源持续占用   | 资源复用，仅需部署需求变动涉及的服务；用完回收资源           |
| 环境数量             | 限于环境创建速度及资源，现仅有三套开发环境+两套测试环境，对于大量的并行需求远远不够 | 理论上无限                                                   |
| 构建次数             | 在服务器上构建，平均一次4分钟；改动一次，需提交构建一次      | 基本上是本地启动，仅有少量构建次数                           |
| 问题定位效率         | 小时级；涉及多人一起定位                                     | 分钟级；可个人独立定位                                       |
| 调试效率             | debug时，造成整体业务流程阻塞                                | 流量劫持到本地环境，无阻塞                                   |
| 环境稳定性           | 固定分支模型，不同的需求代码合并在一起，冲突严重，环境不稳定， | 以业务需求为单位的分支模型，环境隔离，无冲突，环境稳定       |
| 开发、测试环境一致性 | 物理隔离，开发、测试各自使用自己的环境，环境相关的数据及配置需要做两遍，并且要手动更新到另外三套环境 | 以业务需求为维度，开发、测试共用一套虚拟环境，数据准备仅需一次；上线后自动维护基础环境 |

提升40%的开发效率：从saas2.0的研发周期来看，代码开发一周、联调一周、测试一周，总体提升40%是没有问题的。不包括前期的需求分析、技术评审、架构设计等阶段

节省服务器资源：5套环境，28个节点，平均一套环境6个节点（4 cpu、16G内存），包括数据库等独立资源

# 告警

Apache SkyWalking告警是由一组规则驱动，这些规则定义在config/alarm-settings.yml文件中。

告警规则的定义分为三部分。

1. **告警规则**：定义了触发告警所考虑的条件。
2. **webhook**：当告警触发时，被调用的服务端点列表。
3. **gRPCHook**：当告警触发时，被调用的远程gRPC方法的主机和端口。
4. **Slack Chat Hook**：当告警触发时，被调用的Slack Chat接口。
5. **微信 Hook**：当告警触发时，被调用的微信接口。
6. **钉钉 Hook**：当告警触发时，被调用的钉钉接口。

#### 告警规则

告警规则有两种类型，单独规则（Individual Rules）和复合规则（Composite Rules），复合规则是单独规则的组合。

##### 单独规则（Individual Rules）

单独规则主要有以下几点：

- **规则名称**：在告警信息中显示的唯一名称，必须以_rule结尾。
- **metrics-name**：度量名称，也是OAL脚本中的度量名。默认配置中可以用于告警的度量有：**服务**，**实例**，**端点**，**服务关系**，**实例关系**，**端点关系**。它只支持long,double和int类型。
- **include-names**：包含在此规则之内的实体名称列表。
- **exclude-names**：排除在此规则以外的实体名称列表。
- **include-names-regex**：提供一个正则表达式来包含实体名称。如果同时设置包含名称列表和包含名称的正则表达式，则两个规则都将生效。
- **exclude-names-regex**：提供一个正则表达式来排除实体名称。如果同时设置排除名称列表和排除名称的正则表达式，则两个规则都将生效。
- **include-labels**：包含在此规则之内的标签。
- **exclude-labels**：排除在此规则以外的标签。
- **include-labels-regex**：提供一个正则表达式来包含标签。如果同时设置包含标签列表和包含标签的正则表达式，则两个规则都将生效。
- **exclude-labels-regex**：提供一个正则表达式来排除标签。如果同时设置排除标签列表和排除标签的正则表达式，则两个规则都将生效。

标签的设置必须把数据存储在meter-system中，例如：Prometheus, Micrometer。以上四个标签设置必须实现LabeledValueHolder接口。

- **threshold**：阈值。

对于多个值指标，例如**percentile**，阈值是一个数组。像value1 value2 value3 value4 value5这样描述。
每个值可以作为度量中每个值的阈值。如果不想通过此值或某些值触发警报，则将值设置为 -。
例如在**percentile**中，value1是P50的阈值，value2是P75的阈值，那么-，-，value3, value4, value5的意思是，没有阈值的P50和P75的**percentile**告警规则。

- **op**：操作符，支持>, >=, <, <=, =。
- **period**：多久告警规则需要被检查一下。这是一个时间窗口，与后端部署环境时间相匹配。
- **count**：在一个周期窗口中，如果按**op**计算超过阈值的次数达到**count**，则发送告警。
- **only-as-condition**：true或者false，指定规则是否可以发送告警，或者仅作为复合规则的条件。
- **silence-period**：在时间N中触发报警后，在**N -> N + silence-period**这段时间内不告警。 默认情况下，它和**period**一样，这意味着相同的告警（同一个度量名称拥有相同的Id）在同一个周期内只会触发一次。
- **message**：该规则触发时，发送的通知消息。

举个例子：

```plain
rules:
  service_resp_time_rule:
    metrics-name: service_resp_time
    op: ">"
    threshold: 1000
    period: 10
    count: 2
    silence-period: 10
    message: 服务【{name}】的平均响应时间在最近10分钟内有2分钟超过1秒
  service_instance_resp_time_rule:
    metrics-name: service_instance_resp_time
    op: ">"
    threshold: 1000
    period: 10
    count: 2
    silence-period: 10
    message: 实例【{name}】的平均响应时间在最近10分钟内有2分钟超过1秒
  endpoint_resp_time_rule:
    metrics-name: endpoint_avg
    threshold: 1000
    op: ">"
    period: 10
    count: 2
    message: 端点【{name}】的平均响应时间在最近10分钟内有2分钟超过1秒
```

##### 复合规则（Composite Rules）

复合规则仅适用于针对相同实体级别的告警规则，例如都是服务级别的告警规则：service_percent_rule && service_resp_time_percentile_rule。
**不可以**编写不同实体级别的告警规则，例如服务级别的一个告警规则和端点级别的一个规则：service_percent_rule && endpoint_percent_rule。

复合规则主要有以下几点：

- **规则名称**：在告警信息中显示的唯一名称，必须以_rule结尾。
- **expression**：指定如何组成规则，支持&&, ||, ()操作符。
- **message**：该规则触发时，发送的通知消息。

举个例子：

```plain
rules:
  service_resp_time_rule:
    metrics-name: service_resp_time
    op: ">"
    threshold: 1000
    period: 10
    count: 2
    silence-period: 10
    message: 服务【{name}】的平均响应时间在最近10分钟内有2分钟超过1秒
  service_sla_rule:
    metrics-name: service_sla
    op: "<"
    threshold: 8000
    period: 10
    count: 2
    silence-period: 10
    message: 服务【{name}】的成功率在最近10分钟内有2分钟低于80％
composite-rules:
  comp_rule:
    expression: service_resp_time_rule && service_sla_rule
    message: 服务【{name}】在最近10分钟内有2分钟超过1秒平均响应时间超过1秒并且成功率低于80％
```

#### Webhook

Webhook 要求一个点对点的 Web 容器。告警的消息会通过 HTTP 请求进行发送，请求方法为 POST，Content-Type 为 application/json，JSON 格式包含以下信息：

- **scopeId**：目标 Scope 的 ID。
- **name**：目标 Scope 的实体名称。
- **id0**：Scope 实体的 ID。
- **id1**：未使用。
- **ruleName**：您在 alarm-settings.yml 中配置的规则名。
- **alarmMessage**. 告警消息内容。
- **startTime**. 告警时间戳，当前时间与 UTC 1970/1/1 相差的毫秒数。

举个例子：

```plain
[{
	"scopeId": 1, 
	"scope": "SERVICE",
	"name": "one-more-service", 
	"id0": "b3JkZXItY2VudGVyLXNlYXJjaC1hcGk=.1",  
	"id1": "",  
    "ruleName": "service_resp_time_rule",
	"alarmMessage": "服务【one-more-service】的平均响应时间在最近10分钟内有2分钟超过1秒",
	"startTime": 1617670815000
}, {
	"scopeId": 2,
	"scope": "SERVICE_INSTANCE",
	"name": "e4b31262acaa47ef92a22b6a2b8a7cb1@192.168.30.11 of one-more-service",
	"id0": "dWF0LWxib2Mtc2VydmljZQ==.1_ZTRiMzEyNjJhY2FhNDdlZjkyYTIyYjZhMmI4YTdjYjFAMTcyLjI0LjMwLjEzOA==",
	"id1": "",
    "ruleName": "instance_jvm_young_gc_count_rule",
	"alarmMessage": "实例【e4b31262acaa47ef92a22b6a2b8a7cb1@192.168.30.11 of one-more-service】的YoungGC次数在最近10分钟内有2分钟超过10次",
	"startTime": 1617670815000
}, {
	"scopeId": 3,
	"scope": "ENDPOINT",
	"name": "/one/more/endpoint in one-more-service",
	"id0": "b25lcGllY2UtYXBp.1_L3RlYWNoZXIvc3R1ZGVudC92aXBsZXNzb25z",
	"id1": "",
    "ruleName": "endpoint_resp_time_rule",
	"alarmMessage": "端点【/one/more/endpoint in one-more-service】的平均响应时间在最近10分钟内有2分钟超过1秒",
	"startTime": 1617670815000
}]
```

#### gRPCHook

告警消息将使用 Protobuf 类型通过gRPC远程方法发送。消息格式的关键信息定义如下：

```plain
syntax = "proto3";

option java_multiple_files = true;
option java_package = "org.apache.skywalking.oap.server.core.alarm.grpc";

service AlarmService {
    rpc doAlarm (stream AlarmMessage) returns (Response) {
    }
}

message AlarmMessage {
    int64 scopeId = 1;
    string scope = 2;
    string name = 3;
    string id0 = 4;
    string id1 = 5;
    string ruleName = 6;
    string alarmMessage = 7;
    int64 startTime = 8;
}

message Response {
}
```

#### Slack Chat Hook

您需要遵循[传入Webhooks入门指南](https://api.slack.com/messaging/webhooks)并创建新的Webhooks。

如果您按以下方式配置了Slack Incoming Webhooks，则告警消息将按 Content-Type 为 application/json 通过HTTP的 POST 方式发送。

举个例子：

```plain
slackHooks:
  textTemplate: |-
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": ":alarm_clock: *Apache Skywalking Alarm* \n **%s**."
      }
    }
  webhooks:
    - https://hooks.slack.com/services/x/y/z
```

#### 微信Hook

只有微信的企业版才支持 Webhooks ，如何使用微信的 Webhooks 可参见[如何配置群机器人](https://work.weixin.qq.com/help?doc_id=13376)。

如果您按以下方式配置了微信的 Webhooks ，则告警消息将按 Content-Type 为 application/json 通过HTTP的 POST 方式发送。

举个例子：

```plain
wechatHooks:
  textTemplate: |-
    {
      "msgtype": "text",
      "text": {
        "content": "Apache SkyWalking 告警: \n %s."
      }
    }
  webhooks:
    - https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=dummy_key
```

#### 钉钉 Hook

您需要遵循[自定义机器人开放](https://ding-doc.dingtalk.com/doc#/serverapi2/qf2nxq/uKPlK)并创建新的Webhooks。为了安全起见，您可以为Webhook网址配置可选的密钥。

如果您按以下方式配置了钉钉的 Webhooks ，则告警消息将按 Content-Type 为 application/json 通过HTTP的 POST 方式发送。

举个例子：

```plain
dingtalkHooks:
  textTemplate: |-
    {
      "msgtype": "text",
      "text": {
        "content": "Apache SkyWalking 告警: \n %s."
      }
    }
  webhooks:
    - url: https://oapi.dingtalk.com/robot/send?access_token=dummy_token
      secret: dummysecret
```



若有收获，就点个赞吧

# 谈代码架构的可扩展性

# 什么是可扩展性?



### 可维护性



想要好维护, 那么第一任务就是你写的代码要让别人看得懂

因为我们的代码，当他不运行的时候，就是一个纯文本



《[如何写出让同事无法维护的代码？](about:blank)》



**单字母的变量名**。比如：a，b，c，x，y，z（如果不够用，可以考虑 a1，a2，a3，a4，….）

**有创意地拼写错误。**比如：SetPintleOpening， SetPintalClosing，这样可以让人很难搜索代码。

**缩写。**比如：WTF，RTFSC …… （使用拼音缩写也同样给力，比如： BT，TMD，TJJTDS）

**混淆l和1。**字母 l 和数字 1 有时候是看不出来的。

**在注释中撒谎**。你不用真的去撒谎，只需在改代码的时候不要更新注释就可以了。

**从不验证**。从不验证输入的数据，从不验证函数的返回值。这样做可以向大家展示你是多么的信任公司的设备和其它程序员

**分解条件表达式**。如：把 a==100 分解成，a>99 && a<101

**大量使用嵌套**。一个 NB 的程序员可以在一行代码上使用超过 10 层的小括号（），或是在一个函数里使用超过 20 层的语句嵌套{}，把嵌套的 if else 转成 [? :] 也是一件很 NB 的事。

**测试是懦夫行为**。一个勇敢的程序员是根本不需要这一步的





### 可扩展性





![img](https://cdn.nlark.com/yuque/0/2020/png/722705/1590375977593-9f2b0d7a-f866-401e-8200-bcff0703b2b0.png)



扩展性差的代码例子



**Duplicated Code （重复代码）**



重复代码就是不同地点，有着相同的程序结构。一般是因为需求迭代比较快，开发小伙伴担心影响已有功能，就复制粘贴造成的。重复代码很难维护的，如果你要修改其中一段的代码逻辑，就需要修改多次，很可能出现遗漏的情况。

![img](https://cdn.nlark.com/yuque/0/2021/png/334043/1630291847308-ad6e3dc2-f615-4e31-8378-8a65570ade25.png)



![img](https://cdn.nlark.com/yuque/0/2021/png/334043/1630291951350-c4cceb11-87db-40d5-95a5-1bfd42ca4d1a.png)



**Long Method (长函数)**

长函数是指一个函数方法几百行甚至上千行，可读性大大降低，不便于理解。反例如下：

![img](https://cdn.nlark.com/yuque/0/2021/png/334043/1630292215049-cb83397e-60cd-4c29-8f92-fc7c9366f8c4.png)

**Large Class (过大的类)**

一个类做太多事情，维护了太多功能，可读性变差，性能也会下降。举个例子，老授信的功能

风控终审等全部在一个类中维护

![img](https://cdn.nlark.com/yuque/0/2021/png/334043/1630292781426-779ea4e8-6ed8-4d33-b713-3cdf446d675d.png)



**总结**

**可扩展性表现在** 

基础架构不需要经常变更，应用之间较少依赖或耦合

每次新加的代码或者补丁能够在合适的位置合适的地方找打它的位置（不影响原来的代码，不改动原来的代码）



# 怎么提高代码的可扩展性?



关于可扩展代码，我们要讨论的主要方面是：逻辑可扩展性(正常的逻辑流程和设计模式)，模块化设计以及去耦和封装。

—— 《[重构-改善既有代码设计](https://blog.csdn.net/culi4814/article/details/108386573)》



### 合理运用设计模式



设计模式是在某种场合下对某个问题的一种解决方案。如果再通俗一点说，设计模式就是给面向对象软件开发中的一些好的设计取个名字。



![img](https://cdn.nlark.com/yuque/0/2021/png/1032788/1614742652906-b652e92e-a824-433c-9204-68e5e2faa5c2.png)

**模板方法**

模板方法模式是一种行为设计模式，它定义一个操作中的算法的骨架，而将一些步骤延迟到子类中。 模板方法使得子类可以不改变一个算法的结构即可重定义该算法的某些特定步骤的实现方式。



![img](https://cdn.nlark.com/yuque/0/2021/png/334043/1630293885075-e2192355-8a47-4dbf-95aa-21fd06d65d59.png)

**适配器模式**

适配器模式(Adapter Pattern) 将一个接口转换成客户希望的另一个接口，适配器模式使接口不兼容的那些类可以一起工作，其别名为包装器(Wrapper)。

![img](https://cdn.nlark.com/yuque/0/2021/png/334043/1630299566867-4eb6756f-0f30-4099-890a-9551059a274e.png)



### AOP等增强

AOP 的全称是“Aspect Oriented Programming”，即面向切面编程，它将业务逻辑的各个部分进行隔离，使开发人员在编写业务逻辑时可以专心于核心业务，从而提高了开发效率。

AOP 采取横向抽取机制，取代了传统纵向继承体系的重复性代码，其应用主要体现在事务处理、日志管理、权限控制、异常处理等方面。

![img](https://cdn.nlark.com/yuque/0/2021/png/334043/1630299776966-85ef7645-6a62-4df4-9084-2d0f5a9f48bb.png)



### SPI机制实现



SPI的全名为Service Provider Interface.这个是针对厂商或者插件的。

java spi就是提供这样的一个机制：为某个接口寻找服务实现的机制

![img](https://cdn.nlark.com/yuque/0/2021/png/334043/1630300848627-faed8e06-8309-447f-975a-8cad41004d46.png)



### 异步事件Event



很多时候当我们完成某些业务后需要给用户推送相关消息提醒。对于这种非核心业务功能我们可以拿出来，创建一个事件去异步执行，从而实现核心业务和子业务的解耦。



比如用户注册成功以后，系统要给用户发送一封邮件，同时还要给用户发放优惠券，为了跟注册流程解耦，可以在注册成功以后发出一个事件，让其他服务来监听。

### 分布式服务

分布式服务可以通过接口降低系统的耦合性，不同的子系统之间通过相同的接口描述调用服务。



![img](https://cdn.nlark.com/yuque/0/2021/png/334043/1629688993692-c40da90a-7b98-4c1c-a241-5b47524875a4.png)

**单一应用框架**：当网站流量很小时，只需一个应用，将所有功能都部署在一起。

**分布式服务架构**：当垂直应用越来越多，应用之间交互不可避免，将核心业务抽取出来，作为独立的服务，逐渐形成稳定的服务中心，使前端应用能更快速的响应多变的市场需求。此时，用于提高业务复用及整合的分布式服务框架(RPC)是关键。



### 消息队列

消息队列中间件是分布式系统中重要的组件，主要解决应用解耦，异步消息，流量削锋等问题，实现高性能，高可用，可伸缩和最终一致性架构。

![img](https://cdn.nlark.com/yuque/0/2021/png/21872851/1629437156240-de6e86ae-2736-46c9-8c5b-d3983fcab7bd.png)

#### 

### DDD领域驱动设计

领域驱动设计是一种解决业务复杂性的设计思想，不是一种标准规则的解决方法。



在系统复杂之后，我们都需要用分治来拆解问题。一般有两种方式，技术维度和业务维度。技术维度是类似MVC这样，业务维度则是指按业务领域来划分系统。



[阿里技术专家详解 DDD 系列 第一讲- Domain Primitive](https://zhuanlan.zhihu.com/p/340911587)

[阿里技术专家详解DDD系列 第二讲 - 应用架构](https://zhuanlan.zhihu.com/p/343388831)

[阿里技术专家详解DDD系列 第三讲 - Repository模式](https://zhuanlan.zhihu.com/p/348706530)

[阿里技术专家详解DDD系列 第四讲 - 领域层设计规范](https://zhuanlan.zhihu.com/p/356518017)

[阿里技术专家详解DDD系列 第五讲：聊聊如何避免写流水账代码](https://zhuanlan.zhihu.com/p/366395817)

# 可扩展性可能存在的弊端



#### 过度设计



我们未必有能力设计出，对未来考虑足够周全的系统。



这通常是由于开发者过分自信导致的，

60% 的程序员认为自己是属于天才和良好类，只有 30% 左右的人认为他们是一般的程序员。

但实际上，只有不到 1% 的程序员属于天才程序员，有 10% 的良好程序员，其余大量的程序员是一般程序员。

—— 《[屋中的大象](https://www.oschina.net/news/79166/apache-foundation-ceo-decades-views)》



我们能欣赏漂亮设计的优雅之处，不代表我们也能做出这样的设计。



#### 成本和适用性



我们不确定现实项目是否需要这样的设计。

采取任何决策，都不是免费的，总会有各方成本的权衡。

况且，可扩展性设计，在不恰当的场景中，还会有自己的弊端。



### 结语

我们都期望当前维护的系统具有高度可扩展性，以减少眼前的工作负担，

但是，一方面这类系统实际上需要很强的预见性才能设计出来，难免出现偏差。

另一方面，高可扩展性也未必没有弊端，是否具有优势也与当前的项目场景有关。



此外，除了从技术角度考虑软件本身的设计和实现之外，

我们还可以跳出来，从工程角度来重新看待这个问题。

有时候，维护一个高可扩展性的软件系统，可能反而不如简单系统外加合适的变更方案更有效。



毕竟，目前软件都是由人来参与的，

并用来解决人的问题。