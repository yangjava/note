[TOC]

# 7 大版块 | 全面解读与认知支付系统

2018-06-28 16:04:56 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/80844493

大家好，Ping++ 支付学院真的来了。我是支付学院的教导主任，接下来由我为大家带来一些支付的知识，希望大家快乐学习，有所收获。

![img](https://img-blog.csdn.net/20180628154614131?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

 

## 说好的「干货」，绝不掺水

 

最硬干货将会是「全面解读与认知支付系统」，来自秋秋老师在支付学院往期活动上的精彩分享。整个支付架构和功能模块设计，均为秋秋老师根据自身的多年从业经验，对于「支付」的理解和深入实践的总结。由于支付设计本身包含的内容量多、复杂，故根据业务版块拆分，具体请看下图：

![img](https://img-blog.csdn.net/2018062815465915?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

看起来有些头晕，所以我们一块一块分开聊。如果有任何不懂的，记得留言，到时候再拿出来一起探讨。

#  

# **「** **7 大版块****」，召唤支付****神龙**

### **01**

由上图可知，我们从「收银台管理」开始：

![img](https://img-blog.csdn.net/20180628155125372?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

分为三个部分是不是就清晰多了。第一节课会对「收银台管理」进行一下详细讲解，不要走开，精彩马上就来。

 

### **02**

 

学习了「收银台管理」之后，接下来学习的是「支付核心」，顾名思义，希望大家能够认真学习（ 敲黑板 ）。支付核心内容较多，如下图：

 

![img](https://img-blog.csdn.net/20180628155949594?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

 

这个版块的内容不仅多，而且很重要，届时根据具体情况，可能会拆分为1~3篇来为大家讲解。

 

### 03

 

第三个版块是「清算核心」，分为4个部分：

 

![img](https://img-blog.csdn.net/2018062816002741?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

 

虽然大纲内容看起来不多，但实际上内容不少，各位同学要做好心理准备，记好笔记。

 

### 04

 

接下来，第四个版块是「账务核心」。要想做好支付，一定要把账务这部分内容学好：

 

![img](https://img-blog.csdn.net/20180628160109178?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

 

这一部分内容会从基础讲起，所以没有财会背景的同学也不必担心，只要认真学习就会有所收获。

 

### 05

 

第五部分同样亲切友好，从「 0 」开始讲「会计核心」。要想懂「支付」，那先得懂财会，主任再强调一遍：

 

![img](https://img-blog.csdn.net/20180628160138707?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

 

这一部分内容较多，可能需要2~5篇内容才能讲清楚，非常适合零基础的同学们。

 

### 06

 

第六部分与上一版块联系十分紧密，主要讲「核算对账核心」：

 

![img](https://img-blog.csdn.net/20180628160205501?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

 

这一版块的内容要和上一版块结合起来学习，可以对财会知识有一个系统的理解。

 

### 07

 

最后，我们用「差错类调帐」来收尾：

 

![img](https://img-blog.csdn.net/20180628160227185?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

 

至此，我们对于「支付」这一概念就有一个较为清晰、全面的认知了，希望大家都能够努力学习，有所收获！

 

# 师生同心，其利断金

 

作为一个有趣又有料的学习社群，主任在此诚邀各位同学积极加入到建设学院的浪潮中来——翻译成大白话就是：

 

**大白话**

有什么想法、建议、问题，随时给支付学院留言。

 

我们非常欢迎也非常期待这个由所有人一起打造的支付学院未来的模样。

 

那么，这就要开始啦！第一堂课程备课中……

# 一篇文章讲完收银台管理

2018-07-26 21:41:18 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/81228213

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180705075620_18541.png)

收银台管理这节课总共可以分为 3 大部分：收银台流程、支付渠道管理以及充值处理流程。

 

# 一、收银台流程

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180705075635_21696.png)

我们在日常生活及业务中了解到关于收银台的逻辑大致入上图所示，就是收银台前端的基本逻辑，相对来说比较简单。但从后端技术层面来讲，里面的内容大致如下：

 

 

## 充值或者支付的请求：

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180705074216_46529.png)

发起支付或者充值请求之后，一般分为 3 种情况：

a.站内支付

b.站外支付

c.充值

站外支付又分为线上支付和线下支付。线上支付的具体类别可大致分为 3 种：账户支付、网管支付以及快捷支付。这里蛮好理解的不说太多。

 

## 提供默认可用支付/充值渠道：

 

流程开始之后，首先需要处理可用的支付渠道，其中的流程顺序为：

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180705074100_65366.png)

① 取得总支付渠道限制，获得可用支付渠道的一个合集；

② 取得业务对支付渠道的限制，这一环节就会得出一个与上一环节可用支付渠道的交集；

**接下来业务流程是相同的，分别再次：**

③ 检查收款方限制；

④ 检查商品限制；

⑤ 再次检查收款方限制；

⑥ 检查用户设定限制。

每个环节都会得到一个与上一环节可用支付渠道的交集并得出本环节可用支付渠道的最终合集，层层筛查，进入下一环节。

 

 

## 处理优先默认的支付渠道：

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180705074337_42398.png)

进入这一流程时，首先会对业务产品指定有一个判断，在非业务产品指定的大前提下：

首先**判断是否提供支付账户**，如果提供，则根据账户记忆进入下一步，再次判断是支付渠道是否可用，在可用的情况下则按指定规则有限默认完成本环节进入下一环节；在不可用的情况下按原始规则有限默认，并完成本环节进入下一环节。

如果**不提供支付账户**，则根据 cookies 记忆进入下一步，判断支付渠道是否可用，再根据实际情况选择指定规则有限默认或原始规则有限默认结束并进入下一环节。

当然，如果**判断是业务指定产品**，则直接进入支付渠道是否可用的判断，后续判断环节与上述相同。

 

 

## 用户选择支付/充值渠道环节：

 

这一节与我们的日常生活比较贴近，所以非常好理解。

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180705074506_23942.png)

首先是用户选择**支付**渠道，会立即进入一个是否满足手机护航的判定：

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180705074744_70248.png)

**判定满足** 那就输入手机动态口令和支付密码，然后进行一次校验；校验没有问题就进入支付渠道限额检查；这里风控会同步进行一个控制；成功之后就会执行支付了。

**判定不满足** 则输入支付密码，同样经过校验后进入支付渠道限额检查、风控控制，成功之后执行支付。

其次是用户选择充值渠道，这里列举了几个比较有代表性的充值渠道：

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180705074846_97413.png)

根据各渠道特性流程上略有区别，例如快捷充值，选择快捷充值，登录账户后选择一开通快捷支付的银行卡，输入充值金额，按照提示输入支付密码和手机验证码来完成支付。

 

 

# 二、支付渠道管理

 

这一部分内容主要分为 3 个小版块：支付渠道任务模型、支付渠道各类配置以及支付渠道优先默认规则。

## 支付渠道任务模型：

服务使用模型：“服务使用”是最常见也是最复杂的支付渠道配置目标。因此在本章中，主要针对服务使用模型来举例：

假设 2018 年 7 月 3 日，卖家秋秋老师与买家支付学院主任在购物平台上通过招行 B2C 网关渠道使用商品购买服务交易一个数码产品鸭梨手机。

分为六个维度来解读：

 

\1. **服务维度：服务维度是对所有服务从业务角度划分得到的标准分类体系。**这套分类体系不但能够井井有条地组织所有的业务服务，而且在未来推出新的服务时，可以方便地进行扩展。基于这套标准分类体系，我们为每一个具体的服务分配唯一、固定的 ID，作为所有子系统对同一个服务的公共标识。 
\2. **时间维度：时间维度的结构比较简单，它是一个连续维度。**每次服务使用都有一个发生时间，对应于时间维度上的一个点，精确到毫秒。如支付渠道可用性规则，需要在客户进入收银台的这个时间点进行处理；如是否启用 CTU 防火墙规则，需要在客户确认支付后未支付出去前进行检查并启用等。 
\3. **渠道维度：渠道代表客户使用服务的“界面”，它是服务提供者与服务使用者的交互方式。**通过构建一个层次模型，渠道分为两级，第一级是主渠道类型，第二级是子渠道类型。 
\4. **客户维度：客户在这里是指服务的具体使用者。**在“以客户为中心”的业务中，支付机构会为不同的客户提供不同的服务与可用性策略。为了更好地服务客户，满足客户/客户群的个体性需求，业务上需要对客户进行分级。对于客户，我们首先要区分他属于内部、集团还是外部；其次，我们需要区分他的性质，即他是个人还是公司；再次，我们需要区分他的级别，暂时划分为普通与签约。 
\5. **行业维度：针对不同行业的交易标的由于交易价格、成本与利润差异很大，因此在业务上需要有不同的支付渠道可用性标准。**在业务层面上，商品是隶属于客户或市场的。而随着商品所属行业的不同，商品本身的特点，均需要以不同的支付渠道来支持其可变性，以确保安全、成本等环节的控制。 
\6. **市场维度：市场在这里是指引导客户使用支付产品服务的场所。**它可能是支付产品自己，可能是相关公司或平台的其它网站，如淘宝，也可能是外部的交易平台商。由于同样的服务可以针对不同的市场来定制规则，因此，在服务使用中也需要包含市场这个维度。

 

### 支付渠道优先默认规则

 

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180705075020_63916.png)

 

 

## 三、支付处理流程

 

这一部分主要分为 4 个板块： B2C 充值、 B2B 充值、快捷充值以及余额支付 / B2C 支付。

**B2C 充值：**

**充值流程**

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180705075048_54855.png)

 

具体功能为：①客户点击充值功能；②收银台提供充值页面；③客户输入充值金额；④客户选择充值渠道；⑤客户确认充值信息；⑥请求充值服务；⑦生成银行报文；⑧提交银行处理；⑨客户在网银上进行相关操作；⑩接到银行返回信息；⑪为客户展示充值结果。

**B2B 充值：**

**充值流程**

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180705075108_92731.png)

 

具体功能为：①客户点击充值功能；②收银台提供充值页面；③客户输入充值金额；④客户选择充值渠道；⑤客户确认充值信息；⑥请求充值服务；⑦生成银行报文；⑧提交银行处理；⑨客户在网银上进行相关操作；⑩接到银行返回信息；⑪为客户展示预授权结果信息；⑫企业进行本笔充值复核；⑬确认充值完成。

**快捷充值流程：**

**充值流程**

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180705075122_13418.png)

 

具体功能为：①客户点击充值功能；②收银台提供充值页面；③客户输入充值金额；④客户选择充值渠道；⑤客户输入支付密码；⑥检查支付密码是否正确（判定）；⑦请求充值服务；⑧生成银行报文；⑨提交银行处理；⑩接到银行返回信息；⑪为客户展示预授权结果信息。

**余额支付 / B2C 支付：**

**具体功能：**

**a、余额支付**：①客户进入收银台，选择余额支付。当余额不足时，允许一卡通、网银进行补支付；②客户输入支付密码，检查支付密码的正确性；③检查证书情况；④若启用了手机护航，则进行收集动态口令的校验；⑤ CTU 防火墙的检查；⑥继续推进支付；⑦收银台提供支付结果信息。

**b、B2C 支付流程**：①客户进入收银台，选择网银支付；②客户选择 B2C 的银行进行支付；③客户确认支付信息；④请求充值服务；⑤生成银行报文；⑥提交银行处理；⑦客户在网银上进行相关操作；⑧接到银行返回信息；⑨继续推进支付；⑩收银台提供支付结果信息。

# 三节课学懂支付核心（上）| 支付学院

2018-07-26 21:54:03 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/81228404

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180720091316_79933.png)

# 支付核心和清算核心职责

 

首先要明确一个概念：一个完整的支付清算系统结构内，各种特定业务所涵盖的支付服务、清算服务是相互独立的。其独立性体现在具体的产品研发过程以及后期维护等各项工作中：

1、 这种现状导致了业务产品开发复杂化、风险性提高；

2、 支付与清算的相关规则各自为政，彼此独立，加大管理难度；

3、 在开放平台的大背景下，也不能提供给大量外部业务系统所需要的基础支付服务；

4、 若清算服务部署于在后台管理系统，各类清算细则繁冗复杂，对运营部门造成很大不便性。

**在设计支付清算系统时建议：**

1>、 将支付核心和清算核心设计为两层，分为两个独立子系统：

2、 支付核心提供适应各类产品使用的基础支付服务；清算核心则将所有机构所能提供的底层清算服务归集，专门负责与银行的各类清算接口对接；

3、 支付层则对外提供各类经过包装的支付服务，涵盖清算服务、账务服务、客户相关服务等，实现对基础支付服务的编排。

# 提现协议系统业务流程分析

前提：以同步/异步的维度划分提现支付协议，得出两类提现支付协议的处理流程。

**维度：会员层、提现产品层、支付层、财务核心、清算层、银行。**

1、 同步提现支付协议处理流程图

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180720091428_40355.png)

2、 异步提现支付协议处理流程图

![异步体现支付协议处理流程图](https://blog.pingxx.com/wp-content/uploads/2018/07/%E6%94%AF%E4%BB%98%E6%A0%B8%E5%BF%832.png)

 

3、 退票支付协议的处理流程

 

![退票支付协议处理流程](https://blog.pingxx.com/wp-content/uploads/2018/07/%E6%94%AF%E4%BB%98%E6%A0%B8%E5%BF%833.png)

![核心支付服务](https://blog.pingxx.com/wp-content/uploads/2018/07/%E6%94%AF%E4%BB%98%E6%A0%B8%E5%BF%834.png)

如图，将支付与交易分开，主要是为了体现出支付服务机构的核心支付服务功能。

核心支付服务能够为会员提供丰富个性的支付服务：充值、提现、内外转型支付、支付侧营销等内容。

若将交易产品中包装的相关支付服务交由支付服务层与清算服务层协作完成，并将交易以及其他产品释放出来，则产生的整体系统框架图如下：

![交易产品整体系统框架图](https://blog.pingxx.com/wp-content/uploads/2018/07/%E6%94%AF%E4%BB%98%E6%A0%B8%E5%BF%835.png)

# 提现支付协议领域模型

## 模型总览

![提现支付协议领域模型总览](https://blog.pingxx.com/wp-content/uploads/2018/07/%E6%94%AF%E4%BB%98%E6%A0%B8%E5%BF%836.png)

通过对提现支付协议、提现支付指令的归纳抽取，得到本模型图。其中，操作指令部分不对外暴露。

![提现支付协议模型](https://blog.pingxx.com/wp-content/uploads/2018/07/%E6%94%AF%E4%BB%98%E6%A0%B8%E5%BF%837.png)

每 1 提现支付协议，拥有 1 到多个明细项；提支付协议本身和明细项信息是产品在使用支付协议时各专用申请单据转化而来，由原始业务单据数据经过简单加工后得出；

每 1 提现支付协议，拥有 1 到多个提现支付指令；支付指令是在协议和协议明细项基础之上加工得出；其具备了进行后续操作处理的全部要素信息，除原始单据中请求要素外，经过支付层的一系列诸如补全、拆分、检查之后产生；部分没有业务数据的提现产品如正常提现和卡通提现，都是以支付指令作为其产品数据；

每 1 提现支付指令，拥有 1 到多个提现操作指令；提现操作指令是真正可被系统处理的、运行时得出的具体操作步骤；具体表现为账务相关、清算相关以及其他底层公共服务的处理单元；

为了简化提现支付指令与提现支付协议的从属关系，可以直接认为每 1 提现支付协议拥有 1 到多个提现支付指令。

## 核心业务逻辑

以在线用户发起的正常提现申请为例，整体的交互时序图如下：

![提现支付协议核心业务逻辑](https://blog.pingxx.com/wp-content/uploads/2018/07/%E6%94%AF%E4%BB%98%E6%A0%B8%E5%BF%838.png)

支付层内部处理的交互时序图

![支付层内部处理的交互时序图](https://blog.pingxx.com/wp-content/uploads/2018/07/%E6%94%AF%E4%BB%98%E6%A0%B8%E5%BF%839.png)

提现支付指令作为提现支付协议的流水数据，其处理生命周期的状态迁转如图所示：

异步提现支付协议下的提现支付指令状态图

![异步提现支付协议下的提现支付指令状态图](https://blog.pingxx.com/wp-content/uploads/2018/07/%E6%94%AF%E4%BB%98%E6%A0%B8%E5%BF%8310.jpg)

提现退票支付协议下的提现支付指令状态图

![提现退票支付协议下的提现支付指令状态图](https://blog.pingxx.com/wp-content/uploads/2018/07/%E6%94%AF%E4%BB%98%E6%A0%B8%E5%BF%8311.jpg)

同步提现支付协议下的提现支付指令状态图

![同步提现支付协议下的提现支付指令状态图](https://blog.pingxx.com/wp-content/uploads/2018/07/%E6%94%AF%E4%BB%98%E6%A0%B8%E5%BF%8312.jpg)


 三节课学懂支付核心（中）| 支付学院

2018-07-26 22:05:30 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/81228537

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180725120558_15087.png)

## **提现业务边界分析**

首先，提现业务边界分析可以拆分为两大部分：业务用例边界以及系统用例边界。这里着重讲一下系统用例边界，分为：

- 异步提现支付协议申请
- 异步提现支付协议推进处理
- 接受清算处理结果回执
- 统一协议处理结果回执
- 同步提现支付协议申请
- 同步提现支付协议推进/恢复处理
- 提现退票支付协议
- 打款机构
- 支付能力
- 分布式任务
- 公共查询类服务：协议授权查询服务、机构信息查询服务
- 提现查询类服务：银行卡段检查服务、对公账户联行号检查服务、支行列表查询服务、清算通道支付限额查询服务
- 管理服务：协议授权管理服务、打款机构管理服务、支付能力管理服务、缓存刷新服务

## **1****业务用例边界**

支付层作为提供基础支付服务的核心系统，所承担的职责围绕着以下主要业务功能点：

**以协议方式提供适用于各类产品使用的支付服务：**

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180725120629_59341.png)

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180725120649_30148.png)

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180725120703_45525.png)

**可供灵活编辑的各种核心处理规则配置机制，以及提供配套的规则管理服务：**

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180725121158_25380.png)

## **2系统用例边界**

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180725121224_38329.jpg)

###  **异步提现支付协议申请**

本文重点描述异步提现支付协议在申请过程中支付层的体系结构以及处理流程。

需要重点指出的是，支付层所提供的协议申请使用嵌套分布式事物，在此将申请过程分为两个阶段处理：

**阶段一：**

\1.   调用者开启分布式事务，在事务块内请求异步提现支付协议申请：

\2.   整合现有各类非实时处理类提现产品要素，设计专用的申请单据对象；异步提现支付协议支持每次申请单笔或批量明细项；

\3.   通过内部的业务接入层将专用单据转换成统一的内部领域模型对象；

\4.   对领域模型对象加工，包括补全、拆分、检查等；

\5.   启动嵌套分布式任务，执行预授权处理，即冻结提现款；

\6.   组装处理结果并返回。

**阶段二：**

调用者根据支付层协议申请的返回结果，决定提交或回滚分布式事务：

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180725121254_75886.png)

### **异步提现支付协议推进处理**

**支付层自行调度的推进处理**

- 加载协议数据，激活领域模型对象；
- 执行结算处理，包括账务解冻与扣款；
- 执行报清算处理，通过确保达到的ESB消息通知清算层执行清算。

**产品层通知方式的推进处理**

- 加载协议数据，激活领域模型对象；
- 记录协议的相关审核人以及类似于生僻字审核所需要的银行开户名等信息；
- 执行结算处理，包括账务解冻与扣款；
- 执行报清算处理，通过确保达到的ESB消息通知清算层执行清算。

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180725121407_26789.png)

## **异步提现支付协议取消/接受清算处理结果回执**

### **异步提现支付协议取消**

- 这里提到的协议取消不是对整个协议的取消，支付层只允许对单笔支付指令的取消行为；

### **接受清算处理结果回执**

- 在经历了上述两个处理过程后，清算层根据自有的业务规则进行清算处理；最终的清算结果需要确保通知到支付层；此处继续选用高可靠性的ESB确保到达。

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180725121538_40193.png)

## **统一协议处理结果回执/同步提现支付协议申请**

### **统一协议处理结果回执**

- 除了上述的支付指令处理成功/失败已经提现取消作为处理结束状态，需要回执给产品层外，对于退票情况，也需要回执给产品层；
- 产品层目前也是通过前置来统一处理的，所以支付层在回执产品层提现处理结果时需要一并报送该笔支付指令的产品码、子协议代码以及备注信息、操作员等；
- 这里回执给产品层的处理结果，也是采用高可靠性的ESB确保到达。

### **同步提现支付协议申请**

对于需要同步支付并清算的提现产品，使用本协议；同异步提现支付协议，本协议也可以使用嵌套分布式事务；

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180725121556_67049.png)

### **同步提现支付协议推进/恢复处理**

- 支付层同步请求清算，清算层的返回结果中有三种清算状态：

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180725121620_15055.jpg)

如果支付层在请求同步清算时出现了严重异常，如清算层异常宕机或清算返回丢失，则仍然返回产品处理中结果；支付层内部回复程序会继续尝试回复。

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180725121740_24873.png)

### **提现退票支付协议**

提现退票支付协议作为本讲引入的协议之一，通过申请支付层的协议，由支付层负责账务与业务推进处理；在本协议下，退票流水将作为支付指令存在，与被退票的支付指令平级；不会去对已经处理成功的原支付流水做任何改动；

由于不需要进行清算，支付层内部只需要处理账务充值部分即可；所以本协议也是同步的，即申请成功则全部处理完毕。

![img](https://blog.pingxx.com/wp-content/uploads/2018/07/20180725121803_83169.png)

### **打款机构/支付能力/分布式任务**

**打款机构**

任何一笔提现申请，最终目的都是从某一支付账户提现至指定的银行卡上；这个银行卡就是提现支付协议中指定的收款方信息；

由于银行卡信息中的开户行种类繁多，比如各类非直接打款银行；对于这些开户行的提现申请，实际会通过跨行的方式进行提现；具体说来就是根据开户行、提现的额度范围、账户的对公对私属性等，来决定最优的提现方式；

产品层不知道本次提现的实际打款机构；而支付层对每笔支付指令进行账务处理时需要知道具体的打款机构，这样才能请求账务进行扣款或者回充处理；所以打款机构的规则就需要支付层进行维护。

**分布式任务**

支付层的大量调度任务如异步提现支付协议的推进、同步提现支付协议的掉单恢复等；将来会有更多的调度任务加入；

**支付能力**

作为支付协议最重要的处理规则，支付层对外提供可供快速定制的各种内部处理打包方案；

**其他服务类**

**公共查询类服务**

a)   协议授权查询服务

b)   机构信息查询服务

**提现查询类服务**

a)   银行卡段检查服务

b)   对公账户联行号检查服务

c)   清算通道支付限额查询服务

d)   提现统计查询服务

**管理服务**

a)   协议授权管理服务

b)   打款机构管理服务

c)   支付能力管理服务

d)   缓存刷新服务

**本地缓存**

a)   机构信息查询结果；

b)   清算通道支付限额查询结果；

c)   支行列表查询结果；

除此之外，支付层自有的配置规则也可以考虑使用缓存的模式，减少数据库读取频率：

a)   协议授权关系列表；打款机构规则列表；

b)   支付能力列表；


 三节课学懂支付核心（下） | 支付学院

2018-07-29 01:10:34 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/81267212

![img](https://img-blog.csdn.net/20180729010147530?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

# **充值系统业务流程分析**

## **充值协议处理主体流程图（充值遵守的系统处理原则：先清算，后结算）**

![img](https://img-blog.csdn.net/20180729010212961?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

**充值协议处理主体流程图（充退遵循的系统处理原则：先结算，后清算）**

![img](https://img-blog.csdn.net/20180729010213182?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

后结算处理的充值协议，如阿里国际站的小额担保交易的使用场景，其处理流程如下：

![img](https://img-blog.csdn.net/20180729010213196?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

 

## **充值协议系统级架构和领域模型**

### **系统整体架构**

![img](https://img-blog.csdn.net/20180729010251500?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

![img](https://img-blog.csdn.net/20180729010251599?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

我们从多个视角来快速浏览支付层的整体系统架构：

![img](https://img-blog.csdn.net/20180729010336346?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

![img](https://img-blog.csdn.net/20180729010336380?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

**模型总览**

![img](https://img-blog.csdn.net/20180729010336558?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

### **核心业务逻辑**

用户进入统一收银台界面，选择了充值渠道以及充值金额，收银台经过规则检查（如安全、渠道等）后，向支付层发起充值协议申请：

![img](https://img-blog.csdn.net/20180729010421414?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

清算层在处理完金融机构的清算结果通知后，回执给支付层：

![img](https://img-blog.csdn.net/20180729010421470?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

**充值指令的状态迁转如图所示：**

![img](https://img-blog.csdn.net/20180729010534530?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

## **充退协议领域模型**

### **模型总览**

![img](https://img-blog.csdn.net/20180729010534646?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

在某些特定商业背景下（如机票平台大客户的充退需求）必须大客户一次性对一笔充值指令的连续多次充退请求，有如下两种实现方式：

**方式一：**需要清算层在报送银行端时进行恰当的处理，如将支付层报送过来的充退清算指令进行合并，或采取延迟报送银行等手段加以实现；

**方式二：**产品层加强此类合并充退的组织力度，即支付层、账务/会计、清算层以及对账中心都不为此类业务进行内部业务合并，而是交由产品进行合并，请求支付层的充退已经是合并后的单据；这样的整体代价较小，并且提高了核心系统的业务处理稳定性。

支付层提供的充退协议遵循一笔充值指令最多只能有一笔处于活动状态充退指令的约束；同样的原因，充退协议也不再引入协议明细项，直接建立协议与指令的关系；

1. 每1充退协议，拥有1到多个充退指令；
2. 每1充退指令，拥有1到多个充退操作指令；

![img](https://img-blog.csdn.net/20180729010610711?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

### **核心业务逻辑**

![img](https://img-blog.csdn.net/20180729010611863?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

注：对于后结算充退协议，指令状态直接迁转为已报送清算状态，在等待清算回执后再做账务结算。

### **充值协议领域模型VS充退协议领域模型**

与提现和退票的关系类似，充退也是建立在充值基础之上的特殊协议，都是完成了正向协议的反向资金处理过程；

在前面讲述中将提现协议与退票协议进行合并，反映在模型本身、处理流程以及数据存储等各方面都保持一致。

## **充值业务边界分析**

![img](https://img-blog.csdn.net/20180729010648896?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

**系统用例边界总图：**

![img](https://img-blog.csdn.net/20180729010648994?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

### **业务用例边界总图：**

![img](https://img-blog.csdn.net/20180729010648955?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

## **系统用例边界**

 

### **网银充值协议申请**

**基本流程示意图：**

![img](https://img-blog.csdn.net/20180729010724856?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

### **代金卡（充值码）充值协议申请**

1. 网银充值协议申请后所返回的跳转表单对象供收银台跳转至金融机构；而代金卡的充值处理中收银台无需获取跳转表单对象。
2. 代金卡充值协议需要收取手续费，在报送的协议申请单据中需要指定待冻结的金额；支付层充值领域服务完成充值后即发起对充值账户的冻结处理。

### **快捷充值协议申请**

![img](https://img-blog.csdn.net/20180729010724837?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

### **接受充值清算回执**

![img](https://img-blog.csdn.net/20180729010724839?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

 

### **无清算充值协议申请**

1. 以上介绍的各类充值协议其处理过程，都遵循了支付层先记录单据，待清算层完成清算后再由支付层进行结算的处理原则，也就是意味着当清算层回执支付层具体的清算结果时支付层一定是有相应的单据的；而由于COD业务模式的特殊性，物流收到货款后即才支付机构发出通知，以物流订单号作为充值订单号，要求完成此次充值行为。

![img](https://img-blog.csdn.net/20180729010826447?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

支付层要严格控制消息的幂等性，不能为中间账户多次充值！

### **充值后通知事件**

1. 所有成功完成的充值协议，都需要以异步消息方式通知CTU及积分核心系统本充值事件。

### **支付与清算系统掉单恢复**

对于实时完成支付、清算过程的充值协议，需要辅以定时调度任务恢复系统响应超时的掉单充值指令。

### **充值协议查询**

用以解释当前充值订单处理状态，当清算层push相关信息至收银台后，收银台使用此服务获知处理结果并显示用户。

### **预结算充退协议申请**

![img](https://img-blog.csdn.net/20180729010826626?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

 

### **后结算充退协议申请**

1. 针对诸如Migs的渠道，支付层提供了后结算充退协议供使用；与预结算充退协议不同处在于完全依赖清算层的回执才进行账务扣款，并且不存在冻结、解冻以及失败回充的动作；仅在清算层明确回执清算成功后，以实际清算金额（RMB）为准进行账务扣款。

### **异步充退推进调度**

使用分布式任务组件，作为异步充退推进处理的调度策略；这里要完成:

1. 结算
2. 清算

### **异步充退超时调度**

1. 处于结算成本以及客户引导的原因，结算人员对客户发起某些金融机构下的充退是不给予处理的；同时某些充退在申请时其通道是可用的，而推进处理时则发现通道已关闭，此类充退指令则一直处于待推进状态；

### **接收充退清算回执**

当清算层与金额机构清算完毕，业务对账完成后，清算层将清算结果回执给支付层，支付层进行后续处理：

1. 结算
2. 业务分流

### **单笔充退指令取消**

允许异步充值指令的取消行为，所遵循的处理原则有：

1. 外部系统请求支付层取消某一笔充退指令，如果是预结算的，只有该支付指令处于预授权状态放可进行取消；对于后结算充退指令，只要该笔充退指令没有报送至清算层均可被取消；
2. 预结算充退指令取消要完成账务解冻处理；
3. 如果当前状态不允许进行取消，则外部系统需要请求清算层进行取消；复核清算层的取消规则后，清算层会以清算失败的状态异步回执支付层，则支付层进行失败回充。

### **人工充退指令推进**

1. 见上述异步充退推进调度中所使用的独立门面服务，完成结算以及报清算处理过程；

### **充退汇总查询**

独立的门面服务，支付层内部以及外部系统均可使用此服务；用以解释指定的充值指令所对应的所有充退指令集合，包括每笔充退指令的金额、状态等；

### **可充退额度统计**

用以统计每笔充值指令当前可充退金额，如前台会员自助充退则需要获得此统计金额进行控制；

此服务接口可接受批量充值指令的可充退额度统计；

### **充退高可用性的渠道配置**

1. 目前的识别规则分三个维度：**产品、商户(客户)、渠道**，实际上充退产品在申请充退协议时从产品和商户的角度来决定。

### **各类规则配置管理服务**

简单的介绍一下引入的各类配置规则包括：

1. 支付渠道配置管理；
2. 与收银台相关的过滤配置管理；
3. 统一的支付能力配置管理；
4. 支付能力与协议配置管理；
5. 分流目标管理；
6. 充值后冻结渠道配置管理

以上各类规则配置，支付层均需开设相应的管理服务供管理平台使用。

### **业务回执分流器**

本讲说的支付层重要的基础设施之一：负责完成与支付业务处理无关的业务回执分流工作；本讲说的回执通讯方式选型为基于ESB的异步通知方式。

### **业务回执分流注册**

本讲有充值/充退背景的业务回执行为，在组装申请单据至支付层时即设置了回执上下文；而其他子系统也可以直接使用业务回执分流器完成回执，可仅注册回执上下文信息；

### **统一支付能力**

设计提现、充值、充退领域服务可配置的支付能力，保证后续的支付等都可以配置各类协议所使用的差异性支付能力。

### **领域服务监听器**

这里将分流器建设成与支付协议无关的系统间共用通讯通道，从而确保分流器本身的稳定性。

![img](https://img-blog.csdn.net/20180729010952631?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

### **业务回执分流器恢复调度**

即前文中所提到的分流器默认调度策略：接收到监听器通知但并未执行的、或者采取同步回执通讯方式的，对方应答丢失的两种场景下需要进行再次尝试；当回执次数超过指定的上限后即不再尝试。

### **业务回执分流器恢复调度**

![img](https://img-blog.csdn.net/20180729010952760?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

# 深度解析：什么是清算核心？

2018-08-03 11:43:17 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/81384867

# 系统业务流程分析

## 系统架构和领域模型

![img](https://blog.pingxx.com/wp-content/uploads/2018/08/1_meitu_1_meitu_1.png)

逻辑视图

![img](https://blog.pingxx.com/wp-content/uploads/2018/08/2_meitu_2.png)

部署视图

![img](https://blog.pingxx.com/wp-content/uploads/2018/08/3_meitu_3.png)

这里的 Mix 系统职责是两块，一块是作为复杂支付渠道的业务产品，包括网点支付、代金卡、COD、MotoPay；一块是划入支付层职责的转帐账分润业务。之所以要提出这个系统，是因为这些复杂支付渠道的业务逻辑被分散在多个系统中（支付系统，开发平台，银行网关），而这些在系统中的定位是通信前置，不应该包含这些逻辑。所以统一迁到 Mix 系统中。

**模型总览**

![img](https://blog.pingxx.com/wp-content/uploads/2018/08/4_meitu_4.png)

**清算实体通用模型**

**![img](https://blog.pingxx.com/wp-content/uploads/2018/08/5_meitu_5.png)**

**渠道类型**

**![img](https://blog.pingxx.com/wp-content/uploads/2018/08/6_meitu_3_meitu_6.jpg)**

 

 

 

 

 

支付机构内部渠道划分为以下几类：

![img](https://blog.pingxx.com/wp-content/uploads/2018/08/7_meitu_4_meitu_7.png)

银行卡类型：

![img](https://blog.pingxx.com/wp-content/uploads/2018/08/8_meitu_5_meitu_8.jpg)

清算类型：

![img](https://blog.pingxx.com/wp-content/uploads/2018/08/9_meitu_6_meitu_9.png)

清算指令的状态：

![img](https://blog.pingxx.com/wp-content/uploads/2018/08/10_meitu_25.png)

清算指令的通信状态（文件类状态）：

![img](https://blog.pingxx.com/wp-content/uploads/2018/08/12_meitu_8_meitu_11.png)

**指令类状态**

批量的指令有两种发送的实现模式：

- 落地为文件供结算人工下载，人工发送提交。
- 直接通过和银行交互的接口批量或者单笔发送出去

**核心的业务逻辑**

1. 充值文件内清算指令总笔数 = 充值清算文件处理结果总笔数
2. 充值文件内每笔清算指令金额和状态 = 充值清算文件处理结果内每笔清算指令金额和状态
3. 充退文件内清算指令总笔数 = 充退清算文件处理结果的总笔数
4. 充退文件内每笔清算指令金额和状态 = 充退清算文件处理结果内每笔清算指令金额和状态

# 业务边界分析

![img](https://blog.pingxx.com/wp-content/uploads/2018/08/13_meitu_9_meitu_12.png)

## 清算文件处理

![img](https://blog.pingxx.com/wp-content/uploads/2018/08/14_meitu_10_meitu_13.png)

 

- 充值回导文件获取
- 充值回导文件有两种获取方式：一种是人工去银行网银系统去下载，并保存到本地硬盘，然后通过工作平台提供的上传功能进行上传。第二种是人工或系统触发（系统自动触发会是固定时间点，或者有规律的时间段）并由系统通信前置与银行服务器进行交互拿到回导文件。

我们这里主要指的是第二种。

![img](https://blog.pingxx.com/wp-content/uploads/2018/08/15_meitu_11_meitu_14.jpg)

## 清算文件处理

![img](https://blog.pingxx.com/wp-content/uploads/2018/08/17_meitu_12_meitu_15.png)

**充值回导文件解析**

- 见上图，我们要把解析脚本内容保存到数据库，直接读取数据库中的内容，这样方便管理和更新。
- 每一个文件解析脚本和文件模板都需要仔细开发。

**充值回导文件导入**

- 文件解析完成后，需要把数据对象存储到数据库中，对于充值来说业务关键字段和提现一样：充值订单号和充值金额。

**充值回导文件对账**

- 对账需要在导入后进行触发，可以是人工触发，也可以是系统自动触发，也可以在导入后立即系统自动触发对账。系统将提供接口供工作平台调用或者系统自己调用。
- 系统触发可以配置成一个定时执行任务，这样可以把实时要做的事情变成异步确保会做的事情，将使用到定时预约的系统功能，在定时查询中有讲这个工具。通用的对账流程如下图

![img](https://blog.pingxx.com/wp-content/uploads/2018/08/18_meitu_13_meitu_16.png)

**银行通信前置**

- 主要涉及到的工作是网银对指令的签名、校验签名以及报文服务费与清算核心的对接，还有获取对账文件的对接

**清算指令处理**

![img](https://blog.pingxx.com/wp-content/uploads/2018/08/19_meitu_14_meitu_17.png)

**指令的清算结果状态：**

**![img](https://blog.pingxx.com/wp-content/uploads/2018/08/20_meitu_15_meitu_18.jpg)**

**清算指令的通信状态（文件类状态）**

![img](https://blog.pingxx.com/wp-content/uploads/2018/08/21_meitu_16_meitu_19.png)

**指令类状态**

批量的指令有两种发送的实现模式：

- 落地为文件供结算人工下载，人工发送提交。
- 直接通过和银行交互的接口批量或者单笔发送出去

## 内部服务管理

![img](https://blog.pingxx.com/wp-content/uploads/2018/08/23_meitu_18_meitu_21.png)

**指令处理时序图**

![img](https://blog.pingxx.com/wp-content/uploads/2018/08/24_meitu_19_meitu_22.png)

## 系统边界分析

经过前期对业务上的一些认识，目前产品可以分为三大类：直连模式、网银异步模式、其它个性化模式。

**直连模式**

**![img](https://blog.pingxx.com/wp-content/uploads/2018/08/25_meitu_20_meitu_23.png)**

## **网银异步模式**

**![img](https://blog.pingxx.com/wp-content/uploads/2018/08/26_meitu_24.jpg)**基础向：从 0 开始学习支付系统架构

2018-08-14 16:30:35 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/81669412

今天为大家带来 Ping++ 高级技术总监——叶波光老师的《支付系统架构详述》。本篇内容由五个部分组成。

![支付系统架构](https://blog.pingxx.com/wp-content/uploads/2018/08/%E6%94%AF%E4%BB%98%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%AF%A6%E8%BF%B0.png)

\1. 架构的定义：架构一定是基于业务功能来展开的，主要是制定技术规范、框架，指导系统落地，好的架构是需要不断演变和进化而来的。

\2. 架构需要关注的基础核心点主要是：安全、稳定、可扩展。

\3. 构建架构时需要关注的点：目标客户是谁、主要场景有哪些、流程是怎样的、模型、职责有哪些、边界在哪里以及设计。其中比较难以理解的点是困难及模型这两块。

\4. 架构与业务需求的关系：架构的产生来自于业务需求，业务需求进一步抽象形成架构，架构指导后续研发，研发最终成果解决业务需求的问题。整体是一个正向循环的关系。

## 支付架构

![支付架构](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%9B%BE%E7%89%87-1.png)

## 支付流程分析

![支付流程](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%9B%BE%E7%89%87-2.png)

第一步，用户选择支付渠道，进入商户客户端；商户客户端发送支付要素，到商户服务端；第三步，商户服务端发起支付请求到渠道侧（个别渠道如支付宝是不需要此步骤）；第四步渠道返回支付凭证到商户服务端；第五步商户服务端返回支付凭证到商户客户端；第六步，用户调用支付宝控件完成支付。

接下来是重点，第七步一般渠道是采用异步通知方法来通知商户，但是有些企业是在第六步支付完成之后，在C端会同步通知支付成功。如果以此结果来判断支付是否成功，其实是不严谨会出问题的，应当调用渠道的支付接口来进行核查，然后以渠道返回的结果为准。

![商户关注点](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%9B%BE%E7%89%87-3.png)

在日常工作中，许多企业在选择第四方服务商或者渠道的时候，会着重关注「并发」这个点，认为并发量需要达到上万级才可以满足日常需求，但实际上这个量级非常大，其实并没有必要的。

![渠道要求](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%9B%BE%E7%89%87-4.png)

**若直接对接渠道可能会遇到的问题：**

• 接口文档升级、变更能及时得到通知

• 有些业务没有异步通知

• 同一业务在不同渠道表现不一样

• 各种渠道的各自异常

**商户的要求：**

• 清晰的 API 、SDK 文档

• 安全

• 所有应用接口统一标准的异步通知

• 保证出口 IP 稳定（安全）  

**在系统架构设计时需要注意的一些要点：**

\1. 提供规范的 API、SDK

\2. 安全（通讯安全、数据安全）

\3. 稳定

\4. 异步通知统一

\5. 各渠道的异常

\6. 及时了解渠道接口调整

![API接口设计规范](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%9B%BE%E7%89%87-5.png)

**支付核心逻辑**

![支付核心逻辑](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%9B%BE%E7%89%87-6.png)

这里讲一下，支付成功之后，我们会把订单信息同步到财务系统，在账务系统里我们设计了诸如转账、汇款等功能，在前期设计时会设计好账务的生成规则，例如一笔支付的请求会生成多笔账务，对其字段进行区分，这样方便管理和维护。

**支付网关**

此处特指API网关，支付网关的功能：

![支付网关](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%9B%BE%E7%89%87-8.png)

限流最好不要放到业务流程中做，会影响用户的体验。

**支付网关的内容：**

• 唯一的请求入口

• 统一的身份认证、签名、加解密、流控

• API 调用计费

• API 的监控、报警分析

• API 发布管理

• 熔断

• API 聚合

• 协议转换

上述内容除了必要意外，其他不放在业务层做，也是为了更好的用户体验。

**支付逻辑**

主要是根据请求的参数进行静态检验和业务逻辑校验，避免系统异常

• 适配渠道的参数校验：长度、类型、格式

• 订单的支付状态：是否支付

• 订单的有效期等等

**要点：**

• 一般商户是不需要做支付路由，大部分都是指定了最终的某个支付渠道。

• 但也有些没有指定了某个最终的渠道，比如银行卡的支付可以选择哪个第三方支付来完成支付，还有微信线上线下的封装，这个时候就涉及到支付路由

• 规则配置

• 费率：单笔费率、总额费率、阶梯费率、

• 营销活动：固定时间单笔优惠、单笔满减、单笔这款、直接补贴

• 额度限制：单笔额度、时间范围内总额度

• 服务指标：失败率、平均响应时间、异常率、TPS

• 特殊配置：特殊要求（比如某渠道能快速结算）

**支付网关的目的：**

## 省钱

 

**支付风控**

要点：梳理清楚业务风险，分析风险原因，制定风险防范规则。

![风控结果与系统要求](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%9B%BE%E7%89%87-10.png)

数据来源：

**内部数据：**

• 用（商）户信息

• 交易数据

• 账户数据

• 黑名单

• 设备、位置信息

• 日志数据

**外部数据：**

• 第三方购买

• 央行征信

• 芝麻信用

• …

• 合作数据

风控流程：

事前：

• 入网审核

• 风险评估

• 单笔限额设置

• 单日限额设置

• 频次设置

事中：

• 实时分析

• 多维度判断

• 拒绝

• 拦截 – 进一步验证

– 人工介入

• 延迟操作（例如用户大额提现，需要时间段进行复核）

事后：

• 数据分析

• 巡查、警告

• 降低评级

• 升级防范措施

• 逻辑完善

• 反馈至事前、事中规则中

账务系统

• 账务生成

• 内部对账

• 原始账单下载

• 生成标准账单

• 对账

• 差错处理

账务生成后首先进行内部对账，一直后进行原始账单下载，再生成标准账单，进行对账之后进行差错处理。

 

**内部流程如图：**

![账务系统架构](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%9B%BE%E7%89%87-11.png)

• 订阅交易信息

• 根据交易事件查询生成账务的规则

 交易事件：支付、退款、转账等等

• 根据规则生成账务明细

• 将账务明细落地

对账流程（实现方式之一）

内部对账：

• 保证账务和交易信息配对

• 一条交易信息有多条账务信息

渠道账单下载：

• 下载

• 账单标准化（对账字段统一）

• 落地标准化账单

对账：

• 账务和标准账单对账

• 双向对账

• 差错处理

账单下载：

![账单下载](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%9B%BE%E7%89%87-12.png)

这里提一句，在做异常处理这部分工作时，有的研发朋友写代码时遇到过类似的问题，例如订单在周末下单，但账单周一才能查询；等到周一时发现查询不到，选择立即重试 + X 分钟后重试就结束了。这样是不行的，因为银行有的是 8 点之后可以查询到，有的是 9 点之后，所以要选择递增时间重试，然后标记人工处理。

**对账：**

对账部分：

1. 获取核对文件
2. 以账务系统为准来逐笔比对（以某个字段为准进行比对）
3. 数据一致标记成功，数据不一致标记差错

反向操作：

1. 以渠道账单为准来逐笔比对；
2. 数据一致标记成功，数据不一致标记差错

**差错处理**

本地丢失：渠道账单的数据未在账务中查找到。

渠道丢失：账务中的数据未在渠道账单中查找到。

数据差错：账务与渠道某些对账字段未能对上。

此处需要注意的是

针对差错都需要向渠道查询每笔订单信息再次确认。

同时：有些渠道的交易成功时间本来就是有错误的。一般来说是件不会差错很大，一般出现在跨日交易中。例如当天交易无账单，先标记为差错，第二天再改正。

## 支付基础服务

• Webhook

• 公共推送服务

• 主动查询

• 补偿

• 链路监控

**Webhook**

![webhook](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%9B%BE%E7%89%87-13.png)

![webhook](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%9B%BE%E7%89%87-55.png)

**公共推送服务**

![公共推送服务](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%9B%BE%E7%89%87-15.png)

**主动查询**

**异步延时调用**

场景：

1、订单创建成功的时候会向服务推送主动查询信息，如果订单支付成功会通知服务取消后续的主动查询，否则在过期时间点向渠道主动查询订单是否支付目的是避免渠道异步通知服务的异常。

2、退款创建成功的时候会向服务推送主动查询信息，该服务会在一定的时间范围内多次查询渠道直到有明确的结果返回（有些渠道没有异步通知）。

3、转账也是类似的逻辑，但某些渠道只提供重试的功能，要注意幂等性。

……

**补偿**

• 协调保证各模块间数据的一致性

• 一般会跟重试、回滚、兜底来协调使用

• 使用条件

   – 系统异常

   – 业务异常

• 补偿失败报警人工干预

**链路监控**

 

![链路监控](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%9B%BE%E7%89%87-16.png)

展示信息：应用、URL、调用方、调用时间、调用次数、调用失败次数、本地平均耗时、总平均耗时、调用失败平均耗时 、错误率、依赖度

关注：Cache、SQL、HTTP、TCP

基本信息：

![链路监控基本信息](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%9B%BE%E7%89%87-17.png)

依赖度：

![链路监控依赖度](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%9B%BE%E7%89%87-18.png)

## 支付安全

数据安全：

– 防窃听   – 防越权

– 防抵赖   – 防破坏

– 防篡改   – 防重放

– 防泄漏

使用范围：网络、系统、应用、业务等

数据安全要点：

• 加密通讯（防窃听）

• 双向签名（防抵赖、防篡改）

• 敏感数据加密存储（防泄漏）

• 密钥管理（通过认证接口获取，只允许加载到内存，不允许直接写入配置文件）

• 权限控制（防越权-非法访问）

• 数据的完整性（放篡改- 数据被恶意修改、非法篡改）

其他

• 内部接口认证

• **避免内部代码未经审核发布到托管平台！！！**

• 数据异常分析

• 安全机构合作

注意点

• 使用 HTTPS 加密传输

• 传输的数据使用签名

• 提交的数据是符合规则并且是不存在或者是未支付的

• 支付成功以服务端异步通知为准

# 基础向：「财务对账」的秘密都在这篇 3000 字的文章里

2018-08-17 14:45:15 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/81777349

## **概念及目的**

首先抛出3个问题：

1. 为什么需要对账？
2. 支付机构是如何进行账务对账的？
3. 互联网平台应该如何进行对账模块的设计？

**对账**是会计学的一个名字，会计学对对账的定义是：**为了保证账簿记录的真实性、完整性、准确性，在记账以后结账之前，定期或不定期地对有关数据进行检查、核对。**

账簿记录是对公司企业日常经济活动的记录，类似于我们日常生活中使用记账 APP 来记录日常开销，记账 APP 里的每一条记录都是账簿记录。

![img](http://image.woshipm.com/wp-files/2018/08/wQJ6OCKb89V28dBDhYDP.jpg)

这里重点是对账簿记录进行核对，包含三个方面的核对工作，即账证核对、账账核对、账实核对。

**（1）账证核对**，是将账簿记录与记账凭证进行核对，这里是记账凭证是指日常经济活动的书面证明。如果还是用记账 APP 来类别的话，我们超市购物的小票、购买商品的发票、银行卡的收款转账记录，都是记账凭证。

**（2）账账核对**，是把有相互关系的多个账簿记录进行核对。有相互关系的账簿记录，包括总分类账簿间核对，明细账簿间核对等多种类型。例如：我们使用记账 APP 时，整个家庭的日常开销和购物、教育、交通等分类开销的核对，是总分类账簿间核对；核对银行卡取现记录和日常现金支出记录，是明细账簿间核对。

![img](http://image.woshipm.com/wp-files/2018/08/76UHBP9UgUxnOXNsLrY2.jpg)

**（3）账实核对**，是各项资产物资的记录数值与实际真实数额间的核对。例如：我们使用记账 APP 记录购买了一台手机，我发现自己手里确实有一台手机，这就是账实核对。

![img](http://image.woshipm.com/wp-files/2018/08/fsXG2jFldFxomnGocgID.jpg)

## **业务场景中的对账**

以上内容说明的是会计上是如何定义对账的，下面让我们看一下具体的业务场景中，是如何定义对账的。

### 1. 对账的职能

Ping++ 服务的客户都是开展电子商务业务的互联网公司或项目，我们习惯称之为电商平台。电商平台的对账，主要需要完成如下三个任务：

1. 核对平台自身系统交易数据与支付渠道的对账单数据，并将交易金额和支付渠道结算资金进行核对。
2. 保证电商平台各系统间交易状态、交易资金的一致性，支付订单和业务订单状态要一致，收款金额和订单金额一致，总收款金额和商品金额、运费金额要一致。
3. 要包含对账和后续的差错处理流程。

### 2. 对账的内容

对照会计定义中，对账包含的三个方面核对工作。

1. 对于电商平台来说，**记账凭证**就是电商平台自身的交易订单，支付渠道提供对账单。
2. **账账核对**，最重要的是将系统交易数据和渠道的对账单数据进行核对。同时也包括自营商品交易、入驻第三方交易数据的核对，有余额钱包的平台，需要进行余额数据和交易数据的核对。
3. 电商平台需要向入驻第三方进行付款时，要进行结算数据与交易数据的核对。**账实核对**，是将交易数据与支付渠道收款金额、已发货商品数量进行核对，结算数据和付款进行进行核对。

对账模块是大家搭建电商平台、进行业务系统、支付系统规则设计时，容易忽视的环节。往往在平台业务上线后，交易量出现爆发增长，人工无法处理每天出现的差错交易时，才会考虑设计、开发对账模块。

将对账模块的价值比作一个冰山的话，业务运行正常情况下显示的价值，就是冰山海面上的部分；当电商平台发生差错交易时，平静被打破，才会显现出对账的真正价值。

![img](http://image.woshipm.com/wp-files/2018/08/ahybzVIPTjlIgpZ8I6mi.jpg)

### 3. 对账的价值

平台发生差错交易时，对账模块的价值主要体现在：

1. 通过系统自动进行交易数据的核对，解放了财务、运营人员的工作时间，让他们可以专注于可以公司创造更多价值的工作上；
2. 自动完成大量交易数据的核对工作，订单数据量很大的情况，单靠人工无法完成交易数据核对并定位差错；
3. 可以在第一时间发现差错交易，并及时进行处理。不用等到客户投诉来了，再定位问题进行处理，提高了用户体验。

电商平台的对账包含差错处理模块，运营人员人工完成差错处理后，将交易数据同步更新到支付系统；同时还包括电商平台日常业务流程中，和支付系统相关的业务订单系统、发货仓储系统、财务管理软件等周边系统，保证整个平台数据的一致性。

![img](http://image.woshipm.com/wp-files/2018/08/f8f9EgRGXwp4vF4QV5Tf.jpg)

## **对账的设计**

如何进行对账模块的设计，我想先说明下支付机构是如何进行账务对账的。众所周知，支付机构每天需要处理大量的交易订单和资金，支付机构的账务对账对我们进行电商平台对账模块的设计，有很好的指导价值。

![img](http://image.woshipm.com/wp-files/2018/08/8anOXOM9d2xltytvq70p.jpg)

支付机构在进行交易处理时，主要涉及三个系统模块，分别是**联机**、**清分**和**结算**。

**（1）联机系统**负责处理商户的交易，并将交易发送到后端扣款渠道完成交易。支付、代扣、代付、预授权等多种类型的交易，都通过联机系统进行处理。联机系统完成交易处理后，记录的交易信息有：交易时间、交易商户、交易金额、交易类型、扣款渠道等信息。

![img](http://image.woshipm.com/wp-files/2018/08/odShzu2RC0JPTiuNKmBp.png)

**（2）清分系统**主要负责各类账务金额的计算，根据交易类型计算交易商户手续费，根据扣款渠道计算交易成本，手续费减去成本等到支付机构的手机数据。清分系统还负责对账工作，将联机交易信息和资金来源方流水文件进行核对。

资金来源方就是扣款渠道，两方的数据核对完成后，对于有差异的流水，生成差错交易。差错交易会交由运营人员，进行差错交易处理。

![img](http://image.woshipm.com/wp-files/2018/08/hUU1VcK8xgIsjBBJ18Uv.jpg)

对账后，正确无误的交易会生成结算流水文件。如果某一个扣款渠道的流水文件存在差错交易，则这个扣款渠道所有交易都不会生成结算流水文件。等待运营人员完成差错处理后，清分系统再对该扣款渠道的所有交易生成结算流水文件。

**（3）结算系统**根据清分生成的结算流水文件，生成支付机构对外付款的商户结算数据、等待收款的资金来款方数据，以及支付机构的收益数据。

![img](http://image.woshipm.com/wp-files/2018/08/9Utd1QPlGD2Z8t44vep5.jpg)

支付机构负责进行交易资金处理的工作人员，在所有扣款渠道的资金全部入账后，对交易商户所有扣款渠道的交易资金通过一笔资金，完成交易资金的结算。结算系统根据结算流水文件，为交易商户生成对账单，供交易商户后续核对交易订单使用。清分系统对账后，会生成差错交易等待运营人员处理。

### 典型差错类别及处理方法

下面会介绍几种典型的差错类型及其处理方式。

第一种差错类型是长款，简单来说就是支付机构**收的钱多了**。

![img](http://image.woshipm.com/wp-files/2018/08/i9LUbiq4VIqITLEQKQ4B.jpg)

这种类型的差错交易表现为，资金来款方流水文件有记录，而支付机构联机交易状态为未支付、超时等情况。这种情况下，交易商户未收到交易成功信息，支付机构需要交易资金通过来款渠道返还用户。

第二种差错类型是短款，也就是支付机构**收的钱少了**。

![img](http://image.woshipm.com/wp-files/2018/08/zUFcfL3SFFJipcm6DrKH.jpg)

这种类型的差错交易表现为，资金来款方流水文件无记录，而支付机构联机交易状态已成功支付。除了支付机构自身系统故障，错误记录了交易状态之外，发生短款差错的常见原因是，**该笔交易资金在通过人民银行系统进行资金划转时，未能及时划转到来款渠道，导致来款渠道无法将交易资金结算到支付机构**。

这种情况下，支付机构需要向来款渠道发起请款操作，同时将交易商户的其他无差错交易资金进行优先结算。

第三种差错类型双方的交易数据记录不一致，例如交易金额不一致、支付机构记录的成本金额和来款渠道实际成本金额不一致等。

![img](http://image.woshipm.com/wp-files/2018/08/FHggUWV0y97jG4onhr4M.jpg)

发生数据记录不一致的情况，比较罕见，处理差错时，需要业务人员和开发人员配合，根据实际情况进行针对性的处理。

### **对账模块设计思路**

对于支付机构账务对账流程，有了一个宏观的认知后，下面会借鉴支付机构的对账流程，介绍下**互联网电商平台的对账模块设计思路。**

支付系统是电商平台对接各个支付渠道，完成交易订单处理的核心系统。电商平台进行对账模块设计时，首先要进行的就是支付系统对账。

支付系统对账，是将本系统产生的交易资金和支付渠道的结算金额进行核对。包含对**账单下载、数据准备、对账、差错处理**四个环节。

**（1）账单下载**支付系统要对接支付宝、微信、银联等多个渠道，在进行对账单下载时候，就需要针对不同的支付渠道的特点，进行针对性的处理，主要注意这三个方面的不同，分别是：**下载方式不同、下载时间不同以及文件格式不同。**

![img](http://image.woshipm.com/wp-files/2018/08/5UKG6oEmGADjp8Iz4aNU.png)

![img](http://image.woshipm.com/wp-files/2018/08/6FTLWUkt8pdtFTDuYB3J.png)

完成了对账单下载，就需要对渠道对账单数据和本地交易数据，整理成可供对账处理的数据。

**（2）数据准备**

![img](http://image.woshipm.com/wp-files/2018/08/xwDAIDpYJhf1OYKyc0yO.png)

数据准备后，要注意和渠道对账单原始数据、本地交易订单原始数据进行核对，保证数据的准确性。

**（3）对账**单笔账单需要对商户订单号、渠道流水号、交易时间、交易金额等字段进行比对，所有订单进行逐笔比对。

![img](http://image.woshipm.com/wp-files/2018/08/4FIRzQ1PfiWyi9cfibQe.png)

**（4）差错账处理****失败订单**：支付系统中状态为“失败”的，渠道状态为“成功”的订单。

- 首次对账，对账模块本地交易数据无此订单；
- 按渠道数据中的商户订单号、渠道流水号、交易时间，在支付系统查找该笔订单，导入对账模块进行数据准备后，进行二次对账。

**跨天订单**：本地交易数据和渠道对账单记录的交易时间不在同一天。

- 交易时间中日期一致的不记录为差错；
- 日期不在同一天，按本地交易日期计入当天差错交易。


 防踩坑宝典：对接支付渠道二三事

2018-08-31 10:23:57 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/82252282

今天的课程来自于 Ping++  渠道产品负责人——周萍老师的 《 支付渠道业务规则 & 对接管理 》。

其实 Ping++ 在对接支付渠道过程当中，不仅仅是作为聚合支付技术提供方这样一个角色，更多的也是作为一个商家在接入渠道，因此，接下来今天要分享的内容，会以商家的视角去分析对接渠道过程中需要关注的问题。

# 支付渠道业务规则

这部分内容主要介绍常见支付渠道的业务规则以及选择渠道过程中需要关注哪些重点，主要面向商家的业务部门，方便根据自身业务模式匹配最合适的支付渠道。

## 产品概述和应用场景

要想了解支付渠道的业务规则，首先需要知道目前主要的支付渠道、支付产品有哪些，是什么模式，然后商家根据自身产品及业务模式去匹配最优的支付方式。

目前 Ping++ 主要对接的支付渠道有两类：

- 银行：招行、建行、农行等
- 支付机构：微信、支付宝、京东等

每个渠道有自己的收款产品，对应在不同的支付终端上使用。这里讲一下，「支付终端」换成「支付场景」也是合适的，不同公司团队个人叫法可能有所不同，总之方便理解来看就是电脑网站、手机网站以及手机应用等等。

![支付产品及应用场景](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%9B%BE%E7%89%87-1.1.png)

这里将各个渠道的收付款产品放到了对应的支付终端下，不同支付终端下支持的渠道支付产品也有所区别，且需要独立申请开通权限。

下面一张图看看转代付和分账的区别。

 

![转代付](https://blog.pingxx.com/wp-content/uploads/2018/08/%E8%BD%AC%E4%BB%A3%E4%BB%98.png)

B 商家发起收款 100 元，后续可以给 C 端商家或者 B 端商家进行打款。这里需要注明的是，给商家或者用户打款的 X 和 Y 元，跟 100 元没有必然联系，只要确保出款账户内资金足够用于 B 商家打款即可。

![分账](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%88%86%E8%B4%A6.png)

B 商家发起 100 元收款，含分账指令给 C 商户 20 元，那么最终用户完成这笔订单支付的时候，则商家 B 收款 80 元，商家 C 收款 20 元。分账模式比较适用于平台类型的商家或者集团类型的商家，目前所接触到的微信分账并没有对外开放申请，最多关联的分账账户有 5 个的限制。支付宝的分账目前看到的是在跨境上有用到，最多支持在 10 个以内。两个分账功能均需要单独联系 BD 进行申请。

## 行业准入和区别

### 商家收款类别

![收款类别](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%95%86%E5%AE%B6%E6%94%B6%E6%AC%BE%E7%B1%BB%E5%88%AB.png)

1）这里简单列了下大的分类，主要有实物类、虚拟类和政府/事业单位（ 主要指的公立医院和学校 ）走微信和支付宝的渠道申请所对应的费率和结算周期的区别。特殊行业对应所需要的资质也有所区别。

- 实物类：医疗类的会有资质文件才可以申请，比如医疗器械、身体康复用品的需要持有《 医疗器械经营企业许可证 》、经营内容包含美瞳或者隐形眼镜，则需要提供《 第三类医疗器械销售资质 》等等；
- 虚拟类：比如游戏道具购买，需要具备《 网络文化经营许可证 》。

2）商家的行业可以直接参照腾讯或者支付宝的的商家类目、费率、资质的文档，简单粗暴，可以到官网上了解一下。

3）这里提及一下，前面的花呗分期和京东白条产品：使用的前提都是至少拥有支付宝或者京东对应的基础支付功能，才能进一步申请分期的产品权限，目前两家的分期产品的权限都是需要单独联系 BD ，走线下申请的流程，周期较长。

### 商家付款类别

![付款场景类别](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%95%86%E5%AE%B6%E4%BB%98%E6%AC%BE%E7%B1%BB%E5%88%AB.png)

目前银行卡代付的申请，看各家机构的要求，目前尚且没有比较固定的行业分类。基本上 case by case 的去看。所以我们主要看看在使用商家付款产品的时候，需要关注哪些内容。

① 费用

看代付的费用从两种情况来看，一个是付款到银行卡，一个是付款到钱包账户。

② 限额

各家支付机构不一样，但是主要需要与支付机构沟通的是单笔、单日、单月、以及每天的调用频次等是否有限制，限制是多少。

③ 到账时间

选择商家付款渠道的时候也需要关注付款到账时间，因为有些应用场景对于实时性要求比较高。

④ 支持的银行

支持银行列表也需要多加关注，尤其是 B2B 转账或者对于有特殊银行需求的商家。

### 渠道合作模式和优惠政策

早期商家跟渠道的合作比较单一，但是近 2 年渠道也推出来比较多的合作模式来吸引商家以及合作伙伴。

![支付渠道合作模式](https://blog.pingxx.com/wp-content/uploads/2018/08/%E6%B8%A0%E9%81%93%E5%90%88%E4%BD%9C%E6%A8%A1%E5%BC%8F%E5%92%8C%E4%BC%98%E6%83%A0%E6%94%BF%E7%AD%96.png)

简单介绍下各种合作模式：

1、直连

2、直连（ 入驻 ）

3、普通服务商

4、银行服务商

### 各种合作模式的优缺点

![支付渠道合作模式优缺点](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%90%84%E7%A7%8D%E5%90%88%E4%BD%9C%E6%A8%A1%E5%BC%8F%E4%BC%98%E7%BC%BA%E7%82%B9.png)

## 退款处理规则

接下来我们讲讲退款，原先「退款」这一块的逻辑是放在后面渠道开发对接部分的。

但是因为近期日常渠道运营中遇见了一个关于手续费的问题，退款是否退回手续费的问题一定程度上决定了某些特定场景的商户对于支付渠道的选择，因此把它提到业务规则中来聊一聊。

![退款规则](https://blog.pingxx.com/wp-content/uploads/2018/08/%E9%80%80%E6%AC%BE%E8%A7%84%E5%88%99%E5%A4%84%E7%90%86.png)

需要提前捋顺几个问题：

1）退款功能是否需要提前额外申请

2）退款周期是否需要延长

3）退款资金是否需要额外充值：待结算账户、余额充值账户

4）退款或者撤销是否退回原订单的支付手续费

以下是一张关于各渠道的退款周期，是否退回手续费以及退回手续费的逻辑说明：

![退款手续费](https://blog.pingxx.com/wp-content/uploads/2018/08/%E9%80%80%E6%AC%BE%E6%89%8B%E7%BB%AD%E8%B4%B9%E6%B1%87%E6%80%BB.png)

## 支付渠道对接及管理

![渠道对账处理要点](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%90%84%E6%B8%A0%E9%81%93%E5%AF%B9%E8%B4%A6%E5%A4%84%E7%90%86%E8%A6%81%E7%82%B9.png)

1、资金结算方式

手动提现还是自动结算，自动结算是否有资金门槛（ 因为在跨境微信支付宝的渠道资金结算，直连会有 5000 usd 结算资金门槛 ）

2、获取对账单方式

业务需要提前确认获取对账单方式，是只能通过商户平台下载还是也能通过接口下载。

3、清分时间

这个跟获取对账单方式时候可以一并确认，一般渠道的清分时间都是 00-24 点之间的交易。

4、区分不同交易对账单

![对账单汇总](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%90%84%E6%B8%A0%E9%81%93%E5%AF%B9%E8%B4%A6%E5%8D%95%E6%B1%87%E6%80%BB.png)

## 支付渠道对接及管理

这部分内容着重介绍在开发对接渠道过程中需要关注哪些问题，主要面向商家的产品部门。

第一部分主要讲了商家的业务部门在前期申请渠道时候，场景适配以及需要提前跟渠道沟通了解的注意事项。

第二部分就涉及到产品技术对接阶段的一些细节处理。

渠道对接步骤和内容

![渠道对接步骤](https://blog.pingxx.com/wp-content/uploads/2018/08/%E6%B8%A0%E9%81%93%E5%AF%B9%E6%8E%A5%E6%AD%A5%E9%AA%A4%E5%92%8C%E5%86%85%E5%AE%B9.png)

公司内各个部门不同的产品，线上线下产品适用场景不同，费率会有所区分，注意事项在第一部分已经阐述。

1. 切记不要申请错了权限，这个对于微信是比较常见的问题（ 服务号、订阅号、APP ）
2. 配置并获取参数，这一个步骤建议是产品与业务部门能一起操作、确认。另外如果有线下版本的协议，建议产品也可以看下，因为我们曾经遇见过一些渠道有业务处理时间的限制，但是没有写在线下开发文档中，是单独列在了协议中。在获取参数时，部分渠道是一定要通过测试案例提交才能获取正式参数，此处也需要留足项目时间。
3. 对接支付相关的 API ，按照自己内部支付模块以及支付渠道的对接开发文档对接开发即可。
4. 上线结果通知：这一步列在这里的原因是因为对外的技术服务商在日常工作中需要留足足够的时间给协同模块。
5. 关联模块功能更新：可以完成一笔成功的交易并不代表整个交易功能已经完善。比如对于交易明细的展示和管理、报表展示。后期商家内部渠道参数的更新、维护等配套模块也需要做更新。

![对接支付要点](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%AF%B9%E6%8E%A5-%E6%94%AF%E4%BB%98.png)

**① 是否需要添加出口 IP**

部分渠道需要添加 IP 白名单才可以进行开发、测试调试，有些渠道较快的能添加完成，但是有些银行类的可能要走比较漫长的线下申请。

**② 对接的接口版本**

不同支付渠道的接口版本对应的支付渠道的参数也不一样，所以在商务确定产品合作后需要确认对应的业务申请参数和渠道开发的接口版本是否一致。

**③ 订单号长度和组合**

支付机构遇到此类问题比较多。每个渠道的订单规则其实略有不同，例如招行早期的订单号只允许数字形式，不允许其他任何符号；微信、支付宝和银联对订单号的长度要求不同，因此建议订单号长度为 8~20 位，目前来看基本可以适配要求。

**④ 交易金额单位**

一般情况下单位都是以「分」为单位，但也遇到过以「元」为单位的情况。

**⑤ 商品描述特殊字符，是否展示在用户可见的渠道支付页**

部分渠道会因为在商品描述中加入了特殊字符而导致交易失败，然后因为报错提示信息不明显，会导致开发定位较长时间，另外需要确认该信息是否会展示在用户所见的渠道支付页上，避免字段设置的信息给用户产生疑惑。

**⑥ 收款公司名称展示**

常规情况下，大部分支付渠道是可以在后台进行设置或者在入网时有很清晰的提示，但是有些渠道是通过某个字段来进行填写并上传的，比如建行龙支付。

**⑦ 订单过期时间的模式确认**

– 绝对时间（ 某个固定的时间 ）

– 相对时间（ 例如用户在支付页面密码输错了扣款失败，才开始计时 ）

– 二维码有效期

– 过期时间单位

**⑧分期支付是否支持前置展示**

主要是用户体验的问题，假设不做前置展示可能会在最后一步支付时流失掉这个订单。

**⑨ 是否支持禁用信用卡**

有些商家不希望用户支付使用信用卡，部分渠道可以通过请求参数字段进行设置，也有渠道通过入网签订协议后台配置。

**⑩ 前端带回的参数信息**

大部分商家比较在意前端带回的结果参数信息，例如订单号、支付结果等等。

 

![对接退款要点](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%AF%B9%E6%8E%A5-%E9%80%80%E6%AC%BE.png)

**① 可退款订单周期、权限开通**

之前在对接线下扫码支付，走服务商模式，退款权限并不默认开通，需要走线下申请的流程后才可以开通。可退款订单周期如之前提及，需要提前申请确认。

**② 单笔订单退款次数、频率限制**

例如微信是有单笔订单对多 50 次退款限制的，虽然实际场景中遇见单笔退款几十次概率很小，但一旦出现这类情况就需要做好线下给用户退款的准备。

**③ 是否支持原单重试**

这种场景微信比较多，微信现在文档上备注的已经十分详细了，尤其对于商家转账红包这种类型的出款，一定需要提前确认是否支持原单重试，避免重复出款。

**④ 是否支持部分退款 & 是否退还手续费以及计算逻辑**

对接的渠道大部分都支持部分退款，但是有些个别的渠道是支持退款不退手续费。因此商家遇到用户退款的情况，就会在退款时损失手续费。同时对计算逻辑也要进一步确认，有些渠道的手续费分两部分，一部分是固定手续费，一部分是动态手续费。在退款时也会有全退、只退动态手续费不退固定手续费以及手续费全部不退的情况。

**⑤ 多选一单号请求，需要确认优先级**

这个在退款时微信、QQ 钱包都有过类似的问题，例如早期 QQ 钱包超过 30 天的订单如果不使用交易单号就会报错。因此如果渠道的文档表示两个字段二选一都行，就要提前确认好优先级。

**⑥ 退款描述特殊支付，是否展现在用户可见的地方**

这部分和前面是一样的，就不细说了。

**⑦ 是否支持退款的异步通知**

最早期的时候微信退款无异步通知，Ping++ 当时自己做了个自动查询模块，定时（ 5s、10s、20s、1min 等等递增）去调用退款查询接口来获取退款状态，现在微信也支持了退款成功的异步通知，主要的支付渠道也都支持了该功能。

**⑧ 是否区分退款资金来源**

这块主要是需要清楚地明白和业务的关联点在哪里，一般在退款接口上会有区分字段提示。

**⑨ 同步返回的状态，是否可以作为最终结果**

该种情况除了接口文档上的描述外，建议与渠道再做二次确认。通常是根据异步通知或者查询的退款结果进行更新，但是存在部分渠道建议直接根据创建退款同步返回结果直接判断的情况，比如支付宝国际的退款，并不提供退款查询接口。

 

![对接查询要点](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%AF%B9%E6%8E%A5-%E6%9F%A5%E8%AF%A2.png)

**① 支付和退款的查询是否区分接口**

有的渠道不作区分，但有的渠道例如单号是区分支付成功单号以及退款单号两种不同的字段。

**② 确认查询接口展示的状态参数**

比如退款、用户被扫等模式可能存在多个状态，需要考虑多状态之间的关系和更新逻辑。

**③ 多选一单号查询，需要确认优先级**

与前文相同，不做赘述。

**④ 区分通信结果、业务结果、交易结果**

查询一个交易结果之前需要判断通信结果以及业务结果，最终展示的交易状态要根据交交易结果来判断。

**⑤ 结算金额、优惠金额、退款渠道等信息是否返回**

常规情况下渠道会通过支付成功之后的异步通知或者查询返回对应的信息，但是也存在部分渠道是通过后台配置的优惠信息，仅在支付成功页面、对账单中才有体现，并不会体现在交易返回参数中。

**⑥ 查询和异步通知返回的交易相关信息一致**

例如支付宝国际支付，查询与异步通知返回的信息不一致，是由于币种的转换造成的。存在部分返回信息需要提前邮件申请进行配置，虽然对外并没有文档指引和说明。

**⑦ 查询频率是否限制，是否有建议的查询间隔机制**

不同的渠道略有不同，有的渠道对频率有限制、间隔有限制。因此在前期需要确认。

 

![对接异步通知要点](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%AF%B9%E6%8E%A5-%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5.png)

**① 各种交易是否有异步通知**

产品与技术对接过程当中，需要稍微注意一下，因为渠道的文档都放一起，按照惯例是都有的，但是背不住要踩坑，比如线下支付的用户被扫模式。

**② 异步通知地址是请求上送还是后台固定配置**

不同渠道不一样，大部分是通过接口请求上送；小部分渠道通过后台固定地址配置。

**③ 何种状态会触发异步通知**

需要校验异步通知的状态类型，比如支付成功、订单支付中、订单关闭等等，避免未区分异步通知类型导致错误更新订单状态。

**④ 交易成功时间字段**

有些渠道交易成功时间这个字段不正确，可能会导致对账会出现一些问题，需要人工去处理。

**⑤ 是否带回交易请求上送的附加信息**

在渠道提供的交易请求信息并不足以区分商家内部的业务订单时，商家往往还会上送额外的字段信息，有些渠道有去无回，即异步通知不带回该额外信息，导致商家业务更新异常。

**⑥ 重试机制以及恢复信息**

重试机制需要提前确认，如果渠道间隔时间比较长，就需要提前在订单过期前之前加一些查询机制，避免用户体验糟糕。

**⑦ 签名验证或 IP 白名单**

异步通知的验证真伪性一般可以通过签名或者 IP 白名单，如果是 IP 白名单的话提现与渠道确认好出口 IP 。

## 常见对接问题和解决方案

![对接支付渠道常见问题](https://blog.pingxx.com/wp-content/uploads/2018/08/%E5%90%84%E4%B8%AA%E6%B8%A0%E9%81%93%E7%9A%84%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98.png)

一般情况下上图中的情况会导致交易异常，因此建议商家除了对接渠道异步通知也要对接查询接口，可以设置查询任务；同时不建议商家以业务查询结果为参考，查询服务端的订单状态，一旦不一致就调用接口去查询一下，更保险。还有不要查询频率太高，可能造成渠道结果返回不了。

例如支付宝和微信使用线下渠道会有风控（ 一般线上套线下才会有 ），因此匹配自身场景去申请渠道是最安全的。渠道系统异常的情况，最好是多对接几个渠道，万一挂掉了一个另一个也不影响使用。渠道更新接口 / 规则没有及时同步的情况，这就需要经常爬一下各渠道的公告平台了。渠道数据状态不同步的情况只能去咨询渠道，根据渠道的建议去修改查询模块。

# 从 0 开始学支付系统搭建——解析「核算对账核心」

2018-09-26 19:06:56 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/82857240

## **清算对账系统**

支付公司提供的所有金融服务是建立在银行资金体系之上的，支付公司账务系统内账户的资金都与其在银行的存款资金一一对应，为了保证真实的资金账户和虚拟账户的资金转换正确，支付公司必须及时与银行进行各类业务的资金核对，所有资金核对都依赖于银行的系统。

**资金流入与银行的对账**

从银行流入的资金是由银行侧控制资金结转清算与对账时间，即每日客户通过银行向支付机构充值的资金是由银行实时通知支付机构充值指令的发生，银行在每日晚间经过汇总后向支付机构的银行收款账户入账，同时提供入账清算文件。支付机构获取该文件后，与业务数据进行核对。

![img](https://img-blog.csdnimg.cn/20190816115215407.png)

对账结果若相符，则没有问题。若出现对账结果不符，很有可能是系统或者业务在某些环节发生问题，存在两种情况：

\1.   银行充值明细多，支付机构充值明细少；即银行向支付机构入账资金多于支付机构业务发生情况，一般采取临时挂账处理，查出原因后再具体解决；

\2.   银行充值明细少，支付充值明细多；即银行向支付机构入账资金少于支付机构业务发生情况，则可能对支付机构产生资金损失，一般采取临时挂账处理，查出原因后再具体解决。

**资金流出与银行的对账**

从支付公司流出的资金是由银行侧控制资金结转清算与对账时间，即每日客户向支付机构申请提现的资金是在每日支付公司批量向银行发起提现请求时，从支付公司银行存款账户扣转，但扣转的结果一般需要一段时间才能从银行侧得到反馈，当银行侧提供扣转成功和失败的清算文件，支付公司获取这些文件进行明细核对，对于提现失败的申请，由支付公司后台发起直接将资金回充入客户账户，不在对账中心进行对账处理。

![img](https://img-blog.csdnimg.cn/20190816121515364.png)

## **什么是对账？**

![什么是对账.png](https://imgconvert.csdnimg.cn/aHR0cDovL3MxLjUxY3RvLmNvbS9pbWFnZXMvMjAxODA5MjYvMTUzNzk0NzQwNDY2ODIwNy5wbmc_eC1vc3MtcHJvY2Vzcz1pbWFnZS93YXRlcm1hcmssc2l6ZV8xNix0ZXh0X1FEVXhRMVJQNVkyYTVhNmksY29sb3JfRkZGRkZGLHRfMTAwLGdfc2UseF8xMCx5XzEwLHNoYWRvd185MCx0eXBlX1ptRnVaM3BvWlc1bmFHVnBkR2s9)

**什么是资金对账？**

在会计上的概念：指为了保证账簿记录的正确性而进行的有关账项的核对工作，做到账证相符、账账相符、账实相符。

在支付机构的概念：**资金对账**，在对账中心进行，将系统保存的**账务流水**与银行返回的**清算流水**和清算文件进行对账，核对系统账务数据与银行清算数据的一致性，保证支付机构各备付金银行账户每日的预计发生额与实际发生额一致。即核对银行实际清算资金如充值、充退、提现等业务的银行处理结果是否一致。

**对账中心的作用？**

是主要处理对账的系统模块，主要业务是**清算对账**。对账中心部署于工作平台，分别接受**会计系统**和**清算系统**的数据输入进行对账处理。对账中心最主要的**职责**是勾兑银行**清算流水**与支付系统**入账流水**，用以检查反映银存实际账户的余额变化与支付系统内部户余额变化是否平衡；对于已经核对无误的银行清算流水和支付系统入账流水，分别进入相应的历史银行流水库和历史入账流水库。对于勾兑结果中银行清算流水多于系统入账流水的，而操作人员不明确资金的来源，需要根据所设定的分类规则将暂不明确的资金进行**挂账处理**，而后我们认为该部分资金已经系统入账，可以入历史流水库，因为此时的银存实际账户的余额增加，与之对应的是支付系统内部户余额也增加了；比如 T 日的挂账可能会在 T+N 日后进行销账确认，而后续的销账行为是对明细流水的业务分流处理，我们不应将 T+N 日的销账所产生的账务流水作为入账流水，不再需要到对账中心体现。

![什么是对账2.png](https://imgconvert.csdnimg.cn/aHR0cDovL3MxLjUxY3RvLmNvbS9pbWFnZXMvMjAxODA5MjYvMTUzNzk0NzQ0MTkxNDE1NC5wbmc_eC1vc3MtcHJvY2Vzcz1pbWFnZS93YXRlcm1hcmssc2l6ZV8xNix0ZXh0X1FEVXhRMVJQNVkyYTVhNmksY29sb3JfRkZGRkZGLHRfMTAwLGdfc2UseF8xMCx5XzEwLHNoYWRvd185MCx0eXBlX1ptRnVaM3BvWlc1bmFHVnBkR2s9)

![什么是对账3.png](https://imgconvert.csdnimg.cn/aHR0cDovL3MxLjUxY3RvLmNvbS9pbWFnZXMvMjAxODA5MjYvMTUzNzk0NzQ3NDc3MDQzMS5wbmc_eC1vc3MtcHJvY2Vzcz1pbWFnZS93YXRlcm1hcmssc2l6ZV8xNix0ZXh0X1FEVXhRMVJQNVkyYTVhNmksY29sb3JfRkZGRkZGLHRfMTAwLGdfc2UseF8xMCx5XzEwLHNoYWRvd185MCx0eXBlX1ptRnVaM3BvWlc1bmFHVnBkR2s9)

### **对账内容和数据来源**

**第一步**

入账流水和清算流水进行核对，目的是保证对每一笔订单银行的处理结果和我们系统的业务处理结果一致。

**第二步**

对账汇总确认单和银行对账单进行核对，目的是通过轧余额等方式，核对各类业务的银行处理结果是否与银行实际清算给我们的资金一致。

![img](https://img-blog.csdnimg.cn/20190816115349246.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_16,color_FFFFFF,t_70)

**对账业务流程**

![对账业务流程.png](https://imgconvert.csdnimg.cn/aHR0cDovL3MxLjUxY3RvLmNvbS9pbWFnZXMvMjAxODA5MjYvMTUzNzk0NzU2ODE4NzUyNi5wbmc_eC1vc3MtcHJvY2Vzcz1pbWFnZS93YXRlcm1hcmssc2l6ZV8xNix0ZXh0X1FEVXhRMVJQNVkyYTVhNmksY29sb3JfRkZGRkZGLHRfMTAwLGdfc2UseF8xMCx5XzEwLHNoYWRvd185MCx0eXBlX1ptRnVaM3BvWlc1bmFHVnBkR2s9)

**对账业务流程图**

![对账业务流程图.png](https://imgconvert.csdnimg.cn/aHR0cDovL3MxLjUxY3RvLmNvbS9pbWFnZXMvMjAxODA5MjYvMTUzNzk0NzU5MjQ3ODExNi5wbmc_eC1vc3MtcHJvY2Vzcz1pbWFnZS93YXRlcm1hcmssc2l6ZV8xNix0ZXh0X1FEVXhRMVJQNVkyYTVhNmksY29sb3JfRkZGRkZGLHRfMTAwLGdfc2UseF8xMCx5XzEwLHNoYWRvd185MCx0eXBlX1ptRnVaM3BvWlc1bmFHVnBkR2s9)

**对账中心主要功能**

**银行发生资金变动的入账流水**，包括：充值、提现、提现失败、充退、充退失败、退票、购汇、信贷放款、信贷还款、还贷失败一系列业务引起的账务变动信息。这些业务流水在账务系统入账后，**会计核心接收到登记分录请求并处理完毕，发送该流水至对账中心**，对账中心对于某个业务的反向资金变动所产生入账流水也同步至对账中心，这样做的目的是让待清算与入账流水在日切点保持等额，比如提现T 日会员申请提现，生成文件后会员账户提现金额转入待清算提现款项，与此同时发送流水到对账中心，此时待清算与对账中心入账流水是保持平衡的；而T+1 日银行处理失败，系统会回充带清算提现款，如果此时不发送失败流水到对账中心与其对应的流水进行购销的话，则入账流水就会不变，和带清算提现不平衡。

![对账中心主要功能.png](https://imgconvert.csdnimg.cn/aHR0cDovL3MxLjUxY3RvLmNvbS9pbWFnZXMvMjAxODA5MjYvMTUzNzk0NzYyMzkwNDc2Ny5wbmc_eC1vc3MtcHJvY2Vzcz1pbWFnZS93YXRlcm1hcmssc2l6ZV8xNix0ZXh0X1FEVXhRMVJQNVkyYTVhNmksY29sb3JfRkZGRkZGLHRfMTAwLGdfc2UseF8xMCx5XzEwLHNoYWRvd185MCx0eXBlX1ptRnVaM3BvWlc1bmFHVnBkR2s9)

 

**Tips****：**

2、完整的日结流程支持：银行清算流水入库 → 流水对账 → 流水分类 → 汇总确认单 → 自动挂账 → 销账确认 → 操作员轧账 → 总账日结以及登记银行余额等。

4、完善的报表模型输出：如按入账日期 / 银行日期 / 清算日期等的统计报表、银行账户余额报表、未达款项报表等；

8、提供日切服务：在经确认后进入历史清算流水的，同步汇总该部分数据进入历史流水汇总表中保存，所以在日切时，只需直接将该汇总数据再次汇总即可。

9、外围业务功能支持：提供对于银行账户（独立于对账中心之外，不参与处理逻辑）的管理功能，支持与内部户的映射管理，用以满足部分报表需求；提供基于账务核心所提供的业务代码查询功能；提供对于财务系统的交互支持，包括与财务科目的对应关系管理、通知流水数据等；提供用以校验订单与清算流水匹配状态的错账核实功能。

 

**对账流程图**

![对账流程图.png](https://imgconvert.csdnimg.cn/aHR0cDovL3MxLjUxY3RvLmNvbS9pbWFnZXMvMjAxODA5MjYvMTUzNzk0NzY5NzI0MTQxMS5wbmc_eC1vc3MtcHJvY2Vzcz1pbWFnZS93YXRlcm1hcmssc2l6ZV8xNix0ZXh0X1FEVXhRMVJQNVkyYTVhNmksY29sb3JfRkZGRkZGLHRfMTAwLGdfc2UseF8xMCx5XzEwLHNoYWRvd185MCx0eXBlX1ptRnVaM3BvWlc1bmFHVnBkR2s9)

 

**对账中心功能模块分析**

**获取资金对账数据**

·   **获取方式**：需要进行清算流水导入的文件一般通过人工在页面上导入，另外有些业务的流水文件通过系统自动匹配或者定时获取的方式得到。

·   **清算流水导入渠道非常多**：需要统一各清算流水导入功能到一个页面入口， 同时引入清算通道对账的逻辑，将清算流水导入过程需要映射清算通道（包含新增清算流水等）。

·   各类业务的清算流水文件的解析和导入逻辑不一样。

**清算流水对账**

![清算流水对账.png](https://imgconvert.csdnimg.cn/aHR0cDovL3MxLjUxY3RvLmNvbS9pbWFnZXMvMjAxODA5MjYvMTUzNzk0Nzc2ODk4MTUxMC5wbmc_eC1vc3MtcHJvY2Vzcz1pbWFnZS93YXRlcm1hcmssc2l6ZV8xNix0ZXh0X1FEVXhRMVJQNVkyYTVhNmksY29sb3JfRkZGRkZGLHRfMTAwLGdfc2UseF8xMCx5XzEwLHNoYWRvd185MCx0eXBlX1ptRnVaM3BvWlc1bmFHVnBkR2s9)

**a、对账逻辑**

**一对一对账：**入账流水只可能存在一条，银行入账流水也仅存在一条，然后一对一去对。目前按照一对一对账的业务涉及到：网银B2C 充值、网银B2B 充值、VISA、网汇E、卡通充值、正常提现、认证提现、银企互联提现、卡通提现、卖家信贷、信用卡还款提现、COD、网点支付。

**对账标准：**清算通道+ 订单号+ 金额Or 银行名称+ 业务代码+ 订单号+ 金额。

**满足一对一的业务如下：**

·   提现成功：500401

·   认证提现：500402

·   还贷：500404

·   卡通提现：500403

·   个人网银充值：400301

·   企业网银充值：400302

·   VISA：400314

·   网汇e：400315

·   卡通充值：400304

·   贷款：400307

·   银企互联提现：500405

·   信用卡还款提现：500407

·   后台强制提现500406

·   COD

·   网点支付

 

**Tips****：**

o 清算流水有，入账流水也有，金额一致，对账成功，清算流水、对账流水打上 ‘ 对账成功 ’ 标志，记录对账日期为系统当日；

o 清算流水有，入账流水也有，金额不一致，清算流水记金额不等，记录对账日期为系统当日，入账流水不变；

o 清算流水有，入账流水该订单号没有，清算流水打上 ‘ 银行多帐 ’ 的标志，记录对账日期为系统当日；

o 清算流水有，入账流水没有该业务代码初始状态的，清算流水打上 ‘ 银行多帐 ’ 的标志，记录对账日期为系统当日；

o 清算流水有，入账流水没有该银行的初始状态的记录，清算流水打上 ‘ 银行多帐 ’ 的标志，记录对账日期为系统当日；

o 对账之前需要判断1 对1 的流水中是否有重复，有重复的返回失败不进行后续对账。

 

**多对多对账：**入账流水里相同订单号，相同清算渠道，相同，金额相同业务代码的流水存在对条（ 比如充退 ）；而银行清算流水也可能是存在多条的情况的，这种情况下是多对多去对账的，遵循先到的先对的原则。

**对账标准：**清算通道+ 订单号+ 金额Or 银行名称+ 业务代码+ 订单号+ 金额

**满足多对多的业务如下：**

·   充退：410401 

·   银企互联充退：410402

·   Motopay 充退：410403

 

**Tips****：**

o 清算流水有，入账流水有，满足对账标准，则对账成功，清算流水、对账流水打上 ‘ 对账成功 ’ 标志，记录对账日期为系统当日；

o 清算流水有，入账流水有，金额不等，清算流水打上 ‘金额不等’ 的标志，记录对账日期为系统当日，入账流水不变；

o 清算流水有，入账流水没有该订单号，清算流水打上‘ 银行多帐’ 的标志，记录对账日期为系统当日；

o 清算流水有，入账流水没有初始状态410401 的流水，清算流水打上 ‘银行多帐’ 的标志，记录对账日期为系统当日；

o 清算流水有，入账流水没有这个银行初始状态410401 的流水，清算流水打上 ‘银行多帐’ 的标志，记录对账日期为系统当日；

o 清算流水有，入账流水没有初始状态的 ‘410401’ 的流水，清算流水打上 ‘银行多帐’ 的标志，记录对账日期为系统当日。

 

**一对多对账：**入账流水有多条，和银行的一条去对账。

**对账标准：**清算通道+ 订单号+ 金额Or 银行名称+ 业务代码+ 订单号+ 金额

**涉及的业务：境外收单**

·   境外收单购汇扣款（520101）

·   购汇益回补购汇账户（400319）

 

**Tips****：**

o 入账流水存在2 条520101 的，清算流水存在1 条520101 的，将入账流水的2 条加和后的金额和清算流水的进行对账，一致的为对账成功；

o 入账流水存在1 条520101 的，1 条400319的，那么要将2 条金额之差和清算流水的1 条520101 的进行对账。不会出现3 条520101 或者2 条400319 的情况。

**内部流水购销 ：**内部流水购销是针对那种有入账流水表来说的，比如提现业务，提现文件生成就会扣款此时会同步一笔入账流水；而回导失败之后又会回充，此时也会同步一笔反向的业务流水，这两条流水不用再去和银行的资金流水进行对账，直接在入账流水这边进行购销即可。

需要购销的业务如下：

![img](https://img-blog.csdnimg.cn/20190816115514209.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_16,color_FFFFFF,t_70)

o 购销的规则：非已勾销状态下，同一银行同一订单号，金额一致而业务代码相反的正向流水进行勾销，而且一条反向流水只勾销一条；

o 日终轧账时候的购销：日终轧账的时候会对未购销的流水再次进行购销确保当天的流水都购销完全。（这个情况是为了解决反向流水先于正向流水先出现的逻辑错误情况而加的并提示流水号）；

o 如果业务代码相反，而金额不等的情况，就无法进行购销，这种情况原来是作为违反逻辑规则来进行标记的。这部分数据进行查明之后，可以修改流水之后，在日终轧账的时候从新进行购销；

o 购销分 ‘一对一’（ 提现 ）和 ‘多对多’ （ 充退 ）的购销；

o 勾销的流水不入历史库。

**对账汇总确认单**

显示对账结果，选择后续的相应的处理界面，复核员在此模块进行流水的确认，还有的功能就是对于已经对账处理的银行清算流水与系统入账流水进行后续业务分流推进。

o 对于大部分对账成功的数据，可以将这些**流水确认**，确认后该部分流水将进入历史清算流水，只有进入历史清算流水的才认为银行与支付系统数据对平。对账成功的银行清算流水、账务入账流水全部进入各自历史清算流水表保存，相应的银行清算流水与入账流水同步删除；

o **金额不等的流水**，可能是银行清算流水文件有误，也可能是错账，采取的做法是操作员手工修改金额，在银行清算流水管理里操作或直接删除，将其推进到下一轮的对账处理环节，**对账是可以重复对的**，只要满足**初始状态**要求的流水即可；

o **多账部分**，由于各种已明确/未明确的原因，银行已经实际清算给支付公司了，但支付公司的账务系统并没有入账，需要提供一个**流水分类和分类汇总挂账**的操作入口。系统默认**多账的流水给出的菜单是流水分类**，金额不等的流水给出的流水管理页面。区别在于，在点流水分类时，只允许修改业务类型、银行日期，而且改完后不改变多账状态；流水管理，修改状态后，流水的对账状态将变成初始状态，需要进行重新对账。

o **流水进入历史库的校验规则**。举例说明：A 操作员导入了一笔流水，系统对账成功，银行清算流水与账务入账流水状态都被置为成功状态；B操作员再次导入该相同流水，由于入账流水处于成功状态的可以继续对账，所以再次对账成功；系统在对账环节认为正常，但在入历史清算流水时必须做每组流水数据的平衡检查：必须是清算流水总额与入账流水总额匹配才可以进历史数据；对于上述的场景，如复核员针对B操作员的对账成功流水确认后，可以正常进入历史流水，对账批次号认最后操作的批次；而继续对A 操作员的成功对账流水确认，则系统将认为是不合法的入历史流水行为；或者不对特定操作员的汇总确认，系统必须检验出所存在的重复银行清算流水，并将对应的明细数据显示复核员；此时可将该重复对账的清算流水删除即可。

**流水分类和分类汇总挂账**

o 对于多账的流水对账中心提供一个单独的处理入口，首先在此处进行分类，然后进行汇总挂账处理。操作人员可以根据多账流水的未确认类型修改成对应的业务代码，允许修改成业务类型为7 的可挂账的类型（ 其他业务代码不允许挂账 ）；流水可以重复分类，系统不做控制；但已申请挂账的除外，分类完毕的多账流水可直接提供分类汇总挂账操作。

o 系统根据既定的业务代码判断是待查收入或待查支出挂账，页面跳转至相关凭证登记页面，此处业务规则同待查收支挂账；另一部分比如退票，因为不经过对账环节，所以需要直接在清算流水查询里面新增，业务代码700106 未确认退票，不需要经过对账，直接去汇总确认单里将流水挂账。允许挂账的业务代码如下 ：700101 其他应付款，700102 其他应收款，700103 银行错账，700104 未确认结汇款，700105 线下汇款，700106 未确认退票，700107 未确认收款，700108 未确认支出款。

o 提交凭证登记申请相关校验：流水此刻状态是否是 ‘多帐’ ，申请提交人是否是当时的对账人，凭证登记成功，清算流水记录凭证号，流水状态改为 ‘已挂账’ ；

o 汇总挂账的反交易同步入账流水，金额是负值，系统在清算流水里在做一条数据，自动对账。

**清算/入账/历史流水管理**

**a****、清算流水管理**

对于所有的清算流水，都可以在此模块下进行查询，修改，删除，同时也可以新增流水。

o **查询功能**，银行名称、业务代码、银行日期不能为空，业务代码和银行可以多选；

o **修改功能**，处于未对账（ 初始 ）、金额不等、多账、对账成功状态的流水可以进行单笔、批量修改操作，这里的批量修改动作与流水分类功能类似，只是该功能入口不仅支持对批量流水的业务代码、银行日期更新，也支持其他要素信息批量修改，作为提供给操作员在未对账前批量修改已知流水的手段之一；对已挂账的流水，不允许更新。

o **流水删除**：处于未对账（ 初始 ）、金额不等、多账、对账成功状态的流水可以进行单笔、批量删除操作，已挂账状态不允许删除。

**b****、入账流水管理**

入账流水管理功能提供对账务入账流水的查询以及下载功能；为了杜绝对入账流水的人为变更操作，**禁止支持对入账流水进行修改或删除处理。**

o 查询时银行名称、业务代码、入账日期不能为空，业务系统流水号：针对某类业务的业务流水号，如充值业务就是充值流水号；账务流水号：账务处理的流水号，即账务操作记录数据的序号，在账户明细查询里可以获取。

o 对于提现类失败回充的流水，在操作员进行对账动作后，系统自动进行购销，在入账流水查询时，将对账状态选为已购销可以查到，这些不进入历史库，根据数据量，系统定时清理这些数据。

**c****、历史流水管理**

分为历史入账流水和历史清算流水，查询功能在同一页面，查询时可以一起查询，也可以单独查询。历史流水只供查询和下载，不允许进行修改和删除操作。选择历史银行流水和历史清算流水（ 清算日期的时间间隔不能超过7 天 ）进行查询，历史入账流水中无银行日期，历史银行流水中无入账日期。

**银行余额录入功能**

在该模块下，实现对每个银行账户的实际余额录入，以此来和内部账户余额进行匹配校验。分为银行余额登记，银行余额导入（ 复核 ），以及银行余额查询功能。

o **银行余额登记**：选择对应日期以及银行账户录入后，保存，此时去银行余额查询是看不到录入余额的，需要复核导入核对完毕后才能看到，保证核对的有效性。登记后系统记录一个临时余额。系统每天凌晨1.15 的时候会跑批，取上一日已复核过的余额自动带入下日临时余额，如果不登记的话，就取上日余额。

o **银行余额导入**：标准格式是一个填写银行余额的excle 模板。导入后的核对逻辑，对复核员导入的数据进行检测该帐户是否有临时余额。根据银行账号、银行日期、银行余额等条件查询银行余额表，如果判断1 ：如果查询出结果为空那么将返回给用户：“这个银行帐号找不到对应的银行临时余额！”。判断2 ：如果查询结果大余一条，将返回给用户：“这个银行帐号的一天有多个银行临时余额，不正常！”判断3 ：检测该银行帐号对应的银行余额是否相等。如果不相等将返回给用户：“临时余额和实际余额不相等，核对失败！”当余额核对成功后，将复核员导入的余额写入该对应帐户的实际余额，并修改余额状态为已复核。实际余额更新成功后，将删除当天日期的临时余额。

o **银行余额查询**：对操作员登记余额的信息，以及复核员复核过的余额进行查询，查询条件：银行名称、银行帐户、帐户状态、银行日期、余额状态。帐户状态：分为正常、废除、和销户三个状态，默认为正常状态。余额状态：分为未录入（N ）、已录入（A ）、已复核（Y）三个状态，默认为全部。

**内部账户登账**

**a****、业务简述**

针对日常结算工作中非银行待查类的内部账户进行登记，如：清算款、利息、手续费等；该业务登记不产生后续业务登记行为,即不具有作为初始凭证号的使用功能。对于批量销帐类业务处理中，多会员转帐失败的，导致过渡户上有剩余金额情况的，可通过此处进行内部户登账，将过渡户( 负债)和银存( 资产)余额同时减少，再通过待查收入挂帐实现平衡。

**b****、业务校验规则**

\1.   必须登记的是一借一贷帐户信息；

\2.   借贷方帐户不能一致；

\3.   金额必须大于0 ；

\4.   不允许任意一方是销帐帐户。

![img](https://img-blog.csdnimg.cn/20190816115555871.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_16,color_FFFFFF,t_70)

**c、是否同步对帐中心流水**

不需要同步对帐中心流水

**待查收入挂账**

**a****、业务简述**

应用于结算操作员针对日常结算工作中的银行待查收入进行登记；所产生的业务凭证号作为后续销帐业务的原业务凭证号，并且作为所有该登记所引发的后续业务登记的初始凭证号。其中待查收入挂帐业务凭证的借方（ 银存帐户 ）所对应的银行名称作为后续销帐业务的银行名称，包括差额重新挂帐部分再销帐的业务凭证，都递沿该银行名称。

**b****、业务校验规则**

\1.   必须登记的是一借一贷帐户信息；

\2.   借贷方帐户不能一致；

\3.   金额必须大于0；

\4.   借方帐户必须是银存帐户；

\5.   贷方帐户必须是销帐帐户。

![img](https://img-blog.csdnimg.cn/20190816115624189.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_16,color_FFFFFF,t_70)

**c****、是否同步对帐中心流水**

不需要同步对帐中心流水

**待查收入确认**

**a****、业务简述**

针对银行待查收入登账的挂帐，可以通过本模块进行销帐；此处采取销帐确认方式进行处理，需要选择相应的待查收入挂帐业务凭证进行销帐业务登记；该业务登记可能产生后续业务登记行为，如差额销帐情况下系统会自动做不足额部分的重新挂帐并复核通过，所产生的挂帐凭证作为后续销帐凭证的销帐卡片号。

**b****、业务校验规则**

\1.   所销的原待查收入挂帐凭证必须合法；

\2.   所销的原待查收入挂帐凭证必须已复核通过，处理完毕；

\3.   所销的原待查收入挂帐凭证不能已被销帐；

\4.   销帐总额(贷方发生额之和不得大于原待查收入挂帐凭证发生额)并大于0 ；

\5.   贷方必须是内部户。

![img](https://img-blog.csdnimg.cn/2019081611565381.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_16,color_FFFFFF,t_70)

**待查支出挂账**

**a****、业务简述**

针对日常结算工作中的银行待查支出进行登记，所产生的业务凭证号作为后续销帐业务的原业务凭证号，并且作为所有该登记所引发的后续业务登记的初始凭证号。其中待查收入挂帐业务凭证的贷方（ 银存帐户 ）所对应的银行名称作为后续销帐业务的银行名称，包括差额重新挂帐部分再销帐的业务凭证，都递沿该银行名称。

**b****、业务校验规则**

\1.   必须登记的是一借一贷帐户信息；

\2.   借贷方帐户不能一致；

\3.   金额必须大于0 ；

\4.   贷方帐户必须是银存帐户；

\5.   借方帐户必须是销帐帐户 。

![img](https://img-blog.csdnimg.cn/20190816115715415.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_16,color_FFFFFF,t_70)

**c****、是否同步对帐中心流水**

不需要同步对帐中心流水

**待查支出确认**

**a****、业务简述**

针对银行待查支出登账的挂帐，可以通过本模块进行销帐；此处采取销帐确认方式进行处理，需要选择相应的待查支出挂帐业务凭证进行销帐业务登记；该业务登记可能产生后续业务登记行为，如差额销帐情况下系统会自动做不足额部分的重新挂帐并复核通过，所产生的挂帐凭证作为后续销帐凭证的销帐卡片号。

**b****、业务校验规则**

\1.   所销的原待查支出挂帐凭证必须合法；

\2.   所销的原待查支出挂帐凭证必须已复核通过，处理完毕；

\3.   所销的原待查支出挂帐凭证不能已被销帐；

\4.   销帐总额(借方发生额之和不得大于原待查收入挂帐凭证发生额)并大于0 ；

\5.   借方必须是内部户。

![img](https://img-blog.csdnimg.cn/20190816115740239.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_16,color_FFFFFF,t_70)

## **意外数据恢复逻辑**

![img](https://img-blog.csdnimg.cn/20190816121058351.jpg)

**重复支付：**对同一内部订单号进行了二次或二次以上的支付。

**支付失败，金额不等：**买家实际支付的金额与交易金额不等。一般产生的原因是，买家在支付时，产生了掉单，卖家随后修改了交易价格。 在进行网银对账的时候，即会出现订单金额和交易金额不等的情况，且是一笔掉单。**2****、3 两类情况只发生在支付上。**

**支付成功，金额不等（这一类异常，偶尔有发生）：**商户订单状态为成功，后台订单状态也为成功，并且交易状态是买家已付款，等待卖家发货。（ 金额不等，支付成功，是因为会员对一个交易进行支付，但由于网络或银行系统等原因支付公司未接收到银行扣款信息，支付侧交易状态未予以变更，后卖家对该交易修改了价格，买家又对该修改过的价格进行了支付，但该支付成功的信息仍然没有被支付侧接收到，该交易状态仍未变更，后支付侧后台人员先对后面的那笔意外数据进行了恢复，后再对前面那笔意外数据恢复，就会出现这种“金额不等，支付成功”的数据 ）

![img](https://img-blog.csdnimg.cn/2019081612112646.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_16,color_FFFFFF,t_70)

### **对帐及异常恢复逻辑**

**以商户成功订单为准**

用商户上的成功订单与后台的订单来核对：

o 若商户订单为成功，后台为初始或者失败，则更改后台状态为成功；

o 若后台为成功，商户成功订单中无该订单（时间差），则不更改后台状态；

o 若后台为初始或失败，商户成功订单中无该订单，则不更改后台状态；

**不重复恢复**

T＋1 日恢复T 日的订单，并且在 T＋1 日后不再下载 T 日的订单进行二次或多次恢复。（为考虑会员感受，T 日下班前恢复T 日0 点到下班时点的订单）

**时间性差异**

由于各家银行系统日切点均不同，并且大多不会在每日的 24 点（或早或晚），所以下载到的T 日的订单流水与后台T日（ 0:00－24:00 ）的订单流水并不能全部对应上。将商户订单流水与后台订单流水核对，会出现商户有，后台无；商户无，后台有；商户有，后台有三种情况。对于 1、2  两种情况为我们所说的时间性差异。

**商户数据与后台数据的关系为：**

商户数据－（ 商户有，后台无 ）＋（ 商户无，后台有 ）＝后台数据

![img](https://img-blog.csdnimg.cn/20190816121204704.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_16,color_FFFFFF,t_70)

 

# 硬核干货 & 文末福利 | 支付系统设计之查漏补缺的一环——差错账处理

2018-10-26 18:25:31 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/83419132

各位学员大家好，学习无止境，主任今天的内容，是支付系统设计中非常重要的一环——差错账处理。本篇内容来自支付学院 · 一期特约讲师秋秋，大家呱唧呱唧。

 

# **当日反交易**

## 概念简述

当日反交易是把当日初始凭证下所有后续业务登记（包括该初始凭证本身）所产生的账务流水和会计分录分录整套全部抹掉，适用场景特殊，特别是对于批量销帐类业务，慎用。

进行反交易处理后，如该初始凭证下存在未销帐的挂帐凭证，也是不允许对其进行后续销帐业务登记处理的。

 

## **业务校验规则**

1. 被反交易凭证必须是当前日所产生的；
2. 被反交易凭证以及其后续其他业务登记凭证状态必须全部是复核通过并处理结束；
3. 已经被隔日冲正过业务凭证不能被反交易；
4. 已被反交易过的业务凭证不允许被冲正；
5. 补偿校验，必须通过会计核心业务校验：允许对所选择的凭证进行反交易。

 

## **系统数据反映**

![img](https://img-blog.csdnimg.cn/20181026181136834.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_27,color_FFFFFF,t_70)

 

- 源帐户指所有分录所对应的帐户，源金额指所对应的发生额；
- 会计平台中借贷方均为空，发生额为 0 ；
- 不需要同步对帐中心流水；
- 不产生新的账务流水，只在原流水上做抹账标记并反向更新帐户余额，被抹账的分录所对应的账务流水至少对前台用户不可见；
- 不产生新的红、蓝字分录；
- 对于红字或打上抹账标志的账务流水以及分录都不做更新。

**注：不需要同步对账中心流水**

###  

### **举例**

反交易是针对整套业务（依据原始业务凭证）进行反交易，仅限于整套都是当日的业务（可以包含当日正常和登记以及当日后续单边抹账产生的分录），反交易成功后账户明细和分录都将不体现，但记录反交易日志；

**凭证详细信息**

![img](https://img-blog.csdnimg.cn/20181026181255714.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_27,color_FFFFFF,t_70)

 

**分录查询**

![img](https://img-blog.csdnimg.cn/20181026181315299.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_27,color_FFFFFF,t_70)

**分录信息**

 

![img](https://img-blog.csdnimg.cn/20181026181334625.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_27,color_FFFFFF,t_70)

#  

# **当日单边抹账**

## 概念简述

针对当日复核通过并处理结束，而由于登记错误部分记账操作是错误的，可以针对所产生的分录进行当日单边抹账处理。

可对当日凭证做多次单边抹账处理，所达到的目的是将被抹账的分录所对应的款项转至指定的正确目标户，该凭证产生蓝字分录；允许多对多抹账，但方向必须一致。

 

 

**业务校验规则**

1. **必须是单边抹账，即只能抹借贷一方，并且至少有一条被抹分录和目标户信息；**
2. 被抹账分录必须是当日所产生的；
3. 被抹账分录必须归属于同一业务凭证；
4. **被抹账分录业务代码必须一致；**
5. 被抹账分录所属的业务凭证状态必须是复核通过并处理结束；
6. 被抹账分录所属的原始业务凭证及其后续业务登记凭证不能已被隔日冲正过；
7. 被抹账分录所属的原始业务凭证不能已被反交易；
8. **所抹账的分录必须与目标户所产生的蓝字分录方向一致；**
9. **所抹账的分录总额必须与目标户所产生的蓝字分录总额一致；**
10. 红字分录不允许被抹账；
11. 已抹账的分录不允许被抹账；
12. 补偿校验，必须通过会计核心业务校验：允许对所选择的分录进行当日单边抹账。

## **系统数据反映**

![img](https://img-blog.csdnimg.cn/20181026181506653.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_27,color_FFFFFF,t_70)

 

注：

1. 源帐户指被抹账分录所对应的帐户，源金额指所对应的发生额；

2. 目标帐户指所指定的目标户，目标金额指指定的发生额；

3. 会计平台中借/贷方只显示单边帐户信息。

4. 不需要同步对帐中心流水

5. 由于不产生红字账务流水，只在原流水上做抹账标记并反向更新帐户余额，被抹账的分录所对应的账务流水至少对前台用户不可见；

6. 蓝字(目标户)所新产生的账务流水以及会计分录的业务代码与被抹账分录的业务代码保持一致；

7. 蓝字分录的方向根据所抹账分录的方向一致。

    

**注中注：不需要同步对账中心流水**

 

**举例**

- 可根据业务登记中的初始凭证流水号选择原始数据（成套分录）进行单边抹账，对于分录级别的重复单边抹账，系统报错，不允许操作，单边抹账本身也产生业务凭证。
- 只允许针对当日的分录进行当日的单边抹账操作；
- 单边抹账是把选择要抹账的业务流水设置成删除，然后新增蓝字同向的新业务流水，操作上类似于冲正业务，可以选择需要进行单边抹账的业务流水，然后新增新的同方向的业务流水；

**凭证详细信息**

![img](https://img-blog.csdnimg.cn/20181026181536640.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_27,color_FFFFFF,t_70)

**分录查询**

![img](https://img-blog.csdnimg.cn/20181026181554783.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_27,color_FFFFFF,t_70)

**分录信息**

![img](https://img-blog.csdnimg.cn/20181026181946932.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_27,color_FFFFFF,t_70)

#  

# **隔日冲正**

## 概念简述

所达到业务目的同当日单边抹账业务登记行为，不同的是必须在T日后方可对T日的分录进行冲正；可对T日凭证做多次冲正处理，所达到的目的是将被抹账的分录所对应的款项转至指定的正确目标户，该凭证产生红、蓝字分录；允许多对多冲正，但方向必须一致。

## **业务校验规则**

1. 必须是单边冲正，即只能冲正借贷一方，并且至少有一条被冲正分录和目标户信息；
2. 被冲正分录必须是当前日所产生的；
3. 被冲正分录必须归属于同一业务凭证；
4. 被冲正分录业务代码必须一致；
5. 被冲正分录所属的业务凭证状态必须是复核通过并处理结束；
6. 被冲正分录所属的原始业务凭证不能已被反交易；
7. 所冲正的分录必须与目标户所产生的蓝字分录方向一致；
8. 所冲正的分录总额必须与目标户所产生的蓝字分录总额一致；
9. 红字分录不允许被冲正；
10. 已被抹账的分录不允许被冲正；
11. 已被冲正的分录不允许被冲正；
12. 补偿校验，必须通过会计核心业务校验：允许对所选择的分录进行隔日冲正。

## **系统数据反映**

![img](https://img-blog.csdnimg.cn/2018102618204477.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_27,color_FFFFFF,t_70)

 

注：

1. 源帐户指被冲正分录所对应的帐户，源金额指所对应的发生额；
2. 目标帐户指所指定的目标户，目标金额指指定的发生额；
3. 会计平台中借/贷方只显示单边帐户信息。
4. 不需要同步对帐中心流水；
5. 产生红字账务流水，前台用户可见；
6. 红、蓝字所新产生的账务流水以及会计分录的业务代码与被冲正分录的业务代码保持一致；
7. 红、蓝字分录的方向根据被冲正分录的方向一致。

**注中注：不需要同步对帐中心流水**

##  

## **举例**

**凭证详细信息**

![img](https://img-blog.csdnimg.cn/20181026182138250.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_27,color_FFFFFF,t_70)

**分录查询**

![img](https://img-blog.csdnimg.cn/20181026182155784.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_27,color_FFFFFF,t_70)

**分录信息**

![img](https://img-blog.csdnimg.cn/20181026182210980.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_27,color_FFFFFF,t_70)

# **实战举例**（反交易、当日单边抹账、隔日冲正）

![img](https://img-blog.csdnimg.cn/20181026182249441.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_27,color_FFFFFF,t_70)

 

# 支付系统之会计核心（下） | 颈椎病治疗疗程即将结束，好好学习，肌肉强健

2018-11-05 11:23:36 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/83745919

![img](https://img-blog.csdnimg.cn/20181105112259294.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_16,color_FFFFFF,t_70)

## 一、复式记账

第一个问题：如何理解账务系统单边记账，会计系统复式记账？

有些公司内部账户之间转账都采用复式记账法，如充值、提现交易，他们在**账务系统都记单边流水**，等和银行对账后，在**会计系统复式记账**。

### 1. 以充值为例

用户充值：秋秋支付宝充值100 元，那么在账务系统里面单边记账，主要就是如下的流水信息：

![img](http://image.woshipm.com/wp-files/2018/11/KITeJFAamaLgBuvUwL7H.png)

若有N 多条充值的流水，在账务系统中会记录客户分户N 多条账务流水，并实时更新**外部分户**的流水和分户余额。

同时发送该充值业务数据到会计核心，会计核心根据账务系统提供的会计科目做一条客户帐分户的贷方分录，日终汇总分别借记一条工商银行待清算款充值账户的分录，同时更新相应科目下的**内部分户**余额，在会计系统中会对应的生成会计分录流水：

![img](http://image.woshipm.com/wp-files/2018/11/XF7CUXZ37O48DpHe5JRs.png)

银行对账后 ，对账结果触发会计系统会计分录：

![img](http://image.woshipm.com/wp-files/2018/11/Nyrybq2EOY9qOzNHOsig.png)

## 二、会计基础入门

**第二个问题：如何理解会计中的“借”和“贷”？**

首先明确一个公式：资产= 负债+ 所有者权益

![img](http://image.woshipm.com/wp-files/2018/11/CrHhdkSf11NBMa41O8x8.png)

规律：

- 当秋秋收到现金时，都是**借：我的现金** **贷：其他科目**；说明我的现金时借方表示增加。
- 当秋秋借别人钱时，负债增加了，**借：其他科目 贷：我的负债**（属于别人的钱），说明我的负债是贷方表示增加。
- 当秋秋辛苦攒下的积蓄，所有者权益增加了，**借：其他科目 贷：属于我的财产**，说明属于我的财产是贷方表示增加。

![img](http://image.woshipm.com/wp-files/2018/11/MgPZGeBI11FxicNjKHEG.png)

## 三、会计科目和账户

![img](http://image.woshipm.com/wp-files/2018/11/QLCg8qraOxFE03MY1qYX.png)

### 1. 会计科目

- 会计科目按其反映经济内容的不同一般分为**资产类、负债类、所有者权益类、收入类、费用类、利润类**六大类科目。由于支付机构主要核算客户资金和备付金资金账户，没有直接采用所有者权益类、收入类、费用类和利润类科目，仅仅设置资产类、负债类、共同类（待清算），严格遵循会计恒等式。
- 资产类科目余额方向一般在借方，负债类科目的余额一般在贷方，共同类既具有资产也具有负责属性，属于双重科目。

### 2. 科目层级

为了既能够提供总额核算，又能提供明细核算，会计科目一般更具具体需求设置层级。

按照提供指标的详细程度不同，可以分为总分类科目、明细类科目。**总分类科目**就是我们说的**总账科目**或者叫一级科目，是总体反映会计要素具体内容的科目。

**明细分类科目**，也就是明细科目，是对总分科目所含内容做详细分类形成的会计科目。

明细科目根据会计核算和经营管理需要还可设置二级、三级科目。没有下级科目的会计科目为叶子科目，即底层科目，底层科目下按照实际账务处理设置会计账户，会计账户与资金账户一一对应。**只有叶子科目下才能开立账户，非叶子科目下不可以开立账户。**

### 3. 科目和账户的关系

![img](http://image.woshipm.com/wp-files/2018/11/JnnNR89pCSCxDk807Ijt.png)

- 资产类科目记在借方表示增加，记在贷方表示减少；
- 负债类科目记在借方表示减少，记在借方表示增加；
- 所有者权益记在借方表示减少，记在贷方表示减少；
- 费用类科目记在借方表示增加，记在贷方表示减少；
- 利润类科目记在借方表示增加，记在贷方表示增加。

### 4. 交易流程与资金平衡

![img](http://image.woshipm.com/wp-files/2018/11/FupQPU2EIyXwcoWeqZa2.png)

### 5. 内部户和科目的关系

![img](http://image.woshipm.com/wp-files/2018/11/fIrDq3Cj0vIWKZz712br.png)

### 6. 会计科目平衡关系

![img](http://image.woshipm.com/wp-files/2018/11/QvU1KYG6igulPsdazE1M.png)

- 在一级科目110银行存款下，针对不同银行可以设置多个二级科目：11001 A银行存款科目，11002 B银行存款科目；
- 在每一个银行存款二级科目下，根据收付业务目的的不同，又可以设置多个三级科目：1100101 A银行存款_收款专用科目，1100102 A银行存款_付款专用科目，1100103 A银行存款_归集专用科目。

### 7. 每个类目的科目平衡关系

- 叶子科目余额= 该科目下所有账户余额综合；如：1100201 科目余额= 1100201科目下所有账户的余额总和。
- 科目汇总余额= 该科目下所有叶子科目余额总和；如：110 一级科目余额= 110 一级科目下所有叶子科目的余额总和。
- 总账余额= 该科目下所有同级科目汇总余额总和；如：资产类总账= 资产类所有科目的余额总和。

**201 和 202 科目属于客户账科目，其余科目均属于内部账科目，即 201 和 202 科目下的账户属于客户账，其余科目下的账户属于内部账。**

## 四、会计资金平衡关系

采用复式记账法，保证会计核算资金的平衡关系，复式记账法是指对发生的每一项经济业务，都以相等的金额，在相互联系的两个或者两个以上账户中间同时进行登记的方法。

公式①：**资产 （借方余额）= 负债（贷方余额）+ 待清算（借方余额）**

公式②：原始平衡关系：资产 （0）= 负债（0）+ 待清算（0）

![img](http://image.woshipm.com/wp-files/2018/11/XEzOlTgQh9A0JrZiCcxI.png)

支付机构的资金管理体系是在银行资金管理体系基础上建立了，为了能清晰的理清资金的流入与流出关系，保证收支两条线；支付机构一般会在每家合作银行分别开设收款专用户和付款专用户。

其中收款专户是专门用来归集充值流入的资金，付款专户专门用来归集提现流出的资金。

### 1. 充值业务资金流动机制

当充值业务发生时，银行直接从客户的银行账户进行扣款，但是并不会立即向支付机构的银行账户入账，而是先挂入银行内部过渡账户，在日终处理时统一讲当日累计充值资金一次性向支付机构收款专业银行账户入账。

### 2. 提现业务资金流动机制

当提现业务发生时，支付机构并不是立即通知银行扣款，而是在每日定时将一段时间内同一家银行申请提现的请求汇总提交给银行，由银行负责从支付机构付款专用银行账户进行扣款，向客户的银行账户入账。

### 3. 资金调度机制

为了保证每家银行的收款专户资金得到统一的调度支配，同时满足每家银行付款专户的资金需求，支付机构会指定唯一的一家合作银行开设统一归集账户，每日将各家银行收款专户内充值业务资金汇总归集到这个唯一的归集账户内，并根据各家银行付款专户提现业务需要支付的资金，从归集账户向各家银行付款专户划转调拨资金，确保提现支付成功。

支付机构在银行的资金管理体系的基础上，从自身的资金管理需求出发，搭建了自己的资金调度体系，其资金流基本和银行类似，典型的资金体系如下：

![img](http://image.woshipm.com/wp-files/2018/11/XkmqVuJVx5VfgCHYsoJW.png)

由于支付机构内部待清算充值款项是当晚核心系统日终后才能结转到银存收款账户后，才能进行调拨，而每日下午在产生给银行的提现数据时，就需要保证银存付款专户上的资金到位，这样资金调拨就会存在时间差，为了解决这个时间差问题，于是内部设置了一个调拨户进行资金中转。

调拨专户是一个虚拟的账户，不是与真实资金账户对应的账户，余额方向可以是借方或贷方。每日在向银行提交提现数据前，先内部从银行收款账户进行调拨，如果由于时间差原因收款账户资金余额不足，则直接从调拨专户上调拨资金到收款账户，再从收款账户向付款账户调拨。

![img](http://image.woshipm.com/wp-files/2018/11/XxNSKyVpuGQ3Z91D9nFP.png)

**资金调拨专户上的缺口部分需要在日终结转时予以轧差抹平，即现将待清算充值资金结转到调拨户，再从调拨户结转到银行存款收款账户。**

## 五、会计驱动的入账机制

账务系统作为会计系统的前置，一般的业务请求都是由账务系统先完成记账再向会计系统发送请求进行会计记账。

但是有两项特殊业务是会计系统独立处理，并是由会计系统向账务系统发起请求进行最终账务记账处理的，这就是涉及银行资金结算的**充值、提现业务**的待清算账户单边归总记账和日终的会计结转记账。

### 1. 充值业务在会计系统中单边汇总的流程

![img](http://image.woshipm.com/wp-files/2018/11/PcPqIvVQYaGty95p8XGp.png)

### 2. 提现业务在会计系统中单边汇总的流程

![img](http://image.woshipm.com/wp-files/2018/11/xRnjEhDNziZJo4shLCbe.png)

## 六、会计日终处理

![img](http://image.woshipm.com/wp-files/2018/11/txNiTGpNqWjoVrpkl1IO.png)

### 1. 日终前的账务准备阶段

向对账中心通知会计日终处理开始。

针对充值业务和提现业务员的日间单边记账进行汇总，完成待清算款项的汇总单边记账。

![img](http://image.woshipm.com/wp-files/2018/11/eZXdqSQmHfLutdqL1OFL.png)

通知对账中心日终对账，并获取对账中心返回的银行对账结果数据。

根据各家银行充值业务的对账结果数据，汇总结转各银行待清算充值资金到各银行存款账户（若有资金调拨，则结转到资金调拨账户）。

![img](http://image.woshipm.com/wp-files/2018/11/TcmJPHNZQ9ji4ElykQM9.png)

对于有资金调拨的银行，根据充值业务的对账结果数据，汇总结转各家银行资金调拨资金到各银行存款账户。

![img](http://image.woshipm.com/wp-files/2018/11/yjxrFQSq4RDEdc4Okc6S.png)

根据提现业务的对账结果数据，汇总结转各银行待清算提现资金到各银行存款账户。

![img](http://image.woshipm.com/wp-files/2018/11/poqfr0vH4de5f4JvIDIb.png)

因为资金调拨专户需要在日终时归零，所以对于差额部分需要轧差记账，即结转各家银行资金调拨余额到各家银行存款账户。

![img](http://image.woshipm.com/wp-files/2018/11/NUXabmRan5S50W9cfebd.png)

### 2. 日终的轧差与汇总处理阶段

检查所有账户当日会计发生额是是否借贷相等，即借方发生额=贷方发生额，若不相等，则自动登记轧差金额的会计分录，保证借贷发生额平衡，对于导致借贷发生额不平的原因事后查询解决。

对账户的会计分录按借贷进行汇总，同时根据各账户上日余额和当日的发生额计算得到每个账户当日余额。

![img](http://image.woshipm.com/wp-files/2018/11/8rBGRkNMefBdlLRB9MuH.png)

按照科目对科目账户的会计分录进行汇总得到科目当日发生额，同时根据各科目上日余额和当日的发生额计算得到当日科目余额。

![img](http://image.woshipm.com/wp-files/2018/11/YGgbWF1djHkpiy4Lct9J.png)

### 3. 日终的平衡检查和日切阶段

1. 平衡检查主要保证借方科目余额等于贷方科目余额；
2. 科目总分检查保证下级科目余额总和等于对应的上级科目余额；
3. 会计日余额表日切主要保证每日的账户余额数据得到保存；
4. 更新会计日，保证下次日终处理的是下一个会计日。

## 七、会计结算业务参数的配置与管理

会计系统作为核心重点负责清算、结算会计平衡的系统，在每增加一家银行时，都需要配置相关的会计结算关系。

会计系统的日间记帐处理包含两种模式：即时模式和缓冲模式，具体采用何种模式由账务系统触发时决定。

**即时模式**需要会计系统严格按照账务系统发送的指令进行会计记帐处理；

**缓冲模式**需要会计系统根据相关的参数配置进行会计记帐处理，**一般日间都是单边的会计记账处理**，如充值与提现业务。

日间会计系统根据参数配置仅记录客户帐的变化部分，不记录内部账的变化部分，内部账的变化部分在日终时根据相关参数和日间的单边账务记录，进行分类汇总后再分别记帐处理。

### 1. 会计业务相关参数包括以下部分内容

**针对日间所有的充值类交易代码**（含充值 4003、充值补账 4023 ）、提现类交易代码（含提现 5004 、提现补账 4022 、充退 4104 ）操作，其下每一个子交易码 sub_trans_code 对应的每一个涉及该业务的 title_code 科目代码都需要配置一条对应的参数记录，来确定日间该科目下的该交易代码进行怎样的单边会计记帐处理。

参数重点说明该科目该交易记帐的方向、是否需要汇总记帐、是否需要发送对帐中心处理、是否需要 cache ；如 400301 交易代码，业务涉及 20100 1个人账户科目和 2002001 公司账户科目，则需要对应的两条参数记录；具体配置如下：

![img](http://image.woshipm.com/wp-files/2018/11/UP6JhPpadYrzD5NLCfcU.png)

日终批量处理时，有一步是专门针对缓冲记账的处理，会计系统会根据参数表中充值、提现相关的每一个子交易码 sub_trans_code 对应的银行代码 bank_type 不同，分类统计日间的单边会计记账数据，按照汇总后的数据会计系统单边记账处理；完成缓冲记账的剩余部分。

如 400301 交易代码，日终时按照参数表中的银行代码分别统计日间 400301 交易的单边会计记录，产生另一边的待清算户的会计记帐记录。

![img](http://image.woshipm.com/wp-files/2018/11/lBYRxyvsaeM9WxyH71fG.png)

日终批量处理时，有一步是专门针对银行存款结转的，即将经过对帐的资金从待清算账户结转到银行存款账户，以保持与银行真实资金变化的一致。

会计系统会根据与银行的对账结果数据进行结转记账处理，参数表中记录了每家银行从待清算户到银行存款户进行结转的具体记账参数中充值；因为存在两种结算方式，所以存在两套记账参数：

1. 从待结算资金户结转到银行存款户的会计记帐参数；
2. 从待结算资金户结转到资金调拨户的会计记帐参数；
3. 从资金调拨户结转到银行存款户的会计记帐参数。

当前的业务规则表包括字段如下：

![img](http://image.woshipm.com/wp-files/2018/11/7EiQQFXlmmXYhofRozqo.png)

会计业务规则在整个会计核心中起着非常重要的作用。会计核心的几个重要功能（记录分录，发送对账中心数据，汇总记账，日切结转）中，都有他的用处。目前来讲，会计规则主要有三个地方应用：

1. 日间生成分录：这部分规则叫做会计分录规则。
2. 日切汇总记账：这部分规则叫做会计汇总规则。
3. 日切资金结转：这部分规则叫做会计结转规则。

会计汇总规则和会计结转规则同属于会计流转规则。

![img](http://image.woshipm.com/wp-files/2018/11/2ZKA4jLcV7IdBCpdqQeA.png)

### 2. 日间生成分录

在日间过程中，会计核心主要负责把账务请求转化成分录要素并记录下来，同时根据需要发送给对账中心。在这过程中, 会计分录规则起如下作用(左边是账务请求已知信息，右边是通过会计分录规则得到的信息)：

![img](http://image.woshipm.com/wp-files/2018/11/hXrgegRN8aqnwmN4kuyQ.png)

通过会计分录规则的转化，就可以知道是否要进行汇总记账，从而决定**是记单边分录**还是也要记录**待清算方科目的分录**。可以知道会计要素中的银行是从账务请求的哪个字段取。

也可以知道是否要发送给对账中心，有了规则得到的这些信息，再加上能从账务请求直接拿来的会计要素（如：账户，科目，金额，会计日，借贷方向），就可以生成分录，并发送给对账中心。

从能够目前的会计业务规则表中的数据来看，这部分规则的使用如下：其中蓝色部分作为请求部分，黄色部分作为会计业务规则的产出部分。

![img](http://image.woshipm.com/wp-files/2018/11/TFHLnEngXYoyhTAlDZE5.png)

### 3. 日切汇总记账

在日切过程中，需要把充值、提现等业务的多方分录进行汇总，得到一方分录，并记录下来。会计汇总规则在由多方分录转化成一方分录时，起如下用途：

![img](http://image.woshipm.com/wp-files/2018/11/Z6UOj9Q0Op9P0mWKhDVC.png)

通过会计汇总规则的转化，得到一方分录的账户，科目和借贷方向要素，再加上其他一些会计要素（SubTransCode，会计日等），就可以生成一方分录了。

从目前的会计业务规则表中的数据来看，这部分规则的使用如下：

其中蓝色部分作为请求部分，黄色部分作为会计业务规则的产出部分。

![img](http://image.woshipm.com/wp-files/2018/11/2UjE5PDTN6eEoYOzp3xv.png)

### 4. 日切资金结转

在日切结转过程中，需要把已清算款或调拨户结转成银行存款。这些结转所使用规则叫做会计结转规则。日切资金结转有两种情况：

**（1）待清算结转**

对账中心对账完毕之后,在日切过程中,需要把待清算数据结转成银存或调拨户，所以需要建立一套会计结转业务规则,来约束如何从待清算结转到银行或调拨户。

在结转过程中,他是依赖会计结转规则的如下参数来查找规则：

![img](http://image.woshipm.com/wp-files/2018/11/NchBiqFSVCm4rTxRVNuC.png)

根据已清算汇总数据（ pac_gather_daily ）得到的SubTransCode，TitleCode，Remark（＝SubTransCode ），从会计结转规则中得到两条规则，**一条是存放待清算方分录规则**，**一条是存银存方（或调拨方）分录规则**。我们根据这两条规则，然后在根据其他分录要素（ SubTransCode , 会计日等），就可以生成两条分录。

同时要说明得是：这种情况的结转规则，都是成套的。

成套的含义是指用相同的 SubTransCode，BankType，Remark 取查找会计规则，如果能找得到，就是两条，这两条是成套的。

就目前的会计业务规则表中的数据来看，他的用途如下：（其中蓝色部分作为请求部分，黄色部分作为会计业务规则的产出部分。绿色部分是给调拨结转用的）

![img](http://image.woshipm.com/wp-files/2018/11/F57HZQpFskmefRJVP6N0.png)

**（2）调拨结转**

调拨结转是日切过程中,把调拨户的钱结转到银存账户上，会计也需要配置这些结转规则来结转：

![img](http://image.woshipm.com/wp-files/2018/11/HGHFzhkHRLNAeiXi6Buj.png)

把 SubTransCode 和 Remark 都是结转子交易类型（ 701105 ）的规则查找出来。对应如果有Memo 值，则表示结转规则，同时 Memo 保存得是银存方的科目代码，根据科目代码找到银存方的规则。从而获得银存方分录需要需要的 titleCode ,  iwAccountNo ,  借贷方向。

## 八、案例分析

![img](http://image.woshipm.com/wp-files/2018/11/Uy71Iupv6XBEbyG5gGdr.png)

### 1. 打款业务流程图

![img](http://image.woshipm.com/wp-files/2018/11/4GhM1gAfAs6eUcvebCJk.png)

### 2. 支付交易时序图

![img](http://image.woshipm.com/wp-files/2018/11/5USLALdDedJbNYQjwgai.png)

### 3. 打款信息流程图

![img](http://image.woshipm.com/wp-files/2018/11/LuxYIzEfHyS966DTyRyz.png)

### 4. 打款资金流程图

![img](http://image.woshipm.com/wp-files/2018/11/nEjwclCsL2yP5mO2mCFH.png)

### 5. 退款业务流程图

![img](http://image.woshipm.com/wp-files/2018/11/hOZ11PgUcT4apoRGYD7L.png)

### 6. 退款交易时序图

![img](http://image.woshipm.com/wp-files/2018/11/7tIFzVNXobDkJiHlhTLp.png)

### 7. 信息流程图

![img](http://image.woshipm.com/wp-files/2018/11/ZXyvzfm6CZLHKP3SXmhO.png)

## 九、记账逻辑

### 1. 充值类业务记账处理

1. 被支付充值账户登记一条充值业务流水
2. 实时更新被该充值账户余额
3. 发送该充值业务数据到会计核心
4. 会计核心根据账务系统提供的会计科目做一条客户帐的贷方分录
5. 会计前置系统将该条充值业务订单发送之对帐中心数据库
6. 日终处理程序根据对账中心当日的充值数据按业务类别（不含人工恢复数据）汇总分别借记一条中行银行待清算款充值账户的分录，同时更新相应科目下的内部户余额。（注：该分录入账时间与被充值账户的贷方分录中登记的入账日期保持一致）（业务要求：汇总的几条分录能分别查看到相应的明细流水）

![img](http://image.woshipm.com/wp-files/2018/11/FmgytxtZybsCBAUVtEUx.png)

### 2. 充值业务订单的恢复处理

![img](http://image.woshipm.com/wp-files/2018/11/RKpwQXI6rK9lYJxTpENn.png)

### 3. 充值订单对账处理

![img](http://image.woshipm.com/wp-files/2018/11/fFVXXHkXqAuvA6Umg8m5.png)

### 4. 提现类业务记账处理

**（1）提现业务处理**

![img](http://image.woshipm.com/wp-files/2018/11/dAmjac5U31vLG68M1NDl.png)

**（2）提现业务处理记账逻辑**

![img](http://image.woshipm.com/wp-files/2018/11/tuPWSQVA6YI9UZs45N6T.png)

**（3）提现业务对账后账务处理**

![img](http://image.woshipm.com/wp-files/2018/11/UbgOgXduSWUFiC6uX6dT.png)

### 5. 对账处理

![img](http://image.woshipm.com/wp-files/2018/11/qCNquyx9PEmrKXyOH4vu.png)

### 6. 会计分录

![img](http://image.woshipm.com/wp-files/2018/11/GrmnHnJcE1HLl04bb3gw.png)

 

关于头图的「还治颈椎病」，为了保证手机用户的阅读体验，支付学院的公众号选择了横版阅读方式，想治颈椎病的可自行前往 ID:pingxxpi 公众号进行阅读，学习的同时练就歪脖神功，你也可以。

# 支付系统设计白皮书：支付系统的概念与架构

2019-03-06 16:36:03 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/88241704

## 一、什么是支付系统

自古以来，所有的商业活动都会产生货币的收款与付款行为。在人类漫长的历史长河中，记录收付款行为的方式不断迭代：古代的账房先生通过手工记账，工业社会通过收银机机械记账……

今天，进入了互联网时代的我们，商业行为也一同进行了数字化与信息化的演变，成为今天的「电子商务」。

支付系统伴随着电子商务的出现而出现，为各类电子商务经营活动实现在线收付款交易以及管理交易资金等功能，是具有一定独立性的内部系统模块。

![img](http://image.woshipm.com/wp-files/2019/03/Pu4Ub963M0txC0x0OdmM.png)

- **平台**：开展电子商务经济活动的主体。
- **业务系统**：实现平台用户注册、商品定价、营销活动等相关功能。

平台与业务系统的关系：业务系统将用户购买行为通过各种交易订单的形式进行记录，并交付支付系统进行处理，最终由支付系统完成收款与付款。

根据央行的现行规定，人民币交易处理仅限于银行及第三方持牌支付机构，因此支付系统在实现上述功能时，需要通过外部银行、第三方持牌支付机构完成交易资金处理。因此，支付系统需要具备：

- 统一封装处理的交易接口，以对接外部交易渠道，为业务系统实现交易订单处理的功能。
- 根据业务系统设置的资金分配规则，在一笔交易有多个收款方参与的情况下根据资金分配规则完成交易资金的自动化清分与结算，而后通过已对接的外部交易渠道完成划付。
- 账务数据记录功能，上述的交易、清分、结算形成的资金变动信息，需要支付系统通过账务数据记录功能加以记录，对交易资金进行统计并完成交易资金核对等财会工作。

## 二、支付系统架构

支付系统的主要职责是处理业务系统发起的所有交易请求，包含收银台、交易系统、支付核心等模块，根据各模块不同的功能职责，可以将支付系统分为业务层和支付层两部分。

- 业务层负责为业务系统提供收付款的操作界面以及处理业务系统提交的交易请求；
- 支付层负责通过支付渠道实时处理完成资金的收付款、记录参与交易的账户间资金流转情况并按照预定规则对账户所属资金进行拆分与合并。

![img](http://image.woshipm.com/wp-files/2019/03/bGPtXEs29mg4HKur2uXN.png)

### 1. 业务层

业务层包含收银台、交易系统以及会员系统三个功能模块：

**（1）收银台**
**收银台即用户日常付款前选择渠道的页面，是支付平台提供的基本功能之一，**主要职责是协助业务平台完成支付交易，向用户提供一致的交易体验。一般情况下，根据不同终端类型定制标准化的收银台给到外部进行调用，保证各终端体验一致且针对各端特定需求、场景来展现不同的支付方式。

**①收银台的业务场景（边界）**一般分为付款与充值两部分：

- **付款**即通过各类支付方式针对业务订单发起付款，例如：用户在天猫店购买一件衣服，确认订单后自动跳转至支付宝，引导用户选择对应的方式（余额、花呗、银行卡等）进行付款。
- **充值**即用户对账户进行余额充值，例如：用户登录支付宝、微信或其他商户自有钱包系统对账户余额进行充值。

**②支付渠道的服务模型，**分为以下几个要点：

**服务模型的概念：**从支付公司角度来看，服务模型是决定商户可以使用的交易形式（担保收单、即时到账等）、支付产品（快捷、网银、代扣、POS 等）、签约方式、阶段周期（T+0、T+1、T+N 等）以及费率等核心问题的综合体；

从电商平台角度来看，电商公司内部使用的支付系统与支付机构相比复杂度较低，可通过参考支付公司服务模型，梳理不同业务、不同交易类型、不同结算周期以及不同支付渠道等复杂需求，搭建合理且满足业务需求的服务模型，例如充值类交易，具有商城属性的业务可配置担保收单或即时到账等交易类型。

**服务模型的维度：**

![img](http://image.woshipm.com/wp-files/2019/03/VVAtveqqwbqSo0m0X4HP.png)

**行业/服务维度：**即从业务角度出发对支付产品进行划分。

例如：蚂蚁金融面向行业输出交易、结算、会员、安全等服务，且为不同的服务等级划定标准，贯穿所有内部系统；普通非支付公司（以电商为例），提供即时到账、担保收单等，基本上能满足大多数的业务场景。

![img](http://image.woshipm.com/wp-files/2019/03/MLXbheo2s6cGEZlYdi62.png)

**商品维度：**针对不同行业的交易标的，由于交易价格、成本与利润差异大，因此在业务层面不同的支付渠道要有不同的可用性标准。

一般情况下，商品本身与市场或行业挂钩，例如喜马拉雅在接入微信/支付宝时，业务所在行业为视频影音属于虚拟商品，因此接入费率为 1%，结算周期为 T+7。

由此可得，支付公司针对不同商品本身的特性（例如风险等因素）在费率和结算周期上会进行一定的控制；同时，针对高风险行业会在支付方式、渠道层进行限制。

![img](http://image.woshipm.com/wp-files/2019/03/bSfy5e0FE9SnYnFIoevV.png)

**市场维度：**此处「市场」指的是指引客户使用支付产品服务的场所，它可能是支付产品本身，亦可能为相关公司或平台的网站。例如某集团子公司、某公司投资的公司以及与该公司无关的外部公司等等，可分为集团、内部以及外部等维度。

![img](http://image.woshipm.com/wp-files/2019/03/k4tfxWeRRC22LSxrJDpM.png)

**客户维度：**此处「客户」指的是服务的具体使用者。可分为个人客户及企业客户，通过支付系统内的会员系统进行区分。

![img](http://image.woshipm.com/wp-files/2019/03/pr1BbSxKec95Y0MWzJVQ.png)

**付款方维度：**付款方在整个业务过程中未核心角色，针对付款方用户的特征应建立以支付渠道收款方维度的模型，例如付款方的账户模型、安装是否正式、证书等级等要素都决定着付款方的付款流程。

![img](http://image.woshipm.com/wp-files/2019/03/JIb6qojO0LP5iT9IYRiw.png)

**支付渠道维度：**在电商平台，跳转到支付系统是，收银台根据付款方的参数规则，进而对该笔支付在收银台内可使用的支付渠道进行选择。例如充值账户余额不允许使用信用卡时，收银台在付款方付款时仅可展现借记卡等支付方式，喜马拉雅在于支付宝等第三方支付公司交互式，下单接口里一般含有做借贷分离的参数，该参数起到的作用就是可以指定付款方即用户不可使用借记卡或信用卡。

![img](http://image.woshipm.com/wp-files/2019/03/Tnb5xZM6KNqkKZHIsUNi.png)

**业务渠道维度：**业务端使用的入口，代表着客户或者业务方和支付系统的交互方式。例如通过 PC 端跳转到收银台、通过 App 跳转到收银台以及纯接口形式跳转等等。

![img](http://image.woshipm.com/wp-files/2019/03/oUvskCVHCKkpZZHYw7w1.png)

**支付渠道各类配置：**

1. **渠道配置**：抽象收银台支付方式大类（第三方、网银储蓄卡、网银信用卡、信用类（花呗、白条）等），对应每个大类下配置对应的落地渠道，再分别对适用场景进行匹配（ App、H5、PC 端、公众号等等），不同的场景下应对应不同的支付方式。
2. **渠道参数配置**：在业务进行中根据公司的具体情况，部分业务可能独立运营，因此在独立运营过程中财务需要就独立业务传入各支付渠道对应的密钥及商户 ID 等关键参数信息，以满足业务方需要支付系统根据不同商户信息调用对应渠道收款主体的需求。

**（2）交易系统**

交易系统本身是作为支付系统外部处理业务逻辑的外围系统。由于支付核心系统本身并非面向业务端且业务逻辑的多变性与复杂性，支付系统为了兼顾稳定并能够为业务端提供灵活支持，因此需要在支付系统外层搭建面向业务端处理交易逻辑的交易系统。交易系统处理业务端的各种交易类型后，将业务信息转化为支付系统可识别的支付订单并导入。

以担保交易为例，C 端用户在天猫购买一件商品，成功支付后商家进行发货，用户确认收货后平台将货款结算给商家。此处设计到「担保交易支付」以及「确认收货」环节，与支付系统内部的支付与结算步骤一一对应：

1. 用户付款成功后对应交易的付款成功状态；
2. 用户确认收货后对应交易的成功状态。

从支付和收货缓解可以看出，担保收单交易就是讲支付系统的支付基础能力包装后对外支持业务的一款产品。

**交易系统的职责：**

交易系统作为支付系统的入口：

- 首先需要对接上层业务系统；
- 其次将支付系统的支付能力抽象出来，对外提供各类交易方式，例如下单、支付、修改金额、确认结算、退款、关闭交易以及查询等能力；
- 最后，交易系统需要对各种交易类型进行定义，例如担保交易、即时到账、充值、提现等类型。

**交易系统的场景（边界）：**

- **下单**：生成交易订单，确定交易参与；
- **退款**：针对已支付的订单进行退款，退款金额不得大于实际支付金额，积分的退款退回原积分账户，同时针对退款交易类型，会生成交易订单号，关联入款订单；
- **修改金额**：修改交易金额，对应生成新的支付订单；
- **查询**：查询交易结果、支付结果；
- **通知**：通知上层业务系统交易状态；
- **算费**：通过算费子系统计算每笔订单的手续费。

**交易系统的交易类型：**

- **即时到账交易**：买家在电商平台选择购买商品下单，付款成功后金额直接入卖家支付账户或者卖家银行账户；
- **担保收单交易**：买家在电商平台选择购买商品下单，有部分金额为担保金额，买家付款成功后，担保部分进入平台方中间担保账户，未担保金额直接入卖家支付账户或者卖家银行账户；
- **收单退款交易**：买卖双方在达成退款协议后，可针对及时到账交易，订金下定等已支付交易由商户平台发起退款请求；
- **普通转账交易**：当平台方需要对会员进行转账时，通过此接口实现金额的转移；
- **合并支付交易**：多笔交易订单合并（并笔）付款，适用于购物车针对不同商家生成订单的场景；
- **下订交易**：卖家和买家达成购买协议，先行支付部分订金，该部分订金在最终付款的时候可以被使用；
- **提现**：客户将支付账户的余额提到客户绑定的银行卡账户，基于支付账户单笔或者批量付款；
- **冻结解冻**：在交易前通过冻结能力将用户的部分资金冻结，保障交易能正常进行，也可以由于某些原因（账户被盗、司法案件、反洗钱等），冻结用户资金操作，保证用户的资金安全；
- **充值**：基于支付账户做余额充值，将用户的银行卡账户资金充到用户的支付账户余额。

**交易系统的交易特性归类：**

**①实效性：**

- **全额实时到账**：即时到账类交易，付款后实时到账；
- **部分确认支付、部分即时到账**：担保收单类交易，这里分为部分担保的场景，只有指定金额部分需要确认结算；
- **全额确认支付**：全额担保交易，电商交易场景下需用户确认收货后才会将全部货款结算给卖家。

**②交易系统的支付形式：**

- **单笔支付交易：**单笔支付行为，用户基于一笔订单发起付款；
- **合并支付交易**：多笔合并支付行为，用户基于多笔订单发起合并付款；

**③业务类型：**

- **收单交易**：支付入款类型交易，付款人收款人分别是两个角色；
- **充值交易**：账户充值类交易，付款人和收款人都是同一个人，由外部账户到内部账户；
- **出款交易**：基于账户做提现，付款人和收款人都是同一个人，由内部账户到外部账户；
- **退款交易**：收单入款交易的反向流程。

**（3）会员系统**

会员系统是完整的支付平台内极其重要的基础模块之一，负责管理支付系统内部的交易主体。会员系统保存了客户在支付系统内部账号的实体信息，为客户建立了统一的、以会员 ID 为标识的会员基本信息、关系信息（会员和账户、会员和操作人、会员与银行卡）视图。

一般情况，会员在支付系统内部分为个人会员和企业会员（默认企业会员有商户权限），以电商平台为例，C 端用户为个人会员，B 端商户为企业会员：

- 通常，企业会员会配置一定的业务参数，比如结算周期、接口权限、支付方式配置等（开通商户权限的情况下）；
- 在大多数互联网公司，支付系统仅需要对接支付渠道的模块，在没有独立平台化的情况下，不太会出现需要独立的账户体系。

### 2. 支付层

支付层包含支付核心、账务核心以及清算核心三个部分。

**（1）支付核心**

下方的内容介绍了支付核心的职责、边界以及系统架构三个部分。

**支付核心的职责：**

支付系统的职责为通过支付核心与后端清结算、会计、账务等系统的统一协作，让前端支付产品可以更关注产品本身的逻辑，而减少对清分、对账、储值等后端服务的考量及动作；同时通过标准化的支付指令定义，统一前端支付产品的支付请求接口，提供适应各类产品使用的基础支付服务。

**支付核心的边界：**

- **支付服务**：负责对后端支付系统的接口进行业务包装，同时实现使用多个支付方式进行组合支付的功能；
- **支付服务流程**：对各支付类型的支付服务流程进行定义，具体定义为充值、提现、内转支付（转账）、退款等原子类型，并实现对基础服务的流程编排；
- **支付指令**：发起订单后，通过协议和协议明细项加工得出支付指令，需具备进行后续操作处理的全部要素信息；
- **支付协议**：根据产品设立支付协议，因此支付协议的关键要素包含产品码及支付编码，定义着产品的处理流程、收付款信息、对应的支付渠道信息。

**支付核心的系统架构：**

![img](http://image.woshipm.com/wp-files/2019/03/FV9qHJv7y2uY6DIZzfnq.png)

如图，将交易和支付分开，主要是为了体现出支付系统的核心支付功能，能够为会员提供丰富的支付服务：支付核心定义原子支付类型；服务层提供支付业务能力，例如出款、转账、红包、代金券、余额、现金等；产品层能够更加关注产品本身的逻辑，将后端标准化的逻辑交由支付层和清算层来处理，这样就能做到灵活和标准兼顾。

**（2）账务核心**

账务核心的功能为，根据前端业务系统的要求设计相匹配的账户类型、管理各类账户、记录账户资金变动等，同时，按照公司内部的财会规范提供反映各账户间交易资金变化情况的会计数据；并且负责将自身记录账务流水与支付渠道结算资金和结算流水进行核对，对对账结果中出现的差错交易进行差错处理。

**（3）清算核心**

清算核心负责维护客户参与交易时的清分、结算规则，并按照已配置的规则完成交易资金的清分与结算操作。

# 支付系统设计白皮书：契合业务形态的收银台设计思路

2019-03-12 19:43:21 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/88427501

## 支付方式选择

在收银台设计前，根据业务类型要对支付方式进行选择，目前常见的收银台支付类型包含两种：

- 收单：通过各类支付方式针对业务订单发起付款。例如：C 端用户在天猫购买一件衣服，点击「提交订单」后，系统跳转至支付宝进行付款。这是标准的付款场景，也称之为收单。
- 充值：用户对账户进行余额充值。例如：C 端要用户登录支付宝等商户自有的钱包系统对账户进行余额充值。这是标准的充值场景。

## 业务流程及系统流程

### 1. 充值业务

**①业务流程**

1. 用户对钱包账户发起充值；
2. 跳转至收银台，根据展现的支付方式用户选择充值渠道（若该充值业务允许提现，收银台应根据充值业务配置对应的借记渠道，从业务侧规避用户使用信用卡充值做信用卡套现）；
3. 充值成功后返回。

**②系统流程**

![img](http://image.woshipm.com/wp-files/2019/03/HJtKYQemaiOF8M0zo7OX.png)

1. 用户在客户端发起充值流程，客户端获取收银台地址，收银台返回地址；
2. 收银台根据请求类型跳转至收银台充值页面，显示对应的充值渠道；
3. 用户选择对应的充值渠道后，收银台提交对应的充值订单到交易系统；
4. 交易系统通过支付核心转化后给到清算核心，获取对应的支付渠道信息，返回给收银台；
5. 收银台跳转支付渠道，用户在第三方支付页面进行支付；
6. 支付结果以异步形式通知服务端，前台根据 return_url展示对应的充值结果页面。

### 2. 收单业务

**①业务流程**

1. 用户在业务端基于订单发起付款，跳转至收银台后选择支付渠道；
2. 根据用户选择的支付方式决定后续流程：

**余额支付**：首先校验余额是否充足，若充足则用户可选择余额进行全额付款；确认付款后输入支付密码并校验支付密码是否正确，若正确则扣减余额，完成支付；

**网银或第三方支付**：首先根据业务确定可使用的支付渠道列表，其次用户选择第三方支付后，调用第三方支付渠道发起付款，渠道限额校验由第三方完成，最后根据支付结果变更支付状态（正常情况下除了支付成功意外均以「处理中」做业务状态处理）。

**②系统流程**

![img](http://image.woshipm.com/wp-files/2019/03/enMrOahcZpYCG6TTsMeb.png)

1. 业务系统调用支付系统做业务下单，形成对应的入款交易订单，并跳转收银台；根据交易请求判断是否返回收银台（有部分业业务场景指定支付方式或以确认性付款成功等流程无需收银台）；
2. 获取到收银台地址后，打开收银台界面，获取渠道列表并展示对应渠道；
3. 用户选择支付方式，支付请求发送到清算核心，调用第三方支付渠道；
4. 收银台跳转到对应支付渠道，用户在第三方支付页面进行付款；
5. 支付结果以异步形式通知服务端，前台根据 return_url 返回对应页面。

## 组合支付

组合支付即通过一种以上支付渠道完成付款的支付形式。组合支付是交易系统中提供的一种交易服务类型，例如早期支付宝有组合支付功能，最常见的组合支付类型为「账户余额 + 快捷支付」模式，此种类型可在做支付系统设计时进行借鉴，可实现「账户余额 + 第三方支付」的模式。

组合支付的衍生需求很好理解，当用户在平台的钱包账户内进行充值后，若想购买的商品价格超出了账户余额的可支付范围，即可使用组合支付的方式进行付款；此处的账户余额可理解为「广义范围内，所有涉及到支付系统内部清结算能力的支付形式」，凡是需要与其他渠道进行组合付款的场景均可使用组合支付的逻辑，例如基于营销设计的红包、代金券、积分以及预付卡等。

## 组合支付的流程、设计

### 1. 组合支付的流程

**①余额 + 第三方（支付成功）**

![img](http://image.woshipm.com/wp-files/2019/03/4JCCU4xVyXZLJvChiz36.png)

1. 用户发起组合支付，支付前置根据用户组合支付的行为生成组合支付业务订单；
2. 支付前置系统根据系统配置的付款顺序对组合支付进行推进，由内部渠道和外部渠道进行的组合支付：原则上需要先调用外部渠道，因此支付前置基于组合支付订单生成了一笔第三方支付的子订单，也可以称为支付指令；待支付成功后，通知内部账户系统扣减账户余额，这样避免外部渠道不成功的情况下对余额进行了先行扣除；
3. 外部渠道成功后通知前置系统，前置系统此时生成当笔内部余额扣减的支付指令并调用支付核心系统；核心系统返回成功后，将这比组合支付的业务订单置为成功并通知业务端。

**②余额 + 第三方（支付失败）**

![img](http://image.woshipm.com/wp-files/2019/03/r8d7akDbzT9Z0zesWZtC.png)

**③组合支付设计**

组合支付本身对于交易系统来说差别不大，仅在订单发送至支付前置时，由于逻辑上来讲是两笔付款行为，因此会生成两条支付方式的请求：一条为余额支付请求，一条为第三方支付请求；转换到支付前置后，前置系统生成一笔组合支付的订单，且对应着两条支付指令（一条充值、一条转账），当充值的指令成功后去执行转账的指令，两笔都成功的情况下则通知上层系统变更业务状态。

- 定义支付业务类型：组合；
- 对应指令：根据外部加内部的组合，根据具体指令需执行的原子类型，生成对应指令订单，遵循外部成功后再执行内部的流程；
- 支付方式：以组合种类为准，对应种类在网关传递交易时进行拆分，例如代金券 + 余额 + 第三方支付则需要分别定义三条支付方式信息。

## 优惠支付

优惠支付即基于支付系统的代金券、优惠券、红包等营销支付流程设计，本质上是基于账户做的营销支付体系，无论具体优惠形式，在支付系统内部都是以账户形式存在：例如代金券营销账户、优惠券营销账户等；根据具体的业务需求，支付系统对于此类营销支付在账户层面应设计两种方案：

- 平台侧营销账户：代金券营销账户、优惠券营销账户等，其营销成本应从这两个账户中进行扣减，账户需自行预先充值，用户支付时所需部分抵扣的金额从该账户进行获取；
- 用户侧营销账户：红包、消费积分等营销账户与各个用户一一对应，用户在领取时视为开通了红包等营销账户；每当领取红包或获取消费积分，视为账户金额增加（相当于给用户的账户进行充值入账）。此外，也可以通过业务端对明细账户加以控制，支付系统则去维护总账户即可。

## 营销支付设计

营销支付的设计可分为基于业务端做营销和基于支付端做营销两个方向：

**基于业务端做营销**：在业务平台直接对优惠券金额进行扣除。

1. 调用支付系统前，业务系统根据优惠方式（立减、折扣或优惠券等）对可优惠金额完成计算并直接扣减调；
2. 调用支付系统，并将用户实际待支付金额转入支付系统并生成支付订单。

此方法的弊端在于，若平台型电商对营销成本进行结算，仅可通过线下或其他方式完成与商户间的结算工作，会增加财务工作量并造成账务不清晰等结果。
**基于支付端做营销：**可分为平台侧与用户侧两部分。

**（1）平台侧：**

1. 将平台的优惠补贴金额通过内部户等形式存储在账户系统当中，类似「营销补贴户」；
2. 用户在前端发起支付时，使用优惠券、红包、消费积分等营销工具抵扣部分金额，业务平台调用支付系统下单并传入总金额、支付金额以及抵扣金额等相关信息，根据总金额生成交易订单后，根据总金额的构成生成对应的支付订单；实际支付金额与用户待付款的支付订单相对应，抵扣金额为平台内部账户单独的内部流转支付订单，通过用户实际成功支付的消息进行后续处理；

此类方法的优势在于将每个用户的业务明细留存在业务平台系统处理，支付系统只需要记录金额；收银台调用支付平台下单相关参数：业务平台订单号、UID、总金额、抵扣金额、支付金额、支付方式。

**（2）用户侧：**

当前电商平台有部分营销产品拥有较强的用户属性，例如红包、消费积分等，此类自带货币属性的虚拟账户余额，根据其业务属性对支付系统中的每位用户单独开设补贴账户，支付时根据营销账户 + 其他支付方式进行组合，与组合支付的逻辑相类似，一笔付款付多个付款渠道。

# 10 分钟了解微信分账 | 微信生态下的最优资金清分方案

2019-08-16 13:59:39 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/99676567

# ***\*一、什么是微信分账\****

***\*微信分账即微信推出的交易资金再分配产品，收款后按照平台的业务规则，无需中转直接进行资金分配；主要用于服务商帮助特约商户完成订单收单后的资金分配。\****

***\*微信分账的推出主要有三个方面的原因：\****

①市场方面：

在现有环境下，电商平台或者多级分销、加盟代理模式，订单参与方较多，需要用户统一付款后由平台方统一收款，再根据订单参与方统一分账。

②政策方面：

市场需求与政策规范有所冲突，监管机构加大了对大商户+二清模式的打击力度。

③微信支付方面：

在上述两个情况下，微信支付将自身的清结算能力赋能给平台商户。

***\*前提概念：\****

- 分账方：即分账发起方，是商品或服务的提供方，这里指特约商户。
- 分账接收方：接收分账资金的商户或个人，如：特约商户上游的供应方、合作的商户、商户的员工、商户的用户等。

***\*步骤：\****

①分账方通过微信收款的订单，由微信扣除手续费后，冻结在分账方的账户（分账方不可见）。

②分账方根据具体的业务情况和场景，通过微信分账接口，将订单的信息上传微信（分账接收方、分账金额等）。

③微信将相应资金，分配到各接收方账户中（微信商户账户或微信零钱）。

![img](https://img-blog.csdnimg.cn/20190816135059786.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_16,color_FFFFFF,t_70)

***\*资金流向说明：\****

假设用户支付 1000 元：

①微信扣除 6 元手续费；

②微信将 994 元冻结至特约商户账户中（此时金额不可见）；

③商户上传分账信息，为两个分账商户分别分账 50 元与 40 元；

④微信分别为两个分账接受方分账 50 元与 40 元；

⑤微信将剩余的 904 元结算至特约商户的账户中。

***\*微信分账的优点：\****

- 合规：在微信体系内，由微信负责将交易资金分别结算给收款方，平台避免了违规的风险；
- 合理纳税：各收款方根据真实收入合理纳税；
- 开通周期短：与微信企业付款不同的是，企业无需三个月的等待期，可以通过微信服务商（例如 Ping++）开通，快速上线。

------

# **二、微信分账适用场景**

***\*酒店预订：\****

用户缴纳订房费用后，资金可先冻结在酒店的商户号中，待用户确认到店消费后，服务商可根据情况，将资金分账给 OTA 平台、服务商或房东。

![img](https://img-blog.csdnimg.cn/20190816135059745.jpeg)

***\*订餐外卖：\****

用户在订餐平台的某个餐饮商户下单完成支付后，用户支付的订餐资金先冻结在该餐饮商户的商户号中；待用户确认收货后，服务商掉按指令分账的接口，将订餐资金进行分配，例如分账给外卖员、订餐平台抽佣，剩余资金解冻给餐饮商户。

![img](https://img-blog.csdnimg.cn/20190816135101505.jpeg)

***\*停车场：\****

用户在停车场缴纳停车费用后，资金先冻结在停车场的商户号中，服务商根据与停车证之间的协议，将停车费分配给其他微信支付商户，例如智能停车系统服务商。

![img](https://img-blog.csdnimg.cn/2019081613510211.jpeg)

------

# ***\*三、微信分账的特点\****

***\*分账接收方：\****支持 4 种方式创建接收方。

- 公司：微信商户号（不限定是同义个服务商下的特约商户）
- 个人：微信号、分账方公众号 OpenID、服务商公众号 OpenID

***\*支付方式：\****

- 仅限于标记了的订单参与分账
- 支持微信所有支付方式

![img](https://img-blog.csdnimg.cn/20190816135102536.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_16,color_FFFFFF,t_70)

***\*分账方式：\****

- 基于订单进行分账
- 先冻结、再分账
- 最长冻结期限为 30 天
- 单笔订单分账方最多支持 50 个
- 可分账金额为扣除手续费后的金额
- 为了保证特约商户的资金安全，特约商户可以设定允许服务商分配资金的最大比例

![img](https://img-blog.csdnimg.cn/2019081613510369.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_16,color_FFFFFF,t_70)

![img](https://img-blog.csdnimg.cn/201908161351023.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_16,color_FFFFFF,t_70)

![img](https://img-blog.csdnimg.cn/20190816135102584.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_16,color_FFFFFF,t_70)

***\*报表：\****

按照分账方、分账接收方可提供独立报表

- 支付报表：

​    分账方作为特约商户，按照支付、退款交易提供支付报表；

​    信息：订单号、支付金额、手续费、付款用户、购买商品等。

- 分账报表：

​    分账方、分账接收方，按照每笔支付订单的分账金额，提供分账报表；

​    信息：支付订单号、分账方、分账接收方、分账金额、分账时间等。 

***\*微信分账与微信企业付款的区别：\****

![img](https://img-blog.csdnimg.cn/2019081613510371.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_16,color_FFFFFF,t_70)

------

# **四、\**微信分账如何开通\****

- 通过有微信分账权限的支付服务商开通微信分账功能，目前 Ping++ 已对接微信分账接口。

# 扬帆出海，你需要这些干货解决收款问题

2019-08-19 13:48:12 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/99722090

# **一、出海站点分析**

今年，电商、航旅、自主品牌以及工具应用等已形成出海生态：

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWMxLnpoaW1nLmNvbS84MC92Mi1jMjk4YTUwZThmMGZlNThkY2E1NDRmMzQ4ZjVmODk0NF9oZC5qcGc)

国内竞争白热化，出海释放过剩产能，2018 年出海品牌 50 强可以看到各行各业都已涉及海外业务。

**线上出海可分为两种形式：**

①独立站：自建平台、App等，流量、规则、信用需要依靠自身的实力；

②平台入驻：入驻平台则信用方面有平台背书，规则与平台约定，流量依靠平台导流。

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWMyLnpoaW1nLmNvbS84MC92Mi0yNjc3YzIwZDcyYTE1OTIzODg3ODRjZGE4ODI3OGJjMV9oZC5qcGc)

两种方式优劣一目了然，独立站形式自由度高，对于自身私域流量要求也高；入驻平台则需要严格遵守平台规则，无论日常运营还是收付款规则都需要配合平台。

**独立站需要解决的一个主要问题：自主解决支付和收款**

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWM0LnpoaW1nLmNvbS84MC92Mi1lYmY1ZDU1MDMxYzQ2YzQ0NmY2ODFlMDQ4OTRlZDA4Yl9oZC5qcGc)

**以电商类为例，独立站需要自主解决 C 端用户的收款问题：**

①不同的产品内容，海外有相应的要求；

②欧、美、亚、太等不同地域、年龄段、支付习惯等各有差异，需要分析用户画像；

③部署平台不同（PC、H5、App），接入支付及收款对接的支付工具亦有不同；

④不同的币种；

⑤对收款工具亦需要进行选择；

⑥不同的收款合作伙伴。

**平台入驻主要选择收款服务商：**

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWMzLnpoaW1nLmNvbS84MC92Mi1lNjFjODA5NzhmODRlMzdlYTIxMzgyNDUyZGRhMmVhYV9oZC5qcGc)

支付接入的问题由入驻平台解决；收款选择海外丰富的收款服务商即可。

**几个常用的出海服务平台：**

①白鲸出海 ②快出海 ③Enjoy出海

------

# **二、海外用户主要支付工具和选择**

这里的「用户」主要是指 C 端付款用户，根据用户情况指导我们选择收款服务商。

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWM0LnpoaW1nLmNvbS84MC92Mi1hMjkzNDIzYTNmOGYwOWI3NzQyYjY3NGU2MTc5Njc1Yl9oZC5qcGc)

**用中国支付市场不同的是，国内信用卡使用率较低，国外以信用卡为主：**

①北美国际行用卡的覆盖率接近 100% ；

②欧美国家主流的用户付款接入方式为 Paypay，网民覆盖率 40% 以上；

③欧洲国际信用卡在发达市场覆盖率较高，但许多国家用户仍选择本地支付品牌；

④东南亚地区支付市场本地支付品牌较多。

**接入方式：**

①商家自建收银台：

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWMyLnpoaW1nLmNvbS84MC92Mi05YzY3OWFhOTk2ZGJmYzhiOTEwZTRjOGY2YmM3YWE5OV9oZC5qcGc)

用户通过商家收银台填写付款信息，如图所示包含卡片信息、姓名、账单地址、联系方式等；

②使用支付公司收银台：

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWMyLnpoaW1nLmNvbS84MC92Mi01NmZmNjE3YTJjNmQ3ODlhNTViNmUxZTE5MzJkNzFlOV9oZC5qcGc)

支付公司提供标准化收银台，商家通过 SDK 接入，接入较为简单。

两者的区别在于用户的付款信息在哪里被收集，如果通过自建收银台收集，一般情况下需要商家完成 PCI 认证，不仅流程较长，且费用较高。因此一般建议通过支付公司收银台收款。

③使用 3D Secure ：

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWM0LnpoaW1nLmNvbS84MC92Mi1jMTZlOWU3ZDhjOTdhMDdiZWM4NTk1MzJmZGJkMzRlYl9oZC5qcGc)

1. 客户通过互联网访问商户网站，提交支付请求；
2. 商家查询 V/M 的目录服务器，获取用户卡片是否参与 3D 业务；
3. V/M 将该请求发往发卡行，并将请求结果发回给商户；
4. 商户将用户的浏览器重新定向到发卡行的验证页面;
5. 发卡行验证服务器和用户进行验证；
6. 发卡行将 CAVV 和 AVV 值通过客户的浏览器送回商户 MPI ；
7. 发卡行将授权结果写入 V/M 的授权历史服务器；
8. 商户向支付公司提交授权请求；
9. 支付公司将该请求发送 VM 进行处理，获得交易结果返回。

整个流程增加了多个环节，较为复杂，付款成功率下降了，但安全性大幅度提高。比较适合 PC 站点选择。

------

# **三、Paypal支付**

首先需要商户申请 Paypal 企业账户，通过 Paypal 提供的 SDK 接入即可，整体支付流程较好。

**各国本地的支付 APMs**

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWMyLnpoaW1nLmNvbS84MC92Mi00ZjcwNjRiZTg3ODQ5MDI3NTlhN2M0NGQ3ZWQ1ZTA0OV9oZC5qcGc)

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWMzLnpoaW1nLmNvbS84MC92Mi00YTQzNWU0MzY3OTQ5NTYxZTFhMDRjOTE1Zjg2NDEzZV9oZC5qcGc)

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWMxLnpoaW1nLmNvbS84MC92Mi1kY2E0MDIzMzEyOTE4OGYwMjIyMWE3OTJiNzg4MTAwOF9oZC5qcGc)

接入各地区本地支付品牌，可以扩大用户覆盖率。

------

# **四、出海收款的核心问题及运营**

 

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWMzLnpoaW1nLmNvbS84MC92Mi0zZjZiYjUzZmVmNDk2OTE5MTkxODcyMTdhMjc5MzA5Nl9oZC5qcGc)

 

**国际信用卡接入需要关注以下方面：**

1. 倾向于保护用户（但是用户也不能恶意退单）
2. 最长 180 天的 charge back 期限
3. 盗卡、伪冒卡交易相对比较多，在交易中控制手段有限
4. 国际卡公司、收单机构较为严格的退单率、欺诈率监控（1% 高风险，2% 严重）
5. 严格的知识产权保护和罚款（Global Brand Protection Program, GBPP）
6. 较高的费率
7. 较为严格的 KYC 审核（资料 + 网站或应用平台审核）
8. 较为苛刻的结算条款
9. 人民币收单情况下汇率风险不可控

**在接入 Paypay 需要关注以下几点：**

1、费率比较高：3.4%-4.4% + 0.3 美元（跨境交易），没有人民币结算。

2、买家保护：从 2009 年 6 月 15 日起，PayPal 的卖家保护可以帮助减少买家因「未经授权付款」与「物品未收到」而提出的「补偿申请」，「退单」或「撤销」。

例如：数码产品（可下载软件）、服务或无形商品，如游戏币、电子书籍等，当面交付或上门收件；汽车、船只和其他车辆的交易。

3、账户限制：各种情况下的账户限制。需要及时应对，向 Paypal 提交资料回复。

4、账户冻结：

①被客户投诉过多退单过多。投诉率超过 3%，退单率超过 1% 为危险指标；

②所售产品有知识产权问题。

**各地区本地支付品牌接入需要关注以下几点：**

- 可以作为主流支付工具的补充，部分目标市场可以作为主要支付方式；
- 用户主动支付，交易验证，欺诈、退单风险低；
- 没有 GBPP 风险监控；
- 普遍较高的费率；
- 较为苛刻的结算条款。

**如何搭建自有站点：**

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWMzLnpoaW1nLmNvbS84MC92Mi1jNzNiMjM0MDdjNjQ1NzZkYmE2YzRhMDBkZWNlMDNjMl9oZC5qcGc)

①如果有较强的技术团队，可选择自建框架集成；

②选择开源或非开源框架，如图所示；

③App 采用应用市场入驻，限制比较多。

**运营流程控制和关键节点把控：**

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWM0LnpoaW1nLmNvbS84MC92Mi0zZjY1MjUwODc5MzEwNWQ1NDhlOTEyY2JkYmMxNWY3M19oZC5qcGc)

**网站（App）建设和内审需要关注以下几点：**

1. 网站产品/服务内容介绍清晰，明确；
2. 网址域名与网站有合理关联；
3. 用户注册、交易、结算流程完整；
4. 商户退换货 / 维修流程介绍清楚，可行；
5. 网站联系方式可用，以 24 小时客服电话为优；
6. 网站的英语版本流程通顺；
7. 网站产品要有正常的历史交易流量；
8. 没有进行仿品、假货售卖。

**交易风险防范和控制：**

1. 产品可能侵权的防范：图片、Logo、设计、款式、描述等；
2. 对于伪冒卡的防范；
3. 对于退单、欺诈率的监测；
4. 账户信息安全；
5. 对于异常客户的关注、客户收货地址和购物行为。

------

# **五、如何选择收款产品？**

①收银台：收银台对接便利、接入高效快捷、无需二次开发；避免自身需要 PCI 认证。

②支持 DCC：DCC 即在 C 端用户付款时通过账户币种进行扣款，帮助用户规避汇率风险。

③支持订阅支付：与微信、支付宝无感支付类似，除初次绑卡，后续可无感扣款；若用户停止使用服务，取消订阅即可。

**Ping++ 目前已拥有完善的跨境解决方案。**

# 在赢之前，你要先学会输几次

2019-08-26 11:58:53 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/100072679

*过去一年，身边很多创业的朋友去做投资人，而很多本来做投资的朋友出来创业，创投之间出现了一扇旋转门，两批人互换身份。我在跟他们的交流过程中产生了很多奇妙的化学反应，感觉很有必要把这些感悟记下来，其中有自己的思考，也有他人的火花。*

![img](https://img-blog.csdnimg.cn/20190826104433462.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_16,color_FFFFFF,t_70)

###  

### [零]

### 人，永远都是立场的动物

 

创业的朋友，以前的口头禅是：

> 「我这么好的项目，投资人各种挑剔，不知道他们在担心什么，真是不懂行」

现在他们自己做了投资，说法变了：

> 「这个团队缺一个核心合伙人」
>
> 「那个项目所在赛道不够大」
>
> 「我现在大概率也不会投当年的自己」
>
> ……

投资的朋友，以前的口头禅是：

> 「我们想再看看未来 3-6 个月的数据情况」
>
> 「派个阿里的政委帮你解决一下组织问题吧」
>
> 「这个事就必须狠狠砸一笔大钱占领市场心智」
>
> ……

现在他们自己出来创业，说法也变了：

> 「数据怎么可能那么快爆发」
>
> 「找个人太难了团队不好带烦死了」
>
> 「我以前是不是对于创业者太苛刻？」 ……

 

我相信，他们的此刻和彼时都是真诚的。

 

世间哪有那么多的感同身受。坐过谈判桌两边的人，会有着更加立体的人间感悟，他们会在某一瞬间讲出一句曾经自己特别讨厌的话，然后奇怪为啥这句话说得这么顺口，好像自己也没当初听到的时候那么讨厌了。**他们可以分裂成两个人对话，切换身份，犹如盗梦空间般不断递进层次。**

一个之前做早期投资的哥们出来创业，他告诉我他晚上做的梦是上 IC（投资委员会）讨论项目投不投，早上醒来发现邮箱里躺着邮件，告诉自己项目的 TS（投资意向书）又被撕了。

另一个连续创业的哥们后来去做了自己的基金，他说他想投一个「当年的自己」，觉得当年的自己遇到一个现在的自己，就可能会有机会去敲钟，我问他：「难道你要用一辈子的投资生涯去治愈你青涩的创业经历吗？」，他却不说话。

 

我喜欢看人物传记，因为读到第 10 页的时候，稚嫩主人公完全不知道在第389 页上的自己会有多大成就；然后再从第 453 页的功成名就翻回第 60 页，那时候他觉得这次的至暗时刻肯定过不去了。只有在书里，我们才拥有上帝视角，高光时刻和绝望时刻相隔如此之近，任人来回翻阅；现实中的真实人生，只能自己渡自己，与自己的来路和彼岸相爱相杀。

##  

### [壹]

### 没有指数级增长的赛道

### 你网上看到所有关于人才、组织和文化的文章，

### 都会害死你

 

最近好几个朋友创业特别磨叽，我问他们为什么不快点开干，他们说要组建一个完美的「梦之队」，因为找人找了半年都没有凑齐，所以坚决不开始。我一脸疑惑的时候，他们掏出了收藏了多年的朋友圈鸡汤文，大多关于「人才密度要高于发展速度 」吧啦吧啦之类的。所以第一次创业的人，应该都会犯这个错误吧，包括几年前的我。

以前看历史书，特别不理解为什么所有的帝国都要无限扩张，直至最后崩盘，见好就收好好过日子不行吗？后来我发现了这样的一个死循环：如果你要成就一番事业就必须网聚人才，而胸怀大志的人要一起做事情其实很难，所以帝国只能通过不断的增量疆域来满足他们的野心，让他们各安其位；而随着疆域的扩张，原有人才的欲望更大了，更多的人才加入了，于是这个循环必须持续下去，不然一个不扩张甚至萎缩的帝国，是无法解决内部精英之间互相的利益博弈的。**帝国的崩溃从来都不是发生在对外扩张的路上，而是当殿堂之上人才济济之时就已经注定了。**

 

所以，决定人才、组织和文化的根本，在于这个赛道是否可以撕杀出一个帝国模式。如果这是一个小城邦，天花板明显，再好的文化，再好的组织，都留不住人才，反而会吞噬掉「小而美」的可能性，即使人才留住，也只是加速城堡从内部攻克的灭亡。**所有的管理方法都是在战时状态下效果最佳。**

在和平年代，管理意味着平庸和消耗。因此，匹配的人才、匹配的组织和匹配的文化更加重要。**不是谁都有机会开启帝国模式的，况且罗马也不是第一天就建成的。**

##  

### [贰]

### 你知道的

### 关于目标用户画像的一些道理

### 可能是错的

 

大多数的文章和经验分享都在说目标用户画像的重要性，但这里有一个隐性的前提假设是「这个用户画像定位是全局最优的」。

举个简单的例子：

> 如果你希望做 A 类用户的生意，结果来了 A、B、C 类用户，分别占用户样本70%、10%、20%，你觉得需要聚焦，于是自然而然地屏蔽掉了 B 和 C。结果相比 A 类用户，B 类用户是一个 100 倍的潜在市场，你花在优化 A 类用户的产品、服务、体验上的所有精力，在面对一个 100 倍大的机会时，这种专注其实是一种跑偏，因为以你的时间、精力和心气本可以探索出一个更大的市场。

**所以真正正确的思维反而应该是借假修真: 目标用户画像是假，指数级增长万亿市场规模是真。**在跑不出这样的模型曲线之前，产品就是 MVP，公司就是临时组织，创始团队就应该「朝三暮四」。

过去几年，我身边的朋友里至少有四五个贴着「巨大市场」的边沿做了创业项目，死磕产品、推广和数据，他们大多做得小成。但当他们最后把公司卖了复盘这段经历时，每个人或多或少都会提到当年「身边巨大市场端倪」的时闪时现，也就是说他们也曾若隐若现地感受到了一些其他可能，遗憾的是曾经的他们最后都毫不犹豫地选择性忽略。

###  

### [叁]

### 创业做产品

### 本质上是有效供给

### 稀缺性

###  

很多产品最后没有跑出来，或者没有大成，不是没有痛点需求，也不是没有广阔市场，而是不够具备稀缺性，导致无法形成良性的商业循环。

**稀缺性，早期靠非共识，中期靠执行力，后期靠垄断性。**

- 先行者往往不被主流认可，这个时候只有他在供给这样的产品和服务，稀缺性是天然的。此时最重要的是不断验证和强化这个供给，用大白话说就是「能跑多快就跑多快」。
- 随着市场慢慢增长，更多玩家也看到了商机冲了进来，稀缺性面临反向稀释，这一阶段保持半步领先就必须靠超强的执行力和少犯错误，行业老炮在这个时期就会比新贵更有优势。
- 到了后期，市场心智已经占领，网络协同效应开始显现，数据智能反哺产品的高效产出拉开竞争距离，并做到长期垄断生态上下游最核心的资源。

不是所有的公司都可以成功跨越这三个阶段，于是他们不得不面对红海、价格战以及恶性竞争，劣币驱赶良币。从另外一方面看，能够顺利跨过这三个阶段的公司都有一个有趣的特点:**早期有一个创新力极强的创始人，中期有一个行业浸泡多年的合伙人，后期有一个懂得商业模式顶层设计和生态搭建的合伙人。**稀缺性，都是由合适的时间合适的人，带来的。

##  

### [肆]

### 好的商业模式

### 要能守得住秘密

###  

聚合支付是一个很好的点子，Ping++ 在 2014 年发现这个市场真空的时候，我们高兴坏了。**但我那个时候还不明白一个浅显的道理:这个秘密是守不住的。**

后来的发展也印证了这一点，大量竞品涌入，谁都说自己做聚合支付的，市场红海竞争，发展速度就被迫降了下来。之后的共享单车，也是同样的逻辑，毫无秘密可言，别人一看就懂，而且可以基本模仿到用户体验无差异。很多产品，无法摆脱这样的终局，本质上是因为终局一开始就注定了。

所以一家公司的产品，在可以产生某种秘密之前，千万不要堂而皇之的告诉别人、打广告、做宣传，追求热闹。**守不住秘密的商业模式，就是在给行业巨头做炮灰，艰辛你一个人扛，成果别人全面收割。**后来我们在聚合支付的基础上升级产品的时候，我们就学乖了，官网信息也克制，媒体上基本看不到文章，也不参加热闹的活动，处处低调，深耕客户场景，反而取得了不错的成绩和增长。

 

纵观这几年身边的成功经验，最好的秘密是——团队独有的主观气质和超前认知，因为这个东西别人即使看明白了也很难模仿复刻，把它完美融入产品的公司，都可以很好地跑出来，比如小红书。好的赛道，除了有长长的雪道，厚厚的积雪，还应该有只有自己才知道的秘密。

##  

### [伍]

### 企业级服务市场在中国为啥这么难

### 要从服务的客户群体特征去思考

### 也要考虑企业信息化的历史进程

 

很多创业的朋友进入投资行业，现在基本都在看企业级服务市场，他们的观点更是出奇一致: 横向比较人均 GDP 和人力成本，对标美国公司，中国现在正是播种的时候。而我认为这个观点是偏颇的，不然也不会每年都是企业服务市场的元年。我经常开玩笑的说，中国版的 Salesforce 其实是茅台酒，因为它们起到的作用是相似的，所以资本市场的市值也差不多。

这就是由不同国家的企业决策流程体系和文化所决定的。别人的 CRM 就是通过方法论和管理帮助企业赢得订单，而我们则是一瓶酒一桌饭把订单拿下的。**这是客户群体逆向选择的结果，不以人的意志转移。**

还有一个更加隐蔽的原因：美国企业级服务市场兴起的时候还在软件时代，互联网没有出现。等到整个企服市场体系成熟了，1990 年后才逐步触网，2000 年后则开始了云端化。**这个从软件再到互联网的进程极其关键，定型了美国toB市场的整体规则。而中国企业的信息化改造基本等同于互联网化，所以中国企业级服务市场几乎是脱胎于互联网浪潮的，没有软件文化的洗礼，直接互联网思维。**而互联网的特点是：无限上下游扩张，干掉中间环节，流量为王，边际效应递减。所以在中国，效率提升对于很多企业来说都不容易定量售卖，而线索、交易、做业绩增量却容易接受很多。这是互联网基因决定的。

##  

### [陆]

### 亏损扩张的前提是单位经济模型的

### 正向边际效益可计算

###  

朱啸虎先生好像说过：「一个好的投资人要先投过一亿美金」，我觉得一个好的创业者也差不多应该花过这个数才行。多年后，终于明白为啥投资人都要投连续创业者，**因为所有的坑都要用真金白银填上，而如何「合理亏损」就是一个天坑。**

朋友里做过 O2O 大战、单车大战、外卖大战的，后来聚到一起复盘反思，大家的共识是：如果单位经济模型一开始就跑不通，再多的投入也无法让它正向发展。很多时候，我们都并没有合理计算过单位经济模型，要么公式错了，要么参数不合理，要么假设条件客观不存在。

一个从 toB 创业转型到 toC 创业，现在做投资的朋友告诉我：**其实商业模式不应该按 toB 还是 toC 来区分，这个会产生误导，而应该是按单位经济模型是否可以精密计算来区分。**这个说法解释了我多年以来的一个疑问，为什么很多 toC 项目更容易拿大钱，是因为从获客、留存、转化、活跃等等过程都非常容易计算，只要模型跑通且可以正循环，即可拿钱开道批量复制，资本市场也更加接受这逻辑；而 toB 的复杂度更高，每一步之间的转化不够直观，也就意味着不容易用钱砸出来。这点上美国的 SaaS 公司做的很好，也就是单位经济模型可以做到一定程度的精密计算（国内公司大多做不到），所以现在美股 SaaS 公司的市值也反映了大家这样的预期。创业的世界里，时机和机会更加重要，钱并不稀缺，能花钱解决的问题，不要花时间。

##  

### [柒]

### 在存量的世界里厮杀

 

今天，在世界范围内经济发展率超过 5% 的只有中国、印度和越南，其他各国要么增长率已至 1% 以下，要么已完全进入负增长阶段。一个全世界范围内的金融危机正在被孕育，而下一个科技大爆炸带来的财富增长还遥遥无期，全世界一边翘首以盼科技带来新的产业突破，一边咬着牙准备去狩猎他国的生存空间。

今天的企业家、创业者、投资人，都还没有做好存量竞争的心理准备，但我们可能要面对一段时间的存量世界了。**通关游戏还得继续，阶层流动注定发生，利益分配时刻进行。面对残酷世界的杀伐果断，会是我们这一代人的宿命吗？**

 

管他的呢，和平时代，创业者就是革命家。

# 为什么说平台类企业要尽快接入资金存管？

2019-08-29 14:03:40 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/100136442

「资金存管」一般情况下，指的是**企业的平台资金通过第三方银行进行存管**。企业通过平台管理交易，银行负责存管资金，在**资金流与信息流一致**的前提下实现资金的独立管理。最为直接的目的，是**防范平台方挪用资金，保证客户资金的安全**。

近两年层出不穷的「暴雷」、「卷款跑路」等损害消费者权益的违法事件，不仅严重破坏了消费者对于行业的信心，还进一步伤害到了合规从业者的利益。监管部门的政策规范，目的在于约束不法从业者的同时，整顿风气，保护消费者权益并恢复消费者信心。而作为企业方，保护消费者权益亦是为了保护自己的长远利益，为企业的健康发展保驾护航。

![为什么说平台类企业要尽快接入资金存管？](https://imgconvert.csdnimg.cn/aHR0cDovL3AxLnBzdGF0cC5jb20vbGFyZ2UvZGZpYy1pbWFnZWhhbmRsZXIvYzhhNjU1NzQtY2NmMi00Y2E1LTgwMjYtZDQ4OWZiNzgxYzRj?x-oss-process=image/format,png)

#  

# 谁最需要关注合规性？

目前最为常见的互联网商业模式中，有两种场景最需要关注合规性。

1、 **平台业务模式**：电商平台、职业平台、共享经济平台、物业管理平台等

![为什么说平台类企业要尽快接入资金存管？](https://imgconvert.csdnimg.cn/aHR0cDovL3AxLnBzdGF0cC5jb20vbGFyZ2UvZGZpYy1pbWFnZWhhbmRsZXIvNmIzNDcxOTQtODVkMi00ODY3LWE5YjgtZTM0NTc0ZWEzNGYx?x-oss-process=image/format,png)

 

假设企业A的电商平台接入了支付宝，用户通过支付宝在平台上付款购买商品，之后支付宝直接将资金结算给了企业A，企业A再根据自身的业务模式给供应商或入驻商户结算收益费用，此处需要注意的是：

① 资金在平台方进行了一次中转；

② 若企业A出现了资金挪用、平台倒闭甚至携款跑路，那么入驻商户和供应商的钱就此损失。

这就是监管部门提到的「大商户」或「二清」。

2、 **涉及会员充值的模式**：美容美发、运动健身、共享经济等

![为什么说平台类企业要尽快接入资金存管？](https://imgconvert.csdnimg.cn/aHR0cDovL3AxLnBzdGF0cC5jb20vbGFyZ2UvZGZpYy1pbWFnZWhhbmRsZXIvMzk2ZDMwOTYtOGUxNi00YjI4LWIxZDAtNzRjNGE5ODgwMWUy?x-oss-process=image/format,png)

 

这种模式非常常见，出现违规的情况也非常多，用户提前预充值大额会员费，结果商家关门跑路、员工挪用资金或者商家经营不善倒闭关门。

 

# 怎么解决合规问题？

通行做法是**通过与具备资质的机构合作，包括银行、第三方支付公司，由这类机构完成资金的管理及资金的清结算**。

# 当会员充值接入资金存管，这次你再也不用担心资金清算违规

2019-08-29 14:06:16 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/100136526

## **一、为什么说涉及会员充值的场景需要关注合规？**

目前市面上各种会员卡琳琅满目，看似带来种种方便和实惠的同时，也产生了对资金安全的挑战。

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWMyLnpoaW1nLmNvbS84MC92Mi0yMGZiMDFjYjAzZGU1MjE0MmFjZDRkOTg5Y2Q1ODZkOV9oZC5qcGc?x-oss-process=image/format,png)

**预付卡消费欺诈**问题一直属于服务消费投诉的热点，**办卡容易、退卡难投诉量居高不下**，**消费者维权难度大**，吃了哑巴亏还无处讨个说法，自身权益无法得到保障，也势必会对行业秩序产生冲击。

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWM0LnpoaW1nLmNvbS84MC92Mi01M2YwYjEwZTcxMjU4NTVkNWJkY2RlMTBmMDI2NjhlN19oZC5qcGc?x-oss-process=image/format,png)

 

在当今互联网商业模式下，**涉及会员充值的场景**尤其需要关注**合规**性。接下来本篇文章就从对该种场景的说明开始，对涉及会员充值的场景下会出现的种种情况及解决方案进行简单介绍。

------

## **二、什么是涉及会员充值的场景？**

首先，涉及会员充值的场景对应的**业务模式**非常广泛，它的核心围绕着**会员充值、会员运营，适用于强调会员权益或高频低金额的场景**。其中比较典型的场景有**运动健身、美容美发、共享模式**如共享单车、充电宝等。在这种模式下资金流向非常简单，就是**通过充值将资金储蓄到商家提供的会员卡或账户上**。

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWMyLnpoaW1nLmNvbS84MC92Mi1mOGU0NzgxYjQ2M2VhODNhZDFiMGI1YzRiMWFkZmQ4ZF9oZC5qcGc?x-oss-process=image/format,png)

------

## 三、该种场景有什么风险？

但是这种简单的资金流向也存在着诸多风险。**大量C端用户提前预充值的大额充值资金留存在商户的企业账户上，可能会出现以下风险**。

1、**资金挪用。**员工挪用本单位资金归个人使用或者借贷给他人。

2、**商家跑路。**商户销售会员卡后突然停业关门，不知去向或者店面易主，接收者拒绝消费者继续使用原会员卡，且不负责退还卡内储值余额。

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWMxLnpoaW1nLmNvbS84MC92Mi01MzY3NWQxMTU2YTI5NjJhZTAyNDVhNzQ1NDI4Nzc0MF9oZC5qcGc?x-oss-process=image/format,png)

此种情景现实生活中比比皆是。

> 家住南昌市红谷滩新区的艾先生在“南昌海之味海鲜城”消费时，在商家促销活动中办理了一张预付卡(编号为00481)，参加了充值3000元赠送500元的优惠活动。此后，艾先生一直在海鲜城消费。今年年初，当艾先生再次来到海鲜城消费时，却发现其已经歇业。因为卡内余额还有493元，艾先生找出之前保存的经营者电话，多次打电话联系海鲜城要求退款，却遭到拒绝。

3、**商家倒闭。**倒闭后不提供退卡服务。

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWMzLnpoaW1nLmNvbS84MC92Mi1iM2IxYjRhNGY5ZDMyNmFjMzJlMzkxMWE3NTE5Y2VmMl9oZC5qcGc?x-oss-process=image/format,png)

而且，如果了解支付业务的话也不难看出，除了涉及资金安全的问题，还可能会涉及到**违规开展支付业务**的问题。因为这样的充值账户，本质上就是一个类似的电子钱包，属于支付账户的范畴，是**只有持牌机构才能开展**的业务。

------

## **四、怎么解决合规问题？**

在此种互联网商业模式下，合规处理交易资金，其通行做法就是**通过与具备资质的机构合作，包括银行、第三方支付公司，由这类机构完成资金的管理及资金的清结算**。

# 干货 | 互联网平台资金结算的合规处理方案

2019-09-03 16:40:22 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/100513252

央行对于支付资金的监管逐步加强。银行支付机构也推出了像匹配的资金解散产品。新领域新办法新条例的出现，都是为了保护消费者的合法权益不被侵害；守法合规同样也是互联网平台类公司健康发展的必备条件。

那么作为企业我们需要做出哪些对应的动作和调整，让企业在发展的过程中，严格遵守国家法律法规呢？今天就来给大家讲解一下互联网平台资金结算的相关知识及其解决方案，希望大家都能有所收获。

 

# 一、为何现在聚焦合规处理的话题

**1、监管政策**

**——人行加强支付结算领域监管**

1、2017年底开始，人行开始对线上互联网电商平台及线下集中收银模式的“二清+大商户”进行整顿。支付服务商为非法业务提供服务，支付服务商挪用商户待结算资金最后跑路。

2、持续开展互联网支付领域的反洗钱监管，打击非法支付交易。配合国家对整个项目社会问题的打击，关闭非法交易渠道。

3、关注资金安全风险，禁止平台私设不具有真实交易背景、不受金融机构管控的资金池。

**——《电子商务法》公布，平台责任加大**

1、提高平台合规及安全性、资金流转率和使用效率；

2、提升会员活跃度、会员粘性，保证业务持续增量；

3、基于数据层面延伸更多应用，成为众多电商平台发展中的瓶颈。

**2、市场需求**

互联网平台既是信息撮合方，也是交易撮合方。既为买家和卖家提供交易信息的展示，也提供了收款服务并为卖家提供了服务的解决方案，平台方交易撮合会产生痛点。

![img](https://imgconvert.csdnimg.cn/aHR0cDovL2kuY2hhbnBpbjEwMC5jb20vMTU2NzQ3Nzk0MzE2NjU5NDg3?x-oss-process=image/format,png)

**1 ）平台痛点**

——平台方收款后，将交易资金二次结算给其他商户

—— 对于央行公布的二清和大商户入了监管范围之内

a.非金融机构在收付款人之间作为中介机构提供货币资金转移服务需要取得第三方支付牌照第三方支付机构

b.违规“变相开展支付资金结算”，在业务合规方面的问题

——子商户对平台代管资金缺乏信任

a.平台方挪用商户资金，商户不能按时获取交易资金，造成商户资金损失

b.平台方为交易双方提供担保，商户的交易资金在客户收货后延时到账用户支付成功，商户发货，用户确认守护平台方把交易资金严实结算给作为卖家的商户的账号

**2 ）保障交易资金安全**

——用户/子商户在银行有独立账户，管理自身资金

**3 ）助力资金合规清算**

——对接银行存管账户类产品，实现交易资金的合规清算

 

# 二、什么样的业务场景需要关注资金结算的合规处理

**1、业务合作方待结算资金**

• 电商平台——B2B2C——天猫京东

 平台为卖方入驻后，提供优质的附加服务，买方通过平台购买商品

• 社会化分销——B2C2C——微商

 商户平台统筹货源、订单及售后，由代理进行推广销售；并根据代理等级进行统一结算分润。

• 社交电商——S2B2C

 商户平台对接厂家统筹货源与售后，平台拓展流量、营销推广并获得代理收益。

**2、用户储值资金**

• 充值

用户在平台方提前缴纳部分资金，作为自身账户的储值资金，用于后续在平台上消费时使用。

• 押金/保证金

用户在使用服务前将押金/保证金进行冻结，服务使用完毕后进行扣款，并对自动解冻押金，或者将押金/保证金作为已付费金额，继续支付订单剩余金额。

 

# 三、资金结算合规方案

**1、银行——资金存管账户**

平台在银行开立的资金存管账户，有实体账户和银行内部账户两种类型。

**1 ）实体账户**

以平台方公司名称在银行开立的存管账户，本质上属于客户的对公账户，只是在账户用途上，限定为存管账户（不能消费、转账等，只能接受支付渠道结算资金）。

![img](https://imgconvert.csdnimg.cn/aHR0cDovL2kuY2hhbnBpbjEwMC5jb20vMTU2NzQ3NzkyNDY1NTExNTgz?x-oss-process=image/format,png)

• 平台方资金存管账户

 与存管银行签约后开具

 用于接受支付渠道结算的交易资金

• 附属虚拟账户

 按交易实际参与方开立虚拟账户

 中间户

 自有资金账户

 资金托管账户

• 特点

\- 收款：支持支付宝、微信、银联等多种支付方式进行收款

\- 结算：资金结算至入驻商户虚拟户；提现时入驻商户银行卡中的付款方为平台公司名称

\- 资金流水往来：平台收款资金及入驻商户结算资金，体现为平台对公户中的资金进出；如为入驻子商户的交易资金，需通过“代收/代付”科目进行记录；银行提供电子流水单，对资金结算记录提供证明

**2 ）虚拟账户**

银行内部账户。平台方在银行开立，账户名义上归银行所有，但由客户掌握账户的实际使用权，用途限定为存管账户（不能消费、转账等，只能接受支付渠道结算资金并把资金下发给相应的业务参与方）

• 平台方的虚拟户，是属于银行存管产品下的一个银行内部虚拟户。

• 平台方业务中的入驻商户和注册用户，当需要有资金通过存管产品进行管理时，入驻商户和注册用户会在平台方的存管账户虚拟户下，分别开立属于自己的虚拟户。

• 入驻商户和注册用户内的资金，按照平台方的交易指令进行资金管理，如充值、结算、提现等。

![img](https://imgconvert.csdnimg.cn/aHR0cDovL2kuY2hhbnBpbjEwMC5jb20vMTU2NzQ3Nzg2NDQ1MDIxMTI1?x-oss-process=image/format,png)

• 特点

\- 收款：支持支付宝、微信、银联等多种支付方式进行收款；一般使用本行支付通道

\- 结算：资金结算至公司或个人的虚拟户；提现时，虚拟户绑定银行卡中的付款方为虚拟户所属的公司或个人自身，相当于自身两张银行卡间的转账

\- 资金流水往来：平台收款资金及入驻商户结算资金，通过银行内部账户管理，平台对公账户不产生相关资金往来流水；仅平台收入部分，通过提现进入平台对公账户；银行提供电子流水单，对资金结算记录提供证明

**存管账户资金流向**

![img](https://imgconvert.csdnimg.cn/aHR0cDovL2kuY2hhbnBpbjEwMC5jb20vMTU2NzQ3Nzc2NTI5NjQ3NzUz?x-oss-process=image/format,png)

1、支付渠道将交易资金结算到平台方的资金存管账户

2、交易资金进入待清算账户，等待平台方的结算指令后完成交易结算

3、资金存管账户按平台方指定的资金收款方，将交易资金结算到收款子商户虚拟账户

4、子商户通过平台方发起提现，将交易资金从存管账户提现到本人银行卡

 

**2、支付机构——合单支付**

平台方的注册用户、商户，授权支付机构通过平台方来进行统一收款。

入网：参与订单结算的个人/公司，在支付机构完成商户资料提交，完成商户入网。

授权：已完成商户入网的结算方，向支付机构提交授权书，授权平台方代理自身向支付机构发起交易。

交易：平台方发起交易，交易中包含参与结算的用户、商户，用户一次性完成支付。

结算：支付机构按照交易中平台、用户、商户的收款金额，直接进行结算。

适用场景：参与方相对固定，可以提供资质材料；每笔交易发生前，平台已经明确订单参与方。

 

**3、支付机构——订单分账**

• 收款商户的待结算资金，支付机构按照平台的业务规则，二次调整收款资金的归属通常限定分账资金比例

![img](https://imgconvert.csdnimg.cn/aHR0cDovL2kuY2hhbnBpbjEwMC5jb20vMTU2NzQ3Nzc3ODY2NDgyNjYy?x-oss-process=image/format,png)

适用场景：分账方总金额一般不大于订单金额的30%；支付完成后，才能明确订单分账方

 

# 四、如何选择合规处理方案

![img](https://imgconvert.csdnimg.cn/aHR0cDovL2kuY2hhbnBpbjEwMC5jb20vMTU2NzQ3NzYxMjIzODU1OTI5?x-oss-process=image/format,png)

**电商平台**

![img](https://imgconvert.csdnimg.cn/aHR0cDovL2kuY2hhbnBpbjEwMC5jb20vMTU2NzQ3NzYzNDkzNDIzMzc5?x-oss-process=image/format,png)

**会员储值**

![img](https://imgconvert.csdnimg.cn/aHR0cDovL2kuY2hhbnBpbjEwMC5jb20vMTU2NzQ3NzY5MTMzNDc4MDcy?x-oss-process=image/format,png)

# 资金合规结算——聚焦银行内部两种不同账户

2019-09-17 16:24:26 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/100930392

![img](https://img-blog.csdnimg.cn/20190917162805949.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjU0OTY2Mw==,size_16,color_FFFFFF,t_70)

近两年在互联网平台多种场景下，逐渐暴露出许多资金违规问题。

从前用户通过平台方直接交易资金，平台方收款后向第三方、个人、企业进行二次结算，钱从平台方直接流向子商户，然而在**交易撮合的过程中也暴露出了平台方挪用资金等痛点**。

**用户储值资金场景下，也难避资金挪用、商家跑路倒闭等诸多风险**。种种损害消费者权益的违法事件，不仅严重破坏了消费者对于行业的信心，也会连带伤害合规从业者的利益。

作为企业方，关注资金存管合规性尤为必要，**既可保护自己的长远利益，为自身健康发展保驾护航；同时，保证客户资金的安全亦可整顿行业风气，提振消费者信心**。

资金存管一般是指平台交易资金通过第三方银行进行存管，也叫银行存管。通过平台管理交易，银行存管资金的方法，在资金流与信息流一致的前提下实现资金的独立管理，从而达到平台无法挪用资金，确保客户资金安全的目的。

平台交易资金通过第三方银行进行存管时，平台会在银行开立资金存管账户，有实体账户和银行内部账户（虚拟账户）两种。

那么这两种账户的区别是什么呢？下面就为大家讲解一下。

------

# **一、实体账户**

实体账户是以**平台方公司名称**在银行开立的存管账户，本质上属于**客户的对公账户**，在账户用途上限定为**存管账户**（不能消费、转账等，只能接受支付渠道结算资金）。

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWM0LnpoaW1nLmNvbS84MC92Mi0xYTYwYzJlOTg5MmFlNzcyNzI5NTMyZmFmOGNjMjEyM19oZC5qcGc?x-oss-process=image/format,png)

平台方资金存管账户在**与存管银行签约**后开具，用于接收支付渠道结算的交易资金。同时按照**交易实际参与方**会在交易资金存管账户下开设**附属虚拟账户**，如上图所示，包括**中间户、平台托管账户和资金托管账户**。

**中间户**具有存储待清算资金，为交易提供担保服务，提供营销解决方案的功能。

**资金托管账户**是个人和企业在交易资金存管账户下开设的基本户，以虚拟账户形式托管交易资金。当一笔交易完成，钱通过支付渠道名义上打给平台，但是平台不能直接将这些钱进行二次结算，这些钱都转入了平台方在银行开设的资金存管账户中。

**平台托管账户**是平台开设的基本户，同样是以虚拟账户形式暂时托管交易资金。

## **实体账户功能**

实体账户支持支付宝、微信、银联等多种支付方式进行收款，资金结算至入驻商户的虚拟户，即个人、企业和平台在银行开设的资金托管账户，提现时入驻商户银行卡的付款方为**平台公司名称**。

平台收款资金和入驻商户结算资金，资金都是在平台对公户进出，如为入驻子商户的交易资金，需通过“代付/收付”科目进行记录。在资金流水往来交易中，银行会提供电子流水单，对资金结算记录提供证明。

------

# **二、虚拟账户（银行内部账户）**

平台方在银行开立，账户**名义上归银行所有**，但由**客户掌握账户的实际使用权**，用途限定为**存管账户**，是属于银行存管产品下的一个银行内部虚拟户。

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWMyLnpoaW1nLmNvbS84MC92Mi1lZTk1YmFlZTMwNjYxMzg1YzI3NGZjYTVmOTQzODg1OV9oZC5qcGc?x-oss-process=image/format,png)

平台方业务中的入驻商户和注册用户，当需要有资金通过存管产品进行管理时，入驻商户和注册用户会**在平台方的存管账户虚拟户下，分别开立属于自己的虚拟户**，其**资金也就按照平台方的交易指令进行资金管理**，如充值、结算、提现等。

平台开设的是专用账户，即在银行内部开设专属平台业务的虚拟账户，属于**平台对公户**。

各类入驻收款客户、支付客户在平台业务下开设的是分账户，账户类型包括银行对公或对私虚拟账户，对私II类户、支付账户等，属于**商户对公虚拟户**。

与此同时也支持个人同名银行卡账户绑定，属于对私虚拟户。

## **虚拟账户功能**

虚拟账户同样支持支付宝、微信、银联等多种支付方式进行收款且一般使用本行支付通道，资金结算至公司或个人的虚拟户，提现时，虚拟账户绑定银行卡中的付款方为**虚拟户所属的公司或个人自身**，也就相当于自身两张银行卡间的转账。

平台收款资金及入驻商户结算资金，通过银行内部账户管理，所以平台对公账户不产生相关资金往来流水，通过提现进入平台对公账户的**仅为平台收入部分**，银行会提供电子流水单，对资金结算记录提供证明。

银行存管资金，在确保信息一致的情况下实现资金的独立管理，平台对钱没法动手动脚，平台痛点化于无形，从前二清中出现的害群之马也都在透明的结算过程下被就地正法，从而确保了资金安全合规。

# 聚焦业务实例场景，揭秘资金存管优先级奥义

2019-09-27 16:44:17 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/101543492

通过前面几课对资金存管有关知识的学习，相信同学们已经能够大体明白资金存管是什么，以及它是如何确保合规的了。

就目前而言，能够提供资金结算合规方案的，除了银行的资金存管账户，其实还有支付机构的合单支付和订单分账，我们已经对他们各自的资金结算流程和应用场景有所了解，那么面对这些合规产品，为什么说银行的资金存管才是资金合规结算的更佳选择呢？

下图是一个最最最最最简单也是非常常见的基本零售供应场景。

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly81YjA5ODhlNTk1MjI1LmNkbi5zb2h1Y3MuY29tL2ltYWdlcy8yMDE5MDkyNy9lNDZhN2JkMmMzMzY0YzI1OTMzMWEwZjI1MjkyMTAxMC5wbmc?x-oss-process=image/format,png)

在这个零售小B端的场景下，某平台公司推出对其友好的新零售供应链整体解决方案，帮助其解决货源、收款、培训等问题，在这个场景下参与交易的各方——消费者、门店、平台和供应商都在交易过程中承担着各自的职责。

接下来主任会对整个业务实例交易过程进行解读，帮助大家理解为什么资金存管才更能满足实际场景的业务需求。

本篇先让我们来看看这样一个业务实例场景下，各部分主体都具体扮演着怎样的角色呢？ 

# **一、消费者**

即在零售门店购买商品交易中的**付款方**。 

消费者在整个交易过程中**只和门店发生交互**，在零售门店进行购买并直接付款给该门店，发票直接由门店开具，对后面的整个资金清算过程是没有感知的。 

# **二、零售门店**

即为终端消费者提供零售服务交易中的**收款方**。

**直接面向C端**也就是消费者，为C端用户提供服务，交付商品给消费者从而发生交互，在整个交易中作为收款方。 

门店提供的货物从接入平台合作的供应商处获取，供应商把商品通过物流发给门店，由门店进行售卖，随后门店根据售卖商品对应的供应商进行分账。像门店是小百货超市的情况下，往往存在很多的供应商，分账时也需要分别进行。 

这里需要注意的是，进货时**门店无需支付全部货款，只需预付部分即可进货，销售的时候再通过分账的形式，把这部分没有付给供应商的钱通过分账的形式分给供应商。** 

# **三、供应商**

即为零售门店提供商品供应的商家交易中的**分账方**。

供应商作为货源的提供方，有时根据供应商品性质不同还需要提供售后服务，在整个交易过程中作为分账方。

# **四、平台** 

即为零售门店提供供应商及收款、培训等配套服务交易中的**分账方**。 

平台实际上是门店商户和供应商的**中间撮合方**。

对供应商来说，平台能够整合供应商资源，帮助其解决库存问题，拓宽新零售渠道，找寻优质零售终端，帮助供应商提高销量，让资源能够从优配置，从而加速货物流通，所以可以说**供应商和平台存在的是合作关系**； 

对门店来说，平台能够**给新零售门店提供赋能**，为门店提供供应商信息推介、ERP、收银管理软件以及对人员的经营培训等支持，降低开店成本，提高资金运转效率，所以门店在分账时不光需要分账给供应商，也要按照协议向平台分账。 

在这个过程中平台也会抽取相对较低的费用，所以也是一个分账方。

# 零售小B端场景下，为什么合规首选银行存管？

2019-09-27 17:29:17 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/101547467

前一篇文章里主任为大家具体分析了小B端零售业务场景下各主题的职责，不难看出这种业务场景下存在着如下特点：

1、由于终端售卖商品不同，像日化快消，食品服装，毛利率差别很大，平台提供预付部分货款进货，同时需要对门店进行评级。**门店资质不同，在供应商那里获取的信任也不同，这也导致门店给供应商分账比例差别很大。**同样即使是对接相同供应商不同资质的门店获得的信任是不同的。 

2、参与方很多，一个订单往往购买很多家供应商的货品，一些商品如服装，供应商有时不得不面对库存对接不上的问题，门店在前端发生售后服务，比如换货服务，此时订单中的供应商也会相应发生变化，**分账时间确认信息点发生变化，所以也需要相应的灵活的分账方式和处理能力。**

3、与新零售结合的门店，在业务场景中作为直接的收款方，**需要线上线下多渠道收款能力。**

4、**小B端自身财务账务管理能力有限，所以需要平台能够基于支付服务可以提供明晰的财务账务记录支持。**

------

让我们再来回顾一下各合规产品的特点。 

# **银行存管**

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly81YjA5ODhlNTk1MjI1LmNkbi5zb2h1Y3MuY29tL2ltYWdlcy8yMDE5MDkyNy80NGQ3ODIyMDU0OTY0NDM5ODFhOTJjNWQyNzVhYzg3Ni5wbmc?x-oss-process=image/format,png)

**分账比例灵活**——支付渠道将交易资金结算到平台方的资金存管账户，等待平台方的结算指令，按照平台方指定的资金收款方和分账的比例，即可将资金结算到收款子商户的虚拟账户中。

**分账方式灵活**——多个渠道进入银行存管账户可以进行统一的资金结算。

**收款渠道灵活**——支持支付宝、微信、银联等多种支付方式进行收款。

**财务往来明晰**——资金流水往来中，银行对每一笔交易提供电子流水单，对资金结算记录提供证明。

# **支付机构**

**合单支付**

• 参与方相对固定，可以提供资质材料

• 每笔交易发生前，平台已经明确订单参与方

**订单分账**

• 分账方总金额一般不大于订单金额的30%

• 支付完成后，才能明确订单分账方

对于支付机构产品而言，不光对分账资金比例进行了限定，订单参与方也都在交易发生前或者支付完成后才能明确，**分账方式和分账比例都不如银行资金存管产品灵活**。

综上不难得出结论，零售门店业务场景下，银行资金存管账户产品在现实交易中更加契合实际需要，也难怪会成为更佳pick。

# 商户是如何对接银行存管的？三个链路就OK！

2019-10-11 17:34:28  

分类专栏： [主任讲课](https://blog.csdn.net/weixin_42549663/article/category/7764219)

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/102505783

前一篇文章中我们介绍了银行可以为小B端商户做的事情，但是**对于商户端来说，怎么做才能对接上银行资金存管业务呢？**

如果徐家汇所有商场中的每一户商户都要自己寻找对接银行存管链路，或许一些沪漂族还没来得及实现致富梦，就因为到手的钱结算不合规被劝退了。

其实，平台商户需要做的，即**与银行存管完成产品和系统上的对接，需要搭建成如下图所示的系统。**而对接银行存管的链路，主要就是通过如下图所示的系统角色的链路方式来进行的。

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9waWM0LnpoaW1nLmNvbS84MC92Mi1iNTkwY2IzNjRmZTBmODUwNjllMGJiNzcxMDg4NTYzZl9oZC5qcGc?x-oss-process=image/format,png)

在这个过程中会把存管产品分为三个链路。

------

## 一、子商户开户

平台商户下的子商户要同步给存管银行，在平台的支付系统维护商户信息，通过支付系统对接到银行的接口把商户信息同步给银行，在银行侧完成开户。如果商户正好是收款商户，那么还要同步到支付渠道系统同步支付配置。

## 二、订单生成与支付

平台在业务系统产生业务订单，产生的业务订单同步到支付系统，支付系统向银行存管账户系统同步，订单中包含分账信息，使用支付渠道完成支付。

## 三、分账的结算

该动作从业务系统出发，也可从支付系统出发，要视商户具体结算规则而定，通过支付系统对接银行存管接口，按照平台与门店、供应商确定的结算周期，由支付系统发起结算指令到存管账户系统，由银行完成分账结算。

这三个链路后面还会分别进行详细介绍，快快关注支付学院线上课堂，让你在资金结算路上合规守法不迷路~

 

# 从支付系统到银行系统，五个接口就能全方位对接

2019-10-15 17:08:56 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/102570717

前一篇文章里我们简单介绍了商户对接银行存管的三个链路，即子商户开会、订单生成与支付和分账的结算。从商户系统到银行系统，其实主要就是商户的支付系统到银行的存管系统。

平台商户的支付系统对接银行的存管系统，有很多接口和模块，下面我们就来看一下有哪几个模块呢？

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9wMS10dC5ieXRlaW1nLmNvbS9sYXJnZS9wZ2MtaW1hZ2UvZDU1NTMxMzg5MGU3NDgyYzlmY2Q5Nzc1NmNlZjRjNTY?x-oss-process=image/format,png)

# **子商户信息维护**

包括子商户开户，销户申请，子商户材料变更，新子商户材料提交，商户的结算账号绑定，存量商户可能会产生修改。

# **订单信息的同步**

主要包含订单金额，需要说明收款人、付款人各是谁，分账方以及每个分账方会分到多少金额，是用什么支付渠道来支付的。

# **支付**

通过微信或支付宝渠道发起支付，主要正常的链路包含正向交易即支付，逆向交易即退款，这两块的交易。

# **对账**

平台所有的收款商户有收款的信息记录，这些收款的请求到了支付渠道这一侧之后，支付渠道产生信息明细，对账就是在支付渠道在所有请求完成后，第二天支付渠道将对账单给到对接的平台或收款的商户侧，平台需要完成收款商户侧信息和支付渠道账单间的对账，对其中产生的差错进行处理。

# **结算**

对于待分账金额进行分账结算，对所有子商户收入账户，向各自有账户的提现。

------

**在这个对接联调的过程中，有些事项必须要加以注意。**

首先，银行系统和普通互联网公司系统有差异，银行或大型金融公司对安全性要求很高，**对接前商户要确认对接形式**，是互联网还是专线，因为这两者的对应技术存在差异。

**银行安全标准对于商户侧的开发部署环境，软件版本的要求是什么样的也要提前了解。**

比如银行可能会有 PCI DSS 的要求，要求商户端服务端的 SSL 和 TLS 协议有版本要求。以及银行的测试，生产环境的接口联通，是否需要提前做防火墙开墙，IP 地址是否开启白名单配置以供访问，这些问题不提前弄清的话，会产生网络通讯的问题。

 

银行处理交易大部分是同步接收请求，异步进行处理。所有交易资金都有处理时效。**商户设计需要考虑，和银行确认交易和资金处理的时效。**

**在上线前有很多测试需要做，**因为内部ID管理非常严格，会提供一套指定的测试案例，要求商户按照指定测试案例完成对接测试，**有些银行要求作为接入的对接商户，测试范围必须大于要求的测试范围。**

 

商户在对接存管前，已经有一些存量业务在跑，产生的信息和存量的资金需要合规化接入到存管，**商户需要提前和银行确认能不能提供资金导入或数据初始化能力的支持**，然后再看要不要模块接入。

快快关注支付学院线上课堂，让你在资金结算路上合规守法不迷路~

# 左牵业务，右牵支付，中间的支付系统该怎么整？

2019-10-16 17:22:56 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/102589425

支付系统一头牵着业务，一头牵着渠道和存管，可以说是起着串联上下游的作用。

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9wMS10dC5ieXRlaW1nLmNvbS9sYXJnZS9wZ2MtaW1hZ2UvMzM3NTVlYjNkM2QyNGMwNmExYjNhNzQ1NDY5Yzg1MWM?x-oss-process=image/format,png)

它的结构主要分为**业务层和支付层**（也可说是渠道层）。其业务层分为订单信息、商户管理、用户管理三个模块；支付层分为支付网关和存管账户两个模块。每个模块下具体又有很多职能。

支付系统在运作过程中，**模块下的各部分功能通过三条主要链路被有序的串联在一起，完成前面文章所说的存管方案，即子商户开户、订单的支付和分账结算。**

下面我们就来通过这三个主要链路看支付系统是怎样运作的。

# 子商户开户

子商户开户是一个从无到有的过程。子商户开户从上游业务系统的工作（可以是平台商户给到商户侧线上入口，想要和平台合作的商户提交有关信息和材料；也可以是平台商户自己运营的操作管理后台，由平台商户自己的业务拓展人员和线下商户达成签订协议后录入系统）调进支付系统。

业务层商户管理模块中对商户信息实际上进行的是**增、删、改、查**这四个步骤，这个模块里面除商户基础信息外，还需包括商户分账和结算规则，以及商户是否会作为收款商户，如果是的话还要提供相关的渠道参数。

业务层将商户信息维护好后，**通过支付层传递信息，请求银行存管系统给子商户开立虚拟商户**，从而完成子商户在银行侧开户。

# 订单支付

上游业务订单传递给支付系统，支付系统对于已**明确好订单总金额、收款方和付款方**的订单信息进行记录和转发，这里需关注该**订单是否有优惠信息、实付金额是多少、用什么渠道发起支付、有哪些分账方以及分账的比例如何**，然后再通过商户管理模块中的模板进行计算。

分账方是用户的情况也同样适用，根据支付的渠道信息，业务层通过支付层中的支付网关把支付信息给银行渠道，发起支付请求然后拉起微信支付宝发起支付，并将订单分账信息传递给银行的存管账户系统。支付网关配置支付渠道侧的收款参数，对接好支付退款交易和对账功能。

# 分账结算

**按照商户管理清算规则发起，按照交易中的分账信息分账。**指令从业务层到支付层，存管账户中对接分账结算交易并将请求传给银行，银行侧保有之前提供过的分账信息，在拿到请求后根据其进行分账结算。

 

之后我们会继续通过流程示意图的例子来分别介绍三个链路在系统交互上是怎么样的，快快关注支付学院线上课堂，了解支付知识，让你在资金清算的道路上守法合规不迷路~

 

# 支付系统设计——这次不从盘古开天辟地，我们从子商户开户说起

2019-10-18 17:45:54 更多

版权声明：本文为博主原创文章，遵循[ CC 4.0 BY-SA ](http://creativecommons.org/licenses/by-sa/4.0/)版权协议，转载请附上原文出处链接和本声明。本文链接：https://blog.csdn.net/weixin_42549663/article/details/102629641

通过上一篇文章的学习，相信大家都对支付系统的结构层级有了宏观上的把控。

支付系统在运作过程中，**模块下的各部分功能通过三条主要链路被有序的串联在一起，完成三个存管方案，即子商户开户、订单的支付和分账结算。下面我们就分别来讲解一下。**

那么今天要跟大家讲的就是子商户开户。

支付系统的设计需要技术服务商，在如下所示的流程图中，Ping++ 系统就可以简单视为平台商户的支付系统这样一个角色。

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly81YjA5ODhlNTk1MjI1LmNkbi5zb2h1Y3MuY29tL2ltYWdlcy8yMDE5MTAxOC85MWM4NjY1ODRjM2Q0N2M5ODc4ODQxMWEyYTkxMTEyYS5qcGVn?x-oss-process=image/format,png)

平台需要维护商户资料填写并提交申请，**明确账户性质，个人户还是企业户两者在资料层面有着本质区别。**在这个请求提交给平台商户的支付系统后，**由支付系统来做分路，决定是做个人还是企业的账户**，从而相对应地对接到存管银行的个人或企业虚拟账户。

图上虽然看起来只是简单的一两步就可以完成的交互行为，实际上**根据其背后对应的银行的实际产品的不同，也可能会有不一样的接口。**

比如材料提交有单次或者多次，是先创立这样的对象然后再去补充材料，还是先提交材料，然后再把文件链接带进接口直接开户，这就要视银行产品接口设计而定。

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly81YjA5ODhlNTk1MjI1LmNkbi5zb2h1Y3MuY29tL2ltYWdlcy8yMDE5MTAxOC9kZTBlNjA5NDgyNDI0NTQ1YTRjZTI5NDA4NDExYWRmNC5qcGVn?x-oss-process=image/format,png)

通过前面文章的介绍我们可以知道，支付系统中有一块是说分账可以做成模板，制定规则。这其实是说在商户本身具备一些规则时，同样是供应商，同样是门店，可能会有层级的划分。

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly81YjA5ODhlNTk1MjI1LmNkbi5zb2h1Y3MuY29tL2ltYWdlcy8yMDE5MTAxOC9iNWU1MzE5NzViMDA0NzA4ODljNDczN2IyZTgyZTIyMS5qcGVn?x-oss-process=image/format,png)

假设有代理商和中间商在中间赚差价，那么**分账里面就可以根据属性、上下级的角色属性关系来进行模板的配置，这种划分方式可以是按比例，也可以是按照比较小的固定金额。这些分的金额，是给收款方还是给实际对C端服务的终端，即服务方，这里都可以做业务规则的配置。**

在支付系统实际设计中，也可以参考如图所示的模板进行子商户分层，确定分润方式，并制定相应分润相应规则。

快快关注支付学院线上课堂，了解支付知识，让你在资金清算的道路上守法合规不迷路~

